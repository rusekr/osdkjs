/*! Crocodile WebRTC SDK: JavaScript Library - v1.0 - 2013-10-02
* https://www.crocodilertc.net
* Copyright (c) 2013 Crocodile RCS Ltd; Licensed MIT
*
* Incorporates the following third-party open source software:
*
* JsSIP (http://www.jssip.net/)
*  Copyright (c) 2012-2013 José Luis Millán - Versatica
*  License: MIT
*
* JSJaC (https://github.com/sstrigler/JSJaC)
*  Copyright (c) 2004-2008 Stefan Strigler
*  License: MPL-1.1/GPL-2.0+/LGPL-2.1+
*/
function hex_sha1(a){return binb2hex(core_sha1(str2binb(a),a.length*chrsz))}function b64_sha1(a){return binb2b64(core_sha1(str2binb(a),a.length*chrsz))}function str_sha1(a){return binb2str(core_sha1(str2binb(a),a.length*chrsz))}function hex_hmac_sha1(a,b){return binb2hex(core_hmac_sha1(a,b))}function b64_hmac_sha1(a,b){return binb2b64(core_hmac_sha1(a,b))}function str_hmac_sha1(a,b){return binb2str(core_hmac_sha1(a,b))}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc")}function core_sha1(a,b){a[b>>5]|=128<<24-b%32,a[(b+64>>9<<4)+15]=b;for(var c=Array(80),d=1732584193,e=-271733879,f=-1732584194,g=271733878,h=-1009589776,i=0;i<a.length;i+=16){for(var j=d,k=e,l=f,m=g,n=h,o=0;80>o;o++){c[o]=16>o?a[i+o]:rol(c[o-3]^c[o-8]^c[o-14]^c[o-16],1);var p=safe_add(safe_add(rol(d,5),sha1_ft(o,e,f,g)),safe_add(safe_add(h,c[o]),sha1_kt(o)));h=g,g=f,f=rol(e,30),e=d,d=p}d=safe_add(d,j),e=safe_add(e,k),f=safe_add(f,l),g=safe_add(g,m),h=safe_add(h,n)}return Array(d,e,f,g,h)}function sha1_ft(a,b,c,d){return 20>a?b&c|~b&d:40>a?b^c^d:60>a?b&c|b&d|c&d:b^c^d}function sha1_kt(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function core_hmac_sha1(a,b){var c=str2binb(a);c.length>16&&(c=core_sha1(c,a.length*chrsz));for(var d=Array(16),e=Array(16),f=0;16>f;f++)d[f]=909522486^c[f],e[f]=1549556828^c[f];var g=core_sha1(d.concat(str2binb(b)),512+b.length*chrsz);return core_sha1(e.concat(g),672)}function rol(a,b){return a<<b|a>>>32-b}function str2binb(a){for(var b=Array(),c=(1<<chrsz)-1,d=0;d<a.length*chrsz;d+=chrsz)b[d>>5]|=(a.charCodeAt(d/chrsz)&c)<<32-chrsz-d%32;return b}function binb2str(a){for(var b="",c=(1<<chrsz)-1,d=0;d<32*a.length;d+=chrsz)b+=String.fromCharCode(a[d>>5]>>>32-chrsz-d%32&c);return b}function binb2hex(a){for(var b=hexcase?"0123456789ABCDEF":"0123456789abcdef",c="",d=0;d<4*a.length;d++)c+=b.charAt(15&a[d>>2]>>8*(3-d%4)+4)+b.charAt(15&a[d>>2]>>8*(3-d%4));return c}function binb2b64(a){for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c="",d=0;d<4*a.length;d+=3)for(var e=(255&a[d>>2]>>8*(3-d%4))<<16|(255&a[d+1>>2]>>8*(3-(d+1)%4))<<8|255&a[d+2>>2]>>8*(3-(d+2)%4),f=0;4>f;f++)c+=8*d+6*f>32*a.length?b64pad:b.charAt(63&e>>6*(3-f));return c.replace(/AAA\=(\=*?)$/,"$1")}function hex_md5(a){return binl2hex(core_md5(str2binl(a),a.length*chrsz))}function b64_md5(a){return binl2b64(core_md5(str2binl(a),a.length*chrsz))}function str_md5(a){return binl2str(core_md5(str2binl(a),a.length*chrsz))}function hex_hmac_md5(a,b){return binl2hex(core_hmac_md5(a,b))}function b64_hmac_md5(a,b){return binl2b64(core_hmac_md5(a,b))}function str_hmac_md5(a,b){return binl2str(core_hmac_md5(a,b))}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc")}function core_md5(a,b){a[b>>5]|=128<<b%32,a[(b+64>>>9<<4)+14]=b;for(var c=1732584193,d=-271733879,e=-1732584194,f=271733878,g=0;g<a.length;g+=16){var h=c,i=d,j=e,k=f;c=md5_ff(c,d,e,f,a[g+0],7,-680876936),f=md5_ff(f,c,d,e,a[g+1],12,-389564586),e=md5_ff(e,f,c,d,a[g+2],17,606105819),d=md5_ff(d,e,f,c,a[g+3],22,-1044525330),c=md5_ff(c,d,e,f,a[g+4],7,-176418897),f=md5_ff(f,c,d,e,a[g+5],12,1200080426),e=md5_ff(e,f,c,d,a[g+6],17,-1473231341),d=md5_ff(d,e,f,c,a[g+7],22,-45705983),c=md5_ff(c,d,e,f,a[g+8],7,1770035416),f=md5_ff(f,c,d,e,a[g+9],12,-1958414417),e=md5_ff(e,f,c,d,a[g+10],17,-42063),d=md5_ff(d,e,f,c,a[g+11],22,-1990404162),c=md5_ff(c,d,e,f,a[g+12],7,1804603682),f=md5_ff(f,c,d,e,a[g+13],12,-40341101),e=md5_ff(e,f,c,d,a[g+14],17,-1502002290),d=md5_ff(d,e,f,c,a[g+15],22,1236535329),c=md5_gg(c,d,e,f,a[g+1],5,-165796510),f=md5_gg(f,c,d,e,a[g+6],9,-1069501632),e=md5_gg(e,f,c,d,a[g+11],14,643717713),d=md5_gg(d,e,f,c,a[g+0],20,-373897302),c=md5_gg(c,d,e,f,a[g+5],5,-701558691),f=md5_gg(f,c,d,e,a[g+10],9,38016083),e=md5_gg(e,f,c,d,a[g+15],14,-660478335),d=md5_gg(d,e,f,c,a[g+4],20,-405537848),c=md5_gg(c,d,e,f,a[g+9],5,568446438),f=md5_gg(f,c,d,e,a[g+14],9,-1019803690),e=md5_gg(e,f,c,d,a[g+3],14,-187363961),d=md5_gg(d,e,f,c,a[g+8],20,1163531501),c=md5_gg(c,d,e,f,a[g+13],5,-1444681467),f=md5_gg(f,c,d,e,a[g+2],9,-51403784),e=md5_gg(e,f,c,d,a[g+7],14,1735328473),d=md5_gg(d,e,f,c,a[g+12],20,-1926607734),c=md5_hh(c,d,e,f,a[g+5],4,-378558),f=md5_hh(f,c,d,e,a[g+8],11,-2022574463),e=md5_hh(e,f,c,d,a[g+11],16,1839030562),d=md5_hh(d,e,f,c,a[g+14],23,-35309556),c=md5_hh(c,d,e,f,a[g+1],4,-1530992060),f=md5_hh(f,c,d,e,a[g+4],11,1272893353),e=md5_hh(e,f,c,d,a[g+7],16,-155497632),d=md5_hh(d,e,f,c,a[g+10],23,-1094730640),c=md5_hh(c,d,e,f,a[g+13],4,681279174),f=md5_hh(f,c,d,e,a[g+0],11,-358537222),e=md5_hh(e,f,c,d,a[g+3],16,-722521979),d=md5_hh(d,e,f,c,a[g+6],23,76029189),c=md5_hh(c,d,e,f,a[g+9],4,-640364487),f=md5_hh(f,c,d,e,a[g+12],11,-421815835),e=md5_hh(e,f,c,d,a[g+15],16,530742520),d=md5_hh(d,e,f,c,a[g+2],23,-995338651),c=md5_ii(c,d,e,f,a[g+0],6,-198630844),f=md5_ii(f,c,d,e,a[g+7],10,1126891415),e=md5_ii(e,f,c,d,a[g+14],15,-1416354905),d=md5_ii(d,e,f,c,a[g+5],21,-57434055),c=md5_ii(c,d,e,f,a[g+12],6,1700485571),f=md5_ii(f,c,d,e,a[g+3],10,-1894986606),e=md5_ii(e,f,c,d,a[g+10],15,-1051523),d=md5_ii(d,e,f,c,a[g+1],21,-2054922799),c=md5_ii(c,d,e,f,a[g+8],6,1873313359),f=md5_ii(f,c,d,e,a[g+15],10,-30611744),e=md5_ii(e,f,c,d,a[g+6],15,-1560198380),d=md5_ii(d,e,f,c,a[g+13],21,1309151649),c=md5_ii(c,d,e,f,a[g+4],6,-145523070),f=md5_ii(f,c,d,e,a[g+11],10,-1120210379),e=md5_ii(e,f,c,d,a[g+2],15,718787259),d=md5_ii(d,e,f,c,a[g+9],21,-343485551),c=safe_add(c,h),d=safe_add(d,i),e=safe_add(e,j),f=safe_add(f,k)}return Array(c,d,e,f)}function md5_cmn(a,b,c,d,e,f){return safe_add(bit_rol(safe_add(safe_add(b,a),safe_add(d,f)),e),c)}function md5_ff(a,b,c,d,e,f,g){return md5_cmn(b&c|~b&d,a,b,e,f,g)}function md5_gg(a,b,c,d,e,f,g){return md5_cmn(b&d|c&~d,a,b,e,f,g)}function md5_hh(a,b,c,d,e,f,g){return md5_cmn(b^c^d,a,b,e,f,g)}function md5_ii(a,b,c,d,e,f,g){return md5_cmn(c^(b|~d),a,b,e,f,g)}function core_hmac_md5(a,b){var c=str2binl(a);c.length>16&&(c=core_md5(c,a.length*chrsz));for(var d=Array(16),e=Array(16),f=0;16>f;f++)d[f]=909522486^c[f],e[f]=1549556828^c[f];var g=core_md5(d.concat(str2binl(b)),512+b.length*chrsz);return core_md5(e.concat(g),640)}function safe_add(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function bit_rol(a,b){return a<<b|a>>>32-b}function str2binl(a){for(var b=Array(),c=(1<<chrsz)-1,d=0;d<a.length*chrsz;d+=chrsz)b[d>>5]|=(a.charCodeAt(d/chrsz)&c)<<d%32;return b}function binl2str(a){for(var b="",c=(1<<chrsz)-1,d=0;d<32*a.length;d+=chrsz)b+=String.fromCharCode(a[d>>5]>>>d%32&c);return b}function binl2hex(a){for(var b=hexcase?"0123456789ABCDEF":"0123456789abcdef",c="",d=0;d<4*a.length;d++)c+=b.charAt(15&a[d>>2]>>8*(d%4)+4)+b.charAt(15&a[d>>2]>>8*(d%4));return c}function binl2b64(a){for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c="",d=0;d<4*a.length;d+=3)for(var e=(255&a[d>>2]>>8*(d%4))<<16|(255&a[d+1>>2]>>8*((d+1)%4))<<8|255&a[d+2>>2]>>8*((d+2)%4),f=0;4>f;f++)c+=8*d+6*f>32*a.length?b64pad:b.charAt(63&e>>6*(3-f));return c}function utf8t2d(a){a=a.replace(/\r\n/g,"\n");var b=new Array,c=String.fromCharCode(237);if(c.charCodeAt(0)<0)for(var d=0;d<a.length;d++){var e=a.charCodeAt(d);e>0?b[b.length]=e:(b[b.length]=192|256+e>>6,b[b.length]=128|63&256+e)}else for(var d=0;d<a.length;d++){var e=a.charCodeAt(d);128>e?b[b.length]=e:e>127&&2048>e?(b[b.length]=192|e>>6,b[b.length]=128|63&e):(b[b.length]=224|e>>12,b[b.length]=128|63&e>>6,b[b.length]=128|63&e)}return b}function utf8d2t(a){for(var b=new Array,c=0;c<a.length;)a[c]<128?(b[b.length]=String.fromCharCode(a[c]),c++):a[c]>191&&a[c]<224?(b[b.length]=String.fromCharCode((31&a[c])<<6|63&a[c+1]),c+=2):(b[b.length]=String.fromCharCode((15&a[c])<<12|(63&a[c+1])<<6|63&a[c+2]),c+=3);return b.join("")}function b64arrays(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b64=new Array,f64=new Array;for(var b=0;b<a.length;b++)b64[b]=a.charAt(b),f64[a.charAt(b)]=b}function b64d2t(a){var b=new Array,c=0,d=a.length;for(1==d%3&&(a[a.length]=0,a[a.length]=0),2==d%3&&(a[a.length]=0);c<a.length;)b[b.length]=b64[a[c]>>2],b[b.length]=b64[(3&a[c])<<4|a[c+1]>>4],b[b.length]=b64[(15&a[c+1])<<2|a[c+2]>>6],b[b.length]=b64[63&a[c+2]],c+=3;1==d%3&&(b[b.length-1]=b[b.length-2]="="),2==d%3&&(b[b.length-1]="=");var e=b.join("");return e}function b64t2d(a){var b=new Array,c=0;for(a=a.replace(/\n|\r/g,""),a=a.replace(/=/g,"");c<a.length;)b[b.length]=f64[a.charAt(c)]<<2|f64[a.charAt(c+1)]>>4,b[b.length]=(15&f64[a.charAt(c+1)])<<4|f64[a.charAt(c+2)]>>2,b[b.length]=(3&f64[a.charAt(c+2)])<<6|f64[a.charAt(c+3)],c+=4;return 2==a.length%4&&(b=b.slice(0,b.length-2)),3==a.length%4&&(b=b.slice(0,b.length-1)),b}function cnonce(a){for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c="",d=0;a>d;d++)c+=b.charAt(Math.round(Math.random((new Date).getTime())*(b.length-1)));return c}function JSJaCJSON(){}function XmlHttp(){}function XmlDocument(){}function STANZA_ERROR(a,b,c){return window==this?new STANZA_ERROR(a,b,c):(this.code=a,this.type=b,this.cond=c,void 0)}function JSJaCConsoleLogger(a){this.level=a||4,this.start=function(){},this.log=function(a,b){if(b=b||0,!(b>this.level)&&"undefined"!=typeof console)try{switch(b){case 0:console.warn(a);break;case 1:console.error(a);break;case 2:console.info(a);break;case 4:console.debug(a);break;default:console.log(a)}}catch(c){try{console.log(a)}catch(c){}}},this.setLevel=function(a){return this.level=a,this},this.getLevel=function(){return this.level}}function JSJaCCookie(a,b,c,d,e){return window==this?new JSJaCCookie(a,b,c,d,e):(this.name=a,this.value=b,this.secs=c,this.domain=d,this.path=e,this.write=function(){var a;if(this.secs){var b=new Date;b.setTime(b.getTime()+1e3*this.secs),a="; expires="+b.toGMTString()}else a="";var c=this.domain?"; domain="+this.domain:"",d=this.path?"; path="+this.path:"; path=/";document.cookie=this.getName()+"="+JSJaCCookie._escape(this.getValue())+a+c+d},this.erase=function(){var a=new JSJaCCookie(this.getName(),"",-1);a.write()},this.getName=function(){return this.name},this.setName=function(a){return this.name=a,this},this.getValue=function(){return this.value},this.setValue=function(a){return this.value=a,this},this.setDomain=function(a){return this.domain=a,this},this.setPath=function(a){return this.path=a,this},void 0)}function JSJaCCookieException(a){this.message=a,this.name="CookieException"}function JSJaCError(a,b,c){var d=XmlDocument.create("error","jsjac");return d.documentElement.setAttribute("code",a),d.documentElement.setAttribute("type",b),c&&d.documentElement.appendChild(d.createElement(c)).setAttribute("xmlns",NS_STANZAS),d.documentElement}function JSJaCJID(a){this._node="",this._domain="",this._resource="","string"==typeof a?(-1!=a.indexOf("@")&&(this.setNode(a.substring(0,a.indexOf("@"))),a=a.substring(a.indexOf("@")+1)),-1!=a.indexOf("/")&&(this.setResource(a.substring(a.indexOf("/")+1)),a=a.substring(0,a.indexOf("/"))),this.setDomain(a)):(this.setNode(a.node),this.setDomain(a.domain),this.setResource(a.resource))}function JSJaCJIDInvalidException(a){this.message=a,this.name="JSJaCJIDInvalidException"}function JSJaCKeys(a,b){var c=Math.random();if(this._k=new Array,this._k[0]=c.toString(),b?this.oDbg=b:(this.oDbg={},this.oDbg.log=function(){}),a)for(var d=1;JSJAC_NKEYS>d;d++)this._k[d]=a(this._k[d-1]),b.log(d+": "+this._k[d],4);this._indexAt=JSJAC_NKEYS-1,this.getKey=function(){return this._k[this._indexAt--]},this.lastKey=function(){return 0==this._indexAt},this.size=function(){return this._k.length},this._getSuspendVars=function(){return"_k,_indexAt".split(",")}}function JSJaCPacket(a){this.name=a,this.doc="undefined"!=typeof JSJACPACKET_USE_XMLNS&&JSJACPACKET_USE_XMLNS?XmlDocument.create(a,NS_CLIENT):XmlDocument.create(a,"")}function JSJaCPresence(){this.base=JSJaCPacket,this.base("presence")}function JSJaCIQ(){this.base=JSJaCPacket,this.base("iq")}function JSJaCMessage(){this.base=JSJaCPacket,this.base("message")}function JSJaCConnection(a){a&&a.httpbase&&(this._httpbase=a.httpbase),this.oDbg=a&&a.oDbg&&a.oDbg.log?a.oDbg:{log:function(){}},a&&a.timerval?this.setPollInterval(a.timerval):this.setPollInterval(JSJAC_TIMERVAL),this._cookie_prefix=a&&a.cookie_prefix?a.cookie_prefix:"",this._connected=!1,this._events=[],this._keys=null,this._ID=0,this._inQ=[],this._pQueue=[],this._regIDs=[],this._req=[],this._status="intialized",this._errcnt=0,this._inactivity=JSJAC_INACTIVITY,this._sendRawCallbacks=[]}function JSJaCHttpBindingConnection(a){this.base=JSJaCConnection,this.base(a),this._hold=JSJACHBC_MAX_HOLD,this._inactivity=0,this._last_requests={},this._last_rid=0,this._min_polling=0,this._pause=0,this._wait=a.wait||JSJACHBC_MAX_WAIT}function JSJaCWebSocketConnection(a){this.base=JSJaCConnection,this.base(a),this._ws=null,this.registerHandler("onerror",JSJaC.bind(this._cleanupWebSocket,this))}function JSJaCFBApplication(a){a&&a.appID&&(this._appID=a.appID),a&&a.apiKey&&(this._apiKey=a.apiKey),a&&a.apiSecret&&(this._apiSecret=a.apiSecret),this._perms="",this._session=void 0}!function(a){var b=function(){"use strict";var a={};return Object.defineProperties(a,{version:{get:function(){return"0.3.0-crocodile-1-devel"}},name:{get:function(){return"JsSIP"}}}),a}();!function(a){var b,c,d=a.name+" | "+"EVENT EMITTER"+" | ";b=function(){},b.prototype={initEvents:function(a){var b=a.length;for(this.events={},this.onceNotFired=[],this.maxListeners=10,this.events.newListener=function(a){console.log(d+"new listener added to event "+a)};b--;)console.log(d+"adding event "+a[b]),this.events[a[b]]=[]},checkEvent:function(a){return this.events[a]?!0:(console.error(d+"no event named "+a),!1)},addListener:function(a,b){this.checkEvent(a)&&(this.events[a].length>=this.maxListeners&&console.warn(d+"max listeners exceeded for event "+a),this.events[a].push(b),this.events.newListener.call(null,a))},on:function(a,b){this.addListener(a,b)},once:function(a,b){this.events[a].unshift(b),this.onceNotFired.push(a)},removeListener:function(a,b){if(this.checkEvent(a))for(var c=this.events[a],d=0,e=c.length;e>d;)c[d]&&c[d].toString()===b.toString()?c.splice(d,1):d++},removeAllListener:function(a){this.checkEvent(a)&&(this.events[a]=[])},setMaxListeners:function(a){Number(a)&&(this.maxListeners=a)},listeners:function(a){return this.events[a]},emit:function(b,c,e){var f,g,h=0;if(this.checkEvent(b)){console.log(d+"emitting event "+b),f=this.events[b],g=f.length;var i=new a.Event(b,c,e);if(i)for(h;g>h;h++)try{f[h].apply(null,[i])}catch(j){console.warn(d+"event handler threw exception:\n",j.stack)}else for(h;g>h;h++)try{f[h].call()}catch(j){console.warn(d+"event handler threw exception:\n",j.stack)}h=this.onceNotFired.indexOf(b),-1!==h&&(this.onceNotFired.splice(h,1),this.events[b].shift())}},newListener:function(a){this.events.newListener=a}},c=function(a,b,c){this.type=a,this.sender=b,this.data=c},a.EventEmitter=b,a.Event=c}(b),b.C={USER_AGENT:b.name+" "+b.version,SIP:"sip",INVALID_TARGET_URI:"sip:invalid@invalid",causes:{CONNECTION_ERROR:"Connection Error",REQUEST_TIMEOUT:"Request Timeout",SIP_FAILURE_CODE:"SIP Failure Code",INVALID_TARGET:"Invalid Target",INVALID_REFER_TO_TARGET:"Invalid Refer-To Target",INTERNAL_ERROR:"Internal Error",BUSY:"Busy",REJECTED:"Rejected",REDIRECTED:"Redirected",UNAVAILABLE:"Unavailable",NOT_FOUND:"Not Found",ADDRESS_INCOMPLETE:"Address Incomplete",INCOMPATIBLE_SDP:"Incompatible SDP",AUTHENTICATION_ERROR:"Authentication Error",DIALOG_ERROR:"Dialog Error",WEBRTC_NOT_SUPPORTED:"WebRTC Not Supported",WEBRTC_ERROR:"WebRTC Error",CANCELED:"Canceled",NO_ANSWER:"No Answer",EXPIRES:"Expires",NO_ACK:"No ACK",USER_DENIED_MEDIA_ACCESS:"User Denied Media Access",BAD_MEDIA_DESCRIPTION:"Bad Media Description",RTP_TIMEOUT:"RTP Timeout",SESSION_TIMER:"Session Timer Expired"},SIP_ERROR_CAUSES:{REDIRECTED:[300,301,302,305,380],BUSY:[486,600],REJECTED:[403,603],NOT_FOUND:[404,604],UNAVAILABLE:[480,410,408,430],ADDRESS_INCOMPLETE:[484],INCOMPATIBLE_SDP:[488,606],AUTHENTICATION_ERROR:[401,407]},ACK:"ACK",BYE:"BYE",CANCEL:"CANCEL",INFO:"INFO",INVITE:"INVITE",MESSAGE:"MESSAGE",NOTIFY:"NOTIFY",OPTIONS:"OPTIONS",REGISTER:"REGISTER",UPDATE:"UPDATE",SUBSCRIBE:"SUBSCRIBE",REFER:"REFER",SIP_EXTENSIONS:{TIMER:"timer",TARGET_DIALOG:"tdialog",GRUU:"gruu"},REASON_PHRASE:{100:"Trying",180:"Ringing",181:"Call Is Being Forwarded",182:"Queued",183:"Session Progress",199:"Early Dialog Terminated",200:"OK",202:"Accepted",204:"No Notification",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",305:"Use Proxy",380:"Alternative Service",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",410:"Gone",412:"Conditional Request Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Unsupported URI Scheme",417:"Unknown Resource-Priority",420:"Bad Extension",421:"Extension Required",422:"Session Interval Too Small",423:"Interval Too Brief",428:"Use Identity Header",429:"Provide Referrer Identity",430:"Flow Failed",433:"Anonymity Disallowed",436:"Bad Identity-Info",437:"Unsupported Certificate",438:"Invalid Identity Header",439:"First Hop Lacks Outbound Support",440:"Max-Breadth Exceeded",469:"Bad Info Package",470:"Consent Needed",478:"Unresolvable Destination",480:"Temporarily Unavailable",481:"Call/Transaction Does Not Exist",482:"Loop Detected",483:"Too Many Hops",484:"Address Incomplete",485:"Ambiguous",486:"Busy Here",487:"Request Terminated",488:"Not Acceptable Here",489:"Bad Event",491:"Request Pending",493:"Undecipherable",494:"Security Agreement Required",500:"Server Internal Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Server Time-out",505:"Version Not Supported",513:"Message Too Large",580:"Precondition Failure",600:"Busy Everywhere",603:"Decline",604:"Does Not Exist Anywhere",606:"Not Acceptable"}},function(b){var c;c={ConfigurationError:function(){var b=function(b,c){this.code=1,this.name="CONFIGURATION_ERROR",this.parameter=b,this.value=c,this.message=this.value?"Invalid value "+a.JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter};return b.prototype=new Error,b}(),InvalidTargetError:function(){var a=function(a){this.code=2,this.name="INVALID_TARGET_ERROR",this.target=a,this.message="Invalid target: "+this.target};return a.prototype=new Error,a}(),InvalidStateError:function(){var a=function(a){this.code=3,this.name="INVALID_STATE_ERROR",this.status=a};return a.prototype=new Error,a}(),RemoteSupportError:function(){var a=function(a){this.code=4,this.name="REMOTE_SUPPORT_ERROR",this.option=a,this.message="Remote UA does not support method/extension: "+a};return a.prototype=new Error,a}()},b.Exceptions=c}(b),function(a){var b,c=500,d=4e3,e=5e3;b={T1:c,T2:d,T4:e,TIMER_B:64*c,TIMER_D:0*c,TIMER_F:64*c,TIMER_H:64*c,TIMER_I:0*c,TIMER_J:0*c,TIMER_K:0*e,TIMER_L:64*c,TIMER_M:64*c},a.Timers=b}(b),function(b){var c,d=b.name+" | "+"TRANSPORT"+" | ",e={STATUS_READY:0,STATUS_DISCONNECTED:1,STATUS_ERROR:2};c=function(a,b){this.ua=a,this.ws=null,this.server=b,this.reconnection_attempts=0,this.closed=!1,this.connected=!1,this.reconnectTimer=null,this.lastTransportError={},this.ua.transport=this,this.connect()},c.prototype={send:function(a){var b=a.toString();return this.ws&&this.ws.readyState===WebSocket.OPEN?(this.ua.configuration.trace_sip===!0&&console.log(d+"sending WebSocket message:\n\n"+b+"\n"),this.ws.send(b),!0):(console.warn(d+"unable to send message, WebSocket is not open"),!1)},disconnect:function(){this.ws&&(this.closed=!0,console.log(d+"closing WebSocket "+this.server.ws_uri),this.ws.close()),null!==this.reconnectTimer&&(a.clearTimeout(this.reconnectTimer),this.reconnectTimer=null,this.ua.emit("disconnected",this.ua,{transport:this,code:this.lastTransportError.code,reason:this.lastTransportError.reason}))},connect:function(){var a=this;if(this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING))return console.log(d+"WebSocket "+this.server.ws_uri+" is already connected"),!1;this.ws&&this.ws.close(),console.log(d+"connecting to WebSocket "+this.server.ws_uri);try{this.ws=new WebSocket(this.server.ws_uri,"sip")}catch(b){console.warn(d+"error connecting to WebSocket "+this.server.ws_uri+": "+b)}this.ws.binaryType="arraybuffer",this.ws.onopen=function(){a.onOpen()},this.ws.onclose=function(b){a.onClose(b)},this.ws.onmessage=function(b){a.onMessage(b)},this.ws.onerror=function(b){a.onError(b)}},onOpen:function(){this.connected=!0,console.log(d+"WebSocket "+this.server.ws_uri+" connected"),null!==this.reconnectTimer&&(a.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.reconnection_attempts=0,this.closed=!1,this.ua.onTransportConnected(this)},onClose:function(a){var b=this.connected;this.connected=!1,this.lastTransportError.code=a.code,this.lastTransportError.reason=a.reason,console.log(d+"WebSocket disconnected (code: "+a.code+(a.reason?"| reason: "+a.reason:"")+")"),a.wasClean===!1&&console.warn(d+"WebSocket abrupt disconnection"),b===!0?(this.ua.onTransportClosed(this),this.closed?this.ua.emit("disconnected",this.ua,{transport:this,code:this.lastTransportError.code,reason:this.lastTransportError.reason}):this.reConnect()):this.ua.onTransportError(this)},onMessage:function(a){var c,e,f=a.data;if("\r\n"===f)return this.ua.configuration.trace_sip===!0&&console.log(d+"received WebSocket message with CRLF Keep Alive response"),void 0;if("string"!=typeof f){try{f=String.fromCharCode.apply(null,new Uint8Array(f))}catch(g){return console.warn(d+"received WebSocket binary message failed to be converted into string, message discarded"),void 0}this.ua.configuration.trace_sip===!0&&console.log(d+"received WebSocket binary message:\n\n"+f+"\n")}else this.ua.configuration.trace_sip===!0&&console.log(d+"received WebSocket text message:\n\n"+f+"\n");if(c=b.Parser.parseMessage(f),!(this.ua.status===b.UA.C.STATUS_USER_CLOSED&&c instanceof b.IncomingRequest)&&c&&b.sanityCheck(c,this.ua,this))if(c instanceof b.IncomingRequest)c.transport=this,this.ua.receiveRequest(c);else if(c instanceof b.IncomingResponse)switch(c.method){case b.C.INVITE:e=this.ua.transactions.ict[c.via_branch],e&&e.receiveResponse(c);break;case b.C.ACK:break;default:e=this.ua.transactions.nict[c.via_branch],e&&e.receiveResponse(c)}},onError:function(a){console.warn(d+"WebSocket connection error: "+a)},reConnect:function(){var b=this;this.reconnection_attempts+=1,this.reconnection_attempts>this.ua.configuration.ws_server_max_reconnection?(console.warn(d+"maximum reconnection attempts for WebSocket "+this.server.ws_uri),this.ua.onTransportError(this)):(console.log(d+"trying to reconnect to WebSocket "+this.server.ws_uri+" (reconnection attempt "+this.reconnection_attempts+")"),this.reconnectTimer=a.setTimeout(function(){b.connect(),b.reconnectTimer=null},1e3*this.ua.configuration.ws_server_reconnection_timeout))}},c.C=e,b.Transport=c}(b),function(a){function b(a,b){var c=b,d=0,e=0;if(a.substring(c,c+2).match(/(^\r\n)/))return-2;for(;0===d;){if(e=a.indexOf("\r\n",c),-1===e)return e;!a.substring(e+2,e+4).match(/(^\r\n)/)&&a.charAt(e+2).match(/(^\s+)/)?c=e+2:d=e}return d}function c(b,c,d,e){var f,g,h,i=c.indexOf(":",d),j=c.substring(d,i).trim(),k=c.substring(i+1,e).trim();switch(j.toLowerCase()){case"via":case"v":b.addHeader("via",k),1===b.countHeader("via")?(h=b.parseHeader("Via"),h&&(b.via=h,b.via_branch=h.branch)):h=0;break;case"from":case"f":b.setHeader("from",k),h=b.parseHeader("from"),h&&(b.from=h,b.from_tag=h.getParam("tag"));break;case"to":case"t":b.setHeader("to",k),h=b.parseHeader("to"),h&&(b.to=h,b.to_tag=h.getParam("tag"));break;case"record-route":h=a.Grammar.parse(k,"Record_Route"),-1===h&&(h=void 0);for(g in h)f=h[g],b.addHeader("record-route",k.substring(f.possition,f.offset)),b.headers["Record-Route"][b.countHeader("record-route")-1].parsed=f.parsed;break;case"call-id":case"i":b.setHeader("call-id",k),h=b.parseHeader("call-id"),h&&(b.call_id=k);break;case"contact":case"m":h=a.Grammar.parse(k,"Contact"),-1===h&&(h=void 0);for(g in h)f=h[g],b.addHeader("contact",k.substring(f.possition,f.offset)),b.headers.Contact[b.countHeader("contact")-1].parsed=f.parsed;break;case"content-length":case"l":b.setHeader("content-length",k),h=b.parseHeader("content-length");break;case"content-type":case"c":b.setHeader("content-type",k),h=b.parseHeader("content-type");break;case"cseq":b.setHeader("cseq",k),h=b.parseHeader("cseq"),h&&(b.cseq=h.value),b instanceof a.IncomingResponse&&(b.method=h.method);break;case"max-forwards":b.setHeader("max-forwards",k),h=b.parseHeader("max-forwards");break;case"www-authenticate":b.setHeader("www-authenticate",k),h=b.parseHeader("www-authenticate");break;case"proxy-authenticate":b.setHeader("proxy-authenticate",k),h=b.parseHeader("proxy-authenticate");break;case"session-expires":case"x":b.setHeader("session-expires",k),h=b.parseHeader("session-expires");break;case"min-se":b.setHeader("min-se",k),h=b.parseHeader("min-se");break;case"supported":case"k":b.setHeader("supported",k),h=b.parseHeader("supported");break;case"require":b.setHeader("require",k),h=b.parseHeader("require");break;case"allow":b.setHeader("allow",k),h=b.parseHeader("allow");break;case"refer-to":case"r":b.setHeader("refer-to",k),h=b.parseHeader("refer-to");break;case"target-dialog":b.setHeader("target-dialog",k),h=b.parseHeader("target-dialog");break;case"event":case"o":b.setHeader("event",k),h=b.parseHeader("event");break;case"subscription-state":b.setHeader("subscription-state",k),h=b.parseHeader("subscription-state");break;default:b.setHeader(j,k),h=0}return void 0===h?!1:!0}var d,e=a.name+" | "+"PARSER"+" | ";d={},d.parseMessage=function(d,f){var g,h,i,j,k,l=0,m=d.indexOf("\r\n");if(-1===m)return console.warn(e+"no CRLF found, not a SIP message, discarded"),void 0;if(h=d.substring(0,m),k=a.Grammar.parse(h,"Request_Response"),-1===k)return console.warn(e+'error parsing first line of SIP message: "'+h+'"'),void 0;for(k.status_code?(g=new a.IncomingResponse,g.status_code=k.status_code,g.reason_phrase=k.reason_phrase):(g=new a.IncomingRequest,g.method=k.method,g.ruri=k.uri),g.data=d,l=m+2;l<d.length;){if(m=b(d,l),-2===m){j=l+2;break}if(-1===m){if(f)break;return console.warn(e+"error parsing message: no empty line terminating headers"),void 0}if(k=c(g,d,l,m),!k)return console.warn(e+'error parsing header: "'+d.substring(l,m)+'"'),void 0;l=m+2}return j&&(g.hasHeader("content-length")?(i=g.getHeader("content-length"),g.body=d.substr(j,i)):g.body=d.substring(j)),g},a.Parser=d}(b),function(a){var b,c,d,e,f=a.name+" | "+"SIP MESSAGE"+" | ";b=function(b,c,d,e,f,g){var h,i,j,k,l;return e=e||{},b&&c&&d?(this.headers={},this.method=b,this.ruri=c,this.body=g,this.extraHeaders=f||[],e.route_set?this.setHeader("route",e.route_set):d.configuration.use_preloaded_route&&this.setHeader("route",d.transport.server.sip_uri),this.setHeader("via",""),this.setHeader("max-forwards",a.UA.C.MAX_FORWARDS),h=e.to_display_name||0===e.to_display_name?'"'+e.to_display_name+'" ':"",h+="<"+(e.to_uri||c)+">",h+=e.to_tag?";tag="+e.to_tag:"",this.to=new a.NameAddrHeader.parse(h),this.setHeader("to",h),i=e.from_display_name||0===e.from_display_name?'"'+e.from_display_name+'" ':d.configuration.display_name?'"'+d.configuration.display_name+'" ':"",i+="<"+(e.from_uri||d.configuration.uri)+">;tag=",i+=e.from_tag||a.Utils.newTag(),this.from=new a.NameAddrHeader.parse(i),this.setHeader("from",i),j=e.call_id||d.configuration.jssip_id+a.Utils.createRandomToken(15),this.call_id=j,this.setHeader("call-id",j),k=e.cseq||Math.floor(1e4*Math.random()),this.cseq=k,this.setHeader("cseq",k+" "+b),b!==a.C.CANCEL&&b!==a.C.ACK&&this.setHeader("allow",a.Utils.getAllowedMethods(d)),b!==a.C.ACK&&(l=a.Utils.getSupportedExtensions(d,e.extra_supported),this.setHeader("supported",l.join(","))),void 0):null},b.prototype={setHeader:function(b,c){this.headers[a.Utils.headerize(b)]=c instanceof Array?c:[c]},toString:function(){var b,c,d,e="";e+=this.method+" "+this.ruri+" SIP/2.0\r\n";for(b in this.headers)for(d in this.headers[b])e+=b+": "+this.headers[b][d]+"\r\n";for(c=this.extraHeaders.length,d=0;c>d;d++)e+=this.extraHeaders[d]+"\r\n";return e+="User-Agent: "+a.C.USER_AGENT+"\r\n",this.body?(c=a.Utils.str_utf8_length(this.body),e+="Content-Length: "+c+"\r\n\r\n",e+=this.body):e+="Content-Length: 0\r\n\r\n",e}},c=function(){this.data=null,this.headers=null,this.method=null,this.via=null,this.via_branch=null,this.call_id=null,this.cseq=null,this.from=null,this.from_tag=null,this.to=null,this.to_tag=null,this.body=null},c.prototype={addHeader:function(b,c){var d={raw:c};b=a.Utils.headerize(b),this.headers[b]?this.headers[b].push(d):this.headers[b]=[d]},countHeader:function(b){var c=this.headers[a.Utils.headerize(b)];return c?c.length:0},getHeader:function(b,c){var d=this.headers[a.Utils.headerize(b)];return c=c||0,d?d[c]?d[c].raw:void 0:void 0},getHeaderAll:function(b){var c,d=this.headers[a.Utils.headerize(b)],e=[];if(!d)return[];for(c in d)e.push(d[c].raw);return e},hasHeader:function(b){return this.headers[a.Utils.headerize(b)]?!0:!1},parseHeader:function(b,c){var d,e,g;return b=a.Utils.headerize(b),c=c||0,this.headers[b]?c>=this.headers[b].length?(console.log(f+'not so many "'+b+'" headers present'),void 0):(d=this.headers[b][c],e=d.raw,d.parsed?d.parsed:(g=a.Grammar.parse(e,b.replace(/-/g,"_")),-1===g?(this.headers[b].splice(c,1),console.warn(f+'error parsing "'+b+'" header field with value "'+e+'"'),void 0):(d.parsed=g,g))):(console.log(f+'header "'+b+'" not present'),void 0)},s:function(a,b){return this.parseHeader(a,b)},setHeader:function(b,c){var d={raw:c};this.headers[a.Utils.headerize(b)]=[d]},toString:function(){return this.data}},d=function(){this.headers={},this.ruri=null,this.transport=null,this.server_transaction=null},d.prototype=new c,d.prototype.reply=function(b,c,d,e,f,g){var h,i,j,k,l,m=this.getHeader("To"),n=0,o=0;if(b=b||null,c=c||null,!b||100>b||b>699)throw new TypeError("Invalid status_code: "+b);if(c&&"string"!=typeof c&&!(c instanceof String))throw new TypeError("Invalid reason_phrase: "+c);switch(c=c||a.C.REASON_PHRASE[b]||"",d=d||[],l="SIP/2.0 "+b+" "+c+"\r\n",this.method){case a.C.INVITE:case a.C.REFER:case a.C.SUBSCRIBE:case a.C.NOTIFY:if(b>100&&200>=b)for(h=this.countHeader("record-route"),n;h>n;n++)l+="Record-Route: "+this.getHeader("record-route",n)+"\r\n"}for(i=this.countHeader("via"),o;i>o;o++)l+="Via: "+this.getHeader("via",o)+"\r\n";for(this.to_tag&&!this.s("to").hasParam("tag")&&(m+=";tag="+this.to_tag),l+="To: "+m+"\r\n",l+="From: "+this.getHeader("From")+"\r\n",l+="Call-ID: "+this.call_id+"\r\n",l+="CSeq: "+this.cseq+" "+this.method+"\r\n",j=d.length,k=0;j>k;k++)l+=d[k]+"\r\n";l+="User-Agent: "+a.C.USER_AGENT+"\r\n",e?(j=a.Utils.str_utf8_length(e),l+="Content-Type: application/sdp\r\n",l+="Content-Length: "+j+"\r\n\r\n",l+=e):l+="Content-Length: 0\r\n\r\n",this.server_transaction.receiveResponse(b,l,f,g)},d.prototype.reply_sl=function(b,c){var d,e,f=this.countHeader("via");if(b=b||null,c=c||null,!b||100>b||b>699)throw new TypeError("Invalid status_code: "+b);if(c&&"string"!=typeof c&&!(c instanceof String))throw new TypeError("Invalid reason_phrase: "+c);c=c||a.C.REASON_PHRASE[b]||"",e="SIP/2.0 "+b+" "+c+"\r\n";for(var g=0;f>g;g++)e+="Via: "+this.getHeader("via",g)+"\r\n";d=this.getHeader("To"),this.to_tag&&!this.s("to").hasParam("tag")&&(d+=";tag="+this.to_tag),e+="To: "+d+"\r\n",e+="From: "+this.getHeader("From")+"\r\n",e+="Call-ID: "+this.call_id+"\r\n",e+="CSeq: "+this.cseq+" "+this.method+"\r\n",e+="User-Agent: "+a.C.USER_AGENT+"\r\n",e+="Content-Length: 0\r\n\r\n",this.transport.send(e)},e=function(){this.headers={},this.status_code=null,this.reason_phrase=null},e.prototype=new c,a.OutgoingRequest=b,a.IncomingRequest=d,a.IncomingResponse=e}(b),function(b){var c;c=function(a,c,d,e,f,g){var h,i;if(!d)throw new TypeError('missing or invalid "host" parameter');a=a||b.C.SIP,this.parameters={},this.headers={};
for(h in f)this.setParam(h,f[h]);for(i in g)this.setHeader(i,g[i]);Object.defineProperties(this,{scheme:{get:function(){return a},set:function(b){a=b.toLowerCase()}},user:{get:function(){return c},set:function(a){c=a}},host:{get:function(){return d},set:function(a){d=a.toLowerCase()}},port:{get:function(){return e},set:function(a){e=0===a?a:parseInt(a,10)||null}}})},c.prototype={setParam:function(a,b){a&&(this.parameters[a.toLowerCase()]="undefined"==typeof b||null===b?null:b.toString().toLowerCase())},getParam:function(a){return a?this.parameters[a.toLowerCase()]:void 0},hasParam:function(a){return a?this.parameters.hasOwnProperty(a.toLowerCase())&&!0||!1:void 0},deleteParam:function(a){var b;return a=a.toLowerCase(),this.parameters.hasOwnProperty(a)?(b=this.parameters[a],delete this.parameters[a],b):void 0},clearParams:function(){this.parameters={}},setHeader:function(a,c){this.headers[b.Utils.headerize(a)]=c instanceof Array?c:[c]},getHeader:function(a){return a?this.headers[b.Utils.headerize(a)]:void 0},hasHeader:function(a){return a?this.headers.hasOwnProperty(b.Utils.headerize(a))&&!0||!1:void 0},deleteHeader:function(a){var c;return a=b.Utils.headerize(a),this.headers.hasOwnProperty(a)?(c=this.headers[a],delete this.headers[a],c):void 0},clearHeaders:function(){this.headers={}},clone:function(){return new c(this.scheme,this.user,this.host,this.port,a.JSON.parse(a.JSON.stringify(this.parameters)),a.JSON.parse(a.JSON.stringify(this.headers)))},toString:function(){var a,c,d,e,f=[];e=this.scheme+":",this.user&&(e+=b.Utils.escapeUser(this.user)+"@"),e+=this.host,(this.port||0===this.port)&&(e+=":"+this.port);for(c in this.parameters)e+=";"+c,null!==this.parameters[c]&&(e+="="+this.parameters[c]);for(a in this.headers)for(d in this.headers[a])f.push(a+"="+this.headers[a][d]);return f.length>0&&(e+="?"+f.join("&")),e},toAor:function(a){var c;return c=this.scheme+":",this.user&&(c+=b.Utils.escapeUser(this.user)+"@"),c+=this.host,a&&(this.port||0===this.port)&&(c+=":"+this.port),c}},c.parse=function(a){return a=b.Grammar.parse(a,"SIP_URI"),-1!==a?a:void 0},b.URI=c}(b),function(b){var c;c=function(a,c,d){var e;if(!(a&&a instanceof b.URI))throw new TypeError('missing or invalid "uri" parameter');this.uri=a,this.parameters={};for(e in d)this.setParam(e,d[e]);Object.defineProperties(this,{display_name:{get:function(){return c},set:function(a){c=0===a?"0":a}}})},c.prototype={setParam:function(a,b){a&&(this.parameters[a.toLowerCase()]="undefined"==typeof b||null===b?null:b.toString())},getParam:function(a){return a?this.parameters[a.toLowerCase()]:void 0},hasParam:function(a){return a?this.parameters.hasOwnProperty(a.toLowerCase())&&!0||!1:void 0},deleteParam:function(a){var b;return a=a.toLowerCase(),this.parameters.hasOwnProperty(a)?(b=this.parameters[a],delete this.parameters[a],b):void 0},clearParams:function(){this.parameters={}},clone:function(){return new c(this.uri.clone(),this.display_name,a.JSON.parse(a.JSON.stringify(this.parameters)))},toString:function(){var a,b;a=this.display_name||0===this.display_name?'"'+this.display_name+'" ':"",a+="<"+this.uri.toString()+">";for(b in this.parameters)a+=";"+b,null!==this.parameters[b]&&(a+="="+this.parameters[b]);return a}},c.parse=function(a){return a=b.Grammar.parse(a,"Name_Addr_Header"),-1!==a?a:void 0},b.NameAddrHeader=c}(b),function(b){var c,d=b.name+" | "+"TRANSACTION"+" | ",e={STATUS_TRYING:1,STATUS_PROCEEDING:2,STATUS_CALLING:3,STATUS_ACCEPTED:4,STATUS_COMPLETED:5,STATUS_TERMINATED:6,STATUS_CONFIRMED:7};c={};var f=function(){this.init=function(a,b,c){var d;this.transport=c,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=a,this.request=b,d="SIP/2.0/"+(a.ua.configuration.hack_via_tcp?"TCP":c.server.scheme),d+=" "+a.ua.configuration.via_host+";branch="+this.id,this.request.setHeader("via",d)}},g=function(){this.send=function(){var c=this;this.state=e.STATUS_TRYING,this.F=a.setTimeout(function(){c.timer_F()},b.Timers.TIMER_F),this.transport.send(this.request)||this.onTransportError()},this.onTransportError=function(){switch(console.log(d+"transport error occurred, deleting non-INVITE client transaction "+this.id),a.clearTimeout(this.F),a.clearTimeout(this.K),delete this.request_sender.ua.transactions.nict[this.id],this.state){case e.STATUS_COMPLETED:case e.STATUS_TERMINATED:return}this.request_sender.onTransportError()},this.timer_F=function(){console.log(d+"Timer F expired for non-INVITE client transaction "+this.id),this.state=e.STATUS_TERMINATED,this.request_sender.onRequestTimeout(),delete this.request_sender.ua.transactions.nict[this.id]},this.timer_K=function(){this.state=e.STATUS_TERMINATED,delete this.request_sender.ua.transactions.nict[this.id]},this.receiveResponse=function(c){var d=this,f=c.status_code;if(200>f)switch(this.state){case e.STATUS_TRYING:case e.STATUS_PROCEEDING:this.state=e.STATUS_PROCEEDING,this.request_sender.receiveResponse(c)}else switch(this.state){case e.STATUS_TRYING:case e.STATUS_PROCEEDING:this.state=e.STATUS_COMPLETED,a.clearTimeout(this.F),408===f?this.request_sender.onRequestTimeout():this.request_sender.receiveResponse(c),this.K=a.setTimeout(function(){d.timer_K()},b.Timers.TIMER_K);break;case e.STATUS_COMPLETED:}}};g.prototype=new f;var h=function(){this.send=function(){var c=this;this.state=e.STATUS_CALLING,this.B=a.setTimeout(function(){c.timer_B()},b.Timers.TIMER_B),this.transport.send(this.request)||this.onTransportError()},this.onTransportError=function(){switch(console.log(d+"transport error occurred, deleting INVITE client transaction "+this.id),a.clearTimeout(this.B),a.clearTimeout(this.D),a.clearTimeout(this.M),delete this.request_sender.ua.transactions.ict[this.id],this.state){case e.STATUS_ACCEPTED:case e.STATUS_COMPLETED:case e.STATUS_TERMINATED:return}this.request_sender.onTransportError()},this.timer_M=function(){console.log(d+"Timer M expired for INVITE client transaction "+this.id),this.state===e.STATUS_ACCEPTED&&(this.state=e.STATUS_TERMINATED,a.clearTimeout(this.B),delete this.request_sender.ua.transactions.ict[this.id])},this.timer_B=function(){console.log(d+"Timer B expired for INVITE client transaction "+this.id),this.state===e.STATUS_CALLING&&(this.state=e.STATUS_TERMINATED,this.request_sender.onRequestTimeout(),delete this.request_sender.ua.transactions.ict[this.id])},this.timer_D=function(){console.log(d+"Timer D expired for INVITE client transaction "+this.id),this.state=e.STATUS_TERMINATED,a.clearTimeout(this.B),delete this.request_sender.ua.transactions.ict[this.id]},this.sendACK=function(c){var d=this;this.ack="ACK "+this.request.ruri+" SIP/2.0\r\n",this.ack+="Via: "+this.request.headers.Via.toString()+"\r\n",this.request.headers.Route&&(this.ack+="Route: "+this.request.headers.Route.toString()+"\r\n"),this.ack+="To: "+c.getHeader("to")+"\r\n",this.ack+="From: "+this.request.headers.From.toString()+"\r\n",this.ack+="Call-ID: "+this.request.headers["Call-ID"].toString()+"\r\n",this.ack+="CSeq: "+this.request.headers.CSeq.toString().split(" ")[0],this.ack+=" ACK\r\n\r\n",this.D=a.setTimeout(function(){d.timer_D()},b.Timers.TIMER_D),this.transport.send(this.ack)},this.cancel_request=function(a,c){var d=a.request;this.cancel=b.C.CANCEL+" "+d.ruri+" SIP/2.0\r\n",this.cancel+="Via: "+d.headers.Via.toString()+"\r\n",this.request.headers.Route&&(this.cancel+="Route: "+d.headers.Route.toString()+"\r\n"),this.cancel+="To: "+d.headers.To.toString()+"\r\n",this.cancel+="From: "+d.headers.From.toString()+"\r\n",this.cancel+="Call-ID: "+d.headers["Call-ID"].toString()+"\r\n",this.cancel+="CSeq: "+d.headers.CSeq.toString().split(" ")[0]+" CANCEL\r\n",c&&(this.cancel+="Reason: "+c+"\r\n"),this.cancel+="Content-Length: 0\r\n\r\n",this.state===e.STATUS_PROCEEDING&&this.transport.send(this.cancel)},this.receiveResponse=function(c){var d=this,f=c.status_code;if(f>=100&&199>=f)switch(this.state){case e.STATUS_CALLING:this.state=e.STATUS_PROCEEDING,this.request_sender.receiveResponse(c),this.cancel&&this.transport.send(this.cancel);break;case e.STATUS_PROCEEDING:this.request_sender.receiveResponse(c)}else if(f>=200&&299>=f)switch(this.state){case e.STATUS_CALLING:case e.STATUS_PROCEEDING:this.state=e.STATUS_ACCEPTED,this.M=a.setTimeout(function(){d.timer_M()},b.Timers.TIMER_M),this.request_sender.receiveResponse(c);break;case e.STATUS_ACCEPTED:this.request_sender.receiveResponse(c)}else if(f>=300&&699>=f)switch(this.state){case e.STATUS_CALLING:case e.STATUS_PROCEEDING:this.state=e.STATUS_COMPLETED,this.sendACK(c),this.request_sender.receiveResponse(c);break;case e.STATUS_COMPLETED:this.sendACK(c)}}};h.prototype=new f;var i=function(){this.init=function(a,b){this.id=a.via_branch,this.request=a,this.transport=a.transport,this.ua=b,this.last_response="",a.server_transaction=this}},j=function(){this.timer_J=function(){console.log(d+"Timer J expired for non-INVITE server transaction "+this.id),this.state=e.STATUS_TERMINATED,delete this.ua.transactions.nist[this.id]},this.onTransportError=function(){this.transportError||(this.transportError=!0,console.log(d+"transport error occurred, deleting non-INVITE server transaction "+this.id),a.clearTimeout(this.J),delete this.ua.transactions.nist[this.id])},this.receiveResponse=function(c,d,f,g){var h=this;if(100===c)switch(this.state){case e.STATUS_TRYING:this.state=e.STATUS_PROCEEDING,this.transport.send(d)||this.onTransportError();break;case e.STATUS_PROCEEDING:this.last_response=d,this.transport.send(d)?f&&f():(this.onTransportError(),g&&g())}else if(c>=200&&699>=c)switch(this.state){case e.STATUS_TRYING:case e.STATUS_PROCEEDING:this.state=e.STATUS_COMPLETED,this.last_response=d,this.J=a.setTimeout(function(){h.timer_J()},b.Timers.TIMER_J),this.transport.send(d)?f&&f():(this.onTransportError(),g&&g());break;case e.STATUS_COMPLETED:}}};j.prototype=new i;var k=function(){this.timer_H=function(){console.log(d+"Timer H expired for INVITE server transaction "+this.id),this.state===e.STATUS_COMPLETED&&(console.warn(d+"transactions","ACK for INVITE server transaction was never received, call will be terminated"),this.state=e.STATUS_TERMINATED),delete this.ua.transactions.ist[this.id]},this.timer_I=function(){this.state=e.STATUS_TERMINATED,delete this.ua.transactions.ist[this.id]},this.timer_L=function(){console.log(d+"Timer L expired for INVITE server transaction "+this.id),this.state===e.STATUS_ACCEPTED&&(this.state=e.STATUS_TERMINATED,delete this.ua.transactions.ist[this.id])},this.onTransportError=function(){this.transportError||(this.transportError=!0,console.log(d+"transport error occurred, deleting INVITE server transaction "+this.id),a.clearInterval(this.resendProvisionalTimer),a.clearTimeout(this.L),a.clearTimeout(this.H),a.clearTimeout(this.I),delete this.ua.transactions.ist[this.id])},this.resend_provisional=function(){this.transport.send(this.last_response)||this.onTransportError()},this.receiveResponse=function(c,d,f,g){var h=this;if(c>=100&&199>=c)switch(this.state){case e.STATUS_PROCEEDING:this.transport.send(d)||this.onTransportError(),this.last_response=d}if(c>100&&199>=c)this.resendProvisionalTimer||(this.resendProvisionalTimer=a.setInterval(function(){h.resend_provisional()},60*b.Timers.T1));else if(c>=200&&299>=c)switch(this.state){case e.STATUS_PROCEEDING:this.state=e.STATUS_ACCEPTED,this.last_response=d,this.L=a.setTimeout(function(){h.timer_L()},b.Timers.TIMER_L),a.clearInterval(this.resendProvisionalTimer);case e.STATUS_ACCEPTED:this.transport.send(d)?f&&f():(this.onTransportError(),g&&g())}else if(c>=300&&699>=c)switch(this.state){case e.STATUS_PROCEEDING:a.clearInterval(this.resendProvisionalTimer),this.transport.send(d)?(this.state=e.STATUS_COMPLETED,this.H=a.setTimeout(function(){h.timer_H()},b.Timers.TIMER_H),f&&f()):(this.onTransportError(),g&&g())}}};k.prototype=new i,c.NonInviteClientTransaction=function(a,b,c){this.init(a,b,c),this.request_sender.ua.transactions.nict[this.id]=this},c.NonInviteClientTransaction.prototype=new g,c.InviteClientTransaction=function(a,b,c){var d=this;this.init(a,b,c),this.request_sender.ua.transactions.ict[this.id]=this,this.request.cancel=function(a){d.cancel_request(d,a)}},c.InviteClientTransaction.prototype=new h,c.AckClientTransaction=function(a,b,c){this.init(a,b,c),this.send=function(){this.transport.send(b)}},c.AckClientTransaction.prototype=new g,c.NonInviteServerTransaction=function(a,b){this.init(a,b),this.state=e.STATUS_TRYING,b.transactions.nist[this.id]=this},c.NonInviteServerTransaction.prototype=new j,c.InviteServerTransaction=function(a,b){this.init(a,b),this.state=e.STATUS_PROCEEDING,b.transactions.ist[this.id]=this,this.resendProvisionalTimer=null,a.reply(100)},c.InviteServerTransaction.prototype=new k,c.checkTransaction=function(c,d){var f;switch(d.method){case b.C.INVITE:if(f=c.transactions.ist[d.via_branch]){switch(f.state){case e.STATUS_PROCEEDING:f.transport.send(f.last_response);break;case e.STATUS_ACCEPTED:}return!0}break;case b.C.ACK:if(f=c.transactions.ist[d.via_branch],!f)return!1;if(f.state===e.STATUS_ACCEPTED)return!1;if(f.state===e.STATUS_COMPLETED)return f.state=e.STATUS_CONFIRMED,f.I=a.setTimeout(function(){f.timer_I()},b.Timers.TIMER_I),!0;break;case b.C.CANCEL:return f=c.transactions.ist[d.via_branch],f?f.state===e.STATUS_PROCEEDING?!1:(d.reply_sl(481),!0):(d.reply_sl(481),!0);default:if(f=c.transactions.nist[d.via_branch]){switch(f.state){case e.STATUS_TRYING:break;case e.STATUS_PROCEEDING:case e.STATUS_COMPLETED:f.transport.send(f.last_response)}return!0}}},c.C=e,b.Transactions=c}(b),function(b){var c,d,e=b.name+" | "+"DIALOG"+" | ",f={STATUS_EARLY:1,STATUS_CONFIRMED:2,DEFAULT_MIN_SE:90};c=function(a,b,c){this.call_id=a,this.local_tag=b,this.remote_tag=c},c.prototype.toString=function(){return this.call_id+this.local_tag+this.remote_tag},c.prototype.toTargetDialogHeader=function(){return this.call_id+";remote-tag="+this.local_tag+";local-tag="+this.remote_tag},d=function(a,d,g,h){var i;return d.hasHeader("contact")?(d instanceof b.IncomingResponse?h=d.status_code<200?f.STATUS_EARLY:f.STATUS_CONFIRMED:(h=h||f.STATUS_CONFIRMED,d.method===b.C.INVITE&&(this.last_invite_tx=d.server_transaction)),i=d.parseHeader("contact"),"UAS"===g?(this.id=new c(d.call_id,d.to_tag,d.from_tag),this.state=h,this.remote_seqnum=d.cseq,this.local_uri=d.parseHeader("to").uri,this.remote_uri=d.parseHeader("from").uri,this.remote_target=i.uri,this.route_set=d.getHeaderAll("record-route")):"UAC"===g&&(this.id=new c(d.call_id,d.from_tag,d.to_tag),this.state=h,this.local_seqnum=d.cseq,this.local_uri=d.parseHeader("from").uri,this.remote_uri=d.parseHeader("to").uri,this.remote_target=i.uri,this.route_set=d.getHeaderAll("record-route").reverse()),this.session_timer={localRefresher:!0,interval:null,min_interval:f.DEFAULT_MIN_SE,timer_id:null},this.owner=a,a.ua.dialogs[this.id.toString()]=this,console.log(e+"new "+g+" dialog created with status "+(this.state===f.STATUS_EARLY?"EARLY":"CONFIRMED")),void 0):(console.error(e+"unable to create a Dialog without Contact header field"),!1)},d.prototype={update:function(a,b){this.state=f.STATUS_CONFIRMED,console.log(e+"dialog "+this.id.toString()+"  changed to CONFIRMED state"),"UAC"===b&&(this.route_set=a.getHeaderAll("record-route").reverse())},isConfirmed:function(){return this.state===f.STATUS_CONFIRMED},terminate:function(){console.log(e+"dialog "+this.id.toString()+" deleted"),this.clearSessionRefreshTimer(),delete this.owner.ua.dialogs[this.id.toString()]},createRequest:function(a,c){var d,e,g=null;if(c=c||[],this.local_seqnum||(this.local_seqnum=Math.floor(1e4*Math.random())),d=a===b.C.CANCEL||a===b.C.ACK?this.local_seqnum:this.local_seqnum+=1,a===b.C.INVITE||a===b.C.UPDATE){var h=this.session_timer.min_interval,i=this.session_timer.interval;if(h>f.DEFAULT_MIN_SE&&c.push("Min-SE: "+h),null!==i){var j=h>i?h:i,k=this.session_timer.localRefresher?"uac":"uas";c.push("Session-Expires: "+j+";refresher="+k)}}return this.owner instanceof b.RTCSession&&(g=b.Utils.getSessionExtensions(this.owner,a)),e=new b.OutgoingRequest(a,this.remote_target,this.owner.ua,{cseq:d,call_id:this.id.call_id,from_uri:this.local_uri,from_tag:this.id.local_tag,to_uri:this.remote_uri,to_tag:this.id.remote_tag,route_set:this.route_set,extra_supported:g},c),e.dialog=this,e},checkInDialogRequest:function(a){var c;if(this.remote_seqnum){if(a.cseq<this.remote_seqnum)return a.method!==b.C.ACK&&a.reply(500),!1;a.cseq>this.remote_seqnum&&(this.remote_seqnum=a.cseq)}else this.remote_seqnum=a.cseq;switch(a.method){case b.C.INVITE:if(this.last_invite_tx&&this.last_invite_tx.state===b.Transactions.C.STATUS_PROCEEDING)return c=(0|10*Math.random())+1,a.reply(500,null,["Retry-After:"+c]),!1;this.last_invite_tx=a.server_transaction;break;case b.C.UPDATE:if(this.last_update_tx)switch(this.last_update_tx.state){case b.Transactions.C.STATUS_TRYING:case b.Transactions.C.STATUS_PROCEEDING:return c=(0|10*Math.random())+1,a.reply(500,null,["Retry-After:"+c]),!1}this.last_update_tx=a.server_transaction}return!0},receiveRequest:function(a){if(this.checkInDialogRequest(a)&&this.owner.receiveRequest(a))switch(a.method){case b.C.INVITE:case b.C.UPDATE:case b.C.NOTIFY:a.hasHeader("contact")&&(this.remote_target=a.parseHeader("contact").uri)}},updateMinSessionExpires:function(a){a>this.session_timer.min_interval&&(this.session_timer.min_interval=a)},setSessionRefreshTimer:function(){var c,d,e=this.session_timer.localRefresher,f=this.session_timer.interval,g=this;e?(c=f/2,d=function(){g.session_timer.timer_id=null,g.owner.emit("refresh",g.owner,{})}):(c=f-Math.max(f/3,32),d=function(){g.session_timer.timer_id=null,g.owner.sendBye({status_code:408,reason_phrase:b.C.causes.SESSION_TIMER}),g.owner.ended("system",null,b.C.causes.SESSION_TIMER)}),this.session_timer.timer_id=a.setTimeout(d,1e3*c)},clearSessionRefreshTimer:function(){null!==this.session_timer.timer_id&&(a.clearTimeout(this.session_timer.timer_id),this.session_timer.timer_id=null)},disableSessionRefresh:function(){this.session_timer.interval=null,this.clearSessionRefreshTimer()},processSessionTimerHeaders:function(a){if(a.hasHeader("min-se")&&this.updateMinSessionExpires(a.parseHeader("min-se")),!a.hasHeader("session-expires"))return this.disableSessionRefresh(),void 0;this.clearSessionRefreshTimer();var c=a.parseHeader("session-expires"),d=!0;if(a instanceof b.IncomingRequest)c.params&&c.params.refresher&&(d="uas"===c.params.refresher);else{if(!(a instanceof b.IncomingResponse))throw new TypeError("Unexpected message type");d="uac"===c.params.refresher}this.session_timer.interval=c.interval,this.session_timer.localRefresher=d,this.setSessionRefreshTimer()},addSessionTimerResponseHeaders:function(a){var b=this.session_timer.interval;if(b){var c=this.session_timer.localRefresher?"uas":"uac";a.push("Session-Expires: "+b+";refresher="+c)}}},d.C=f,b.DialogId=c,b.Dialog=d}(b),function(a){var b,c=a.name+" | "+"REQUEST SENDER"+" | ";b=function(b,c){this.ua=c,this.applicant=b,this.method=b.request.method,this.request=b.request,this.credentials=null,this.challenged=!1,this.staled=!1,c.status!==a.UA.C.STATUS_USER_CLOSED||this.method===a.C.BYE&&this.method===a.C.ACK||this.onTransportError()},b.prototype={send:function(){switch(this.method){case"INVITE":this.clientTransaction=new a.Transactions.InviteClientTransaction(this,this.request,this.ua.transport);break;case"ACK":this.clientTransaction=new a.Transactions.AckClientTransaction(this,this.request,this.ua.transport);break;default:this.clientTransaction=new a.Transactions.NonInviteClientTransaction(this,this.request,this.ua.transport)}this.clientTransaction.send()},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(b){var d,e,f,g=b.status_code;if(401!==g&&407!==g||null===this.ua.configuration.password)this.applicant.receiveResponse(b);else{if(401===b.status_code?(e=b.parseHeader("www-authenticate"),f="authorization"):(e=b.parseHeader("proxy-authenticate"),f="proxy-authorization"),!e)return console.warn(c+b.status_code+" with wrong or missing challenge, cannot authenticate"),this.applicant.receiveResponse(b),void 0;if(!this.challenged||!this.staled&&e.stale===!0){if(this.credentials||(this.credentials=new a.DigestAuthentication(this.ua)),!this.credentials.authenticate(this.request,e))return this.applicant.receiveResponse(b),void 0;this.challenged=!0,e.stale&&(this.staled=!0),b.method===a.C.REGISTER?d=this.applicant.cseq+=1:this.request.dialog?d=this.request.dialog.local_seqnum+=1:(d=this.request.cseq+1,this.request.cseq=d),this.request.setHeader("cseq",d+" "+this.method),this.request.setHeader(f,this.credentials.toString()),this.send()}else this.applicant.receiveResponse(b)}}},a.RequestSender=b}(b),function(a){var b;b=function(a){this.applicant=a,this.request=a.request},b.prototype={send:function(){var b=new a.RequestSender(this,this.applicant.session.ua);b.send()},onRequestTimeout:function(){this.applicant.session.onRequestTimeout(),this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.session.onTransportError(),this.applicant.onTransportError()},receiveResponse:function(b){(408===b.status_code||481===b.status_code)&&(this.request.method!==a.C.BYE&&this.applicant.session.sendBye({status_code:b.status_code,reason_phrase:b.reason_phrase}),this.applicant.session.ended("remote",b,a.C.causes.DIALOG_ERROR)),this.applicant.receiveResponse(b)}},a.InDialogRequestSender=b}(b),function(b){var c,d=b.name+" | "+"REGISTRATOR"+" | ";c=function(a,c){var d=1;this.ua=a,this.transport=c,this.registrar=a.configuration.registrar_server,this.expires=a.configuration.register_expires,this.call_id=b.Utils.createRandomToken(22),this.cseq=80,this.to_uri=a.configuration.uri,this.registrationTimer=null,this.registered=this.registered_before=!1,this.ua.registrator=this,this.contact=this.ua.contact.toString(),d&&(this.contact+=";reg-id="+d,this.contact+=';+sip.instance="<urn:'+this.ua.configuration.instance_id+'>"')},c.prototype={register:function(c){var e,f,g,h=this;c=c||{},g=c.extraHeaders||[],g.push("Contact: "+this.contact+";expires="+this.expires),this.request=new b.OutgoingRequest(b.C.REGISTER,this.registrar,this.ua,{to_uri:this.to_uri,call_id:this.call_id,cseq:this.cseq+=1},g),e=new b.RequestSender(this,this.ua),this.receiveResponse=function(c){var e,g,i=c.countHeader("contact");if(c.cseq===this.cseq)switch(!0){case/^1[0-9]{2}$/.test(c.status_code):break;case/^2[0-9]{2}$/.test(c.status_code):if(c.hasHeader("expires")&&(g=c.getHeader("expires")),!i){console.warn(d+"no Contact header in response to REGISTER, response ignored");break}for(;i--;){if(e=c.parseHeader("contact",i),e.uri.user===this.ua.contact.uri.user){g=e.getParam("expires");break}e=null}if(!e){console.warn(d+"no Contact header pointing to us, response ignored");break}g||(g=this.expires),this.registrationTimer=a.setTimeout(function(){h.register()},1e3*g-3e3),e.hasParam("temp-gruu")&&(this.ua.contact.temp_gruu=e.getParam("temp-gruu").replace(/"/g,"")),e.hasParam("pub-gruu")&&(this.ua.contact.pub_gruu=e.getParam("pub-gruu").replace(/"/g,"")),this.registered=!0,this.ua.emit("registered",this.ua,{response:c});break;case/^423$/.test(c.status_code):c.hasHeader("min-expires")?(this.expires=c.getHeader("min-expires"),this.registrationTimer=a.setTimeout(function(){h.register()},0)):(console.warn(d+"423 response received for REGISTER without Min-Expires"),this.registrationFailure(c,b.C.causes.SIP_FAILURE_CODE));break;default:f=b.Utils.sipErrorCause(c.status_code),this.registrationFailure(c,f)}},this.onRequestTimeout=function(){this.registrationFailure(null,b.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){this.registrationFailure(null,b.C.causes.CONNECTION_ERROR)},e.send()},unregister:function(c){var e;if(!this.registered)return console.warn(d+"already unregistered"),void 0;c=c||{},e=c.extraHeaders||[],this.registered=!1,a.clearTimeout(this.registrationTimer),c.all?(e.push("Contact: *"),e.push("Expires: 0"),this.request=new b.OutgoingRequest(b.C.REGISTER,this.registrar,this.ua,{to_uri:this.to_uri,call_id:this.call_id,cseq:this.cseq+=1},e)):(e.push("Contact: "+this.contact+";expires=0"),this.request=new b.OutgoingRequest(b.C.REGISTER,this.registrar,this.ua,{to_uri:this.to_uri,call_id:this.call_id,cseq:this.cseq+=1},e));var f=new b.RequestSender(this,this.ua);this.receiveResponse=function(a){var c;switch(!0){case/^1[0-9]{2}$/.test(a.status_code):break;case/^2[0-9]{2}$/.test(a.status_code):this.unregistered(a);break;default:c=b.Utils.sipErrorCause(a.status_code),this.unregistered(a,c)}},this.onRequestTimeout=function(){this.unregistered(null,b.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){this.unregistered(null,b.C.causes.CONNECTION_ERROR)},f.send()},registrationFailure:function(a,b){this.ua.emit("registrationFailed",this.ua,{response:a||null,cause:b}),this.registered&&(this.registered=!1,this.ua.emit("unregistered",this.ua,{response:a||null,cause:b}))},unregistered:function(a,b){this.registered=!1,this.ua.emit("unregistered",this.ua,{response:a||null,cause:b||null})},onTransportClosed:function(){this.registered_before=this.registered,a.clearTimeout(this.registrationTimer),this.registered&&(this.registered=!1,this.ua.emit("unregistered",this.ua))},onTransportConnected:function(){this.register()},close:function(){this.registered_before=this.registered,this.unregister()}},b.Registrator=c}(b),function(b){var c,d=function(b){var c=function(a,c){this.applicant=a,this.request=c||a.request,this.session=a instanceof b.RTCSession?a:a.session,this.reattempt=!1,this.reatemptTimer=null,this.request_sender=new b.InDialogRequestSender(this)};return c.prototype={receiveResponse:function(c){var d=this,e=c.status_code;c.method===b.C.INVITE&&491===e?this.reattempt?this.applicant.receiveResponse(c):(this.request.cseq.value=this.request.dialog.local_seqnum+=1,this.reatemptTimer=a.setTimeout(function(){d.session.status!==b.RTCSession.C.STATUS_TERMINATED&&(d.reattempt=!0,d.request_sender.send())},this.getReattemptTimeout())):this.applicant.receiveResponse(c)},send:function(){this.request_sender.send()},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},getReattemptTimeout:function(){return"outgoing"===this.session.direction?(1.9*Math.random()+2.1).toFixed(2):(2*Math.random()).toFixed(2)}},c}(b),e=function(a){var b=function(a,b){b=b||{},this.session=a,this.localMedia=null,this.peerConnection=null,this.init(b)};return b.prototype={createOffer:function(a,b){var c=this,d=!1;this.onIceCompleted=function(){d||(d=!0,a(c.peerConnection.localDescription.sdp))},this.peerConnection.createOffer(function(a){c.setLocalDescription(a,b)},function(a){console.error(j+"unable to create offer"),console.error(a),b()})},createAnswer:function(a,b){var c=this,d=!1;this.onIceCompleted=function(){d||(d=!0,a(c.peerConnection.localDescription.sdp))},this.peerConnection.createAnswer(function(a){c.setLocalDescription(a,b)},function(a){console.error(j+"unable to create answer"),console.error(a),b()})},setLocalDescription:function(a,b){this.peerConnection.setLocalDescription(a,null,function(a){console.error(j+"unable to set local description"),console.error(a),b()})},addStream:function(a,b,c,d){try{this.peerConnection.addStream(a,d)}catch(e){return console.error(j+"error adding stream"),console.error(e),c(),void 0}b()},init:function(b){var c,d,e,f,g=this,h=[];for(c in this.session.ua.configuration.stun_servers)d=this.session.ua.configuration.stun_servers[c],h.push({url:d});for(c in this.session.ua.configuration.turn_servers)d=this.session.ua.configuration.turn_servers[c],f=d.server,e=f.substr(0,f.indexOf(":")),h.push({url:e+":"+d.username+"@"+f.substr(e.length+1),credential:d.password});this.peerConnection=new a.WebRTC.RTCPeerConnection({iceServers:h},b),this.peerConnection.onaddstream=function(a){console.log(j+"stream added: "+a.stream.id)},this.peerConnection.onremovestream=function(a){console.log(j+"stream removed: "+a.stream.id)},this.peerConnection.onicecandidate=function(a){a.candidate?console.log(j+"ICE candidate received: "+a.candidate.candidate):g.onIceCompleted()},this.peerConnection.ongatheringchange=function(a){"complete"===a.currentTarget.iceGatheringState&&"closed"!==this.iceConnectionState&&g.onIceCompleted()},this.peerConnection.onicechange=function(){console.log(j+'ICE connection state changed to "'+this.iceConnectionState+'"')},this.peerConnection.onstatechange=function(){console.log(j+'PeerConnection state changed to "'+this.readyState+'"')}},close:function(){console.log(j+"closing PeerConnection"),this.peerConnection&&(this.peerConnection.close(),this.localMedia&&this.localMedia.stop())},getUserMedia:function(b,c,d){var e=this;console.log(j+"requesting access to local media"),a.WebRTC.getUserMedia(d,function(a){console.log(j+"got local media stream"),e.localMedia=a,b(a)},function(a){console.error(j+"unable to get user media"),console.error(a),c()})},onMessage:function(b,c,d,e){this.peerConnection.setRemoteDescription(new a.WebRTC.RTCSessionDescription({type:b,sdp:c}),d,e)}},b}(b),f=function(a){var b,c={MIN_DURATION:70,MAX_DURATION:6e3,DEFAULT_DURATION:100,MIN_INTER_TONE_GAP:50,DEFAULT_INTER_TONE_GAP:500};return b=function(a){var b=["succeeded","failed"];this.session=a,this.direction=null,this.tone=null,this.duration=null,this.initEvents(b)},b.prototype=new a.EventEmitter,b.prototype.send=function(b,c){var e,f,g,h;if(void 0===b)throw new TypeError("Not enough arguments");if(this.direction="outgoing",this.session.status!==a.RTCSession.C.STATUS_CONFIRMED&&this.session.status!==a.RTCSession.C.STATUS_WAITING_FOR_ACK)throw new a.Exceptions.InvalidStateError(this.session.status);if(c=c||{},h=c.extraHeaders?c.extraHeaders.slice():[],g=c.eventHandlers||{},"string"==typeof b)b=b.toUpperCase();else{if("number"!=typeof b)throw new TypeError("Invalid tone: "+b);b=b.toString()}if(!b.match(/^[0-9A-D#*]$/))throw new TypeError("Invalid tone: "+b);this.tone=b,this.duration=c.duration;for(f in g)this.on(f,g[f]);h.push("Content-Type: application/dtmf-relay"),this.request=this.session.dialog.createRequest(a.C.INFO,h),this.request.body="Signal= "+this.tone+"\r\n",this.request.body+="Duration= "+this.duration,e=new d(this),this.session.emit("newDTMF",this.session,{originator:"local",dtmf:this,request:this.request}),e.send()},b.prototype.receiveResponse=function(b){var c;switch(!0){case/^1[0-9]{2}$/.test(b.status_code):break;case/^2[0-9]{2}$/.test(b.status_code):this.emit("succeeded",this,{originator:"remote",response:b});break;default:c=a.Utils.sipErrorCause(b.status_code),this.emit("failed",this,{originator:"remote",response:b,cause:c})}},b.prototype.onRequestTimeout=function(){this.emit("failed",this,{originator:"system",cause:a.C.causes.REQUEST_TIMEOUT})},b.prototype.onTransportError=function(){this.emit("failed",this,{originator:"system",cause:a.C.causes.CONNECTION_ERROR})},b.prototype.init_incoming=function(a){var b,c=/^(Signal\s*?=\s*?)([0-9A-D#*]{1})(\s)?.*/,d=/^(Duration\s?=\s?)([0-9]{1,4})(\s)?.*/;this.direction="incoming",this.request=a,a.reply(200),a.body&&(b=a.body.split("\r\n"),2===b.length&&(c.test(b[0])&&(this.tone=b[0].replace(c,"$2")),d.test(b[1])&&(this.duration=parseInt(b[1].replace(d,"$2"),10)))),this.tone&&this.duration?this.session.emit("newDTMF",this.session,{originator:"remote",dtmf:this,request:a}):console.warn(j+"invalid INFO DTMF received, discarded")},b.C=c,b}(b),g=function(b){var c,e=b.name+" | "+"REINVITE"+" | ";return c=function(a){var c=["succeeded","failed","completed"];this.session=a,this.direction=null,this.status=b.RTCSession.C.STATUS_NULL,this.timers={},this.initEvents(c)},c.prototype=new b.EventEmitter,c.prototype.send=function(a,c){var e,f,g,h;if(void 0===a)throw new TypeError("Not enough arguments");if(this.direction="outgoing",this.session.status!==b.RTCSession.C.STATUS_CONFIRMED)throw new b.Exceptions.InvalidStateError(this.session.status);c=c||{},h=c.extraHeaders?c.extraHeaders.slice():[],g=c.eventHandlers||{};for(f in g)this.on(f,g[f]);h.push("Contact: "+this.session.contact),a&&h.push("Content-Type: application/sdp"),this.request=this.session.dialog.createRequest(b.C.INVITE,h),this.request.body=a,e=new d(this),this.session.emit("reinvite",this.session,{originator:"local",reinvite:this,request:this.request}),e.send(),this.status=b.RTCSession.C.STATUS_INVITE_SENT
},c.prototype.receiveResponse=function(a){var c,d=a.status_code;switch(this.status){case b.RTCSession.C.STATUS_CONFIRMED:case b.RTCSession.C.STATUS_CANCELED:return this.session.status===b.RTCSession.C.STATUS_CONFIRMED&&(console.info(e+"Retransmitting ACK"),this.session.sendACK()),void 0}return d>=100&&200>d?(this.status=b.RTCSession.C.STATUS_1XX_RECEIVED,void 0):(d>=200&&300>d?(this.status=b.RTCSession.C.STATUS_CONFIRMED,this.session.status===b.RTCSession.C.STATUS_CONFIRMED&&(this.session.sendACK(),console.log(e+"re-INVITE ACK sent",Date.now()),this.session.dialog.processSessionTimerHeaders(a),this.emit("succeeded",this,{originator:"remote",response:a,sdp:a.body}))):(this.status=b.RTCSession.C.STATUS_CANCELED,c=b.Utils.sipErrorCause(a.status_code),this.emit("failed",this,{originator:"remote",response:a,cause:c})),this.emit("completed",this,{originator:"local"}),void 0)},c.prototype.receiveAck=function(){this.status=b.RTCSession.C.STATUS_CONFIRMED,console.log(e+"re-INVITE ACK received",Date.now()),this.timers.invite2xxTimer&&(a.clearTimeout(this.timers.invite2xxTimer),delete this.timers.invite2xxTimer),this.timers.ackTimer&&(a.clearTimeout(this.timers.ackTimer),delete this.timers.ackTimer),this.emit("completed",this,{originator:"remote"})},c.prototype.onRequestTimeout=function(){this.status=b.RTCSession.C.STATUS_TERMINATED,this.emit("failed",this,{originator:"system",cause:b.C.causes.REQUEST_TIMEOUT})},c.prototype.onTransportError=function(){switch(this.status){case b.RTCSession.C.STATUS_CONFIRMED:case b.RTCSession.C.STATUS_CANCELED:case b.RTCSession.C.STATUS_TERMINATED:return}this.status=b.RTCSession.C.STATUS_TERMINATED,this.emit("failed",this,{originator:"system",cause:b.C.causes.CONNECTION_ERROR})},c.prototype.init_incoming=function(a){var c=null,d=a.getHeader("Content-Type");this.direction="incoming",this.request=a,this.status=b.RTCSession.C.STATUS_INVITE_RECEIVED,a.body&&"application/sdp"===d&&(c=a.body),this.session.emit("reinvite",this.session,{originator:"remote",reinvite:this,request:a,sdp:c})},c.prototype.successResponseSent=function(c,d,f){var g=this.session,h=1,i=b.Timers.T1;this.timers.invite2xxTimer=a.setTimeout(function j(){g.status===b.RTCSession.C.STATUS_WAITING_FOR_ACK&&(console.log(e+"Retransmitting 2xx:",h++),c.reply(200,null,d,f),i<b.Timers.T2&&(i=2*i,i>b.Timers.T2&&(i=b.Timers.T2)),g.timers.invite2xxTimer=a.setTimeout(j,i))},i),console.log(e+"re-INVITE response sent",Date.now()),this.timers.ackTimer=a.setTimeout(function(){g.status===b.RTCSession.C.STATUS_WAITING_FOR_ACK&&(console.log(e+"no ACK received, terminating the call"),g.timers.invite2xxTimer&&(a.clearTimeout(g.timers.invite2xxTimer),delete g.timers.invite2xxTimer),g.session.sendBye(),g.session.ended("remote",null,b.C.causes.NO_ACK))},b.Timers.TIMER_H)},c.prototype.sdpValid=function(){var c=this,d=this.request,e=null,f=c.session.ua.configuration.no_answer_timeout;if("incoming"!==this.direction)throw new TypeError('Invalid method "sdpValid" for an outgoing reINVITE');this.status=b.RTCSession.C.STATUS_WAITING_FOR_ANSWER,d.hasHeader("expires")&&(e=1e3*d.getHeader("expires")),this.timers.provisionalResponse=a.setTimeout(function(){d.reply(180,null,["Contact: "+c.session.contact]),delete c.timers.provisionalResponse},1e3),this.timers.answer=e&&f>e?a.setTimeout(function(){d.reply(487),c.emit("failed",c,{originator:"system",cause:b.C.causes.EXPIRES})},e):a.setTimeout(function(){d.reply(480),c.emit("failed",c,{originator:"local",cause:b.C.causes.NO_ANSWER})},f)},c.prototype.sdpInvalid=function(){if("incoming"!==this.direction)throw new TypeError('Invalid method "sdpInvalid" for an outgoing reINVITE');this.request.reply(488),this.status=b.RTCSession.C.STATUS_WAITING_FOR_ACK,this.emit("failed",this,{originator:"remote",cause:b.C.causes.BAD_MEDIA_DESCRIPTION})},c.prototype.accept=function(c){c=c||{};var d=this,e=this.request,f=c.extraHeaders||[],g=c.sdp;if("incoming"!==this.direction)throw new TypeError('Invalid method "accept" for an outgoing reINVITE');this.timers.provisionalResponse&&(a.clearTimeout(this.timers.provisionalResponse),delete this.timers.provisionalResponse),this.timers.answer&&(a.clearTimeout(this.timers.answer),delete this.timers.answer),this.session.dialog.processSessionTimerHeaders(e),this.session.dialog.addSessionTimerResponseHeaders(f),f.push("Contact: "+d.session.contact),f.push("Allow: "+b.Utils.getAllowedMethods(d.session.ua)),f.push("Content-Type: application/sdp");var h=function(){d.session.onTransportError(),d.onTransportError()};e.reply(200,null,f,g,this.successResponseSent.bind(this,e,f,g),h),this.status=b.RTCSession.C.STATUS_WAITING_FOR_ACK},c.prototype.reject=function(c){c=c||{};var d=c.status_code||480,e=c.reason_phrase,f=c.extraHeaders||[];if("incoming"!==this.direction)throw new TypeError('Invalid method "reject" for an outgoing reINVITE');if(300>d||d>=700)throw new TypeError("Invalid status_code: "+d);this.timers.provisionalResponse&&(a.clearTimeout(this.timers.provisionalResponse),delete this.timers.provisionalResponse),this.timers.answer&&(a.clearTimeout(this.timers.answer),delete this.timers.answer),this.request.reply(d,e,f),this.status=b.RTCSession.C.STATUS_WAITING_FOR_ACK},c.C=k,c}(b),h=function(a){var b;return b=function(a){var b=["succeeded","failed"];this.session=a,this.direction=null,this.accepted=null,this.initEvents(b)},b.prototype=new a.EventEmitter,b.prototype.send=function(b){var c,e,f,g,h;if(this.direction="outgoing",this.session.status!==a.RTCSession.C.STATUS_CONFIRMED&&this.session.status!==a.RTCSession.C.STATUS_WAITING_FOR_ACK)throw new a.Exceptions.InvalidStateError(this.session.status);b=b||{},g=b.extraHeaders?b.extraHeaders.slice():[],f=b.eventHandlers||{},h=b.sdp;for(e in f)this.on(e,f[e]);g.push("Contact: "+this.session.contact),h&&g.push("Content-Type: application/sdp"),this.request=this.session.dialog.createRequest(a.C.UPDATE,g),this.request.body=h,c=new d(this),this.session.emit("update",this.session,{originator:"local",update:this,request:this.request}),c.send()},b.prototype.receiveResponse=function(b){var c;if(this.session.status===a.RTCSession.C.STATUS_CONFIRMED)switch(!0){case/^1[0-9]{2}$/.test(b.status_code):break;case/^2[0-9]{2}$/.test(b.status_code):this.session.dialog.processSessionTimerHeaders(b),this.emit("succeeded",this,{originator:"remote",response:b});break;default:c=a.Utils.sipErrorCause(b.status_code),this.emit("failed",this,{originator:"remote",response:b,cause:c})}},b.prototype.onRequestTimeout=function(){this.emit("failed",this,{originator:"system",cause:a.C.causes.REQUEST_TIMEOUT})},b.prototype.onTransportError=function(){this.emit("failed",this,{originator:"system",cause:a.C.causes.CONNECTION_ERROR})},b.prototype.init_incoming=function(a){if(this.direction="incoming",this.request=a,this.session.emit("update",this.session,{originator:"remote",update:this,request:a}),null===this.accepted){var b=a.getHeader("content-type");b||a.body?this.reject({status_code:488}):this.accept()}return this.accepted},b.prototype.accept=function(a){a=a||{};var b=a.extraHeaders||[],c=a.body;if("incoming"!==this.direction)throw new TypeError('Invalid method "accept" for an outgoing update');this.session.dialog.processSessionTimerHeaders(this.request),this.session.dialog.addSessionTimerResponseHeaders(b),b.push("Contact: "+this.session.contact),this.request.reply(200,null,b,c),this.accepted=!0},b.prototype.reject=function(a){a=a||{};var b=a.status_code||480,c=a.reason_phrase,d=a.extraHeaders||[],e=a.body;if("incoming"!==this.direction)throw new TypeError('Invalid method "reject" for an outgoing update');if(300>b||b>=700)throw new TypeError("Invalid status_code: "+b);this.request.reply(b,c,d,e),this.accepted=!1},b}(b),i=function(a){var b,c=a.name+" | "+"IN-DIALOG REFER"+" | ",e=18e4;return b=function(a){var b=["accepted","failed","notify"];this.session=a,this.ua=a.ua,this.closed=!1,this.request=null,this.id=null,this.contact=a.contact,this.notify_timer=null,this.dialog=a.dialog,this.subscription_state="pending",this.subscription_expires=null,this.expire_timer=null,this.last_notify_body=null,this.accepted=!1,this.rejected=!1,this.direction=null,this.refer_uri=null,this.data={},this.initEvents(b)},b.prototype=new a.EventEmitter,b.prototype.send=function(b,e){var f,g,h,i,j,k,l=null;if(void 0===b)throw new TypeError("Not enough arguments");if(this.session.status!==a.RTCSession.C.STATUS_CONFIRMED&&this.session.status!==a.RTCSession.C.STATUS_WAITING_FOR_ACK)throw new a.Exceptions.InvalidStateError(this.session.status);e=e||{},j=e.extraHeaders||[],i=e.eventHandlers||{},h=e.contentType||"text/plain";for(g in i)this.on(g,i[g]);try{b=a.Utils.normalizeURI(b,this.ua.configuration.hostport_params)}catch(m){b=a.URI.parse(a.C.INVALID_TARGET_URI),l=a.C.causes.INVALID_REFER_TO_TARGET}this.direction="outgoing",this.refer_uri=b,k=this.dialog.createRequest(a.C.REFER,j),this.request=k,this.id=k.call_id+this.dialog.id.local_tag,k.setHeader("contact",this.contact),k.setHeader("refer-to",b),e.body&&(k.setHeader("content-type",h),k.body=e.body),f=new d(this),this.ua.emit("newRefer",this.ua,{originator:"local",refer:this,request:this.request}),l?this.emit("failed",this,{originator:"local",cause:l}):(f.send(),console.log(c+this.id+" sent"),this.notify_timer=setTimeout(this.onNotifyTimeout.bind(this),a.Timers.TIMER_F))},b.prototype.receiveResponse=function(b){var d;if(!this.closed)switch(!0){case/^1[0-9]{2}$/.test(b.status_code):break;case/^2[0-9]{2}$/.test(b.status_code):console.log(c+this.id+" accepted"),this.emit("accepted",this,{originator:"remote",response:b});break;default:console.log(c+this.id+" rejected (early)"),this.close(),d=a.Utils.sipErrorCause(b.status_code),this.emit("failed",this,{originator:"remote",message:b,cause:d})}},b.prototype.onRequestTimeout=function(){this.closed||(console.log(c+this.id+" request timeout"),this.close(),this.emit("failed",this,{originator:"system",cause:a.C.causes.REQUEST_TIMEOUT}))},b.prototype.onTransportError=function(){this.closed||(console.log(c+this.id+" transport error"),this.close(),this.emit("failed",this,{originator:"system",cause:a.C.causes.CONNECTION_ERROR}))},b.prototype.onNotifyTimeout=function(){this.closed||"pending"!==this.subscription_state||(console.log(c+this.id+" notify timeout"),this.emitFinalNotify(),this.close())},b.prototype.emitFinalNotify=function(){var b,c=this.last_notify_body;c||(c=a.Parser.parseMessage("SIP/2.0 100 Trying\r\n",!0)),b=c.status_code<200?"progress":c.status_code<300?"started":"failed",this.emit("notify",this,{originator:"system",request:null,sipFrag:c,sessionEvent:b,finalNotify:!0})},b.prototype.close=function(){"active"===this.subscription_state&&(console.warn(c+this.id+" closed with active subscription"),"incoming"===this.direction?this.notify({body:this.last_notify_body,finalNotify:!0}):this.emitFinalNotify()),null!==this.expire_timer&&(clearTimeout(this.expire_timer),this.expire_timer=null),null!==this.notify_timer&&(clearTimeout(this.notify_timer),this.notify_timer=null),this.closed=!0,console.log(c+this.id+" closed")},b.prototype.subscriptionExpired=function(){"terminated"!==this.subscription_state&&(this.notify({body:this.last_notify_body,finalNotify:!0,terminateReason:"timeout"}),this.expire_timer=null,console.log(c+this.id+" subscription expired"))},b.prototype.init_incoming=function(a){return this.direction="incoming",this.request=a,this.id=a.call_id+a.from_tag,a.hasHeader("refer-to")?a.countHeader("refer-to")>1?(a.reply(400,"Too many Refer-To header fields"),!1):(this.refer_uri=a.parseHeader("refer-to").uri,console.log(c+this.id+" received"),this.ua.emit("newRefer",this.ua,{originator:"remote",refer:this,request:a,session:this.session}),this.accepted||this.rejected||this.accept(),this.accepted):(a.reply(400,"Missing Refer-To header field"),!1)},b.prototype.call=function(b){var c,d=this.refer_uri;if(d.scheme!==a.C.SIP)throw new a.Exceptions.InvalidTargetError(d);return this.accepted||this.accept(),c=new a.RTCSession(this.ua),c.connect(d,b),this.addSessionNotifyHandlers(c),c},b.prototype.addSessionNotifyHandlers=function(b){var c=this;b.on("progress",function(a){var b=a.data.response;c.notify({status_code:b.status_code,reason_phrase:b.reason_phrase})}),b.once("started",function(a){var b=a.data.response;c.notify({status_code:b.status_code,reason_phrase:b.reason_phrase}),c.close()}),b.once("failed",function(b){var d=500,e=null,f=b.data.message;f&&f instanceof a.IncomingResponse&&(d=f.status_code,e=f.reason_phrase),c.notify({status_code:d,reason_phrase:e}),c.close()})},b.prototype.accept=function(a){a=a||{};var b=a.extraHeaders||[],d=a.body;if("incoming"!==this.direction)throw new TypeError('Invalid method "accept" for an outgoing refer');this.closed||(this.subscription_state="active",this.subscription_expires=Date.now()+e,this.expire_timer=setTimeout(this.subscriptionExpired.bind(this),e),b.push("Contact: "+this.contact),this.request.reply(202,null,b,d),this.notify(),this.accepted=!0,console.log(c+this.id+" accepted"))},b.prototype.reject=function(a){a=a||{};var b=a.status_code||603,d=a.reason_phrase,e=a.extraHeaders||[],f=a.body;if("incoming"!==this.direction)throw new TypeError('Invalid method "reject" for an outgoing refer');if(300>b||b>=700)throw new TypeError("Invalid status_code: "+b);this.closed||(this.accepted?(console.log(c+this.id+" rejected (late)"),this.notify({status_code:b,reason_phrase:d})):(console.log(c+this.id+" rejected (early)"),this.request.reply(b,d,e,f),this.rejected=!0),this.close())},b.prototype.notify=function(b){var d,e,f,g,h,i,j,k,l=this;if("incoming"!==this.direction)throw new TypeError('Invalid method "notify" for an outgoing refer');if(b=b||{},b.body&&"undefined"==typeof b.finalNotify)throw new TypeError("Must specify finalNotify when providing notify body");"active"===this.subscription_state&&(d=b.status_code||100,e=b.reason_phrase||a.C.REASON_PHRASE[d]||"",f=b.finalNotify||d>=200,f?(g="terminated",h=b.terminateReason||"noresource",i=g+";reason="+h):(g="active",i=g+";expires="+Math.round((this.subscription_expires-Date.now())/1e3)),j=b.body||"SIP/2.0 "+d+" "+e+"\r\n",this.last_notify_body=j,k=new a.Notify(this),k.send("refer;id="+this.request.cseq,i,{extraHeaders:b.extraHeaders,eventHandlers:b.eventHandlers,content_type:"message/sipfrag",body:j}),this.subscription_state=g,f||k.on("failed",function(){l.subscription_state="terminated",console.log(c+l.id+" unsubscribed (rejected notify)"),l.close()}))},b.prototype.receiveRequest=function(b){switch(b.method){case a.C.NOTIFY:return this.receiveNotify(b);case a.C.SUBSCRIBE:return this.receiveSubscribe(b)}return b.reply(405,null,["Allow: "+a.Utils.getAllowedMethods(this.ua)]),!1},b.prototype.receiveNotify=function(b){var d,e,f,g,h,i,j,k=!1;return"outgoing"!==this.direction||"active"!==this.subscription_state&&"pending"!==this.subscription_state?(b.reply(481,"Subscription Does Not Exist"),!1):(d=b.parseHeader("event"),d&&"refer"===d.event?(e=b.parseHeader("subscription-state"))?(f=b.getHeader("content-type"),f&&f.indexOf("message/sipfrag")<0?(b.reply(415),this.close(),!1):(j=b.body,/\r\n$/.test(j)||(j+="\r\n"),g=a.Parser.parseMessage(j,!0),!g||!g instanceof a.IncomingResponse?(b.reply(400,"Bad Message Body"),this.close(),!1):0===this.listeners("notify").length?(console.log(c+this.id+" no notify listeners; unsubscribing"),b.reply(603),this.subscription_state="terminated",this.close(),!1):(this.subscription_state=e.state,this.subscription_expires=Date.now()+1e3*e.expires,this.last_notify_body=g,null!==this.notify_timer&&(clearTimeout(this.notify_timer),this.notify_timer=null),null!==this.expire_timer&&(clearTimeout(this.expire_timer),this.expire_timer=null),i=["Contact: "+this.contact],b.reply(200,null,i),h=g.status_code<200?"progress":g.status_code<300?"started":"failed",console.log(c+this.id+" notify: "+h),"terminated"===this.subscription_state?(k=!0,this.close()):this.expire_timer=setTimeout(this.close.bind(this),1e3*(e.expires+a.Timers.T4)),this.emit("notify",this,{originator:"remote",request:b,sipFrag:g,sessionEvent:h,finalNotify:k}),!0))):(b.reply(400,"Missing Subscription-State Header"),this.close(),!1):(b.reply(489),this.close(),!1))},b.prototype.receiveSubscribe=function(a){var b,d,f;return"incoming"!==this.direction?(a.reply(481),!1):"active"!==this.subscription_state&&"terminated"!==this.subscription_state?(a.reply(403),!1):(b=a.parseHeader("event"),b&&"refer"===b.event?(d=a.parseHeader("expires"),0===d?(console.log(c+this.id+" unsubscribed (expires=0)"),this.notify({body:this.last_notify_body,finalNotify:!0}),f=["Contact: "+this.contact],a.reply(200,null,f),this.close(),!0):(d=d>0?1e3*d:e,this.subscription_state="active",this.subscription_expires=Date.now()+d,null!==this.expire_timer&&clearTimeout(this.expire_timer),this.expire_timer=setTimeout(this.subscriptionExpired.bind(this),d),f=["Contact: "+this.contact,"Expires: "+d/1e3],a.reply(200,null,f),console.log(c+this.id+" subscription extended"),!0)):(a.reply(489),!1))},b}(b),j=b.name+" | "+"RTC SESSION"+" | ",k={STATUS_NULL:0,STATUS_INVITE_SENT:1,STATUS_1XX_RECEIVED:2,STATUS_INVITE_RECEIVED:3,STATUS_WAITING_FOR_ANSWER:4,STATUS_WAITING_FOR_ACK:5,STATUS_CANCELED:6,STATUS_TERMINATED:7,STATUS_CONFIRMED:8};c=function(a){var b=["progress","failed","started","ended","newDTMF","reinvite","refresh","update"];this.ua=a,this.status=k.STATUS_NULL,this.lastReinvite=null,this.dialog=null,this.earlyDialogs={},this.rtcMediaHandler=null,this.tones=null,this.allowed=null,this.supported=null,this.incoming_refer=null,this.outgoing_refer=null,this.timers={ackTimer:null,expiresTimer:null,invite2xxTimer:null,userNoAnswerTimer:null},this.direction=null,this.local_identity=null,this.remote_identity=null,this.start_time=null,this.end_time=null,this.data={},this.initEvents(b)},c.prototype=new b.EventEmitter,c.prototype.terminate=function(a){a=a||{};var c,d=a.status_code,e=a.reason_phrase,f=a.extraHeaders||[],g=a.body;if(this.status===k.STATUS_TERMINATED)throw new b.Exceptions.InvalidStateError(this.status);switch(this.status){case k.STATUS_NULL:case k.STATUS_INVITE_SENT:case k.STATUS_1XX_RECEIVED:if(console.log(j+"canceling RTCSession"),d&&(200>d||d>=700))throw new TypeError("Invalid status_code: "+d);d&&(e=e||b.C.REASON_PHRASE[d]||"",c="SIP ;cause="+d+' ;text="'+e+'"'),this.status===k.STATUS_NULL?(this.isCanceled=!0,this.cancelReason=c):this.status===k.STATUS_INVITE_SENT?this.received_100?this.request.cancel(c):(this.isCanceled=!0,this.cancelReason=c):this.status===k.STATUS_1XX_RECEIVED&&this.request.cancel(c),this.failed("local",null,b.C.causes.CANCELED);break;case k.STATUS_WAITING_FOR_ANSWER:if(console.log(j+"rejecting RTCSession"),d=d||480,300>d||d>=700)throw new TypeError("Invalid status_code: "+d);this.request.reply(d,e,f,g),this.failed("local",null,b.C.causes.REJECTED);break;case k.STATUS_WAITING_FOR_ACK:case k.STATUS_CONFIRMED:console.log(j+"terminating RTCSession"),this.sendBye(a),this.ended("local",null,b.C.causes.BYE)}this.close()},c.prototype.answer=function(c){c=c||{};var d=this,e=this.request,f=c.extraHeaders||[],g=c.mediaConstraints||{audio:!0,video:!0},h=c.sdp,i=function(a){d.rtcMediaHandler.addStream(a,m,n)},l=function(){e.reply(480),d.failed("local",null,b.C.causes.USER_DENIED_MEDIA_ACCESS)},m=function(){d.rtcMediaHandler.createAnswer(o,p)},n=function(){d.status!==k.STATUS_TERMINATED&&d.failed("local",null,b.C.causes.WEBRTC_ERROR)},o=function(c){var g,h=function(){var f=1,g=b.Timers.T1;d.status=k.STATUS_WAITING_FOR_ACK,d.timers.invite2xxTimer=a.setTimeout(function h(){d.status===b.RTCSession.C.STATUS_WAITING_FOR_ACK&&(console.log(j+"Retransmitting 2xx:",f++),e.reply(200,null,["Contact: "+d.contact],c),g<b.Timers.T2&&(g=2*g,g>b.Timers.T2&&(g=b.Timers.T2)),d.timers.invite2xxTimer=a.setTimeout(h,g))},g),d.timers.ackTimer=a.setTimeout(function(){d.status===k.STATUS_WAITING_FOR_ACK&&(console.log(j+"no ACK received, terminating the call"),a.clearTimeout(d.timers.invite2xxTimer),d.sendBye(),d.ended("remote",null,b.C.causes.NO_ACK))},b.Timers.TIMER_H),d.started("local")},i=function(){d.failed("system",null,b.C.causes.CONNECTION_ERROR)};f.push("Contact: "+d.contact),f.push("Allow: "+b.Utils.getAllowedMethods(d.ua)),g=b.Utils.getSupportedExtensions(d.ua,b.Utils.getSessionExtensions(d,b.C.INVITE)),f.push("Supported: "+g.join(",")),e.reply(200,null,f,c,h,i)},p=function(){d.status!==k.STATUS_TERMINATED&&d.failed("local",null,b.C.causes.WEBRTC_ERROR)};if("incoming"!==this.direction)throw new TypeError('Invalid method "answer" for an outgoing call');if(this.status!==k.STATUS_WAITING_FOR_ANSWER)throw new b.Exceptions.InvalidStateError(this.status);return this.createDialog(e,"UAS")?(a.clearTimeout(this.timers.userNoAnswerTimer),this.dialog.processSessionTimerHeaders(e),this.dialog.addSessionTimerResponseHeaders(f),h?o(h):this.rtcMediaHandler.getUserMedia(i,l,g),void 0):(e.reply(500,"Missing Contact header field"),void 0)},c.prototype.sendDTMF=function(c,d){var e,g,h=0,i=this;if(d=d||{},e=d.duration||null,g=d.interToneGap||null,void 0===c)throw new TypeError("Not enough arguments");if(this.status!==k.STATUS_CONFIRMED&&this.status!==k.STATUS_WAITING_FOR_ACK)throw new b.Exceptions.InvalidStateError(this.status);if(!c||"string"!=typeof c&&"number"!=typeof c||!c.toString().match(/^[0-9A-D#*,]+$/i))throw new TypeError("Invalid tones: "+c);if(c=c.toString(),e&&!b.Utils.isDecimal(e))throw new TypeError("Invalid tone duration: "+e);if(e?e<f.C.MIN_DURATION?(console.warn(j+'"duration" value is lower than the minimum allowed, setting it to '+f.C.MIN_DURATION+" milliseconds"),e=f.C.MIN_DURATION):e>f.C.MAX_DURATION?(console.warn(j+'"duration" value is greater than the maximum allowed, setting it to '+f.C.MAX_DURATION+" milliseconds"),e=f.C.MAX_DURATION):e=Math.abs(e):e=f.C.DEFAULT_DURATION,d.duration=e,g&&!b.Utils.isDecimal(g))throw new TypeError("Invalid interToneGap: "+g);if(g?g<f.C.MIN_INTER_TONE_GAP?(console.warn(j+'"interToneGap" value is lower than the minimum allowed, setting it to '+f.C.MIN_INTER_TONE_GAP+" milliseconds"),g=f.C.MIN_INTER_TONE_GAP):g=Math.abs(g):g=f.C.DEFAULT_INTER_TONE_GAP,this.tones)return this.tones+=c,void 0;this.tones=c;var l=function(){var b,c,j=i.tones;if(i.status===k.STATUS_TERMINATED||!j||h>=j.length)return i.tones=null,void 0;if(b=j[h],h+=1,","===b)c=2e3;else{var m=new f(i);m.on("failed",function(){i.tones=null}),m.send(b,d),c=e+g}a.setTimeout(l,c)};l()},c.prototype.sendReinvite=function(a){var c;if(a=a||{},c=a.sdp,this.lastReinvite)switch(this.lastReinvite.status){case k.STATUS_CONFIRMED:case k.STATUS_CANCELED:case k.STATUS_TERMINATED:break;default:throw new b.Exceptions.InvalidStateError(this.lastReinvite.status)}var d=new g(this);d.send(c,a),this.lastReinvite=d},c.prototype.sendUpdate=function(a){var b;a=a||{},b=a.sdp;var c=new h(this);c.send(a)},c.prototype.sendRefer=function(a,c){var d,e=this.dialog.remote_target;if(c=c||{},c.targetDialog=this.dialog,!this.isMethodAllowed(b.C.REFER,!1))throw new b.Exceptions.RemoteSupportError(b.C.REFER);if(this.isOptionSupported(b.C.SIP_EXTENSIONS.GRUU)&&e.hasParam("gr")&&this.isOptionSupported(b.C.SIP_EXTENSIONS.TARGET_DIALOG))return d=new b.Refer(this.ua),d.send(e,a,c),void 0;if(d=this.outgoing_refer,d&&!d.closed)throw new b.Exceptions.InvalidStateError("Refer in progress");d=new i(this),d.send(a,c),this.outgoing_refer=d},c.prototype.isMethodAllowed=function(a,b){return this.allowed?this.allowed.indexOf(a)>=0?!0:!1:b},c.prototype.isOptionSupported=function(a){return this.supported&&this.supported.indexOf(a)>=0?!0:!1},c.prototype.getLocalStreams=function(){return this.rtcMediaHandler&&this.rtcMediaHandler.peerConnection&&this.rtcMediaHandler.peerConnection.getLocalStreams()||[]},c.prototype.getRemoteStreams=function(){return this.rtcMediaHandler&&this.rtcMediaHandler.peerConnection&&this.rtcMediaHandler.peerConnection.getRemoteStreams()||[]},c.prototype.init_incoming=function(c){var d,f=this,g=c.getHeader("Content-Type");if(!c.body||"application/sdp"!==g)return c.reply(415),void 0;if(this.status=k.STATUS_INVITE_RECEIVED,this.from_tag=c.from_tag,this.id=c.call_id+this.from_tag,this.request=c,this.contact=this.ua.contact.toString(),this.ua.sessions[this.id]=this,c.hasHeader("allow")&&(this.allowed=c.parseHeader("allow")),c.hasHeader("supported")&&(this.supported=c.parseHeader("supported")),c.hasHeader("expires")&&(d=1e3*c.getHeader("expires")),c.to_tag=b.Utils.newTag(),!this.createDialog(c,"UAS",!0))return c.reply(500,"Missing Contact header field"),void 0;var h=function(){c.reply(180,null,["Contact: "+f.contact]),f.status=k.STATUS_WAITING_FOR_ANSWER,f.timers.userNoAnswerTimer=a.setTimeout(function(){c.reply(480),f.failed("local",null,b.C.causes.NO_ANSWER)},f.ua.configuration.no_answer_timeout),d&&(f.timers.expiresTimer=a.setTimeout(function(){f.status===k.STATUS_WAITING_FOR_ANSWER&&(c.reply(487),f.failed("system",null,b.C.causes.EXPIRES))},d))},i=function(){c.reply(488),f.failed("remote",c,b.C.causes.BAD_MEDIA_DESCRIPTION)},l=function(){f.rtcMediaHandler=new e(f),f.rtcMediaHandler.onMessage("offer",c.body,function(){h(),f.newRTCSession("remote",c)},function(a){console.warn(j+"invalid SDP"),console.warn(a),i()})};this.ua.configuration.handle_media?l():this.newRTCSession("remote",c,h,i,l)},c.prototype.connect=function(a,c){c=c||{};var d,f,g,h=!1,i=c.eventHandlers||{},j=c.extraHeaders||[],l=c.mediaConstraints||{audio:!0,video:!0},m=c.RTCConstraints||{},n=c.featureTags||"",o=c.sdp;if(void 0===a)throw new TypeError("Not enough arguments");if(this.status!==k.STATUS_NULL)throw new b.Exceptions.InvalidStateError(this.status);for(d in i)this.on(d,i[d]);try{a=b.Utils.normalizeURI(a,this.ua.configuration.hostport_params)}catch(p){a=b.URI.parse(b.C.INVALID_TARGET_URI),h=!0}if(this.from_tag=b.Utils.newTag(),o||(this.rtcMediaHandler=new e(this,m)),this.anonymous=c.anonymous,this.isCanceled=!1,this.received_100=!1,f={from_tag:this.from_tag,extra_supported:b.Utils.getSessionExtensions(this,b.C.INVITE)},this.contact=this.ua.contact.toString({anonymous:this.anonymous,outbound:!0})+n,this.anonymous&&(f.from_display_name="Anonymous",f.from_uri="sip:anonymous@anonymous.invalid",j.push("P-Preferred-Identity: "+this.ua.configuration.uri.toString()),j.push("Privacy: id")),g=new b.OutgoingRequest(b.C.INVITE,a,this.ua,f,j),this.request=g,g.setHeader("contact",this.contact),g.setHeader("content-type","application/sdp"),this.id=this.request.call_id+this.from_tag,this.ua.sessions[this.id]=this,this.newRTCSession("local",this.request),h)this.failed("local",null,b.C.causes.INVALID_TARGET);else if(o){var q=new b.RequestSender(this,this.ua);this.request.body=o,this.status=k.STATUS_INVITE_SENT,q.send()}else this.sendInitialRequest(l)},c.prototype.close=function(){var b;if(this.status!==k.STATUS_TERMINATED){console.log(j+"closing INVITE session "+this.id),this.rtcMediaHandler&&this.rtcMediaHandler.close(),this.incoming_refer&&this.incoming_refer.close(),this.outgoing_refer&&this.outgoing_refer.close();for(b in this.timers)a.clearTimeout(this.timers[b]);this.dialog&&(this.dialog.terminate(),delete this.dialog);for(b in this.earlyDialogs)this.earlyDialogs[b].terminate(),delete this.earlyDialogs[b];this.status=k.STATUS_TERMINATED,delete this.ua.sessions[this.id]}},c.prototype.calcDialogId=function(a,b){var c="UAS"===b?a.to_tag:a.from_tag,d="UAS"===b?a.from_tag:a.to_tag;return a.call_id+c+d},c.prototype.createDialog=function(a,c,d){var e,f,g=this.calcDialogId(a,c);return f=this.earlyDialogs[g],d?f?!0:(f=new b.Dialog(this,a,c,b.Dialog.C.STATUS_EARLY),f.id?(this.earlyDialogs[g]=f,!0):(this.failed("remote",a,b.C.causes.INTERNAL_ERROR),!1)):f?(f.update(a,c),this.dialog=f,delete this.earlyDialogs[g],!0):(e=new b.Dialog(this,a,c),e.id?(this.to_tag=a.to_tag,this.dialog=e,!0):(this.failed("remote",a,b.C.causes.INTERNAL_ERROR),!1))},c.prototype.receiveRequest=function(c){var d,e,j,l,m;if(c.method===b.C.CANCEL)return this.status===k.STATUS_WAITING_FOR_ANSWER?(this.status=k.STATUS_CANCELED,this.request.reply(487),c.reply(200),this.failed("remote",c,b.C.causes.CANCELED),!0):(c.reply(481),!1);switch(c.method){case b.C.ACK:this.status===k.STATUS_WAITING_FOR_ACK?(a.clearTimeout(this.timers.ackTimer),a.clearTimeout(this.timers.invite2xxTimer),this.status=k.STATUS_CONFIRMED):this.lastReinvite&&this.lastReinvite.status===k.STATUS_WAITING_FOR_ACK&&this.lastReinvite.receiveAck();break;case b.C.BYE:this.status===k.STATUS_CONFIRMED&&(c.reply(200),this.ended("remote",c,b.C.causes.BYE));break;case b.C.INVITE:if(this.status!==k.STATUS_CONFIRMED)return c.reply(491),!1;if(this.lastReinvite)switch(this.lastReinvite.status){case k.STATUS_CONFIRMED:case k.STATUS_CANCELED:case k.STATUS_TERMINATED:break;default:return c.reply(491),!1}e=new g(this),e.init_incoming(c),this.lastReinvite=e;break;case b.C.INFO:(this.status===k.STATUS_CONFIRMED||this.status===k.STATUS_WAITING_FOR_ACK)&&(d=c.getHeader("content-type"),d&&d.match(/^application\/dtmf-relay/i)&&new f(this).init_incoming(c));break;case b.C.UPDATE:return j=new h(this),j.init_incoming(c);case b.C.REFER:return this.incoming_refer&&!this.incoming_refer.closed?(c.reply(491,"Existing Refer In Progress"),!1):(l=new i(this),this.incoming_refer=l,l.init_incoming(c));case b.C.NOTIFY:return c.hasHeader("event")?(m=c.parseHeader("event"),m&&"refer"===m.event?(l=this.outgoing_refer)?l.receiveRequest(c):(c.reply(481,"Subscription Does Not Exist"),!1):(c.reply(489),!1)):(c.reply(400,"Missing Event Header"),!1);case b.C.SUBSCRIBE:return c.hasHeader("event")?(m=c.parseHeader("event"),m&&"refer"===m.event?(l=this.incoming_refer)?l.receiveRequest(c):(c.reply(403),!1):(c.reply(489),!1)):(c.reply(400,"Missing Event Header"),!1)}return!0},c.prototype.sendInitialRequest=function(a){var c=this,d=new b.RequestSender(c,this.ua),e=function(a){c.rtcMediaHandler.addStream(a,g,h)},f=function(){c.status!==k.STATUS_TERMINATED&&c.failed("local",null,b.C.causes.USER_DENIED_MEDIA_ACCESS)},g=function(){c.rtcMediaHandler.createOffer(i,j)},h=function(){c.status!==k.STATUS_TERMINATED&&c.failed("local",null,b.C.causes.WEBRTC_ERROR)},i=function(a){c.isCanceled||c.status===k.STATUS_TERMINATED||(c.request.body=a,c.status=k.STATUS_INVITE_SENT,d.send())},j=function(){c.status!==k.STATUS_TERMINATED&&c.failed("local",null,b.C.causes.WEBRTC_ERROR)};this.rtcMediaHandler.getUserMedia(e,f,a)},c.prototype.receiveResponse=function(a){switch(a.method){case b.C.INVITE:this.receiveInviteResponse(a);break;case b.C.BYE:break;default:console.warn(j+"Unexpected response received:",a)}},c.prototype.receiveInviteResponse=function(a){var c,d=this;if(this.status!==k.STATUS_INVITE_SENT&&this.status!==k.STATUS_1XX_RECEIVED&&this.status!==k.STATUS_CONFIRMED)return console.warn(j+"Unexpected INVITE response:",a),void 0;if(this.isCanceled)return a.status_code>=100&&a.status_code<200?this.request.cancel(this.cancelReason):a.status_code>=200&&a.status_code<299&&this.acceptAndTerminate(a),void 0;switch(!0){case/^100$/.test(a.status_code):this.received_100=!0;break;case/^1[0-9]{2}$/.test(a.status_code):if(!a.to_tag){console.warn(j+"1xx response received without to tag");break}a.hasHeader("contact")&&this.createDialog(a,"UAC",!0),this.status=k.STATUS_1XX_RECEIVED,this.progress("remote",a);break;case/^2[0-9]{2}$/.test(a.status_code):if(this.status===k.STATUS_CONFIRMED){var e=this.calcDialogId(a,"UAC");e===this.dialog.id.toString()?(console.info(j+"Retransmitting ACK"),this.sendACK()):(console.info(j+"Accepting and terminating fork, did:",e),this.acceptAndTerminate(a));break}if(this.status=k.STATUS_CONFIRMED,!a.body){this.acceptAndTerminate(a,400,"Missing session description"),this.failed("remote",a,b.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(a,"UAC"))break;this.sendACK(),a.hasHeader("allow")&&(this.allowed=a.parseHeader("allow")),a.hasHeader("supported")&&(this.supported=a.parseHeader("supported")),this.dialog.processSessionTimerHeaders(a),this.rtcMediaHandler?this.rtcMediaHandler.onMessage("answer",a.body,function(){d.started("remote",a)},function(c){console.warn(c),d.sendBye({status_code:488,reason_phrase:"Not Acceptable Here"}),d.failed("remote",a,b.C.causes.BAD_MEDIA_DESCRIPTION)}):d.started("remote",a);
break;default:c=b.Utils.sipErrorCause(a.status_code),this.failed("remote",a,c)}},c.prototype.acceptAndTerminate=function(a,b,c){var d=this.calcDialogId(a,"UAC"),e=null;this.dialog?this.dialog&&d===this.dialog.id.toString()?e=this.dialog:this.earlyDialogs[d]?e=this.earlyDialogs[d]:this.createDialog(a,"UAC",!0)&&(e=this.earlyDialogs[d]):this.createDialog(a,"UAC")&&(e=this.dialog),e&&(this.sendACK({dialog:e}),this.sendBye({dialog:e,status_code:b,reason_phrase:c}))},c.prototype.sendACK=function(a){a=a||{};var c=a.dialog||this.dialog,d=c.createRequest(b.C.ACK);this.sendRequest(d)},c.prototype.sendBye=function(a){a=a||{};var c,d,e=a.status_code,f=a.reason_phrase||b.C.REASON_PHRASE[e]||"",g=a.extraHeaders||[],h=a.body,i=a.dialog||this.dialog;if(e&&(200>e||e>=700))throw new TypeError("Invalid status_code: "+e);e&&(d="SIP ;cause="+e+'; text="'+f+'"',g.push("Reason: "+d)),c=i.createRequest(b.C.BYE,g),c.body=h,this.sendRequest(c)},c.prototype.sendRequest=function(a){var b=new d(this,a);b.send()},c.prototype.onTransportError=function(){this.status!==k.STATUS_TERMINATED&&(this.status===k.STATUS_CONFIRMED?this.ended("system",null,b.C.causes.CONNECTION_ERROR):this.failed("system",null,b.C.causes.CONNECTION_ERROR))},c.prototype.onRequestTimeout=function(){this.status!==k.STATUS_TERMINATED&&(this.status===k.STATUS_CONFIRMED?this.ended("system",null,b.C.causes.REQUEST_TIMEOUT):this.failed("system",null,b.C.causes.CONNECTION_ERROR))},c.prototype.newRTCSession=function(a,b,c,d,e){var f=this,g="newRTCSession";"remote"===a?(f.direction="incoming",f.local_identity=b.to,f.remote_identity=b.from):"local"===a&&(f.direction="outgoing",f.local_identity=b.from,f.remote_identity=b.to),f.ua.emit(g,f.ua,{originator:a,session:f,request:b,sdpValid:c||null,sdpInvalid:d||null,handleMedia:e||null})},c.prototype.connecting=function(a,b){var c=this,d="connecting";c.emit(d,c,{originator:"local",request:b})},c.prototype.progress=function(a,b){var c=this,d="progress";c.emit(d,c,{originator:a,response:b||null})},c.prototype.started=function(a,b){var c=this,d="started";c.start_time=new Date,c.emit(d,c,{originator:a,response:b||null})},c.prototype.ended=function(a,b,c){var d=this,e="ended";d.end_time=new Date,d.close(),d.emit(e,d,{originator:a,message:b||null,cause:c})},c.prototype.failed=function(a,b,c){var d=this,e="failed";d.close(),d.emit(e,d,{originator:a,message:b||null,cause:c})},c.C=k,b.RTCSession=c}(b),function(a){var b;b=function(a){this.ua=a,this.direction=null,this.local_identity=null,this.remote_identity=null,this.data={}},b.prototype=new a.EventEmitter,b.prototype.send=function(b,c,d){var e,f,g,h,i,j=["succeeded","failed"],k=!1;if(void 0===b||void 0===c)throw new TypeError("Not enough arguments");this.initEvents(j),d=d||{},i=d.extraHeaders||[],h=d.eventHandlers||{},g=d.contentType||"text/plain";for(f in h)this.on(f,h[f]);try{b=a.Utils.normalizeURI(b,this.ua.configuration.hostport_params)}catch(l){b=a.URI.parse(a.C.INVALID_TARGET_URI),k=!0}this.direction="outgoing",this.local_identity=this.ua.configuration.uri,this.remote_identity=b,this.closed=!1,this.ua.applicants[this]=this,i.push("Content-Type: "+g),this.request=new a.OutgoingRequest(a.C.MESSAGE,b,this.ua,null,i),c&&(this.request.body=c),e=new a.RequestSender(this,this.ua),this.ua.emit("newMessage",this.ua,{originator:"local",message:this,request:this.request}),k?this.emit("failed",this,{originator:"local",cause:a.C.causes.INVALID_TARGET}):e.send()},b.prototype.receiveResponse=function(b){var c;if(!this.closed)switch(!0){case/^1[0-9]{2}$/.test(b.status_code):break;case/^2[0-9]{2}$/.test(b.status_code):delete this.ua.applicants[this],this.emit("succeeded",this,{originator:"remote",response:b});break;default:delete this.ua.applicants[this],c=a.Utils.sipErrorCause(b.status_code),this.emit("failed",this,{originator:"remote",response:b,cause:c})}},b.prototype.onRequestTimeout=function(){this.closed||this.emit("failed",this,{originator:"system",cause:a.C.causes.REQUEST_TIMEOUT})},b.prototype.onTransportError=function(){this.closed||this.emit("failed",this,{originator:"system",cause:a.C.causes.CONNECTION_ERROR})},b.prototype.close=function(){this.closed=!0,delete this.ua.applicants[this]},b.prototype.init_incoming=function(b){var c;this.direction="incoming",this.request=b,this.local_identity=b.to.uri,this.remote_identity=b.from.uri,this.ua.emit("newMessage",this.ua,{originator:"remote",message:this,request:b}),c=this.ua.transactions.nist[b.via_branch],!c||c.state!==a.Transactions.C.STATUS_TRYING&&c.state!==a.Transactions.C.STATUS_PROCEEDING||b.reply(200)},b.prototype.accept=function(a){a=a||{};var b=a.extraHeaders||[],c=a.body;if("incoming"!==this.direction)throw new TypeError('Invalid method "accept" for an outgoing message');this.request.reply(200,null,b,c)},b.prototype.reject=function(a){a=a||{};var b=a.status_code||480,c=a.reason_phrase,d=a.extraHeaders||[],e=a.body;if("incoming"!==this.direction)throw new TypeError('Invalid method "reject" for an outgoing message');if(300>b||b>=700)throw new TypeError("Invalid status_code: "+b);this.request.reply(b,c,d,e)},a.Message=b}(b),function(b){var c,d=b.name+" | "+"UA"+" | ",e={STATUS_INIT:0,STATUS_READY:1,STATUS_USER_CLOSED:2,STATUS_NOT_READY:3,CONFIGURATION_ERROR:1,NETWORK_ERROR:2,EVENT_METHODS:{newRTCSession:"INVITE,UPDATE",newMessage:"MESSAGE",newRefer:"REFER"},ALLOWED_METHODS:["ACK","CANCEL","BYE","OPTIONS","NOTIFY"],ACCEPTED_BODY_TYPES:["application/sdp","application/dtmf-relay"],SUPPORTED_EXTENSIONS:["path","outbound","gruu"],EVENT_EXTENSIONS:{tdialog:"newRefer"},SESSION_EVENT_EXTENSIONS:{timer:"refresh"},MAX_FORWARDS:69,TAG_LENGTH:10};c=function(a){var b=["connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage","newOptions","newRefer"];if(e.ACCEPTED_BODY_TYPES=e.ACCEPTED_BODY_TYPES.toString(),this.cache={credentials:{}},this.configuration={},this.dialogs={},this.registrator=null,this.applicants={},this.sessions={},this.refers={},this.transport=null,this.contact=null,this.status=e.STATUS_INIT,this.error=null,this.transactions={nist:{},nict:{},ist:{},ict:{}},this.transportRecoverAttempts=0,void 0===a)throw new TypeError("Not enough arguments");try{this.loadConfig(a),this.initEvents(b)}catch(c){throw this.status=e.STATUS_NOT_READY,this.error=e.CONFIGURATION_ERROR,c}},c.prototype=new b.EventEmitter,c.prototype.register=function(a){this.configuration.register=!0,this.registrator.register(a)},c.prototype.unregister=function(a){this.configuration.register=!1,this.registrator.unregister(a)},c.prototype.isRegistered=function(){return this.registrator&&this.registrator.registered?!0:!1},c.prototype.isConnected=function(){return this.transport?this.transport.connected:!1},c.prototype.call=function(a,c){var d;d=new b.RTCSession(this),d.connect(a,c)},c.prototype.sendMessage=function(a,c,d){var e;e=new b.Message(this),e.send(a,c,d)},c.prototype.stop=function(){var b,c,f,g=this;if(console.log(d+"user requested closure..."),this.status===e.STATUS_USER_CLOSED)return console.warn("UA already closed"),void 0;this.registrator&&(console.log(d+"closing registrator"),this.registrator.close());for(b in this.sessions)console.log(d+"closing session "+b),this.sessions[b].terminate();for(c in this.refers)this.refers[c].close();for(f in this.applicants)this.applicants[f].close();this.status=e.STATUS_USER_CLOSED,this.isAnyTransactionOutstanding()?(this.transactionCheckTimer=a.setInterval(function(){g.isAnyTransactionOutstanding()||(a.clearInterval(g.transactionCheckTimer),a.clearTimeout(g.shutdownGraceTimer),g.transport.disconnect())},500),this.shutdownGraceTimer=a.setTimeout(function(){a.clearInterval(g.transactionCheckTimer),g.transport.disconnect()},"5000")):g.transport.disconnect()},c.prototype.start=function(){var a;console.log(d+"user requested startup..."),this.status===e.STATUS_INIT?(a=this.getNextWsServer(),new b.Transport(this,a)):this.status===e.STATUS_USER_CLOSED?(console.log(d+"resuming"),this.status=e.STATUS_READY,this.transport.connect()):this.status===e.STATUS_READY?console.log(d+"UA is in READY status, not resuming"):console.error("Connection is down. Auto-Recovery system is trying to connect")},c.prototype.saveCredentials=function(a){this.cache.credentials[a.realm]=this.cache.credentials[a.realm]||{},this.cache.credentials[a.realm][a.uri]=a},c.prototype.getCredentials=function(a){var b,c;return b=a.ruri.host,this.cache.credentials[b]&&this.cache.credentials[b][a.ruri]&&(c=this.cache.credentials[b][a.ruri],c.method=a.method),c},c.prototype.isAnyTransactionOutstanding=function(){var a=["nict","ict","nist","ist"];for(var b in a)for(var c in this.transactions[a[b]])return!!c;return!1},c.prototype.onTransportClosed=function(a){var c,e,f=["nict","ict","nist","ist"];a.server.status=b.Transport.C.STATUS_DISCONNECTED,console.log(d+"connection state set to "+b.Transport.C.STATUS_DISCONNECTED);for(c in f)for(e in this.transactions[f[c]])this.transactions[f[c]][e].onTransportError();this.contact.pub_gruu||this.closeSessionsOnTransportError()},c.prototype.onTransportError=function(a){var c;console.log(d+"transport "+a.server.ws_uri+" failed | connection state set to "+b.Transport.C.STATUS_ERROR),a.server.status=b.Transport.C.STATUS_ERROR,this.emit("disconnected",this,{transport:a,code:a.lastTransportError.code,reason:a.lastTransportError.reason}),c=this.getNextWsServer(),c?new b.Transport(this,c):(this.closeSessionsOnTransportError(),this.error&&this.error===e.NETWORK_ERROR||(this.status=e.STATUS_NOT_READY,this.error=e.NETWORK_ERROR),this.recoverTransport())},c.prototype.onTransportConnected=function(a){this.transport=a,this.transportRecoverAttempts=0,a.server.status=b.Transport.C.STATUS_READY,console.log(d+"connection state set to "+b.Transport.C.STATUS_READY),this.status!==e.STATUS_USER_CLOSED&&(this.status=e.STATUS_READY,this.error=null,this.emit("connected",this,{transport:a}),this.configuration.register?this.registrator?this.registrator.onTransportConnected():(this.registrator=new b.Registrator(this,a),this.register()):this.registrator=new b.Registrator(this,a))},c.prototype.receiveRequest=function(a){var c,f,g,h,i=a.method;if(a.ruri.user!==this.configuration.uri.user&&a.ruri.user!==this.contact.uri.user)return console.warn(d+"Request-URI does not point to us"),a.method!==b.C.ACK&&a.reply_sl(404),void 0;if(!b.Transactions.checkTransaction(this,a)){if(a.hasHeader("require"))for(var j=b.Utils.getSupportedExtensions(this),k=a.parseHeader("require"),l=0,m=k.length;m>l;l++){var n=k[l];if(j.indexOf(n)<0&&!e.SESSION_EVENT_EXTENSIONS[n])return a.method!==b.C.ACK&&a.reply_sl(420),void 0}if(i===b.C.INVITE?new b.Transactions.InviteServerTransaction(a,this):i!==b.C.ACK&&new b.Transactions.NonInviteServerTransaction(a,this),i===b.C.OPTIONS){var o=["Allow: "+b.Utils.getAllowedMethods(this),"Accept: "+e.ACCEPTED_BODY_TYPES,"Supported: "+b.Utils.getSupportedExtensions(this).join(",")];return this.checkEvent("newOptions")&&0!==this.listeners("newOptions").length?this.emit("newOptions",this,{originator:"remote",request:a,extraHeaders:o}):a.reply(200,null,o),void 0}if(i===b.C.MESSAGE)return this.checkEvent("newMessage")&&0!==this.listeners("newMessage").length?(g=new b.Message(this),g.init_incoming(a),void 0):(a.reply(405,null,["Allow: "+b.Utils.getAllowedMethods(this)]),void 0);if(a.to_tag){if(c=this.findDialog(a))return c.receiveRequest(a),void 0;if(i===b.C.NOTIFY)return(f=this.findSession(a))?(f.receiveRequest(a),void 0):(h=this.refers[a.call_id+a.to_tag])?(h.receiveRequest(a),void 0):(console.warn(d+"received NOTIFY request for a non existent session"),a.reply(481,"Subscription does not exist"),void 0);if(i!==b.C.ACK)return a.reply(481),void 0}else{if(!this.isRegistered())return a.reply(410),void 0;switch(i){case b.C.INVITE:!this.configuration.handle_media||b.WebRTC.isSupported?(f=new b.RTCSession(this),f.init_incoming(a)):(console.warn(d+"INVITE received but WebRTC is not supported"),a.reply(488));break;case b.C.BYE:a.reply(481);break;case b.C.CANCEL:f=this.findSession(a),f?f.receiveRequest(a):(a.reply(481),console.warn(d+"received CANCEL request for a non existent session"));break;case b.C.ACK:break;case b.C.REFER:h=new b.Refer(this),h.init_incoming(a);break;default:a.reply(405,null,["Allow: "+b.Utils.getAllowedMethods(this)])}}}},c.prototype.findSession=function(a){var b=a.call_id+a.from_tag,c=this.sessions[b],d=a.call_id+a.to_tag,e=this.sessions[d];return c?c:e?e:null},c.prototype.findDialog=function(a){var b=a.call_id+a.from_tag+a.to_tag,c=this.dialogs[b];return c?c:(b=a.call_id+a.to_tag+a.from_tag,c=this.dialogs[b],c?c:null)},c.prototype.getNextWsServer=function(){var a,c,d=[];for(a in this.configuration.ws_servers)c=this.configuration.ws_servers[a],c.status!==b.Transport.C.STATUS_ERROR&&(0===d.length?d.push(c):c.weight>d[0].weight?d=[c]:c.weight===d[0].weight&&d.push(c));return a=Math.floor(Math.random()*d.length),d[a]},c.prototype.closeSessionsOnTransportError=function(){var a;for(a in this.sessions)this.sessions[a].onTransportError();this.registrator&&this.registrator.onTransportClosed()},c.prototype.recoverTransport=function(c){var e,f,g,h,i;c=c||this,h=c.transportRecoverAttempts;for(e in c.configuration.ws_servers)c.configuration.ws_servers[e].status=0;i=c.getNextWsServer(),f=Math.floor(Math.random()*Math.pow(2,h)+1),g=f*c.configuration.connection_recovery_min_interval,g>c.configuration.connection_recovery_max_interval&&(console.log(d+"time for next connection attempt exceeds connection_recovery_max_interval, resetting counter"),g=c.configuration.connection_recovery_min_interval,h=0),console.log(d+"next connection attempt in "+g+" seconds"),a.setTimeout(function(){c.transportRecoverAttempts=h+1,new b.Transport(c,i)},1e3*g)},c.prototype.loadConfig=function(e){var f,g,h,i,j,k={via_host:b.Utils.createRandomToken(12)+".invalid",password:null,register_expires:600,register_min_expires:120,register:!0,registrar_server:null,ws_server_max_reconnection:3,ws_server_reconnection_timeout:4,connection_recovery_min_interval:2,connection_recovery_max_interval:30,use_preloaded_route:!1,no_answer_timeout:60,stun_servers:["stun:stun.l.google.com:19302"],turn_servers:[],handle_media:!0,trace_sip:!1,hack_via_tcp:!1,hack_ip_in_contact:!1};for(f in c.configuration_check.mandatory){if(!e.hasOwnProperty(f))throw new b.Exceptions.ConfigurationError(f);if(g=e[f],h=c.configuration_check.mandatory[f](g),void 0===h)throw new b.Exceptions.ConfigurationError(f,g);k[f]=h}for(f in c.configuration_check.optional)if(e.hasOwnProperty(f)){if(g=e[f],null===g||""===g||void 0===g)continue;if("number"==typeof g&&a.isNaN(g))continue;if(h=c.configuration_check.optional[f](g),void 0===h)throw new b.Exceptions.ConfigurationError(f,g);k[f]=h}if(k.connection_recovery_max_interval<k.connection_recovery_min_interval)throw new b.Exceptions.ConfigurationError("connection_recovery_max_interval",k.connection_recovery_max_interval);0===k.display_name&&(k.display_name="0"),k.instance_id||(k.instance_id="uuid:"+b.Utils.newUUID()),k.jssip_id=b.Utils.createRandomToken(5),i=k.uri.clone(),i.user=null,k.hostport_params=i.toString().replace(/^sip:/i,""),k.authorization_user||(k.authorization_user=k.uri.user),k.registrar_server||(j=k.uri.clone(),j.user=null,k.registrar_server=j),k.no_answer_timeout=1e3*k.no_answer_timeout,k.hack_ip_in_contact&&(k.via_host=b.Utils.getRandomTestNetIP()),this.contact={pub_gruu:null,temp_gruu:null,uri:new b.URI("sip",b.Utils.createRandomToken(8),k.via_host,null,{transport:"ws"}),toString:function(a){a=a||{};var b=a.anonymous||null,c=a.outbound||null,d="<";return d+=b?this.temp_gruu||"sip:anonymous@anonymous.invalid;transport=ws":this.pub_gruu||this.uri.toString(),c&&(d+=";ob"),d+=">"}},console.log(d+"configuration parameters after validation:");for(f in k){switch(f){case"uri":case"registrar_server":console.log("· "+f+": "+k[f]);break;default:console.log("· "+f+": "+a.JSON.stringify(k[f]))}c.configuration_skeleton[f].value=k[f]}Object.defineProperties(this.configuration,c.configuration_skeleton);for(f in k)c.configuration_skeleton[f].value=""},c.configuration_skeleton=function(){var a,b,c={},d=["jssip_id","register_min_expires","ws_server_max_reconnection","ws_server_reconnection_timeout","hostport_params","uri","ws_servers","authorization_user","connection_recovery_max_interval","connection_recovery_min_interval","display_name","hack_via_tcp","hack_ip_in_contact","handle_media","instance_id","no_answer_timeout","password","register_expires","registrar_server","stun_servers","trace_sip","turn_servers","use_preloaded_route","via_core_value","via_host"];for(a in d)b=d[a],c[b]={value:"",writable:!1,configurable:!1};return c.register={value:"",writable:!0,configurable:!1},c}(),c.configuration_check={mandatory:{uri:function(a){var c;return/^sip:/i.test(a)||(a=b.C.SIP+":"+a),c=b.URI.parse(a),c?c.user?c:void 0:void 0},ws_servers:function(a){var c,e;if("string"==typeof a)a=[{ws_uri:a}];else{if(!(a instanceof Array))return;for(c in a)"string"==typeof a[c]&&(a[c]={ws_uri:a[c]})}if(0===a.length)return!1;for(c in a){if(!a[c].ws_uri)return console.error(d+'missing "ws_uri" attribute in ws_servers parameter'),void 0;if(a[c].weight&&!Number(a[c].weight))return console.error(d+'"weight" attribute in ws_servers parameter must be a Number'),void 0;if(e=b.Grammar.parse(a[c].ws_uri,"absoluteURI"),-1===e)return console.error(d+'invalid "ws_uri" attribute in ws_servers parameter: '+a[c].ws_uri),void 0;if("wss"!==e.scheme&&"ws"!==e.scheme)return console.error(d+"invalid URI scheme in ws_servers parameter: "+e.scheme),void 0;a[c].sip_uri="<sip:"+e.host+(e.port?":"+e.port:"")+";transport=ws;lr>",a[c].weight||(a[c].weight=0),a[c].status=0,a[c].scheme=e.scheme.toUpperCase()}return a}},optional:{authorization_user:function(a){return-1===b.Grammar.parse('"'+a+'"',"quoted_string")?void 0:a},connection_recovery_max_interval:function(c){var d;return b.Utils.isDecimal(c)&&(d=a.Number(c),d>0)?d:void 0},connection_recovery_min_interval:function(c){var d;return b.Utils.isDecimal(c)&&(d=a.Number(c),d>0)?d:void 0},display_name:function(a){return-1===b.Grammar.parse('"'+a+'"',"display_name")?void 0:a},hack_via_tcp:function(a){return"boolean"==typeof a?a:void 0},hack_ip_in_contact:function(a){return"boolean"==typeof a?a:void 0},handle_media:function(a){return"boolean"==typeof a?a:void 0},instance_id:function(a){return/^uuid?:/.test(a)||(a="uuid:"+a),-1===b.Grammar.parse(a,"uuid_URI")?void 0:a},no_answer_timeout:function(c){var d;return b.Utils.isDecimal(c)&&(d=a.Number(c),d>0)?d:void 0},password:function(a){return String(a)},register:function(a){return"boolean"==typeof a?a:void 0},register_expires:function(c){var d;return b.Utils.isDecimal(c)&&(d=a.Number(c),d>0)?d:void 0},registrar_server:function(a){var c;return/^sip:/i.test(a)||(a=b.C.SIP+":"+a),c=b.URI.parse(a),c?c.user?void 0:c:void 0},stun_servers:function(a){var c,d;if("string"==typeof a)a=[a];else if(!(a instanceof Array))return;for(c in a){if(d=a[c],/^stuns?:/.test(d)||(d="stun:"+d),-1===b.Grammar.parse(d,"stun_URI"))return;a[c]=d}return a},trace_sip:function(a){return"boolean"==typeof a?a:void 0},turn_servers:function(a){var c,d;a instanceof Array||(a=[a]);for(c in a){if(d=a[c],!(d.server&&d.username&&d.password))return;if(/^turns?:/.test(d.server)||(d.server="turn:"+d.server),-1===b.Grammar.parse(d.server,"turn_URI"))return;if(-1===b.Grammar.parse(d.username,"user"))return;if(-1===b.Grammar.parse(d.password,"password"))return}return a},use_preloaded_route:function(a){return"boolean"==typeof a?a:void 0}}},c.C=e,b.UA=c}(b),function(b){var c;c={str_utf8_length:function(b){return a.unescape(encodeURIComponent(b)).length},isFunction:function(a){return void 0!==a?"[object Function]"===Object.prototype.toString.call(a)?!0:!1:!1},isDecimal:function(a){return!isNaN(a)&&parseFloat(a)===parseInt(a,10)},createRandomToken:function(a,b){var c,d,e="";for(b=b||32,c=0;a>c;c++)d=0|Math.random()*b,e+=d.toString(b);return e},newTag:function(){return b.Utils.createRandomToken(b.UA.C.TAG_LENGTH)},newUUID:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"===a?b:8|3&b;return c.toString(16)});return a},hostType:function(a){return a?(a=b.Grammar.parse(a,"host"),-1!==a?a.host_type:void 0):void 0},normalizeURI:function(a,c){var d,e,f,g,h=a;if(a){if(a instanceof b.URI)return a;if("string"==typeof a){switch(e=a.split("@"),e.length){case 1:if(!c)throw new b.Exceptions.InvalidTargetError(h);f=a,g=c;break;case 2:f=e[0],g=e[1];break;default:f=e.slice(0,e.length-1).join("@"),g=e[e.length-1]}if(f=f.replace(/^(sips?|tel):/i,""),/^[\-\.\(\)]*\+?[0-9\-\.\(\)]+$/.test(f)&&(f=f.replace(/[\-\.\(\)]/g,"")),a=b.C.SIP+":"+b.Utils.escapeUser(f)+"@"+g,d=b.URI.parse(a))return d;throw new b.Exceptions.InvalidTargetError(h)}throw new b.Exceptions.InvalidTargetError(h)}throw new b.Exceptions.InvalidTargetError(h)},escapeUser:function(b){return a.encodeURIComponent(a.decodeURIComponent(b)).replace(/%3A/gi,":").replace(/%2B/gi,"+").replace(/%3F/gi,"?").replace(/%2F/gi,"/")},headerize:function(a){var b,c={"Call-Id":"Call-ID",Cseq:"CSeq","Www-Authenticate":"WWW-Authenticate","Min-Se":"Min-SE"},d=a.toLowerCase().replace(/_/g,"-").split("-"),e="";for(b in d)"0"!==b&&(e+="-"),e+=d[b].charAt(0).toUpperCase()+d[b].substring(1);return c[e]&&(e=c[e]),e},sipErrorCause:function(a){var c;for(c in b.C.SIP_ERROR_CAUSES)if(-1!==b.C.SIP_ERROR_CAUSES[c].indexOf(a))return b.C.causes[c];return b.C.causes.SIP_FAILURE_CODE},getRandomTestNetIP:function(){function b(b,c){return a.Math.floor(a.Math.random()*(c-b+1)+b)}return"192.0.2."+b(1,254)},getAllowedMethods:function(a){var c,d=b.UA.C.ALLOWED_METHODS.toString();for(c in b.UA.C.EVENT_METHODS)a.checkEvent(c)&&a.listeners(c).length>0&&(d+=","+b.UA.C.EVENT_METHODS[c]);return d},getSupportedExtensions:function(a,c){var d,e,f=b.UA.C.SUPPORTED_EXTENSIONS.slice();for(d in b.UA.C.EVENT_EXTENSIONS)e=b.UA.C.EVENT_EXTENSIONS[d],a.checkEvent(e)&&a.listeners(e).length>0&&f.push(d);return c?f.concat(c):f},getSessionExtensions:function(a){var c,d,e=[];for(c in b.UA.C.SESSION_EVENT_EXTENSIONS)d=b.UA.C.SESSION_EVENT_EXTENSIONS[c],a.checkEvent(d)&&a.listeners(d).length>0&&e.push(c);return e},calculateMD5:function(a){function b(a,b){return a<<b|a>>>32-b}function c(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f}function d(a,b,c){return a&b|~a&c}function e(a,b,c){return a&c|b&~c}function f(a,b,c){return a^b^c}function g(a,b,c){return b^(a|~c)}function h(a,e,f,g,h,i,j){return a=c(a,c(c(d(e,f,g),h),j)),c(b(a,i),e)}function i(a,d,f,g,h,i,j){return a=c(a,c(c(e(d,f,g),h),j)),c(b(a,i),d)}function j(a,d,e,g,h,i,j){return a=c(a,c(c(f(d,e,g),h),j)),c(b(a,i),d)}function k(a,d,e,f,h,i,j){return a=c(a,c(c(g(d,e,f),h),j)),c(b(a,i),d)}function l(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=Array(f-1),h=0,i=0;c>i;)b=(i-i%4)/4,h=8*(i%4),g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=8*(i%4),g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g}function m(a){var b,c,d="",e="";for(c=0;3>=c;c++)b=255&a>>>8*c,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d}function n(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(192|d>>6),b+=String.fromCharCode(128|63&d)):(b+=String.fromCharCode(224|d>>12),b+=String.fromCharCode(128|63&d>>6),b+=String.fromCharCode(128|63&d))}return b}var o,p,q,r,s,t,u,v,w,x=[],y=7,z=12,A=17,B=22,C=5,D=9,E=14,F=20,G=4,H=11,I=16,J=23,K=6,L=10,M=15,N=21;for(a=n(a),x=l(a),t=1732584193,u=4023233417,v=2562383102,w=271733878,o=0;o<x.length;o+=16)p=t,q=u,r=v,s=w,t=h(t,u,v,w,x[o+0],y,3614090360),w=h(w,t,u,v,x[o+1],z,3905402710),v=h(v,w,t,u,x[o+2],A,606105819),u=h(u,v,w,t,x[o+3],B,3250441966),t=h(t,u,v,w,x[o+4],y,4118548399),w=h(w,t,u,v,x[o+5],z,1200080426),v=h(v,w,t,u,x[o+6],A,2821735955),u=h(u,v,w,t,x[o+7],B,4249261313),t=h(t,u,v,w,x[o+8],y,1770035416),w=h(w,t,u,v,x[o+9],z,2336552879),v=h(v,w,t,u,x[o+10],A,4294925233),u=h(u,v,w,t,x[o+11],B,2304563134),t=h(t,u,v,w,x[o+12],y,1804603682),w=h(w,t,u,v,x[o+13],z,4254626195),v=h(v,w,t,u,x[o+14],A,2792965006),u=h(u,v,w,t,x[o+15],B,1236535329),t=i(t,u,v,w,x[o+1],C,4129170786),w=i(w,t,u,v,x[o+6],D,3225465664),v=i(v,w,t,u,x[o+11],E,643717713),u=i(u,v,w,t,x[o+0],F,3921069994),t=i(t,u,v,w,x[o+5],C,3593408605),w=i(w,t,u,v,x[o+10],D,38016083),v=i(v,w,t,u,x[o+15],E,3634488961),u=i(u,v,w,t,x[o+4],F,3889429448),t=i(t,u,v,w,x[o+9],C,568446438),w=i(w,t,u,v,x[o+14],D,3275163606),v=i(v,w,t,u,x[o+3],E,4107603335),u=i(u,v,w,t,x[o+8],F,1163531501),t=i(t,u,v,w,x[o+13],C,2850285829),w=i(w,t,u,v,x[o+2],D,4243563512),v=i(v,w,t,u,x[o+7],E,1735328473),u=i(u,v,w,t,x[o+12],F,2368359562),t=j(t,u,v,w,x[o+5],G,4294588738),w=j(w,t,u,v,x[o+8],H,2272392833),v=j(v,w,t,u,x[o+11],I,1839030562),u=j(u,v,w,t,x[o+14],J,4259657740),t=j(t,u,v,w,x[o+1],G,2763975236),w=j(w,t,u,v,x[o+4],H,1272893353),v=j(v,w,t,u,x[o+7],I,4139469664),u=j(u,v,w,t,x[o+10],J,3200236656),t=j(t,u,v,w,x[o+13],G,681279174),w=j(w,t,u,v,x[o+0],H,3936430074),v=j(v,w,t,u,x[o+3],I,3572445317),u=j(u,v,w,t,x[o+6],J,76029189),t=j(t,u,v,w,x[o+9],G,3654602809),w=j(w,t,u,v,x[o+12],H,3873151461),v=j(v,w,t,u,x[o+15],I,530742520),u=j(u,v,w,t,x[o+2],J,3299628645),t=k(t,u,v,w,x[o+0],K,4096336452),w=k(w,t,u,v,x[o+7],L,1126891415),v=k(v,w,t,u,x[o+14],M,2878612391),u=k(u,v,w,t,x[o+5],N,4237533241),t=k(t,u,v,w,x[o+12],K,1700485571),w=k(w,t,u,v,x[o+3],L,2399980690),v=k(v,w,t,u,x[o+10],M,4293915773),u=k(u,v,w,t,x[o+1],N,2240044497),t=k(t,u,v,w,x[o+8],K,1873313359),w=k(w,t,u,v,x[o+15],L,4264355552),v=k(v,w,t,u,x[o+6],M,2734768916),u=k(u,v,w,t,x[o+13],N,1309151649),t=k(t,u,v,w,x[o+4],K,4149444226),w=k(w,t,u,v,x[o+11],L,3174756917),v=k(v,w,t,u,x[o+2],M,718787259),u=k(u,v,w,t,x[o+9],N,3951481745),t=c(t,p),u=c(u,q),v=c(v,r),w=c(w,s);var O=m(t)+m(u)+m(v)+m(w);return O.toLowerCase()}},b.Utils=c}(b),function(a){function b(){return"sip"!==l.s("to").uri.scheme?(j(416),!1):void 0}function c(){return l.to_tag||l.call_id.substr(0,5)!==m.configuration.jssip_id?void 0:(j(482),!1)}function d(){var b=a.Utils.str_utf8_length(l.body),c=l.getHeader("content-length");return c>b?(j(400),!1):void 0}function e(){var b,c,d=l.from_tag,e=l.call_id,f=l.cseq;if(!l.to_tag)if(l.method===a.C.INVITE){if(b=m.transactions.ist[l.via_branch],!b)return;for(c in m.transactions.ist)if(b=m.transactions.ist[c],b.request.from_tag===d&&b.request.call_id===e&&b.request.cseq===f)return j(482),!1}else{if(b=m.transactions.nist[l.via_branch],!b)return;for(c in m.transactions.nist)if(b=m.transactions.nist[c],b.request.from_tag===d&&b.request.call_id===e&&b.request.cseq===f)return j(482),!1}}function f(){return l.countHeader("via")>1?(console.warn(o+"More than one Via header field present in the response. Dropping the response"),!1):void 0}function g(){var a=m.configuration.via_host;return l.via.host!==a?(console.warn(o+"Via host in the response does not match UA Via host value. Dropping the response"),!1):void 0}function h(){var b=a.Utils.str_utf8_length(l.body),c=l.getHeader("content-length");return c>b?(console.warn(o+"Message body length is lower than the value in Content-Length header field. Dropping the response"),!1):void 0}function i(){for(var a=["from","to","call_id","cseq","via"],b=a.length;b--;)if(!l.hasHeader(a[b]))return console.warn(o+"Missing mandatory header field : "+a[b]+". Dropping the response"),!1}function j(b){var c,d="SIP/2.0 "+b+" "+a.C.REASON_PHRASE[b]+"\r\n",e=l.countHeader("via"),f=0;for(f;e>f;f++)d+="Via: "+l.getHeader("via",f)+"\r\n";c=l.getHeader("To"),l.to_tag||(c+=";tag="+a.Utils.newTag()),d+="To: "+c+"\r\n",d+="From: "+l.getHeader("From")+"\r\n",d+="Call-ID: "+l.call_id+"\r\n",d+="CSeq: "+l.cseq+" "+l.method+"\r\n",d+="\r\n",n.send(d)}var k,l,m,n,o=a.name+" | "+"SANITY CHECK"+" | ",p=[],q=[],r=[];p.push(b),p.push(c),p.push(d),p.push(e),q.push(f),q.push(g),q.push(h),r.push(i),k=function(b,c,d){var e,f;for(l=b,m=c,n=d,e=r.length;e--;)if(f=r[e](l),f===!1)return!1;if(l instanceof a.IncomingRequest){for(e=p.length;e--;)if(f=p[e](l),f===!1)return!1}else if(l instanceof a.IncomingResponse)for(e=q.length;e--;)if(f=q[e](l),f===!1)return!1;return!0},a.sanityCheck=k}(b),function(a){var b,c=a.name+" | "+"DIGEST AUTHENTICATION"+" | ";b=function(a){this.username=a.configuration.authorization_user,this.password=a.configuration.password,this.cnonce=null,this.nc=0,this.ncHex="00000000",this.response=null},b.prototype.authenticate=function(b,d){if(this.algorithm=d.algorithm,this.realm=d.realm,this.nonce=d.nonce,this.opaque=d.opaque,this.stale=d.stale,this.algorithm){if("MD5"!==this.algorithm)return console.warn(c+'challenge with Digest algorithm different than "MD5", authentication aborted'),!1}else this.algorithm="MD5";if(!this.realm)return console.warn(c+"challenge without Digest realm, authentication aborted"),!1;if(!this.nonce)return console.warn(c+"challenge without Digest nonce, authentication aborted"),!1;if(d.qop)if(d.qop.indexOf("auth")>-1)this.qop="auth";else{if(!(d.qop.indexOf("auth-int")>-1))return console.warn(c+'challenge without Digest qop different than "auth" or "auth-int", authentication aborted'),!1;this.qop="auth-int"}else this.qop=null;return this.method=b.method,this.uri=b.ruri,this.cnonce=a.Utils.createRandomToken(12),this.nc+=1,this.updateNcHex(),4294967296===this.nc&&(this.nc=1,this.ncHex="00000001"),this.calculateResponse(),!0},b.prototype.calculateResponse=function(){var b,c;b=a.Utils.calculateMD5(this.username+":"+this.realm+":"+this.password),"auth"===this.qop?(c=a.Utils.calculateMD5(this.method+":"+this.uri),this.response=a.Utils.calculateMD5(b+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth:"+c)):"auth-int"===this.qop?(c=a.Utils.calculateMD5(this.method+":"+this.uri+":"+a.Utils.calculateMD5(this.body?this.body:"")),this.response=a.Utils.calculateMD5(b+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth-int:"+c)):null===this.qop&&(c=a.Utils.calculateMD5(this.method+":"+this.uri),this.response=a.Utils.calculateMD5(b+":"+this.nonce+":"+c))},b.prototype.toString=function(){var a=[];if(!this.response)throw new Error("response field does not exist, cannot generate Authorization header");return a.push("algorithm="+this.algorithm),a.push('username="'+this.username+'"'),a.push('realm="'+this.realm+'"'),a.push('nonce="'+this.nonce+'"'),a.push('uri="'+this.uri+'"'),a.push('response="'+this.response+'"'),this.opaque&&a.push('opaque="'+this.opaque+'"'),this.qop&&(a.push("qop="+this.qop),a.push('cnonce="'+this.cnonce+'"'),a.push("nc="+this.ncHex)),"Digest "+a.join(", ")},b.prototype.updateNcHex=function(){var a=Number(this.nc).toString(16);this.ncHex="00000000".substr(0,8-a.length)+a},a.DigestAuthentication=b}(b),function(b){var c;c={},a.navigator.webkitGetUserMedia?c.getUserMedia=a.navigator.webkitGetUserMedia.bind(navigator):a.navigator.mozGetUserMedia?c.getUserMedia=a.navigator.mozGetUserMedia.bind(navigator):a.navigator.getUserMedia&&(c.getUserMedia=a.navigator.getUserMedia.bind(navigator)),a.webkitRTCPeerConnection?c.RTCPeerConnection=a.webkitRTCPeerConnection:a.mozRTCPeerConnection?c.RTCPeerConnection=a.mozRTCPeerConnection:a.RTCPeerConnection&&(c.RTCPeerConnection=a.RTCPeerConnection),a.webkitRTCSessionDescription?c.RTCSessionDescription=a.webkitRTCSessionDescription:a.mozRTCSessionDescription?c.RTCSessionDescription=a.mozRTCSessionDescription:a.RTCSessionDescription&&(c.RTCSessionDescription=a.RTCSessionDescription),c.RTCPeerConnection&&c.RTCPeerConnection.prototype&&(c.RTCPeerConnection.prototype.getLocalStreams||(c.RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},c.RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})),c.isSupported=c.getUserMedia&&c.RTCPeerConnection&&c.RTCSessionDescription?!0:!1,b.WebRTC=c}(b),function(a){var b,c=a.name+" | "+"REFER"+" | ",d=18e4;b=function(a){var b=["accepted","failed","notify"];this.ua=a,this.targetDialog=null,this.closed=!1,this.request=null,this.local_tag=null,this.remote_tag=null,this.id=null,this.contact=null,this.notify_timer=null,this.dialog=null,this.subscription_state="pending",this.subscription_expires=null,this.expire_timer=null,this.last_notify_body=null,this.accepted=!1,this.rejected=!1,this.direction=null,this.local_identity=null,this.remote_identity=null,this.refer_uri=null,this.data={},this.initEvents(b)
},b.prototype=new a.EventEmitter,b.prototype.send=function(b,d,e){var f,g,h,i,j,k,l=null;if(void 0===b||void 0===d)throw new TypeError("Not enough arguments");e=e||{},j=e.extraHeaders||[],i=e.eventHandlers||{},h=e.contentType||"text/plain";for(g in i)this.on(g,i[g]);try{b=a.Utils.normalizeURI(b,this.ua.configuration.hostport_params)}catch(m){b=a.URI.parse(a.C.INVALID_TARGET_URI),l=a.C.causes.INVALID_TARGET}try{d=a.Utils.normalizeURI(d,this.ua.configuration.hostport_params)}catch(m){d=a.URI.parse(a.C.INVALID_TARGET_URI),l=a.C.causes.INVALID_REFER_TO_TARGET}this.direction="outgoing",this.local_identity=this.ua.configuration.uri,this.remote_identity=b,this.refer_uri=d,this.local_tag=a.Utils.newTag(),this.contact=this.ua.contact.toString({outbound:!0}),k=new a.OutgoingRequest(a.C.REFER,b,this.ua,{from_tag:this.local_tag},j,e.body),this.request=k,this.id=k.call_id+this.local_tag,this.ua.refers[this.id]=this,k.setHeader("contact",this.contact),k.setHeader("refer-to",d),e.targetDialog&&(this.targetDialog=e.targetDialog,k.setHeader("require",a.C.SIP_EXTENSIONS.TARGET_DIALOG),k.setHeader("target-dialog",e.targetDialog.id.toTargetDialogHeader())),e.body&&k.setHeader("content-type",h),f=new a.RequestSender(this,this.ua),this.ua.emit("newRefer",this.ua,{originator:"local",refer:this,request:this.request}),l?this.emit("failed",this,{originator:"local",cause:l}):(f.send(),console.log(c+this.id+" sent"),this.notify_timer=setTimeout(this.onNotifyTimeout.bind(this),a.Timers.TIMER_F))},b.prototype.receiveResponse=function(b){var d;if(!this.closed)switch(!0){case/^1[0-9]{2}$/.test(b.status_code):break;case/^2[0-9]{2}$/.test(b.status_code):console.log(c+this.id+" accepted"),this.emit("accepted",this,{originator:"remote",response:b});break;default:console.log(c+this.id+" rejected (early)"),this.close(),d=a.Utils.sipErrorCause(b.status_code),this.emit("failed",this,{originator:"remote",message:b,cause:d})}},b.prototype.onRequestTimeout=function(){this.closed||(console.log(c+this.id+" request timeout"),this.close(),this.emit("failed",this,{originator:"system",cause:a.C.causes.REQUEST_TIMEOUT}))},b.prototype.onTransportError=function(){this.closed||(console.log(c+this.id+" transport error"),this.close(),this.emit("failed",this,{originator:"system",cause:a.C.causes.CONNECTION_ERROR}))},b.prototype.onNotifyTimeout=function(){this.closed||"pending"!==this.subscription_state||(console.log(c+this.id+" notify timeout"),this.emitFinalNotify(),this.close())},b.prototype.emitFinalNotify=function(){var b,c=this.last_notify_body;c||(c=a.Parser.parseMessage("SIP/2.0 100 Trying\r\n",!0)),b=c.status_code<200?"progress":c.status_code<300?"started":"failed",this.emit("notify",this,{originator:"system",request:null,sipFrag:c,sessionEvent:b,finalNotify:!0})},b.prototype.close=function(){"active"===this.subscription_state&&(console.warn(c+this.id+" closed with active subscription"),"incoming"===this.direction?this.notify({body:this.last_notify_body,finalNotify:!0}):this.emitFinalNotify()),null!==this.expire_timer&&(clearTimeout(this.expire_timer),this.expire_timer=null),null!==this.notify_timer&&(clearTimeout(this.notify_timer),this.notify_timer=null),this.dialog&&(this.dialog.terminate(),delete this.dialog),this.closed=!0,delete this.ua.refers[this],console.log(c+this.id+" closed")},b.prototype.subscriptionExpired=function(){"terminated"!==this.subscription_state&&(this.notify({body:this.last_notify_body,finalNotify:!0,terminateReason:"timeout"}),this.expire_timer=null,console.log(c+this.id+" subscription expired"))},b.prototype.init_incoming=function(b){var d=null;if(this.direction="incoming",this.request=b,this.remote_tag=b.from_tag,this.id=b.call_id+b.from_tag,this.contact=this.ua.contact.toString(),this.local_identity=b.to.uri,this.remote_identity=b.from.uri,!b.hasHeader("refer-to"))return b.reply(400,"Missing Refer-To header field"),void 0;if(b.countHeader("refer-to")>1)return b.reply(400,"Too many Refer-To header fields"),void 0;if(this.refer_uri=b.parseHeader("refer-to").uri,b.hasHeader("target-dialog")){var e=b.parseHeader("target-dialog"),f=new a.DialogId(e.call_id,e.local_tag,e.remote_tag);this.targetDialog=this.ua.dialogs[f.toString()]||null}return this.targetDialog&&this.targetDialog.isConfirmed()&&(d=this.targetDialog.owner,(d.dialog!==this.targetDialog||!d instanceof a.RTCSession)&&(d=null)),this.local_tag=b.to_tag=a.Utils.newTag(),this.dialog=new a.Dialog(this,b,"UAS"),this.dialog.id?(this.ua.refers[this.id]=this,console.log(c+this.id+" received"),this.ua.emit("newRefer",this.ua,{originator:"remote",refer:this,request:b,session:d}),this.accepted||this.rejected||this.accept(),void 0):(b.reply(500,"Missing Contact header field"),void 0)},b.prototype.call=function(b){var c,d=this.refer_uri;if(d.scheme!==a.C.SIP)throw new a.Exceptions.InvalidTargetError(d);return this.accepted||this.accept(),c=new a.RTCSession(this.ua),c.connect(d,b),this.addSessionNotifyHandlers(c),c},b.prototype.addSessionNotifyHandlers=function(b){var c=this;b.on("progress",function(a){var b=a.data.response;c.notify({status_code:b.status_code,reason_phrase:b.reason_phrase})}),b.once("started",function(a){var b=a.data.response;c.notify({status_code:b.status_code,reason_phrase:b.reason_phrase}),c.close()}),b.once("failed",function(b){var d=500,e=null,f=b.data.message;f&&f instanceof a.IncomingResponse&&(d=f.status_code,e=f.reason_phrase),c.notify({status_code:d,reason_phrase:e}),c.close()})},b.prototype.accept=function(a){a=a||{};var b=a.extraHeaders||[],e=a.body;if("incoming"!==this.direction)throw new TypeError('Invalid method "accept" for an outgoing refer');this.closed||(this.subscription_state="active",this.subscription_expires=Date.now()+d,this.expire_timer=setTimeout(this.subscriptionExpired.bind(this),d),b.push("Contact: "+this.contact),this.request.reply(202,null,b,e),this.notify(),this.accepted=!0,console.log(c+this.id+" accepted"))},b.prototype.reject=function(a){a=a||{};var b=a.status_code||603,d=a.reason_phrase,e=a.extraHeaders||[],f=a.body;if("incoming"!==this.direction)throw new TypeError('Invalid method "reject" for an outgoing refer');if(300>b||b>=700)throw new TypeError("Invalid status_code: "+b);this.closed||(this.accepted?(console.log(c+this.id+" rejected (late)"),this.notify({status_code:b,reason_phrase:d})):(console.log(c+this.id+" rejected (early)"),this.request.reply(b,d,e,f),this.rejected=!0),this.close())},b.prototype.notify=function(b){var d,e,f,g,h,i,j,k,l=this;if("incoming"!==this.direction)throw new TypeError('Invalid method "notify" for an outgoing refer');if(b=b||{},b.body&&"undefined"==typeof b.finalNotify)throw new TypeError("Must specify finalNotify when providing notify body");"active"===this.subscription_state&&(d=b.status_code||100,e=b.reason_phrase||a.C.REASON_PHRASE[d]||"",f=b.finalNotify||d>=200,f?(g="terminated",h=b.terminateReason||"noresource",i=g+";reason="+h):(g="active",i=g+";expires="+Math.round((this.subscription_expires-Date.now())/1e3)),j=b.body||"SIP/2.0 "+d+" "+e+"\r\n",this.last_notify_body=j,k=new a.Notify(this),k.send("refer",i,{extraHeaders:b.extraHeaders,eventHandlers:b.eventHandlers,content_type:"message/sipfrag",body:j}),this.subscription_state=g,f||k.on("failed",function(){l.subscription_state="terminated",console.log(c+l.id+" unsubscribed (rejected notify)"),l.close()}))},b.prototype.receiveRequest=function(b){switch(b.method){case a.C.NOTIFY:return this.receiveNotify(b),void 0;case a.C.SUBSCRIBE:return this.receiveSubscribe(b),void 0}b.reply(405,null,["Allow: "+a.Utils.getAllowedMethods(this.ua)])},b.prototype.receiveNotify=function(b){var d,e,f,g,h,i,j,k=!1;return"outgoing"!==this.direction||"active"!==this.subscription_state&&"pending"!==this.subscription_state?(b.reply(481,"Subscription Does Not Exist"),void 0):(d=b.parseHeader("event"),d&&"refer"===d.event?(e=b.parseHeader("subscription-state"))?(f=b.getHeader("content-type"),f&&f.indexOf("message/sipfrag")<0?(b.reply(415),this.close(),void 0):(j=b.body,/\r\n$/.test(j)||(j+="\r\n"),g=a.Parser.parseMessage(j,!0),!g||!g instanceof a.IncomingResponse?(b.reply(400,"Bad Message Body"),this.close(),void 0):0===this.listeners("notify").length?(console.log(c+this.id+" no notify listeners; unsubscribing"),b.reply(603),this.subscription_state="terminated",this.close(),void 0):this.dialog||(this.remote_tag=b.from_tag,this.dialog=new a.Dialog(this,b,"UAS"),this.dialog.id)?(this.subscription_state=e.state,this.subscription_expires=Date.now()+1e3*e.expires,this.last_notify_body=g,null!==this.notify_timer&&(clearTimeout(this.notify_timer),this.notify_timer=null),null!==this.expire_timer&&(clearTimeout(this.expire_timer),this.expire_timer=null),i=["Contact: "+this.contact],b.reply(200,null,i),h=g.status_code<200?"progress":g.status_code<300?"started":"failed",console.log(c+this.id+" notify: "+h),"terminated"===this.subscription_state?(k=!0,this.close()):this.expire_timer=setTimeout(this.close.bind(this),1e3*(e.expires+a.Timers.T4)),this.emit("notify",this,{originator:"remote",request:b,sipFrag:g,sessionEvent:h,finalNotify:k}),void 0):(console.warn(c+this.id+" dialog creation failed"),this.close(),this.emit("failed",this,{originator:"remote",message:b,cause:a.C.causes.INTERNAL_ERROR}),void 0))):(b.reply(400,"Missing Subscription-State Header"),this.close(),void 0):(b.reply(489),this.close(),void 0))},b.prototype.receiveSubscribe=function(a){var b,e,f;return"incoming"!==this.direction?(a.reply(481),void 0):"active"!==this.subscription_state&&"terminated"!==this.subscription_state?(a.reply(403),void 0):(b=a.parseHeader("event"),b&&"refer"===b.event?(e=a.parseHeader("expires"),0===e?(console.log(c+this.id+" unsubscribed (expires=0)"),this.notify({body:this.last_notify_body,finalNotify:!0}),f=["Contact: "+this.contact],a.reply(200,null,f),this.close(),void 0):(e=e>0?1e3*e:d,this.subscription_state="active",this.subscription_expires=Date.now()+e,null!==this.expire_timer&&clearTimeout(this.expire_timer),this.expire_timer=setTimeout(this.subscriptionExpired.bind(this),e),f=["Contact: "+this.contact,"Expires: "+e/1e3],a.reply(200,null,f),console.log(c+this.id+" subscription extended"),void 0)):(a.reply(489),void 0))},a.Refer=b}(b),function(a){var b;b=function(a){var b=["succeeded","failed"];this.session=a,this.direction=null,this.request=null,this.initEvents(b)},b.prototype=new a.EventEmitter,b.prototype.send=function(b,c,d){var e,f,g,h,i;if(this.direction="outgoing","active"!==this.session.subscription_state&&"pending"!==this.session.subscription_state)throw new a.Exceptions.InvalidStateError(this.session.subscription_state);d=d||{},h=d.extraHeaders?d.extraHeaders.slice():[],g=d.eventHandlers||{};for(f in g)this.on(f,g[f]);i=this.session.dialog.createRequest(a.C.NOTIFY,h),this.request=i,i.setHeader("contact",this.session.contact),i.setHeader("event",b),i.setHeader("subscription-state",c),d.content_type&&i.setHeader("content-type",d.content_type),d.body&&(i.body=d.body),e=new a.RequestSender(this,this.session.ua),this.session.emit("notify",this.session,{originator:"local",notify:this,request:i}),e.send()},b.prototype.receiveResponse=function(b){var c;if("terminated"!==this.session.subscription_state)switch(!0){case/^1[0-9]{2}$/.test(b.status_code):break;case/^2[0-9]{2}$/.test(b.status_code):this.emit("succeeded",this,{originator:"remote",response:b});break;default:c=a.Utils.sipErrorCause(b.status_code),this.emit("failed",this,{originator:"remote",response:b,cause:c})}},b.prototype.onRequestTimeout=function(){this.emit("failed",this,{originator:"system",cause:a.C.causes.REQUEST_TIMEOUT})},b.prototype.onTransportError=function(){this.emit("failed",this,{originator:"system",cause:a.C.causes.CONNECTION_ERROR})},a.Notify=b}(b),a.JsSIP=b}(window),JsSIP.Grammar=function(){function a(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var b={parse:function(b,c){function d(a){xe>ve||(ve>xe&&(xe=ve,ye=[]),ye.push(a))}function e(){var a;return"\r\n"===b.substr(ve,2)?(a="\r\n",ve+=2):(a=null,0===we&&d('"\\r\\n"')),a}function f(){var a;return/^[0-9]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[0-9]")),a}function g(){var a;return/^[a-zA-Z]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[a-zA-Z]")),a}function h(){var a;return/^[0-9a-fA-F]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[0-9a-fA-F]")),a}function i(){var a;return a=l(),null===a&&(a=m()),a}function j(){var a;return/^[\0-\xFF]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[\\0-\\xFF]")),a}function k(){var a;return/^["]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d('["]')),a}function l(){var a;return 32===b.charCodeAt(ve)?(a=" ",ve++):(a=null,0===we&&d('" "')),a}function m(){var a;return 9===b.charCodeAt(ve)?(a="	",ve++):(a=null,0===we&&d('"\\t"')),a}function n(){var a;return/^[a-zA-Z0-9]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[a-zA-Z0-9]")),a}function o(){var a;return 59===b.charCodeAt(ve)?(a=";",ve++):(a=null,0===we&&d('";"')),null===a&&(47===b.charCodeAt(ve)?(a="/",ve++):(a=null,0===we&&d('"/"')),null===a&&(63===b.charCodeAt(ve)?(a="?",ve++):(a=null,0===we&&d('"?"')),null===a&&(58===b.charCodeAt(ve)?(a=":",ve++):(a=null,0===we&&d('":"')),null===a&&(64===b.charCodeAt(ve)?(a="@",ve++):(a=null,0===we&&d('"@"')),null===a&&(38===b.charCodeAt(ve)?(a="&",ve++):(a=null,0===we&&d('"&"')),null===a&&(61===b.charCodeAt(ve)?(a="=",ve++):(a=null,0===we&&d('"="')),null===a&&(43===b.charCodeAt(ve)?(a="+",ve++):(a=null,0===we&&d('"+"')),null===a&&(36===b.charCodeAt(ve)?(a="$",ve++):(a=null,0===we&&d('"$"')),null===a&&(44===b.charCodeAt(ve)?(a=",",ve++):(a=null,0===we&&d('","'))))))))))),a}function p(){var a;return a=n(),null===a&&(a=q()),a}function q(){var a;return 45===b.charCodeAt(ve)?(a="-",ve++):(a=null,0===we&&d('"-"')),null===a&&(95===b.charCodeAt(ve)?(a="_",ve++):(a=null,0===we&&d('"_"')),null===a&&(46===b.charCodeAt(ve)?(a=".",ve++):(a=null,0===we&&d('"."')),null===a&&(33===b.charCodeAt(ve)?(a="!",ve++):(a=null,0===we&&d('"!"')),null===a&&(126===b.charCodeAt(ve)?(a="~",ve++):(a=null,0===we&&d('"~"')),null===a&&(42===b.charCodeAt(ve)?(a="*",ve++):(a=null,0===we&&d('"*"')),null===a&&(39===b.charCodeAt(ve)?(a="'",ve++):(a=null,0===we&&d('"\'"')),null===a&&(40===b.charCodeAt(ve)?(a="(",ve++):(a=null,0===we&&d('"("')),null===a&&(41===b.charCodeAt(ve)?(a=")",ve++):(a=null,0===we&&d('")"')))))))))),a}function r(){var a,c,e,f;return f=ve,37===b.charCodeAt(ve)?(a="%",ve++):(a=null,0===we&&d('"%"')),null!==a?(c=h(),null!==c?(e=h(),null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function s(){var a,b,c,d,f,g;for(d=ve,f=ve,g=ve,a=[],b=i();null!==b;)a.push(b),b=i();if(null!==a?(b=e(),null!==b?a=[a,b]:(a=null,ve=g)):(a=null,ve=g),a=null!==a?a:"",null!==a){if(c=i(),null!==c)for(b=[];null!==c;)b.push(c),c=i();else b=null;null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(){return" "}(d)),null===a&&(ve=d),a}function t(){var a;return a=s(),a=null!==a?a:""}function u(){var a,c,e,f,g;for(f=ve,g=ve,a=[],c=l(),null===c&&(c=m());null!==c;)a.push(c),c=l(),null===c&&(c=m());return null!==a?(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return":"}(f)),null===a&&(ve=f),a}function v(){var a,c,d,e,f,g,h;if(f=ve,g=ve,c=w(),null!==c)for(a=[];null!==c;)a.push(c),c=w();else a=null;if(null!==a){for(c=[],h=ve,d=[],e=s();null!==e;)d.push(e),e=s();for(null!==d?(e=w(),null!==e?d=[d,e]:(d=null,ve=h)):(d=null,ve=h);null!==d;){for(c.push(d),h=ve,d=[],e=s();null!==e;)d.push(e),e=s();null!==d?(e=w(),null!==e?d=[d,e]:(d=null,ve=h)):(d=null,ve=h)}null!==c?a=[a,c]:(a=null,ve=g)}else a=null,ve=g;return null!==a&&(a=function(a){return b.substring(ve,a)}(f)),null===a&&(ve=f),a}function w(){var a;return/^[!-~]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[!-~]")),null===a&&(a=x()),a}function x(){var a;return/^[\x80-\uFFFF]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[\\x80-\\uFFFF]")),a}function y(){var a;return/^[\x80-\xBF]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[\\x80-\\xBF]")),a}function z(){var a;return a=f(),null===a&&(/^[a-f]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[a-f]"))),a}function A(){var a,c,e;if(e=ve,c=n(),null===c&&(45===b.charCodeAt(ve)?(c="-",ve++):(c=null,0===we&&d('"-"')),null===c&&(46===b.charCodeAt(ve)?(c=".",ve++):(c=null,0===we&&d('"."')),null===c&&(33===b.charCodeAt(ve)?(c="!",ve++):(c=null,0===we&&d('"!"')),null===c&&(37===b.charCodeAt(ve)?(c="%",ve++):(c=null,0===we&&d('"%"')),null===c&&(42===b.charCodeAt(ve)?(c="*",ve++):(c=null,0===we&&d('"*"')),null===c&&(95===b.charCodeAt(ve)?(c="_",ve++):(c=null,0===we&&d('"_"')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')),null===c&&(96===b.charCodeAt(ve)?(c="`",ve++):(c=null,0===we&&d('"`"')),null===c&&(39===b.charCodeAt(ve)?(c="'",ve++):(c=null,0===we&&d('"\'"')),null===c&&(126===b.charCodeAt(ve)?(c="~",ve++):(c=null,0===we&&d('"~"')))))))))))),null!==c)for(a=[];null!==c;)a.push(c),c=n(),null===c&&(45===b.charCodeAt(ve)?(c="-",ve++):(c=null,0===we&&d('"-"')),null===c&&(46===b.charCodeAt(ve)?(c=".",ve++):(c=null,0===we&&d('"."')),null===c&&(33===b.charCodeAt(ve)?(c="!",ve++):(c=null,0===we&&d('"!"')),null===c&&(37===b.charCodeAt(ve)?(c="%",ve++):(c=null,0===we&&d('"%"')),null===c&&(42===b.charCodeAt(ve)?(c="*",ve++):(c=null,0===we&&d('"*"')),null===c&&(95===b.charCodeAt(ve)?(c="_",ve++):(c=null,0===we&&d('"_"')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')),null===c&&(96===b.charCodeAt(ve)?(c="`",ve++):(c=null,0===we&&d('"`"')),null===c&&(39===b.charCodeAt(ve)?(c="'",ve++):(c=null,0===we&&d('"\'"')),null===c&&(126===b.charCodeAt(ve)?(c="~",ve++):(c=null,0===we&&d('"~"'))))))))))));else a=null;return null!==a&&(a=function(a){return b.substring(ve,a)}(e)),null===a&&(ve=e),a}function B(){var a,c,e;if(e=ve,c=n(),null===c&&(45===b.charCodeAt(ve)?(c="-",ve++):(c=null,0===we&&d('"-"')),null===c&&(33===b.charCodeAt(ve)?(c="!",ve++):(c=null,0===we&&d('"!"')),null===c&&(37===b.charCodeAt(ve)?(c="%",ve++):(c=null,0===we&&d('"%"')),null===c&&(42===b.charCodeAt(ve)?(c="*",ve++):(c=null,0===we&&d('"*"')),null===c&&(95===b.charCodeAt(ve)?(c="_",ve++):(c=null,0===we&&d('"_"')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')),null===c&&(96===b.charCodeAt(ve)?(c="`",ve++):(c=null,0===we&&d('"`"')),null===c&&(39===b.charCodeAt(ve)?(c="'",ve++):(c=null,0===we&&d('"\'"')),null===c&&(126===b.charCodeAt(ve)?(c="~",ve++):(c=null,0===we&&d('"~"'))))))))))),null!==c)for(a=[];null!==c;)a.push(c),c=n(),null===c&&(45===b.charCodeAt(ve)?(c="-",ve++):(c=null,0===we&&d('"-"')),null===c&&(33===b.charCodeAt(ve)?(c="!",ve++):(c=null,0===we&&d('"!"')),null===c&&(37===b.charCodeAt(ve)?(c="%",ve++):(c=null,0===we&&d('"%"')),null===c&&(42===b.charCodeAt(ve)?(c="*",ve++):(c=null,0===we&&d('"*"')),null===c&&(95===b.charCodeAt(ve)?(c="_",ve++):(c=null,0===we&&d('"_"')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')),null===c&&(96===b.charCodeAt(ve)?(c="`",ve++):(c=null,0===we&&d('"`"')),null===c&&(39===b.charCodeAt(ve)?(c="'",ve++):(c=null,0===we&&d('"\'"')),null===c&&(126===b.charCodeAt(ve)?(c="~",ve++):(c=null,0===we&&d('"~"')))))))))));else a=null;return null!==a&&(a=function(a){return b.substring(ve,a)}(e)),null===a&&(ve=e),a}function C(){var a;return 40===b.charCodeAt(ve)?(a="(",ve++):(a=null,0===we&&d('"("')),null===a&&(41===b.charCodeAt(ve)?(a=")",ve++):(a=null,0===we&&d('")"')),null===a&&(60===b.charCodeAt(ve)?(a="<",ve++):(a=null,0===we&&d('"<"')),null===a&&(62===b.charCodeAt(ve)?(a=">",ve++):(a=null,0===we&&d('">"')),null===a&&(64===b.charCodeAt(ve)?(a="@",ve++):(a=null,0===we&&d('"@"')),null===a&&(44===b.charCodeAt(ve)?(a=",",ve++):(a=null,0===we&&d('","')),null===a&&(59===b.charCodeAt(ve)?(a=";",ve++):(a=null,0===we&&d('";"')),null===a&&(58===b.charCodeAt(ve)?(a=":",ve++):(a=null,0===we&&d('":"')),null===a&&(92===b.charCodeAt(ve)?(a="\\",ve++):(a=null,0===we&&d('"\\\\"')),null===a&&(a=k(),null===a&&(47===b.charCodeAt(ve)?(a="/",ve++):(a=null,0===we&&d('"/"')),null===a&&(91===b.charCodeAt(ve)?(a="[",ve++):(a=null,0===we&&d('"["')),null===a&&(93===b.charCodeAt(ve)?(a="]",ve++):(a=null,0===we&&d('"]"')),null===a&&(63===b.charCodeAt(ve)?(a="?",ve++):(a=null,0===we&&d('"?"')),null===a&&(61===b.charCodeAt(ve)?(a="=",ve++):(a=null,0===we&&d('"="')),null===a&&(123===b.charCodeAt(ve)?(a="{",ve++):(a=null,0===we&&d('"{"')),null===a&&(125===b.charCodeAt(ve)?(a="}",ve++):(a=null,0===we&&d('"}"')),null===a&&(a=l(),null===a&&(a=m())))))))))))))))))),a}function D(){var a,c,e;if(e=ve,c=n(),null===c&&(45===b.charCodeAt(ve)?(c="-",ve++):(c=null,0===we&&d('"-"')),null===c&&(46===b.charCodeAt(ve)?(c=".",ve++):(c=null,0===we&&d('"."')),null===c&&(33===b.charCodeAt(ve)?(c="!",ve++):(c=null,0===we&&d('"!"')),null===c&&(37===b.charCodeAt(ve)?(c="%",ve++):(c=null,0===we&&d('"%"')),null===c&&(42===b.charCodeAt(ve)?(c="*",ve++):(c=null,0===we&&d('"*"')),null===c&&(95===b.charCodeAt(ve)?(c="_",ve++):(c=null,0===we&&d('"_"')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')),null===c&&(96===b.charCodeAt(ve)?(c="`",ve++):(c=null,0===we&&d('"`"')),null===c&&(39===b.charCodeAt(ve)?(c="'",ve++):(c=null,0===we&&d('"\'"')),null===c&&(126===b.charCodeAt(ve)?(c="~",ve++):(c=null,0===we&&d('"~"')),null===c&&(40===b.charCodeAt(ve)?(c="(",ve++):(c=null,0===we&&d('"("')),null===c&&(41===b.charCodeAt(ve)?(c=")",ve++):(c=null,0===we&&d('")"')),null===c&&(60===b.charCodeAt(ve)?(c="<",ve++):(c=null,0===we&&d('"<"')),null===c&&(62===b.charCodeAt(ve)?(c=">",ve++):(c=null,0===we&&d('">"')),null===c&&(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null===c&&(92===b.charCodeAt(ve)?(c="\\",ve++):(c=null,0===we&&d('"\\\\"')),null===c&&(c=k(),null===c&&(47===b.charCodeAt(ve)?(c="/",ve++):(c=null,0===we&&d('"/"')),null===c&&(91===b.charCodeAt(ve)?(c="[",ve++):(c=null,0===we&&d('"["')),null===c&&(93===b.charCodeAt(ve)?(c="]",ve++):(c=null,0===we&&d('"]"')),null===c&&(63===b.charCodeAt(ve)?(c="?",ve++):(c=null,0===we&&d('"?"')),null===c&&(123===b.charCodeAt(ve)?(c="{",ve++):(c=null,0===we&&d('"{"')),null===c&&(125===b.charCodeAt(ve)?(c="}",ve++):(c=null,0===we&&d('"}"'))))))))))))))))))))))))),null!==c)for(a=[];null!==c;)a.push(c),c=n(),null===c&&(45===b.charCodeAt(ve)?(c="-",ve++):(c=null,0===we&&d('"-"')),null===c&&(46===b.charCodeAt(ve)?(c=".",ve++):(c=null,0===we&&d('"."')),null===c&&(33===b.charCodeAt(ve)?(c="!",ve++):(c=null,0===we&&d('"!"')),null===c&&(37===b.charCodeAt(ve)?(c="%",ve++):(c=null,0===we&&d('"%"')),null===c&&(42===b.charCodeAt(ve)?(c="*",ve++):(c=null,0===we&&d('"*"')),null===c&&(95===b.charCodeAt(ve)?(c="_",ve++):(c=null,0===we&&d('"_"')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')),null===c&&(96===b.charCodeAt(ve)?(c="`",ve++):(c=null,0===we&&d('"`"')),null===c&&(39===b.charCodeAt(ve)?(c="'",ve++):(c=null,0===we&&d('"\'"')),null===c&&(126===b.charCodeAt(ve)?(c="~",ve++):(c=null,0===we&&d('"~"')),null===c&&(40===b.charCodeAt(ve)?(c="(",ve++):(c=null,0===we&&d('"("')),null===c&&(41===b.charCodeAt(ve)?(c=")",ve++):(c=null,0===we&&d('")"')),null===c&&(60===b.charCodeAt(ve)?(c="<",ve++):(c=null,0===we&&d('"<"')),null===c&&(62===b.charCodeAt(ve)?(c=">",ve++):(c=null,0===we&&d('">"')),null===c&&(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null===c&&(92===b.charCodeAt(ve)?(c="\\",ve++):(c=null,0===we&&d('"\\\\"')),null===c&&(c=k(),null===c&&(47===b.charCodeAt(ve)?(c="/",ve++):(c=null,0===we&&d('"/"')),null===c&&(91===b.charCodeAt(ve)?(c="[",ve++):(c=null,0===we&&d('"["')),null===c&&(93===b.charCodeAt(ve)?(c="]",ve++):(c=null,0===we&&d('"]"')),null===c&&(63===b.charCodeAt(ve)?(c="?",ve++):(c=null,0===we&&d('"?"')),null===c&&(123===b.charCodeAt(ve)?(c="{",ve++):(c=null,0===we&&d('"{"')),null===c&&(125===b.charCodeAt(ve)?(c="}",ve++):(c=null,0===we&&d('"}"')))))))))))))))))))))))));else a=null;return null!==a&&(a=function(a){return b.substring(ve,a)}(e)),null===a&&(ve=e),a}function E(){var a,c,e,f,g;return f=ve,g=ve,a=t(),null!==a?(42===b.charCodeAt(ve)?(c="*",ve++):(c=null,0===we&&d('"*"')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return"*"}(f)),null===a&&(ve=f),a}function F(){var a,c,e,f,g;return f=ve,g=ve,a=t(),null!==a?(47===b.charCodeAt(ve)?(c="/",ve++):(c=null,0===we&&d('"/"')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return"/"}(f)),null===a&&(ve=f),a}function G(){var a,c,e,f,g;return f=ve,g=ve,a=t(),null!==a?(61===b.charCodeAt(ve)?(c="=",ve++):(c=null,0===we&&d('"="')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return"="}(f)),null===a&&(ve=f),a}function H(){var a,c,e,f,g;return f=ve,g=ve,a=t(),null!==a?(40===b.charCodeAt(ve)?(c="(",ve++):(c=null,0===we&&d('"("')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return"("}(f)),null===a&&(ve=f),a}function I(){var a,c,e,f,g;return f=ve,g=ve,a=t(),null!==a?(41===b.charCodeAt(ve)?(c=")",ve++):(c=null,0===we&&d('")"')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return")"}(f)),null===a&&(ve=f),a}function J(){var a,c,e,f;return e=ve,f=ve,62===b.charCodeAt(ve)?(a=">",ve++):(a=null,0===we&&d('">"')),null!==a?(c=t(),null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),null!==a&&(a=function(){return">"}(e)),null===a&&(ve=e),a}function K(){var a,c,e,f;return e=ve,f=ve,a=t(),null!==a?(60===b.charCodeAt(ve)?(c="<",ve++):(c=null,0===we&&d('"<"')),null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),null!==a&&(a=function(){return"<"}(e)),null===a&&(ve=e),a}function L(){var a,c,e,f,g;return f=ve,g=ve,a=t(),null!==a?(44===b.charCodeAt(ve)?(c=",",ve++):(c=null,0===we&&d('","')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return","}(f)),null===a&&(ve=f),a}function M(){var a,c,e,f,g;return f=ve,g=ve,a=t(),null!==a?(59===b.charCodeAt(ve)?(c=";",ve++):(c=null,0===we&&d('";"')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return";"}(f)),null===a&&(ve=f),a}function N(){var a,c,e,f,g;return f=ve,g=ve,a=t(),null!==a?(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=t(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){return":"}(f)),null===a&&(ve=f),a}function O(){var a,b,c,d;return c=ve,d=ve,a=t(),null!==a?(b=k(),null!==b?a=[a,b]:(a=null,ve=d)):(a=null,ve=d),null!==a&&(a=function(){return'"'}(c)),null===a&&(ve=c),a}function P(){var a,b,c,d;return c=ve,d=ve,a=k(),null!==a?(b=t(),null!==b?a=[a,b]:(a=null,ve=d)):(a=null,ve=d),null!==a&&(a=function(){return'"'}(c)),null===a&&(ve=c),a}function Q(){var a,b,c,d;if(d=ve,a=H(),null!==a){for(b=[],c=R(),null===c&&(c=V(),null===c&&(c=Q()));null!==c;)b.push(c),c=R(),null===c&&(c=V(),null===c&&(c=Q()));null!==b?(c=I(),null!==c?a=[a,b,c]:(a=null,ve=d)):(a=null,ve=d)}else a=null,ve=d;return a}function R(){var a;return/^[!-']/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[!-']")),null===a&&(/^[*-[]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[*-[]")),null===a&&(/^[\]-~]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[\\]-~]")),null===a&&(a=x(),null===a&&(a=s())))),a}function S(){var a,c,d,e,f,g;if(f=ve,g=ve,a=t(),null!==a)if(c=k(),null!==c){for(d=[],e=U(),null===e&&(e=V());null!==e;)d.push(e),e=U(),null===e&&(e=V());null!==d?(e=k(),null!==e?a=[a,c,d,e]:(a=null,ve=g)):(a=null,ve=g)}else a=null,ve=g;else a=null,ve=g;return null!==a&&(a=function(a){return b.substring(ve,a)}(f)),null===a&&(ve=f),a}function T(){var a,c,d,e,f,g;if(f=ve,g=ve,a=t(),null!==a)if(c=k(),null!==c){for(d=[],e=U(),null===e&&(e=V());null!==e;)d.push(e),e=U(),null===e&&(e=V());null!==d?(e=k(),null!==e?a=[a,c,d,e]:(a=null,ve=g)):(a=null,ve=g)}else a=null,ve=g;else a=null,ve=g;return null!==a&&(a=function(a){return b.substring(ve-1,a+1)}(f)),null===a&&(ve=f),a}function U(){var a;return a=s(),null===a&&(33===b.charCodeAt(ve)?(a="!",ve++):(a=null,0===we&&d('"!"')),null===a&&(/^[#-[]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[#-[]")),null===a&&(/^[\]-~]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[\\]-~]")),null===a&&(a=x())))),a}function V(){var a,c,e;return e=ve,92===b.charCodeAt(ve)?(a="\\",ve++):(a=null,0===we&&d('"\\\\"')),null!==a?(/^[\0-\t]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[\\0-\\t]")),null===c&&(/^[\x0B-\f]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[\\x0B-\\f]")),null===c&&(/^[\x0E-]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[\\x0E-]")))),null!==c?a=[a,c]:(a=null,ve=e)):(a=null,ve=e),a}function W(){var a,c,e,f,g,h;return g=ve,h=ve,a=Y(),null!==a?(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=Z(),e=null!==e?e:"",null!==e?(f=bb(),null!==f?a=[a,c,e,f]:(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h),null!==a&&(a=function(){try{ze.uri=new JsSIP.URI(ze.scheme,ze.user,ze.host,ze.port),delete ze.scheme,delete ze.user,delete ze.host,delete ze.host_type,delete ze.port}catch(a){ze=-1}}(g)),null===a&&(ve=g),a}function X(){var a,e,f,g,h,i,j,k;return j=ve,k=ve,a=Y(),null!==a?(58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=Z(),f=null!==f?f:"",null!==f?(g=bb(),null!==g?(h=nb(),null!==h?(i=Ab(),i=null!==i?i:"",null!==i?a=[a,e,f,g,h,i]:(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k),null!==a&&(a=function(){try{ze.uri=new JsSIP.URI(ze.scheme,ze.user,ze.host,ze.port,ze.uri_params,ze.uri_headers),delete ze.scheme,delete ze.user,delete ze.host,delete ze.host_type,delete ze.port,delete ze.uri_params,"SIP_URI"===c&&(ze=ze.uri)}catch(a){ze=-1}}(j)),null===a&&(ve=j),a}function Y(){var a,c;return c=ve,"sip"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"sip"')),null!==a&&(a=function(a,b){ze.scheme=b.toLowerCase()}(c,a)),null===a&&(ve=c),a}function Z(){var a,c,e,f,g,h;return f=ve,g=ve,a=$(),null!==a?(h=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ab(),null!==e?c=[c,e]:(c=null,ve=h)):(c=null,ve=h),c=null!==c?c:"",null!==c?(64===b.charCodeAt(ve)?(e="@",ve++):(e=null,0===we&&d('"@"')),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a){ze.user=window.decodeURIComponent(b.substring(ve-1,a))}(f)),null===a&&(ve=f),a}function $(){var a,b;if(b=p(),null===b&&(b=r(),null===b&&(b=_())),null!==b)for(a=[];null!==b;)a.push(b),b=p(),null===b&&(b=r(),null===b&&(b=_()));else a=null;return a}function _(){var a;return 38===b.charCodeAt(ve)?(a="&",ve++):(a=null,0===we&&d('"&"')),null===a&&(61===b.charCodeAt(ve)?(a="=",ve++):(a=null,0===we&&d('"="')),null===a&&(43===b.charCodeAt(ve)?(a="+",ve++):(a=null,0===we&&d('"+"')),null===a&&(36===b.charCodeAt(ve)?(a="$",ve++):(a=null,0===we&&d('"$"')),null===a&&(44===b.charCodeAt(ve)?(a=",",ve++):(a=null,0===we&&d('","')),null===a&&(59===b.charCodeAt(ve)?(a=";",ve++):(a=null,0===we&&d('";"')),null===a&&(63===b.charCodeAt(ve)?(a="?",ve++):(a=null,0===we&&d('"?"')),null===a&&(47===b.charCodeAt(ve)?(a="/",ve++):(a=null,0===we&&d('"/"'))))))))),a}function ab(){var a,c,e;for(e=ve,a=[],c=p(),null===c&&(c=r(),null===c&&(38===b.charCodeAt(ve)?(c="&",ve++):(c=null,0===we&&d('"&"')),null===c&&(61===b.charCodeAt(ve)?(c="=",ve++):(c=null,0===we&&d('"="')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')),null===c&&(36===b.charCodeAt(ve)?(c="$",ve++):(c=null,0===we&&d('"$"')),null===c&&(44===b.charCodeAt(ve)?(c=",",ve++):(c=null,0===we&&d('","'))))))));null!==c;)a.push(c),c=p(),null===c&&(c=r(),null===c&&(38===b.charCodeAt(ve)?(c="&",ve++):(c=null,0===we&&d('"&"')),null===c&&(61===b.charCodeAt(ve)?(c="=",ve++):(c=null,0===we&&d('"="')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')),null===c&&(36===b.charCodeAt(ve)?(c="$",ve++):(c=null,0===we&&d('"$"')),null===c&&(44===b.charCodeAt(ve)?(c=",",ve++):(c=null,0===we&&d('","'))))))));
return null!==a&&(a=function(a){ze.password=b.substring(ve,a)}(e)),null===a&&(ve=e),a}function bb(){var a,c,e,f,g;return f=ve,a=cb(),null!==a?(g=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=mb(),null!==e?c=[c,e]:(c=null,ve=g)):(c=null,ve=g),c=null!==c?c:"",null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),a}function cb(){var a,c;return c=ve,a=db(),null===a&&(a=kb(),null===a&&(a=gb())),null!==a&&(a=function(a){return ze.host=b.substring(ve,a).toLowerCase(),ze.host}(c)),null===a&&(ve=c),a}function db(){var a,c,e,f,g,h;for(f=ve,g=ve,a=[],h=ve,c=eb(),null!==c?(46===b.charCodeAt(ve)?(e=".",ve++):(e=null,0===we&&d('"."')),null!==e?c=[c,e]:(c=null,ve=h)):(c=null,ve=h);null!==c;)a.push(c),h=ve,c=eb(),null!==c?(46===b.charCodeAt(ve)?(e=".",ve++):(e=null,0===we&&d('"."')),null!==e?c=[c,e]:(c=null,ve=h)):(c=null,ve=h);return null!==a?(c=fb(),null!==c?(46===b.charCodeAt(ve)?(e=".",ve++):(e=null,0===we&&d('"."')),e=null!==e?e:"",null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a){return ze.host_type="domain",b.substring(ve,a)}(f)),null===a&&(ve=f),a}function eb(){var a,c;if(/^[a-zA-Z0-9_\-]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[a-zA-Z0-9_\\-]")),null!==c)for(a=[];null!==c;)a.push(c),/^[a-zA-Z0-9_\-]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[a-zA-Z0-9_\\-]"));else a=null;return a}function fb(){var a,c;if(/^[a-zA-Z_\-]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[a-zA-Z_\\-]")),null!==c)for(a=[];null!==c;)a.push(c),/^[a-zA-Z_\-]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[a-zA-Z_\\-]"));else a=null;return a}function gb(){var a,c,e,f,g;return f=ve,g=ve,91===b.charCodeAt(ve)?(a="[",ve++):(a=null,0===we&&d('"["')),null!==a?(c=hb(),null!==c?(93===b.charCodeAt(ve)?(e="]",ve++):(e=null,0===we&&d('"]"')),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a){return ze.host_type="IPv6",b.substring(ve,a)}(f)),null===a&&(ve=f),a}function hb(){var a,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r;return p=ve,q=ve,a=ib(),null!==a?(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ib(),null!==e?(58===b.charCodeAt(ve)?(f=":",ve++):(f=null,0===we&&d('":"')),null!==f?(g=ib(),null!==g?(58===b.charCodeAt(ve)?(h=":",ve++):(h=null,0===we&&d('":"')),null!==h?(i=ib(),null!==i?(58===b.charCodeAt(ve)?(j=":",ve++):(j=null,0===we&&d('":"')),null!==j?(k=ib(),null!==k?(58===b.charCodeAt(ve)?(l=":",ve++):(l=null,0===we&&d('":"')),null!==l?(m=ib(),null!==m?(58===b.charCodeAt(ve)?(n=":",ve++):(n=null,0===we&&d('":"')),null!==n?(o=jb(),null!==o?a=[a,c,e,f,g,h,i,j,k,l,m,n,o]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,"::"===b.substr(ve,2)?(a="::",ve+=2):(a=null,0===we&&d('"::"')),null!==a?(c=ib(),null!==c?(58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?(58===b.charCodeAt(ve)?(g=":",ve++):(g=null,0===we&&d('":"')),null!==g?(h=ib(),null!==h?(58===b.charCodeAt(ve)?(i=":",ve++):(i=null,0===we&&d('":"')),null!==i?(j=ib(),null!==j?(58===b.charCodeAt(ve)?(k=":",ve++):(k=null,0===we&&d('":"')),null!==k?(l=ib(),null!==l?(58===b.charCodeAt(ve)?(m=":",ve++):(m=null,0===we&&d('":"')),null!==m?(n=jb(),null!==n?a=[a,c,e,f,g,h,i,j,k,l,m,n]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,"::"===b.substr(ve,2)?(a="::",ve+=2):(a=null,0===we&&d('"::"')),null!==a?(c=ib(),null!==c?(58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?(58===b.charCodeAt(ve)?(g=":",ve++):(g=null,0===we&&d('":"')),null!==g?(h=ib(),null!==h?(58===b.charCodeAt(ve)?(i=":",ve++):(i=null,0===we&&d('":"')),null!==i?(j=ib(),null!==j?(58===b.charCodeAt(ve)?(k=":",ve++):(k=null,0===we&&d('":"')),null!==k?(l=jb(),null!==l?a=[a,c,e,f,g,h,i,j,k,l]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,"::"===b.substr(ve,2)?(a="::",ve+=2):(a=null,0===we&&d('"::"')),null!==a?(c=ib(),null!==c?(58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?(58===b.charCodeAt(ve)?(g=":",ve++):(g=null,0===we&&d('":"')),null!==g?(h=ib(),null!==h?(58===b.charCodeAt(ve)?(i=":",ve++):(i=null,0===we&&d('":"')),null!==i?(j=jb(),null!==j?a=[a,c,e,f,g,h,i,j]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,"::"===b.substr(ve,2)?(a="::",ve+=2):(a=null,0===we&&d('"::"')),null!==a?(c=ib(),null!==c?(58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?(58===b.charCodeAt(ve)?(g=":",ve++):(g=null,0===we&&d('":"')),null!==g?(h=jb(),null!==h?a=[a,c,e,f,g,h]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,"::"===b.substr(ve,2)?(a="::",ve+=2):(a=null,0===we&&d('"::"')),null!==a?(c=ib(),null!==c?(58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=jb(),null!==f?a=[a,c,e,f]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,"::"===b.substr(ve,2)?(a="::",ve+=2):(a=null,0===we&&d('"::"')),null!==a?(c=jb(),null!==c?a=[a,c]:(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,"::"===b.substr(ve,2)?(a="::",ve+=2):(a=null,0===we&&d('"::"')),null!==a?(c=ib(),null!==c?a=[a,c]:(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,a=ib(),null!==a?("::"===b.substr(ve,2)?(c="::",ve+=2):(c=null,0===we&&d('"::"')),null!==c?(e=ib(),null!==e?(58===b.charCodeAt(ve)?(f=":",ve++):(f=null,0===we&&d('":"')),null!==f?(g=ib(),null!==g?(58===b.charCodeAt(ve)?(h=":",ve++):(h=null,0===we&&d('":"')),null!==h?(i=ib(),null!==i?(58===b.charCodeAt(ve)?(j=":",ve++):(j=null,0===we&&d('":"')),null!==j?(k=ib(),null!==k?(58===b.charCodeAt(ve)?(l=":",ve++):(l=null,0===we&&d('":"')),null!==l?(m=jb(),null!==m?a=[a,c,e,f,g,h,i,j,k,l,m]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,a=ib(),null!==a?(r=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ib(),null!==e?c=[c,e]:(c=null,ve=r)):(c=null,ve=r),c=null!==c?c:"",null!==c?("::"===b.substr(ve,2)?(e="::",ve+=2):(e=null,0===we&&d('"::"')),null!==e?(f=ib(),null!==f?(58===b.charCodeAt(ve)?(g=":",ve++):(g=null,0===we&&d('":"')),null!==g?(h=ib(),null!==h?(58===b.charCodeAt(ve)?(i=":",ve++):(i=null,0===we&&d('":"')),null!==i?(j=ib(),null!==j?(58===b.charCodeAt(ve)?(k=":",ve++):(k=null,0===we&&d('":"')),null!==k?(l=jb(),null!==l?a=[a,c,e,f,g,h,i,j,k,l]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,a=ib(),null!==a?(r=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ib(),null!==e?c=[c,e]:(c=null,ve=r)):(c=null,ve=r),c=null!==c?c:"",null!==c?(r=ve,58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?e=[e,f]:(e=null,ve=r)):(e=null,ve=r),e=null!==e?e:"",null!==e?("::"===b.substr(ve,2)?(f="::",ve+=2):(f=null,0===we&&d('"::"')),null!==f?(g=ib(),null!==g?(58===b.charCodeAt(ve)?(h=":",ve++):(h=null,0===we&&d('":"')),null!==h?(i=ib(),null!==i?(58===b.charCodeAt(ve)?(j=":",ve++):(j=null,0===we&&d('":"')),null!==j?(k=jb(),null!==k?a=[a,c,e,f,g,h,i,j,k]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,a=ib(),null!==a?(r=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ib(),null!==e?c=[c,e]:(c=null,ve=r)):(c=null,ve=r),c=null!==c?c:"",null!==c?(r=ve,58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?e=[e,f]:(e=null,ve=r)):(e=null,ve=r),e=null!==e?e:"",null!==e?(r=ve,58===b.charCodeAt(ve)?(f=":",ve++):(f=null,0===we&&d('":"')),null!==f?(g=ib(),null!==g?f=[f,g]:(f=null,ve=r)):(f=null,ve=r),f=null!==f?f:"",null!==f?("::"===b.substr(ve,2)?(g="::",ve+=2):(g=null,0===we&&d('"::"')),null!==g?(h=ib(),null!==h?(58===b.charCodeAt(ve)?(i=":",ve++):(i=null,0===we&&d('":"')),null!==i?(j=jb(),null!==j?a=[a,c,e,f,g,h,i,j]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,a=ib(),null!==a?(r=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ib(),null!==e?c=[c,e]:(c=null,ve=r)):(c=null,ve=r),c=null!==c?c:"",null!==c?(r=ve,58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?e=[e,f]:(e=null,ve=r)):(e=null,ve=r),e=null!==e?e:"",null!==e?(r=ve,58===b.charCodeAt(ve)?(f=":",ve++):(f=null,0===we&&d('":"')),null!==f?(g=ib(),null!==g?f=[f,g]:(f=null,ve=r)):(f=null,ve=r),f=null!==f?f:"",null!==f?(r=ve,58===b.charCodeAt(ve)?(g=":",ve++):(g=null,0===we&&d('":"')),null!==g?(h=ib(),null!==h?g=[g,h]:(g=null,ve=r)):(g=null,ve=r),g=null!==g?g:"",null!==g?("::"===b.substr(ve,2)?(h="::",ve+=2):(h=null,0===we&&d('"::"')),null!==h?(i=jb(),null!==i?a=[a,c,e,f,g,h,i]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,a=ib(),null!==a?(r=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ib(),null!==e?c=[c,e]:(c=null,ve=r)):(c=null,ve=r),c=null!==c?c:"",null!==c?(r=ve,58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?e=[e,f]:(e=null,ve=r)):(e=null,ve=r),e=null!==e?e:"",null!==e?(r=ve,58===b.charCodeAt(ve)?(f=":",ve++):(f=null,0===we&&d('":"')),null!==f?(g=ib(),null!==g?f=[f,g]:(f=null,ve=r)):(f=null,ve=r),f=null!==f?f:"",null!==f?(r=ve,58===b.charCodeAt(ve)?(g=":",ve++):(g=null,0===we&&d('":"')),null!==g?(h=ib(),null!==h?g=[g,h]:(g=null,ve=r)):(g=null,ve=r),g=null!==g?g:"",null!==g?(r=ve,58===b.charCodeAt(ve)?(h=":",ve++):(h=null,0===we&&d('":"')),null!==h?(i=ib(),null!==i?h=[h,i]:(h=null,ve=r)):(h=null,ve=r),h=null!==h?h:"",null!==h?("::"===b.substr(ve,2)?(i="::",ve+=2):(i=null,0===we&&d('"::"')),null!==i?(j=ib(),null!==j?a=[a,c,e,f,g,h,i,j]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q),null===a&&(q=ve,a=ib(),null!==a?(r=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ib(),null!==e?c=[c,e]:(c=null,ve=r)):(c=null,ve=r),c=null!==c?c:"",null!==c?(r=ve,58===b.charCodeAt(ve)?(e=":",ve++):(e=null,0===we&&d('":"')),null!==e?(f=ib(),null!==f?e=[e,f]:(e=null,ve=r)):(e=null,ve=r),e=null!==e?e:"",null!==e?(r=ve,58===b.charCodeAt(ve)?(f=":",ve++):(f=null,0===we&&d('":"')),null!==f?(g=ib(),null!==g?f=[f,g]:(f=null,ve=r)):(f=null,ve=r),f=null!==f?f:"",null!==f?(r=ve,58===b.charCodeAt(ve)?(g=":",ve++):(g=null,0===we&&d('":"')),null!==g?(h=ib(),null!==h?g=[g,h]:(g=null,ve=r)):(g=null,ve=r),g=null!==g?g:"",null!==g?(r=ve,58===b.charCodeAt(ve)?(h=":",ve++):(h=null,0===we&&d('":"')),null!==h?(i=ib(),null!==i?h=[h,i]:(h=null,ve=r)):(h=null,ve=r),h=null!==h?h:"",null!==h?(r=ve,58===b.charCodeAt(ve)?(i=":",ve++):(i=null,0===we&&d('":"')),null!==i?(j=ib(),null!==j?i=[i,j]:(i=null,ve=r)):(i=null,ve=r),i=null!==i?i:"",null!==i?("::"===b.substr(ve,2)?(j="::",ve+=2):(j=null,0===we&&d('"::"')),null!==j?a=[a,c,e,f,g,h,i,j]:(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q)):(a=null,ve=q))))))))))))))),null!==a&&(a=function(a){return ze.host_type="IPv6",b.substring(ve,a)}(p)),null===a&&(ve=p),a}function ib(){var a,b,c,d,e;return e=ve,a=h(),null!==a?(b=h(),b=null!==b?b:"",null!==b?(c=h(),c=null!==c?c:"",null!==c?(d=h(),d=null!==d?d:"",null!==d?a=[a,b,c,d]:(a=null,ve=e)):(a=null,ve=e)):(a=null,ve=e)):(a=null,ve=e),a}function jb(){var a,c,e,f;return f=ve,a=ib(),null!==a?(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ib(),null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),null===a&&(a=kb()),a}function kb(){var a,c,e,f,g,h,i,j,k;return j=ve,k=ve,a=lb(),null!==a?(46===b.charCodeAt(ve)?(c=".",ve++):(c=null,0===we&&d('"."')),null!==c?(e=lb(),null!==e?(46===b.charCodeAt(ve)?(f=".",ve++):(f=null,0===we&&d('"."')),null!==f?(g=lb(),null!==g?(46===b.charCodeAt(ve)?(h=".",ve++):(h=null,0===we&&d('"."')),null!==h?(i=lb(),null!==i?a=[a,c,e,f,g,h,i]:(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k)):(a=null,ve=k),null!==a&&(a=function(a){return ze.host_type="IPv4",b.substring(ve,a)}(j)),null===a&&(ve=j),a}function lb(){var a,c,e,g;return g=ve,"25"===b.substr(ve,2)?(a="25",ve+=2):(a=null,0===we&&d('"25"')),null!==a?(/^[0-5]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[0-5]")),null!==c?a=[a,c]:(a=null,ve=g)):(a=null,ve=g),null===a&&(g=ve,50===b.charCodeAt(ve)?(a="2",ve++):(a=null,0===we&&d('"2"')),null!==a?(/^[0-4]/.test(b.charAt(ve))?(c=b.charAt(ve),ve++):(c=null,0===we&&d("[0-4]")),null!==c?(e=f(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null===a&&(g=ve,49===b.charCodeAt(ve)?(a="1",ve++):(a=null,0===we&&d('"1"')),null!==a?(c=f(),null!==c?(e=f(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null===a&&(g=ve,/^[1-9]/.test(b.charAt(ve))?(a=b.charAt(ve),ve++):(a=null,0===we&&d("[1-9]")),null!==a?(c=f(),null!==c?a=[a,c]:(a=null,ve=g)):(a=null,ve=g),null===a&&(a=f())))),a}function mb(){var a,b,c,d,e,g,h;return g=ve,h=ve,a=f(),a=null!==a?a:"",null!==a?(b=f(),b=null!==b?b:"",null!==b?(c=f(),c=null!==c?c:"",null!==c?(d=f(),d=null!==d?d:"",null!==d?(e=f(),e=null!==e?e:"",null!==e?a=[a,b,c,d,e]:(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h),null!==a&&(a=function(a,b){return b=parseInt(b.join("")),ze.port=b,b}(g,a)),null===a&&(ve=g),a}function nb(){var a,c,e,f;for(a=[],f=ve,59===b.charCodeAt(ve)?(c=";",ve++):(c=null,0===we&&d('";"')),null!==c?(e=ob(),null!==e?c=[c,e]:(c=null,ve=f)):(c=null,ve=f);null!==c;)a.push(c),f=ve,59===b.charCodeAt(ve)?(c=";",ve++):(c=null,0===we&&d('";"')),null!==c?(e=ob(),null!==e?c=[c,e]:(c=null,ve=f)):(c=null,ve=f);return a}function ob(){var a;return a=pb(),null===a&&(a=qb(),null===a&&(a=rb(),null===a&&(a=sb(),null===a&&(a=tb(),null===a&&(a=ub(),null===a&&(a=vb())))))),a}function pb(){var a,c,e,f;return e=ve,f=ve,"transport="===b.substr(ve,10).toLowerCase()?(a=b.substr(ve,10),ve+=10):(a=null,0===we&&d('"transport="')),null!==a?("udp"===b.substr(ve,3).toLowerCase()?(c=b.substr(ve,3),ve+=3):(c=null,0===we&&d('"udp"')),null===c&&("tcp"===b.substr(ve,3).toLowerCase()?(c=b.substr(ve,3),ve+=3):(c=null,0===we&&d('"tcp"')),null===c&&("sctp"===b.substr(ve,4).toLowerCase()?(c=b.substr(ve,4),ve+=4):(c=null,0===we&&d('"sctp"')),null===c&&("tls"===b.substr(ve,3).toLowerCase()?(c=b.substr(ve,3),ve+=3):(c=null,0===we&&d('"tls"')),null===c&&(c=A())))),null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),null!==a&&(a=function(a,b){ze.uri_params||(ze.uri_params={}),ze.uri_params.transport=b.toLowerCase()}(e,a[1])),null===a&&(ve=e),a}function qb(){var a,c,e,f;return e=ve,f=ve,"user="===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"user="')),null!==a?("phone"===b.substr(ve,5).toLowerCase()?(c=b.substr(ve,5),ve+=5):(c=null,0===we&&d('"phone"')),null===c&&("ip"===b.substr(ve,2).toLowerCase()?(c=b.substr(ve,2),ve+=2):(c=null,0===we&&d('"ip"')),null===c&&(c=A())),null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),null!==a&&(a=function(a,b){ze.uri_params||(ze.uri_params={}),ze.uri_params.user=b.toLowerCase()}(e,a[1])),null===a&&(ve=e),a}function rb(){var a,c,e,f;return e=ve,f=ve,"method="===b.substr(ve,7).toLowerCase()?(a=b.substr(ve,7),ve+=7):(a=null,0===we&&d('"method="')),null!==a?(c=fc(),null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),null!==a&&(a=function(a,b){ze.uri_params||(ze.uri_params={}),ze.uri_params.method=b}(e,a[1])),null===a&&(ve=e),a}function sb(){var a,c,e,f;return e=ve,f=ve,"ttl="===b.substr(ve,4).toLowerCase()?(a=b.substr(ve,4),ve+=4):(a=null,0===we&&d('"ttl="')),null!==a?(c=_d(),null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),null!==a&&(a=function(a,b){ze.params||(ze.params={}),ze.params.ttl=b}(e,a[1])),null===a&&(ve=e),a}function tb(){var a,c,e,f;return e=ve,f=ve,"maddr="===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"maddr="')),null!==a?(c=cb(),null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),null!==a&&(a=function(a,b){ze.uri_params||(ze.uri_params={}),ze.uri_params.maddr=b}(e,a[1])),null===a&&(ve=e),a}function ub(){var a,c,e,f,g,h;return f=ve,g=ve,"lr"===b.substr(ve,2).toLowerCase()?(a=b.substr(ve,2),ve+=2):(a=null,0===we&&d('"lr"')),null!==a?(h=ve,61===b.charCodeAt(ve)?(c="=",ve++):(c=null,0===we&&d('"="')),null!==c?(e=A(),null!==e?c=[c,e]:(c=null,ve=h)):(c=null,ve=h),c=null!==c?c:"",null!==c?a=[a,c]:(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(){ze.uri_params||(ze.uri_params={}),ze.uri_params.lr=void 0}(f)),null===a&&(ve=f),a}function vb(){var a,c,e,f,g,h;return f=ve,g=ve,a=wb(),null!==a?(h=ve,61===b.charCodeAt(ve)?(c="=",ve++):(c=null,0===we&&d('"="')),null!==c?(e=xb(),null!==e?c=[c,e]:(c=null,ve=h)):(c=null,ve=h),c=null!==c?c:"",null!==c?a=[a,c]:(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b,c){ze.uri_params||(ze.uri_params={}),c="undefined"==typeof c?void 0:c[1],ze.uri_params[b.toLowerCase()]=c&&c.toLowerCase()}(f,a[0],a[1])),null===a&&(ve=f),a}function wb(){var a,b,c;if(c=ve,b=yb(),null!==b)for(a=[];null!==b;)a.push(b),b=yb();else a=null;return null!==a&&(a=function(a,b){return b.join("")}(c,a)),null===a&&(ve=c),a}function xb(){var a,b,c;if(c=ve,b=yb(),null!==b)for(a=[];null!==b;)a.push(b),b=yb();else a=null;return null!==a&&(a=function(a,b){return b.join("")}(c,a)),null===a&&(ve=c),a}function yb(){var a;return a=zb(),null===a&&(a=p(),null===a&&(a=r())),a}function zb(){var a;return 91===b.charCodeAt(ve)?(a="[",ve++):(a=null,0===we&&d('"["')),null===a&&(93===b.charCodeAt(ve)?(a="]",ve++):(a=null,0===we&&d('"]"')),null===a&&(47===b.charCodeAt(ve)?(a="/",ve++):(a=null,0===we&&d('"/"')),null===a&&(58===b.charCodeAt(ve)?(a=":",ve++):(a=null,0===we&&d('":"')),null===a&&(38===b.charCodeAt(ve)?(a="&",ve++):(a=null,0===we&&d('"&"')),null===a&&(43===b.charCodeAt(ve)?(a="+",ve++):(a=null,0===we&&d('"+"')),null===a&&(36===b.charCodeAt(ve)?(a="$",ve++):(a=null,0===we&&d('"$"')))))))),a}function Ab(){var a,c,e,f,g,h,i;if(h=ve,63===b.charCodeAt(ve)?(a="?",ve++):(a=null,0===we&&d('"?"')),null!==a)if(c=Bb(),null!==c){for(e=[],i=ve,38===b.charCodeAt(ve)?(f="&",ve++):(f=null,0===we&&d('"&"')),null!==f?(g=Bb(),null!==g?f=[f,g]:(f=null,ve=i)):(f=null,ve=i);null!==f;)e.push(f),i=ve,38===b.charCodeAt(ve)?(f="&",ve++):(f=null,0===we&&d('"&"')),null!==f?(g=Bb(),null!==g?f=[f,g]:(f=null,ve=i)):(f=null,ve=i);null!==e?a=[a,c,e]:(a=null,ve=h)}else a=null,ve=h;else a=null,ve=h;return a}function Bb(){var a,c,e,f,g;return f=ve,g=ve,a=Cb(),null!==a?(61===b.charCodeAt(ve)?(c="=",ve++):(c=null,0===we&&d('"="')),null!==c?(e=Db(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b,c){b=b.join("").toLowerCase(),c=c.join(""),ze.uri_headers||(ze.uri_headers={}),ze.uri_headers[b]?ze.uri_headers[b].push(c):ze.uri_headers[b]=[c]}(f,a[0],a[2])),null===a&&(ve=f),a}function Cb(){var a,b;if(b=Eb(),null===b&&(b=p(),null===b&&(b=r())),null!==b)for(a=[];null!==b;)a.push(b),b=Eb(),null===b&&(b=p(),null===b&&(b=r()));else a=null;return a}function Db(){var a,b;for(a=[],b=Eb(),null===b&&(b=p(),null===b&&(b=r()));null!==b;)a.push(b),b=Eb(),null===b&&(b=p(),null===b&&(b=r()));return a}function Eb(){var a;return 91===b.charCodeAt(ve)?(a="[",ve++):(a=null,0===we&&d('"["')),null===a&&(93===b.charCodeAt(ve)?(a="]",ve++):(a=null,0===we&&d('"]"')),null===a&&(47===b.charCodeAt(ve)?(a="/",ve++):(a=null,0===we&&d('"/"')),null===a&&(63===b.charCodeAt(ve)?(a="?",ve++):(a=null,0===we&&d('"?"')),null===a&&(58===b.charCodeAt(ve)?(a=":",ve++):(a=null,0===we&&d('":"')),null===a&&(43===b.charCodeAt(ve)?(a="+",ve++):(a=null,0===we&&d('"+"')),null===a&&(36===b.charCodeAt(ve)?(a="$",ve++):(a=null,0===we&&d('"$"')))))))),a}function Fb(){var a;return a=gc(),null===a&&(a=Gb()),a}function Gb(){var a,b,c,d,e,f;return f=ve,a=fc(),null!==a?(b=l(),null!==b?(c=Hb(),null!==c?(d=l(),null!==d?(e=Yb(),null!==e?a=[a,b,c,d,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function Hb(){var a;return a=X(),null===a&&(a=Ib()),a}function Ib(){var a,c,e,f;return f=ve,a=Tb(),null!==a?(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=Jb(),null===e&&(e=Mb()),null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function Jb(){var a,c,e,f,g;return f=ve,a=Kb(),null===a&&(a=Lb()),null!==a?(g=ve,63===b.charCodeAt(ve)?(c="?",ve++):(c=null,0===we&&d('"?"')),null!==c?(e=Xb(),null!==e?c=[c,e]:(c=null,ve=g)):(c=null,ve=g),c=null!==c?c:"",null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),a}function Kb(){var a,c,e,f;return f=ve,"//"===b.substr(ve,2)?(a="//",ve+=2):(a=null,0===we&&d('"//"')),null!==a?(c=Ub(),null!==c?(e=Lb(),e=null!==e?e:"",null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function Lb(){var a,c,e;return e=ve,47===b.charCodeAt(ve)?(a="/",ve++):(a=null,0===we&&d('"/"')),null!==a?(c=Pb(),null!==c?a=[a,c]:(a=null,ve=e)):(a=null,ve=e),a}function Mb(){var a,b,c,d;if(d=ve,a=Ob(),null!==a){for(b=[],c=Nb();null!==c;)b.push(c),c=Nb();null!==b?a=[a,b]:(a=null,ve=d)}else a=null,ve=d;return a}function Nb(){var a;return a=o(),null===a&&(a=p(),null===a&&(a=r())),a}function Ob(){var a;return a=p(),null===a&&(a=r(),null===a&&(59===b.charCodeAt(ve)?(a=";",ve++):(a=null,0===we&&d('";"')),null===a&&(63===b.charCodeAt(ve)?(a="?",ve++):(a=null,0===we&&d('"?"')),null===a&&(58===b.charCodeAt(ve)?(a=":",ve++):(a=null,0===we&&d('":"')),null===a&&(64===b.charCodeAt(ve)?(a="@",ve++):(a=null,0===we&&d('"@"')),null===a&&(38===b.charCodeAt(ve)?(a="&",ve++):(a=null,0===we&&d('"&"')),null===a&&(61===b.charCodeAt(ve)?(a="=",ve++):(a=null,0===we&&d('"="')),null===a&&(43===b.charCodeAt(ve)?(a="+",ve++):(a=null,0===we&&d('"+"')),null===a&&(36===b.charCodeAt(ve)?(a="$",ve++):(a=null,0===we&&d('"$"')),null===a&&(44===b.charCodeAt(ve)?(a=",",ve++):(a=null,0===we&&d('","')))))))))))),a}function Pb(){var a,c,e,f,g,h;if(g=ve,a=Qb(),null!==a){for(c=[],h=ve,47===b.charCodeAt(ve)?(e="/",ve++):(e=null,0===we&&d('"/"')),null!==e?(f=Qb(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==e;)c.push(e),h=ve,47===b.charCodeAt(ve)?(e="/",ve++):(e=null,0===we&&d('"/"')),null!==e?(f=Qb(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==c?a=[a,c]:(a=null,ve=g)}else a=null,ve=g;return a}function Qb(){var a,c,e,f,g,h;for(g=ve,a=[],c=Sb();null!==c;)a.push(c),c=Sb();if(null!==a){for(c=[],h=ve,59===b.charCodeAt(ve)?(e=";",ve++):(e=null,0===we&&d('";"')),null!==e?(f=Rb(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==e;)c.push(e),h=ve,59===b.charCodeAt(ve)?(e=";",ve++):(e=null,0===we&&d('";"')),null!==e?(f=Rb(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==c?a=[a,c]:(a=null,ve=g)}else a=null,ve=g;return a}function Rb(){var a,b;for(a=[],b=Sb();null!==b;)a.push(b),b=Sb();return a}function Sb(){var a;return a=p(),null===a&&(a=r(),null===a&&(58===b.charCodeAt(ve)?(a=":",ve++):(a=null,0===we&&d('":"')),null===a&&(64===b.charCodeAt(ve)?(a="@",ve++):(a=null,0===we&&d('"@"')),null===a&&(38===b.charCodeAt(ve)?(a="&",ve++):(a=null,0===we&&d('"&"')),null===a&&(61===b.charCodeAt(ve)?(a="=",ve++):(a=null,0===we&&d('"="')),null===a&&(43===b.charCodeAt(ve)?(a="+",ve++):(a=null,0===we&&d('"+"')),null===a&&(36===b.charCodeAt(ve)?(a="$",ve++):(a=null,0===we&&d('"$"')),null===a&&(44===b.charCodeAt(ve)?(a=",",ve++):(a=null,0===we&&d('","')))))))))),a}function Tb(){var a,c,e,h,i;if(h=ve,i=ve,a=g(),null!==a){for(c=[],e=g(),null===e&&(e=f(),null===e&&(43===b.charCodeAt(ve)?(e="+",ve++):(e=null,0===we&&d('"+"')),null===e&&(45===b.charCodeAt(ve)?(e="-",ve++):(e=null,0===we&&d('"-"')),null===e&&(46===b.charCodeAt(ve)?(e=".",ve++):(e=null,0===we&&d('"."'))))));null!==e;)c.push(e),e=g(),null===e&&(e=f(),null===e&&(43===b.charCodeAt(ve)?(e="+",ve++):(e=null,0===we&&d('"+"')),null===e&&(45===b.charCodeAt(ve)?(e="-",ve++):(e=null,0===we&&d('"-"')),null===e&&(46===b.charCodeAt(ve)?(e=".",ve++):(e=null,0===we&&d('"."'))))));null!==c?a=[a,c]:(a=null,ve=i)}else a=null,ve=i;return null!==a&&(a=function(a){ze.scheme=b.substring(ve,a)}(h)),null===a&&(ve=h),a}function Ub(){var a;return a=Vb(),null===a&&(a=Wb()),a}function Vb(){var a,c,e,f;return e=ve,f=ve,a=Z(),null!==a?(64===b.charCodeAt(ve)?(c="@",ve++):(c=null,0===we&&d('"@"')),null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),a=null!==a?a:"",null!==a?(c=bb(),null!==c?a=[a,c]:(a=null,ve=e)):(a=null,ve=e),a=null!==a?a:""}function Wb(){var a,c;if(c=p(),null===c&&(c=r(),null===c&&(36===b.charCodeAt(ve)?(c="$",ve++):(c=null,0===we&&d('"$"')),null===c&&(44===b.charCodeAt(ve)?(c=",",ve++):(c=null,0===we&&d('","')),null===c&&(59===b.charCodeAt(ve)?(c=";",ve++):(c=null,0===we&&d('";"')),null===c&&(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null===c&&(64===b.charCodeAt(ve)?(c="@",ve++):(c=null,0===we&&d('"@"')),null===c&&(38===b.charCodeAt(ve)?(c="&",ve++):(c=null,0===we&&d('"&"')),null===c&&(61===b.charCodeAt(ve)?(c="=",ve++):(c=null,0===we&&d('"="')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"'))))))))))),null!==c)for(a=[];null!==c;)a.push(c),c=p(),null===c&&(c=r(),null===c&&(36===b.charCodeAt(ve)?(c="$",ve++):(c=null,0===we&&d('"$"')),null===c&&(44===b.charCodeAt(ve)?(c=",",ve++):(c=null,0===we&&d('","')),null===c&&(59===b.charCodeAt(ve)?(c=";",ve++):(c=null,0===we&&d('";"')),null===c&&(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null===c&&(64===b.charCodeAt(ve)?(c="@",ve++):(c=null,0===we&&d('"@"')),null===c&&(38===b.charCodeAt(ve)?(c="&",ve++):(c=null,0===we&&d('"&"')),null===c&&(61===b.charCodeAt(ve)?(c="=",ve++):(c=null,0===we&&d('"="')),null===c&&(43===b.charCodeAt(ve)?(c="+",ve++):(c=null,0===we&&d('"+"')))))))))));else a=null;return a}function Xb(){var a,b;for(a=[],b=Nb();null!==b;)a.push(b),b=Nb();return a}function Yb(){var a,c,e,g,h,i,j,k;if(j=ve,k=ve,"sip"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"SIP"')),null!==a)if(47===b.charCodeAt(ve)?(c="/",ve++):(c=null,0===we&&d('"/"')),null!==c){if(g=f(),null!==g)for(e=[];null!==g;)e.push(g),g=f();else e=null;if(null!==e)if(46===b.charCodeAt(ve)?(g=".",ve++):(g=null,0===we&&d('"."')),null!==g){if(i=f(),null!==i)for(h=[];null!==i;)h.push(i),i=f();else h=null;null!==h?a=[a,c,e,g,h]:(a=null,ve=k)}else a=null,ve=k;else a=null,ve=k}else a=null,ve=k;else a=null,ve=k;return null!==a&&(a=function(a){ze.sip_version=b.substring(ve,a)}(j)),null===a&&(ve=j),a}function Zb(){var a;return"INVITE"===b.substr(ve,6)?(a="INVITE",ve+=6):(a=null,0===we&&d('"INVITE"')),a}function $b(){var a;return"ACK"===b.substr(ve,3)?(a="ACK",ve+=3):(a=null,0===we&&d('"ACK"')),a}function _b(){var a;return"OPTIONS"===b.substr(ve,7)?(a="OPTIONS",ve+=7):(a=null,0===we&&d('"OPTIONS"')),a}function ac(){var a;return"BYE"===b.substr(ve,3)?(a="BYE",ve+=3):(a=null,0===we&&d('"BYE"')),a}function bc(){var a;return"CANCEL"===b.substr(ve,6)?(a="CANCEL",ve+=6):(a=null,0===we&&d('"CANCEL"')),a}function cc(){var a;return"REGISTER"===b.substr(ve,8)?(a="REGISTER",ve+=8):(a=null,0===we&&d('"REGISTER"')),a}function dc(){var a;return"SUBSCRIBE"===b.substr(ve,9)?(a="SUBSCRIBE",ve+=9):(a=null,0===we&&d('"SUBSCRIBE"')),a}function ec(){var a;return"NOTIFY"===b.substr(ve,6)?(a="NOTIFY",ve+=6):(a=null,0===we&&d('"NOTIFY"')),a}function fc(){var a,c;return c=ve,a=Zb(),null===a&&(a=$b(),null===a&&(a=_b(),null===a&&(a=ac(),null===a&&(a=bc(),null===a&&(a=cc(),null===a&&(a=dc(),null===a&&(a=ec(),null===a&&(a=A())))))))),null!==a&&(a=function(a){return ze.method=b.substring(ve,a),ze.method}(c)),null===a&&(ve=c),a}function gc(){var a,b,c,d,e,f;return f=ve,a=Yb(),null!==a?(b=l(),null!==b?(c=hc(),null!==c?(d=l(),null!==d?(e=jc(),null!==e?a=[a,b,c,d,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function hc(){var a,b;return b=ve,a=ic(),null!==a&&(a=function(a,b){ze.status_code=parseInt(b.join(""))}(b,a)),null===a&&(ve=b),a}function ic(){var a,b,c,d;return d=ve,a=f(),null!==a?(b=f(),null!==b?(c=f(),null!==c?a=[a,b,c]:(a=null,ve=d)):(a=null,ve=d)):(a=null,ve=d),a}function jc(){var a,c,d;for(d=ve,a=[],c=o(),null===c&&(c=p(),null===c&&(c=r(),null===c&&(c=x(),null===c&&(c=y(),null===c&&(c=l(),null===c&&(c=m()))))));null!==c;)a.push(c),c=o(),null===c&&(c=p(),null===c&&(c=r(),null===c&&(c=x(),null===c&&(c=y(),null===c&&(c=l(),null===c&&(c=m()))))));return null!==a&&(a=function(a){ze.reason_phrase=b.substring(ve,a)}(d)),null===a&&(ve=d),a}function kc(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=lc(),null!==a){for(b=[],g=ve,c=L(),null!==c?(d=lc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=L(),null!==c?(d=lc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(){ze=ze.methods}(e)),null===a&&(ve=e),a}function lc(){var a,b;return b=ve,a=fc(),null!==a&&(a=function(a,b){ze.methods||(ze.methods=[]),ze.methods.push(b)}(b,a)),null===a&&(ve=b),a}function mc(){var a,b,c,d,e,f;if(e=ve,a=Uc(),null!==a){for(b=[],f=ve,c=L(),null!==c?(d=Uc(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==c;)b.push(c),f=ve,c=L(),null!==c?(d=Uc(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==b?a=[a,b]:(a=null,ve=e)}else a=null,ve=e;return a}function nc(){var a,b;return b=ve,a=oc(),null!==a&&(a=function(a,b){ze=b}(b,a)),null===a&&(ve=b),a}function oc(){var a,c,e,f,g,h;return f=ve,g=ve,a=D(),null!==a?(h=ve,64===b.charCodeAt(ve)?(c="@",ve++):(c=null,0===we&&d('"@"')),null!==c?(e=D(),null!==e?c=[c,e]:(c=null,ve=h)):(c=null,ve=h),c=null!==c?c:"",null!==c?a=[a,c]:(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a){return b.substring(ve,a)}(f)),null===a&&(ve=f),a}function pc(){var a,b,c,d,e,f,g;if(e=ve,a=E(),null===a)if(f=ve,a=qc(),null!==a){for(b=[],g=ve,c=L(),null!==c?(d=qc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=L(),null!==c?(d=qc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(){var a;for(a in ze.multi_header)if(null===ze.multi_header[a].parsed){ze=null;break}ze=null!==ze?ze.multi_header:-1}(e)),null===a&&(ve=e),a}function qc(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=W(),null===a&&(a=rc()),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=tc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=tc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(a){var b;ze.multi_header||(ze.multi_header=[]);try{b=new JsSIP.NameAddrHeader(ze.uri,ze.display_name,ze.params),delete ze.uri,delete ze.display_name,delete ze.params}catch(c){b=null}ze.multi_header.push({possition:ve,offset:a,parsed:b})}(e)),null===a&&(ve=e),a}function rc(){var a,b,c,d,e;return e=ve,a=sc(),a=null!==a?a:"",null!==a?(b=K(),null!==b?(c=X(),null!==c?(d=J(),null!==d?a=[a,b,c,d]:(a=null,ve=e)):(a=null,ve=e)):(a=null,ve=e)):(a=null,ve=e),a}function sc(){var a,c,d,e,f,g,h;if(f=ve,g=ve,a=A(),null!==a){for(c=[],h=ve,d=s(),null!==d?(e=A(),null!==e?d=[d,e]:(d=null,ve=h)):(d=null,ve=h);null!==d;)c.push(d),h=ve,d=s(),null!==d?(e=A(),null!==e?d=[d,e]:(d=null,ve=h)):(d=null,ve=h);null!==c?a=[a,c]:(a=null,ve=g)}else a=null,ve=g;return null===a&&(a=S()),null!==a&&(a=function(a,c){c=b.substring(ve,a).trim(),'"'===c[0]&&(c=c.substring(1,c.length-1)),ze.display_name=c}(f,a)),null===a&&(ve=f),a}function tc(){var a;return a=uc(),null===a&&(a=vc(),null===a&&(a=yc())),a}function uc(){var a,c,e,f,g;return f=ve,g=ve,"q"===b.substr(ve,1).toLowerCase()?(a=b.substr(ve,1),ve++):(a=null,0===we&&d('"q"')),null!==a?(c=G(),null!==c?(e=xc(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.params||(ze.params={}),ze.params.q=b
}(f,a[2])),null===a&&(ve=f),a}function vc(){var a,c,e,f,g;return f=ve,g=ve,"expires"===b.substr(ve,7).toLowerCase()?(a=b.substr(ve,7),ve+=7):(a=null,0===we&&d('"expires"')),null!==a?(c=G(),null!==c?(e=wc(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.params||(ze.params={}),ze.params.expires=b}(f,a[2])),null===a&&(ve=f),a}function wc(){var a,b,c;if(c=ve,b=f(),null!==b)for(a=[];null!==b;)a.push(b),b=f();else a=null;return null!==a&&(a=function(a,b){return parseInt(b.join(""))}(c,a)),null===a&&(ve=c),a}function xc(){var a,c,e,g,h,i,j,k;return i=ve,j=ve,48===b.charCodeAt(ve)?(a="0",ve++):(a=null,0===we&&d('"0"')),null!==a?(k=ve,46===b.charCodeAt(ve)?(c=".",ve++):(c=null,0===we&&d('"."')),null!==c?(e=f(),e=null!==e?e:"",null!==e?(g=f(),g=null!==g?g:"",null!==g?(h=f(),h=null!==h?h:"",null!==h?c=[c,e,g,h]:(c=null,ve=k)):(c=null,ve=k)):(c=null,ve=k)):(c=null,ve=k),c=null!==c?c:"",null!==c?a=[a,c]:(a=null,ve=j)):(a=null,ve=j),null!==a&&(a=function(a){return parseFloat(b.substring(ve,a))}(i)),null===a&&(ve=i),a}function yc(){var a,b,c,d,e,f;return d=ve,e=ve,a=A(),null!==a?(f=ve,b=G(),null!==b?(c=zc(),null!==c?b=[b,c]:(b=null,ve=f)):(b=null,ve=f),b=null!==b?b:"",null!==b?a=[a,b]:(a=null,ve=e)):(a=null,ve=e),null!==a&&(a=function(a,b,c){ze.params||(ze.params={}),c="undefined"==typeof c?void 0:c[1],ze.params[b.toLowerCase()]=c}(d,a[0],a[1])),null===a&&(ve=d),a}function zc(){var a;return a=A(),null===a&&(a=cb(),null===a&&(a=S())),a}function Ac(){var a,b,c,d,e,f;if(e=ve,a=Bc(),null!==a){for(b=[],f=ve,c=M(),null!==c?(d=Cc(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==c;)b.push(c),f=ve,c=M(),null!==c?(d=Cc(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==b?a=[a,b]:(a=null,ve=e)}else a=null,ve=e;return a}function Bc(){var a;return"render"===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"render"')),null===a&&("session"===b.substr(ve,7).toLowerCase()?(a=b.substr(ve,7),ve+=7):(a=null,0===we&&d('"session"')),null===a&&("icon"===b.substr(ve,4).toLowerCase()?(a=b.substr(ve,4),ve+=4):(a=null,0===we&&d('"icon"')),null===a&&("alert"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"alert"')),null===a&&(a=A())))),a}function Cc(){var a;return a=Dc(),null===a&&(a=yc()),a}function Dc(){var a,c,e,f;return f=ve,"handling"===b.substr(ve,8).toLowerCase()?(a=b.substr(ve,8),ve+=8):(a=null,0===we&&d('"handling"')),null!==a?(c=G(),null!==c?("optional"===b.substr(ve,8).toLowerCase()?(e=b.substr(ve,8),ve+=8):(e=null,0===we&&d('"optional"')),null===e&&("required"===b.substr(ve,8).toLowerCase()?(e=b.substr(ve,8),ve+=8):(e=null,0===we&&d('"required"')),null===e&&(e=A())),null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function Ec(){var a,b,c,d,e,f;if(e=ve,a=A(),null!==a){for(b=[],f=ve,c=L(),null!==c?(d=A(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==c;)b.push(c),f=ve,c=L(),null!==c?(d=A(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==b?a=[a,b]:(a=null,ve=e)}else a=null,ve=e;return a}function Fc(){var a,b,c;if(c=ve,b=f(),null!==b)for(a=[];null!==b;)a.push(b),b=f();else a=null;return null!==a&&(a=function(a,b){ze=parseInt(b.join(""))}(c,a)),null===a&&(ve=c),a}function Gc(){var a,c;return c=ve,a=Hc(),null!==a&&(a=function(a){ze=b.substring(ve,a)}(c)),null===a&&(ve=c),a}function Hc(){var a,b,c,d,e,f,g,h;if(g=ve,a=Ic(),null!==a)if(b=F(),null!==b)if(c=Nc(),null!==c){for(d=[],h=ve,e=M(),null!==e?(f=Oc(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==e;)d.push(e),h=ve,e=M(),null!==e?(f=Oc(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==d?a=[a,b,c,d]:(a=null,ve=g)}else a=null,ve=g;else a=null,ve=g;else a=null,ve=g;return a}function Ic(){var a;return a=Jc(),null===a&&(a=Kc()),a}function Jc(){var a;return"text"===b.substr(ve,4).toLowerCase()?(a=b.substr(ve,4),ve+=4):(a=null,0===we&&d('"text"')),null===a&&("image"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"image"')),null===a&&("audio"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"audio"')),null===a&&("video"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"video"')),null===a&&("application"===b.substr(ve,11).toLowerCase()?(a=b.substr(ve,11),ve+=11):(a=null,0===we&&d('"application"')),null===a&&(a=Lc()))))),a}function Kc(){var a;return"message"===b.substr(ve,7).toLowerCase()?(a=b.substr(ve,7),ve+=7):(a=null,0===we&&d('"message"')),null===a&&("multipart"===b.substr(ve,9).toLowerCase()?(a=b.substr(ve,9),ve+=9):(a=null,0===we&&d('"multipart"')),null===a&&(a=Lc())),a}function Lc(){var a;return a=A(),null===a&&(a=Mc()),a}function Mc(){var a,c,e;return e=ve,"x-"===b.substr(ve,2).toLowerCase()?(a=b.substr(ve,2),ve+=2):(a=null,0===we&&d('"x-"')),null!==a?(c=A(),null!==c?a=[a,c]:(a=null,ve=e)):(a=null,ve=e),a}function Nc(){var a;return a=Lc(),null===a&&(a=A()),a}function Oc(){var a,b,c,d;return d=ve,a=A(),null!==a?(b=G(),null!==b?(c=Pc(),null!==c?a=[a,b,c]:(a=null,ve=d)):(a=null,ve=d)):(a=null,ve=d),a}function Pc(){var a;return a=A(),null===a&&(a=S()),a}function Qc(){var a,b,c,d;return d=ve,a=Rc(),null!==a?(b=s(),null!==b?(c=fc(),null!==c?a=[a,b,c]:(a=null,ve=d)):(a=null,ve=d)):(a=null,ve=d),a}function Rc(){var a,b,c;if(c=ve,b=f(),null!==b)for(a=[];null!==b;)a.push(b),b=f();else a=null;return null!==a&&(a=function(a,b){ze.value=parseInt(b.join(""))}(c,a)),null===a&&(ve=c),a}function Sc(){var a,b;return b=ve,a=wc(),null!==a&&(a=function(a,b){ze=b}(b,a)),null===a&&(ve=b),a}function Tc(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=Uc(),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(a,b){ze.event=b.join("").toLowerCase()}(e,a[0])),null===a&&(ve=e),a}function Uc(){var a,c,e,f,g,h;if(g=ve,a=B(),null!==a){for(c=[],h=ve,46===b.charCodeAt(ve)?(e=".",ve++):(e=null,0===we&&d('"."')),null!==e?(f=B(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==e;)c.push(e),h=ve,46===b.charCodeAt(ve)?(e=".",ve++):(e=null,0===we&&d('"."')),null!==e?(f=B(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==c?a=[a,c]:(a=null,ve=g)}else a=null,ve=g;return a}function Vc(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=W(),null===a&&(a=rc()),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=Wc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=Wc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(){var a=ze.tag;try{ze=new JsSIP.NameAddrHeader(ze.uri,ze.display_name,ze.params),a&&ze.setParam("tag",a)}catch(b){ze=-1}}(e)),null===a&&(ve=e),a}function Wc(){var a;return a=Xc(),null===a&&(a=yc()),a}function Xc(){var a,c,e,f,g;return f=ve,g=ve,"tag"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"tag"')),null!==a?(c=G(),null!==c?(e=A(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.tag=b}(f,a[2])),null===a&&(ve=f),a}function Yc(){var a,b,c;if(c=ve,b=f(),null!==b)for(a=[];null!==b;)a.push(b),b=f();else a=null;return null!==a&&(a=function(a,b){ze=parseInt(b.join(""))}(c,a)),null===a&&(ve=c),a}function Zc(){var a,b;return b=ve,a=wc(),null!==a&&(a=function(a,b){ze=b}(b,a)),null===a&&(ve=b),a}function $c(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=wc(),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(a,b){ze=b>=90?b:-1}(e,a[0])),null===a&&(ve=e),a}function _c(){var a,b,c,d,e,f,g,h,i,j;for(h=ve,i=ve,a=[],b=sc();null!==b;)a.push(b),b=sc();if(null!==a)if(b=K(),null!==b)if(c=X(),null!==c)if(d=J(),null!==d){for(e=[],j=ve,f=M(),null!==f?(g=yc(),null!==g?f=[f,g]:(f=null,ve=j)):(f=null,ve=j);null!==f;)e.push(f),j=ve,f=M(),null!==f?(g=yc(),null!==g?f=[f,g]:(f=null,ve=j)):(f=null,ve=j);null!==e?a=[a,b,c,d,e]:(a=null,ve=i)}else a=null,ve=i;else a=null,ve=i;else a=null,ve=i;else a=null,ve=i;return null!==a&&(a=function(){try{ze=new JsSIP.NameAddrHeader(ze.uri,ze.display_name,ze.params)}catch(a){ze=-1}}(h)),null===a&&(ve=h),a}function ad(){var a;return a=bd()}function bd(){var a,c,e,f,g,h,i,j;if(i=ve,"digest"===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"Digest"')),null!==a)if(c=s(),null!==c)if(e=ed(),null!==e){for(f=[],j=ve,g=L(),null!==g?(h=ed(),null!==h?g=[g,h]:(g=null,ve=j)):(g=null,ve=j);null!==g;)f.push(g),j=ve,g=L(),null!==g?(h=ed(),null!==h?g=[g,h]:(g=null,ve=j)):(g=null,ve=j);null!==f?a=[a,c,e,f]:(a=null,ve=i)}else a=null,ve=i;else a=null,ve=i;else a=null,ve=i;return null===a&&(a=cd()),a}function cd(){var a,b,c,d,e,f,g,h;if(g=ve,a=A(),null!==a)if(b=s(),null!==b)if(c=dd(),null!==c){for(d=[],h=ve,e=L(),null!==e?(f=dd(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==e;)d.push(e),h=ve,e=L(),null!==e?(f=dd(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==d?a=[a,b,c,d]:(a=null,ve=g)}else a=null,ve=g;else a=null,ve=g;else a=null,ve=g;return a}function dd(){var a,b,c,d;return d=ve,a=A(),null!==a?(b=G(),null!==b?(c=A(),null===c&&(c=S()),null!==c?a=[a,b,c]:(a=null,ve=d)):(a=null,ve=d)):(a=null,ve=d),a}function ed(){var a;return a=fd(),null===a&&(a=hd(),null===a&&(a=jd(),null===a&&(a=ld(),null===a&&(a=md(),null===a&&(a=nd(),null===a&&(a=od(),null===a&&(a=dd()))))))),a}function fd(){var a,c,e,f;return f=ve,"realm"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"realm"')),null!==a?(c=G(),null!==c?(e=gd(),null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function gd(){var a,b;return b=ve,a=T(),null!==a&&(a=function(a,b){ze.realm=b}(b,a)),null===a&&(ve=b),a}function hd(){var a,c,e,f,g,h,i,j,k;if(j=ve,"domain"===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"domain"')),null!==a)if(c=G(),null!==c)if(e=O(),null!==e)if(f=id(),null!==f){if(g=[],k=ve,i=l(),null!==i)for(h=[];null!==i;)h.push(i),i=l();else h=null;for(null!==h?(i=id(),null!==i?h=[h,i]:(h=null,ve=k)):(h=null,ve=k);null!==h;){if(g.push(h),k=ve,i=l(),null!==i)for(h=[];null!==i;)h.push(i),i=l();else h=null;null!==h?(i=id(),null!==i?h=[h,i]:(h=null,ve=k)):(h=null,ve=k)}null!==g?(h=P(),null!==h?a=[a,c,e,f,g,h]:(a=null,ve=j)):(a=null,ve=j)}else a=null,ve=j;else a=null,ve=j;else a=null,ve=j;else a=null,ve=j;return a}function id(){var a;return a=Ib(),null===a&&(a=Lb()),a}function jd(){var a,c,e,f;return f=ve,"nonce"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"nonce"')),null!==a?(c=G(),null!==c?(e=kd(),null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function kd(){var a,b;return b=ve,a=T(),null!==a&&(a=function(a,b){ze.nonce=b}(b,a)),null===a&&(ve=b),a}function ld(){var a,c,e,f,g;return f=ve,g=ve,"opaque"===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"opaque"')),null!==a?(c=G(),null!==c?(e=T(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.opaque=b}(f,a[2])),null===a&&(ve=f),a}function md(){var a,c,e,f,g;return f=ve,"stale"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"stale"')),null!==a?(c=G(),null!==c?(g=ve,"true"===b.substr(ve,4).toLowerCase()?(e=b.substr(ve,4),ve+=4):(e=null,0===we&&d('"true"')),null!==e&&(e=function(){ze.stale=!0}(g)),null===e&&(ve=g),null===e&&(g=ve,"false"===b.substr(ve,5).toLowerCase()?(e=b.substr(ve,5),ve+=5):(e=null,0===we&&d('"false"')),null!==e&&(e=function(){ze.stale=!1}(g)),null===e&&(ve=g)),null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function nd(){var a,c,e,f,g;return f=ve,g=ve,"algorithm"===b.substr(ve,9).toLowerCase()?(a=b.substr(ve,9),ve+=9):(a=null,0===we&&d('"algorithm"')),null!==a?(c=G(),null!==c?("md5"===b.substr(ve,3).toLowerCase()?(e=b.substr(ve,3),ve+=3):(e=null,0===we&&d('"MD5"')),null===e&&("md5-sess"===b.substr(ve,8).toLowerCase()?(e=b.substr(ve,8),ve+=8):(e=null,0===we&&d('"MD5-sess"')),null===e&&(e=A())),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.algorithm=b.toUpperCase()}(f,a[2])),null===a&&(ve=f),a}function od(){var a,c,e,f,g,h,i,j,k,l;if(j=ve,"qop"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"qop"')),null!==a)if(c=G(),null!==c)if(e=O(),null!==e){if(k=ve,f=pd(),null!==f){for(g=[],l=ve,44===b.charCodeAt(ve)?(h=",",ve++):(h=null,0===we&&d('","')),null!==h?(i=pd(),null!==i?h=[h,i]:(h=null,ve=l)):(h=null,ve=l);null!==h;)g.push(h),l=ve,44===b.charCodeAt(ve)?(h=",",ve++):(h=null,0===we&&d('","')),null!==h?(i=pd(),null!==i?h=[h,i]:(h=null,ve=l)):(h=null,ve=l);null!==g?f=[f,g]:(f=null,ve=k)}else f=null,ve=k;null!==f?(g=P(),null!==g?a=[a,c,e,f,g]:(a=null,ve=j)):(a=null,ve=j)}else a=null,ve=j;else a=null,ve=j;else a=null,ve=j;return a}function pd(){var a,c;return c=ve,"auth-int"===b.substr(ve,8).toLowerCase()?(a=b.substr(ve,8),ve+=8):(a=null,0===we&&d('"auth-int"')),null===a&&("auth"===b.substr(ve,4).toLowerCase()?(a=b.substr(ve,4),ve+=4):(a=null,0===we&&d('"auth"')),null===a&&(a=A())),null!==a&&(a=function(a,b){ze.qop||(ze.qop=[]),ze.qop.push(b.toLowerCase())}(c,a)),null===a&&(ve=c),a}function qd(){var a,b,c,d,e,f;if(e=ve,a=rd(),null!==a){for(b=[],f=ve,c=L(),null!==c?(d=rd(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==c;)b.push(c),f=ve,c=L(),null!==c?(d=rd(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==b?a=[a,b]:(a=null,ve=e)}else a=null,ve=e;return a}function rd(){var a,b;return b=ve,a=A(),null!==a&&(a=function(a,b){ze.options||(ze.options=[]),ze.options.push(b)}(b,a)),null===a&&(ve=b),a}function sd(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=td(),null!==a){for(b=[],g=ve,c=L(),null!==c?(d=td(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=L(),null!==c?(d=td(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(){var a;for(a in ze.multi_header)if(null===ze.multi_header[a].parsed){ze=null;break}ze=null!==ze?ze.multi_header:-1}(e)),null===a&&(ve=e),a}function td(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=rc(),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(a){var b;ze.multi_header||(ze.multi_header=[]);try{b=new JsSIP.NameAddrHeader(ze.uri,ze.display_name,ze.params),delete ze.uri,delete ze.display_name,delete ze.params}catch(c){b=null}ze.multi_header.push({possition:ve,offset:a,parsed:b})}(e)),null===a&&(ve=e),a}function ud(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=W(),null===a&&(a=rc()),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(){try{ze=new JsSIP.NameAddrHeader(ze.uri,ze.display_name,ze.params)}catch(a){ze=-1}}(e)),null===a&&(ve=e),a}function vd(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=rd(),null!==a){for(b=[],g=ve,c=L(),null!==c?(d=rd(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=L(),null!==c?(d=rd(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(){ze=ze.options}(e)),null===a&&(ve=e),a}function wd(){var a,b,c,d,e,f;if(e=ve,a=xd(),null!==a){for(b=[],f=ve,c=L(),null!==c?(d=xd(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==c;)b.push(c),f=ve,c=L(),null!==c?(d=xd(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==b?a=[a,b]:(a=null,ve=e)}else a=null,ve=e;return a}function xd(){var a,b,c,d,e,f;if(e=ve,a=rc(),null!==a){for(b=[],f=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==c;)b.push(c),f=ve,c=M(),null!==c?(d=yc(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==b?a=[a,b]:(a=null,ve=e)}else a=null,ve=e;return a}function yd(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=wc(),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=zd(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=zd(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(a,b){ze.interval=b}(e,a[0])),null===a&&(ve=e),a}function zd(){var a;return a=Ad(),null===a&&(a=yc()),a}function Ad(){var a,c,e,f,g;return f=ve,g=ve,"refresher"===b.substr(ve,9).toLowerCase()?(a=b.substr(ve,9),ve+=9):(a=null,0===we&&d('"refresher"')),null!==a?(c=G(),null!==c?("uas"===b.substr(ve,3).toLowerCase()?(e=b.substr(ve,3),ve+=3):(e=null,0===we&&d('"uas"')),null===e&&("uac"===b.substr(ve,3).toLowerCase()?(e=b.substr(ve,3),ve+=3):(e=null,0===we&&d('"uac"'))),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.params||(ze.params={}),ze.params.refresher=b}(f,a[2])),null===a&&(ve=f),a}function Bd(){var a,b,c,d,e,f;if(e=ve,a=Cd(),null!==a){for(b=[],f=ve,c=M(),null!==c?(d=Dd(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==c;)b.push(c),f=ve,c=M(),null!==c?(d=Dd(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==b?a=[a,b]:(a=null,ve=e)}else a=null,ve=e;return a}function Cd(){var a,c;return c=ve,"active"===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"active"')),null===a&&("pending"===b.substr(ve,7).toLowerCase()?(a=b.substr(ve,7),ve+=7):(a=null,0===we&&d('"pending"')),null===a&&("terminated"===b.substr(ve,10).toLowerCase()?(a=b.substr(ve,10),ve+=10):(a=null,0===we&&d('"terminated"')),null===a&&(a=A()))),null!==a&&(a=function(a){ze.state=b.substring(ve,a)}(c)),null===a&&(ve=c),a}function Dd(){var a,c,e,f,g;return f=ve,g=ve,"reason"===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"reason"')),null!==a?(c=G(),null!==c?(e=Ed(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){"undefined"!=typeof b&&(ze.reason=b)}(f,a[2])),null===a&&(ve=f),null===a&&(f=ve,g=ve,"expires"===b.substr(ve,7).toLowerCase()?(a=b.substr(ve,7),ve+=7):(a=null,0===we&&d('"expires"')),null!==a?(c=G(),null!==c?(e=wc(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){"undefined"!=typeof b&&(ze.expires=b)}(f,a[2])),null===a&&(ve=f),null===a&&(f=ve,g=ve,"retry_after"===b.substr(ve,11).toLowerCase()?(a=b.substr(ve,11),ve+=11):(a=null,0===we&&d('"retry_after"')),null!==a?(c=G(),null!==c?(e=wc(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){"undefined"!=typeof b&&(ze.retry_after=b)}(f,a[2])),null===a&&(ve=f),null===a&&(a=yc()))),a}function Ed(){var a;return"deactivated"===b.substr(ve,11).toLowerCase()?(a=b.substr(ve,11),ve+=11):(a=null,0===we&&d('"deactivated"')),null===a&&("probation"===b.substr(ve,9).toLowerCase()?(a=b.substr(ve,9),ve+=9):(a=null,0===we&&d('"probation"')),null===a&&("rejected"===b.substr(ve,8).toLowerCase()?(a=b.substr(ve,8),ve+=8):(a=null,0===we&&d('"rejected"')),null===a&&("timeout"===b.substr(ve,7).toLowerCase()?(a=b.substr(ve,7),ve+=7):(a=null,0===we&&d('"timeout"')),null===a&&("giveup"===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"giveup"')),null===a&&("noresource"===b.substr(ve,10).toLowerCase()?(a=b.substr(ve,10),ve+=10):(a=null,0===we&&d('"noresource"')),null===a&&("invariant"===b.substr(ve,9).toLowerCase()?(a=b.substr(ve,9),ve+=9):(a=null,0===we&&d('"invariant"')),null===a&&(a=A()))))))),a}function Fd(){var a;return a=v(),a=null!==a?a:""}function Gd(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=rd(),null!==a){for(b=[],g=ve,c=L(),null!==c?(d=rd(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=L(),null!==c?(d=rd(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return a=null!==a?a:"",null!==a&&(a=function(){ze=ze.options||[]}(e)),null===a&&(ve=e),a}function Hd(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=oc(),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=Id(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=Id(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(a,b){ze.call_id=b}(e,a[0])),null===a&&(ve=e),a}function Id(){var a;return a=Jd(),null===a&&(a=Kd(),null===a&&(a=yc())),a}function Jd(){var a,c,e,f,g;return f=ve,g=ve,"remote-tag"===b.substr(ve,10).toLowerCase()?(a=b.substr(ve,10),ve+=10):(a=null,0===we&&d('"remote-tag"')),null!==a?(c=G(),null!==c?(e=A(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.remote_tag=b}(f,a[2])),null===a&&(ve=f),a}function Kd(){var a,c,e,f,g;return f=ve,g=ve,"local-tag"===b.substr(ve,9).toLowerCase()?(a=b.substr(ve,9),ve+=9):(a=null,0===we&&d('"local-tag"')),null!==a?(c=G(),null!==c?(e=A(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.local_tag=b}(f,a[2])),null===a&&(ve=f),a}function Ld(){var a,b,c,d,e,f,g;if(e=ve,f=ve,a=W(),null===a&&(a=rc()),null!==a){for(b=[],g=ve,c=M(),null!==c?(d=Md(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==c;)b.push(c),g=ve,c=M(),null!==c?(d=Md(),null!==d?c=[c,d]:(c=null,ve=g)):(c=null,ve=g);null!==b?a=[a,b]:(a=null,ve=f)}else a=null,ve=f;return null!==a&&(a=function(){var a=ze.tag;try{ze=new JsSIP.NameAddrHeader(ze.uri,ze.display_name,ze.params),a&&ze.setParam("tag",a)}catch(b){ze=-1}}(e)),null===a&&(ve=e),a}function Md(){var a;return a=Xc(),null===a&&(a=yc()),a}function Nd(){var a,b,c,d,e,f;if(e=ve,a=Od(),null!==a){for(b=[],f=ve,c=L(),null!==c?(d=Od(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==c;)b.push(c),f=ve,c=L(),null!==c?(d=Od(),null!==d?c=[c,d]:(c=null,ve=f)):(c=null,ve=f);null!==b?a=[a,b]:(a=null,ve=e)}else a=null,ve=e;return a}function Od(){var a,b,c,d,e,f,g,h;if(g=ve,a=Vd(),null!==a)if(b=s(),null!==b)if(c=Yd(),null!==c){for(d=[],h=ve,e=M(),null!==e?(f=Pd(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==e;)d.push(e),h=ve,e=M(),null!==e?(f=Pd(),null!==f?e=[e,f]:(e=null,ve=h)):(e=null,ve=h);null!==d?a=[a,b,c,d]:(a=null,ve=g)}else a=null,ve=g;else a=null,ve=g;else a=null,ve=g;return a}function Pd(){var a;return a=Qd(),null===a&&(a=Rd(),null===a&&(a=Sd(),null===a&&(a=Td(),null===a&&(a=Ud(),null===a&&(a=yc()))))),a}function Qd(){var a,c,e,f,g;return f=ve,g=ve,"ttl"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"ttl"')),null!==a?(c=G(),null!==c?(e=_d(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.ttl=b}(f,a[2])),null===a&&(ve=f),a}function Rd(){var a,c,e,f,g;return f=ve,g=ve,"maddr"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"maddr"')),null!==a?(c=G(),null!==c?(e=cb(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.maddr=b}(f,a[2])),null===a&&(ve=f),a}function Sd(){var a,c,e,f,g;return f=ve,g=ve,"received"===b.substr(ve,8).toLowerCase()?(a=b.substr(ve,8),ve+=8):(a=null,0===we&&d('"received"')),null!==a?(c=G(),null!==c?(e=kb(),null===e&&(e=hb()),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.received=b}(f,a[2])),null===a&&(ve=f),a}function Td(){var a,c,e,f,g;return f=ve,g=ve,"branch"===b.substr(ve,6).toLowerCase()?(a=b.substr(ve,6),ve+=6):(a=null,0===we&&d('"branch"')),null!==a?(c=G(),null!==c?(e=A(),null!==e?a=[a,c,e]:(a=null,ve=g)):(a=null,ve=g)):(a=null,ve=g),null!==a&&(a=function(a,b){ze.branch=b}(f,a[2])),null===a&&(ve=f),a}function Ud(){var a,c,e,g,h,i,j;if(h=ve,i=ve,"rport"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"rport"')),null!==a){if(j=ve,c=G(),null!==c){for(e=[],g=f();null!==g;)e.push(g),g=f();null!==e?c=[c,e]:(c=null,ve=j)}else c=null,ve=j;c=null!==c?c:"",null!==c?a=[a,c]:(a=null,ve=i)}else a=null,ve=i;return null!==a&&(a=function(){"undefined"!=typeof response_port&&(ze.rport=response_port.join(""))}(h)),null===a&&(ve=h),a}function Vd(){var a,b,c,d,e,f;return f=ve,a=Wd(),null!==a?(b=F(),null!==b?(c=A(),null!==c?(d=F(),null!==d?(e=Xd(),null!==e?a=[a,b,c,d,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function Wd(){var a,c;return c=ve,"sip"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"SIP"')),null===a&&(a=A()),null!==a&&(a=function(a,b){ze.protocol=b}(c,a)),null===a&&(ve=c),a}function Xd(){var a,c;return c=ve,"udp"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"UDP"')),null===a&&("tcp"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"TCP"')),null===a&&("tls"===b.substr(ve,3).toLowerCase()?(a=b.substr(ve,3),ve+=3):(a=null,0===we&&d('"TLS"')),null===a&&("sctp"===b.substr(ve,4).toLowerCase()?(a=b.substr(ve,4),ve+=4):(a=null,0===we&&d('"SCTP"')),null===a&&(a=A())))),null!==a&&(a=function(a,b){ze.transport=b}(c,a)),null===a&&(ve=c),a}function Yd(){var a,b,c,d,e;return d=ve,a=Zd(),null!==a?(e=ve,b=N(),null!==b?(c=$d(),null!==c?b=[b,c]:(b=null,ve=e)):(b=null,ve=e),b=null!==b?b:"",null!==b?a=[a,b]:(a=null,ve=d)):(a=null,ve=d),a}function Zd(){var a,c;return c=ve,a=db(),null===a&&(a=kb(),null===a&&(a=gb())),null!==a&&(a=function(a){ze.host=b.substring(ve,a)}(c)),null===a&&(ve=c),a}function $d(){var a,b,c,d,e,g,h;return g=ve,h=ve,a=f(),a=null!==a?a:"",null!==a?(b=f(),b=null!==b?b:"",null!==b?(c=f(),c=null!==c?c:"",null!==c?(d=f(),d=null!==d?d:"",null!==d?(e=f(),e=null!==e?e:"",null!==e?a=[a,b,c,d,e]:(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h),null!==a&&(a=function(a,b){ze.port=parseInt(b.join(""))}(g,a)),null===a&&(ve=g),a}function _d(){var a,b,c,d,e;return d=ve,e=ve,a=f(),null!==a?(b=f(),b=null!==b?b:"",null!==b?(c=f(),c=null!==c?c:"",null!==c?a=[a,b,c]:(a=null,ve=e)):(a=null,ve=e)):(a=null,ve=e),null!==a&&(a=function(a,b){return parseInt(b.join(""))}(d,a)),null===a&&(ve=d),a}function ae(){var a;return a=bd()}function be(){var a,b,c,d;return d=ve,a=A(),null!==a?(b=u(),null!==b?(c=ce(),null!==c?a=[a,b,c]:(a=null,ve=d)):(a=null,ve=d)):(a=null,ve=d),a}function ce(){var a,b;for(a=[],b=w(),null===b&&(b=y(),null===b&&(b=s()));null!==b;)a.push(b),b=w(),null===b&&(b=y(),null===b&&(b=s()));return a}function de(){var a,b;for(a=[],b=j();null!==b;)a.push(b),b=j();return a}function ee(){var a,c,e,f;return f=ve,a=fe(),null!==a?(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ge(),null!==e?a=[a,c,e]:(a=null,ve=f)):(a=null,ve=f)):(a=null,ve=f),a}function fe(){var a,c;return c=ve,"stuns"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"stuns"')),null===a&&("stun"===b.substr(ve,4).toLowerCase()?(a=b.substr(ve,4),ve+=4):(a=null,0===we&&d('"stun"'))),null!==a&&(a=function(a,b){ze.scheme=b}(c,a)),null===a&&(ve=c),a}function ge(){var a,c,e,f,g;return f=ve,a=he(),null!==a?(g=ve,58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=mb(),null!==e?c=[c,e]:(c=null,ve=g)):(c=null,ve=g),c=null!==c?c:"",null!==c?a=[a,c]:(a=null,ve=f)):(a=null,ve=f),a}function he(){var a,b;return b=ve,a=kb(),null===a&&(a=gb(),null===a&&(a=Wb())),null!==a&&(a=function(a,b){ze.host=b}(b,a)),null===a&&(ve=b),a}function Wb(){var a,c,d;for(d=ve,a=[],c=ie(),null===c&&(c=r(),null===c&&(c=je()));null!==c;)a.push(c),c=ie(),null===c&&(c=r(),null===c&&(c=je()));return null!==a&&(a=function(a){return b.substring(ve,a)}(d)),null===a&&(ve=d),a}function ie(){var a;return a=g(),null===a&&(a=f(),null===a&&(45===b.charCodeAt(ve)?(a="-",ve++):(a=null,0===we&&d('"-"')),null===a&&(46===b.charCodeAt(ve)?(a=".",ve++):(a=null,0===we&&d('"."')),null===a&&(95===b.charCodeAt(ve)?(a="_",ve++):(a=null,0===we&&d('"_"')),null===a&&(126===b.charCodeAt(ve)?(a="~",ve++):(a=null,0===we&&d('"~"'))))))),a}function je(){var a;return 33===b.charCodeAt(ve)?(a="!",ve++):(a=null,0===we&&d('"!"')),null===a&&(36===b.charCodeAt(ve)?(a="$",ve++):(a=null,0===we&&d('"$"')),null===a&&(38===b.charCodeAt(ve)?(a="&",ve++):(a=null,0===we&&d('"&"')),null===a&&(39===b.charCodeAt(ve)?(a="'",ve++):(a=null,0===we&&d('"\'"')),null===a&&(40===b.charCodeAt(ve)?(a="(",ve++):(a=null,0===we&&d('"("')),null===a&&(41===b.charCodeAt(ve)?(a=")",ve++):(a=null,0===we&&d('")"')),null===a&&(42===b.charCodeAt(ve)?(a="*",ve++):(a=null,0===we&&d('"*"')),null===a&&(43===b.charCodeAt(ve)?(a="+",ve++):(a=null,0===we&&d('"+"')),null===a&&(44===b.charCodeAt(ve)?(a=",",ve++):(a=null,0===we&&d('","')),null===a&&(59===b.charCodeAt(ve)?(a=";",ve++):(a=null,0===we&&d('";"')),null===a&&(61===b.charCodeAt(ve)?(a="=",ve++):(a=null,0===we&&d('"="')))))))))))),a}function ke(){var a,c,e,f,g,h,i;return h=ve,a=le(),null!==a?(58===b.charCodeAt(ve)?(c=":",ve++):(c=null,0===we&&d('":"')),null!==c?(e=ge(),null!==e?(i=ve,"?transport="===b.substr(ve,11)?(f="?transport=",ve+=11):(f=null,0===we&&d('"?transport="')),null!==f?(g=Xd(),null!==g?f=[f,g]:(f=null,ve=i)):(f=null,ve=i),f=null!==f?f:"",null!==f?a=[a,c,e,f]:(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h)):(a=null,ve=h),a}function le(){var a,c;return c=ve,"turns"===b.substr(ve,5).toLowerCase()?(a=b.substr(ve,5),ve+=5):(a=null,0===we&&d('"turns"')),null===a&&("turn"===b.substr(ve,4).toLowerCase()?(a=b.substr(ve,4),ve+=4):(a=null,0===we&&d('"turn"'))),null!==a&&(a=function(a,b){ze.scheme=b}(c,a)),null===a&&(ve=c),a}function me(){var a,c,e,f,g;if(f=ve,g=ve,a=Xd(),null!==a){if("udp"===b.substr(ve,3).toLowerCase()?(c=b.substr(ve,3),ve+=3):(c=null,0===we&&d('"udp"')),null===c&&("tcp"===b.substr(ve,3).toLowerCase()?(c=b.substr(ve,3),ve+=3):(c=null,0===we&&d('"tcp"')),null===c))for(c=[],e=p();null!==e;)c.push(e),e=p();null!==c?a=[a,c]:(a=null,ve=g)}else a=null,ve=g;return null!==a&&(a=function(){ze.transport=transport}(f)),null===a&&(ve=f),a}function ne(){var a,c,e;return e=ve,"uuid:"===b.substr(ve,5)?(a="uuid:",ve+=5):(a=null,0===we&&d('"uuid:"')),null!==a?(c=oe(),null!==c?a=[a,c]:(a=null,ve=e)):(a=null,ve=e),a}function oe(){var a,c,e,f,g,h,i,j,k,l,m;return l=ve,m=ve,a=qe(),null!==a?(45===b.charCodeAt(ve)?(c="-",ve++):(c=null,0===we&&d('"-"')),null!==c?(e=pe(),null!==e?(45===b.charCodeAt(ve)?(f="-",ve++):(f=null,0===we&&d('"-"')),null!==f?(g=pe(),null!==g?(45===b.charCodeAt(ve)?(h="-",ve++):(h=null,0===we&&d('"-"')),null!==h?(i=pe(),null!==i?(45===b.charCodeAt(ve)?(j="-",ve++):(j=null,0===we&&d('"-"')),null!==j?(k=re(),null!==k?a=[a,c,e,f,g,h,i,j,k]:(a=null,ve=m)):(a=null,ve=m)):(a=null,ve=m)):(a=null,ve=m)):(a=null,ve=m)):(a=null,ve=m)):(a=null,ve=m)):(a=null,ve=m)):(a=null,ve=m),null!==a&&(a=function(a){ze=b.substring(ve+5,a)}(l,a[0])),null===a&&(ve=l),a}function pe(){var a,b,c,d,e;return e=ve,a=h(),null!==a?(b=h(),null!==b?(c=h(),null!==c?(d=h(),null!==d?a=[a,b,c,d]:(a=null,ve=e)):(a=null,ve=e)):(a=null,ve=e)):(a=null,ve=e),a}function qe(){var a,b,c;return c=ve,a=pe(),null!==a?(b=pe(),null!==b?a=[a,b]:(a=null,ve=c)):(a=null,ve=c),a}function re(){var a,b,c,d;return d=ve,a=pe(),null!==a?(b=pe(),null!==b?(c=pe(),null!==c?a=[a,b,c]:(a=null,ve=d)):(a=null,ve=d)):(a=null,ve=d),a}function se(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}function te(){for(var a=1,c=1,d=!1,e=0;e<Math.max(ve,xe);e++){var f=b.charAt(e);"\n"===f?(d||a++,c=1,d=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(a++,c=1,d=!0):(c++,d=!1)}return{line:a,column:c}}var ue={CRLF:e,DIGIT:f,ALPHA:g,HEXDIG:h,WSP:i,OCTET:j,DQUOTE:k,SP:l,HTAB:m,alphanum:n,reserved:o,unreserved:p,mark:q,escaped:r,LWS:s,SWS:t,HCOLON:u,TEXT_UTF8_TRIM:v,TEXT_UTF8char:w,UTF8_NONASCII:x,UTF8_CONT:y,LHEX:z,token:A,token_nodot:B,separators:C,word:D,STAR:E,SLASH:F,EQUAL:G,LPAREN:H,RPAREN:I,RAQUOT:J,LAQUOT:K,COMMA:L,SEMI:M,COLON:N,LDQUOT:O,RDQUOT:P,comment:Q,ctext:R,quoted_string:S,quoted_string_clean:T,qdtext:U,quoted_pair:V,SIP_URI_noparams:W,SIP_URI:X,uri_scheme:Y,userinfo:Z,user:$,user_unreserved:_,password:ab,hostport:bb,host:cb,hostname:db,domainlabel:eb,toplabel:fb,IPv6reference:gb,IPv6address:hb,h16:ib,ls32:jb,IPv4address:kb,dec_octet:lb,port:mb,uri_parameters:nb,uri_parameter:ob,transport_param:pb,user_param:qb,method_param:rb,ttl_param:sb,maddr_param:tb,lr_param:ub,other_param:vb,pname:wb,pvalue:xb,paramchar:yb,param_unreserved:zb,headers:Ab,header:Bb,hname:Cb,hvalue:Db,hnv_unreserved:Eb,Request_Response:Fb,Request_Line:Gb,Request_URI:Hb,absoluteURI:Ib,hier_part:Jb,net_path:Kb,abs_path:Lb,opaque_part:Mb,uric:Nb,uric_no_slash:Ob,path_segments:Pb,segment:Qb,param:Rb,pchar:Sb,scheme:Tb,authority:Ub,srvr:Vb,reg_name:Wb,query:Xb,SIP_Version:Yb,INVITEm:Zb,ACKm:$b,OPTIONSm:_b,BYEm:ac,CANCELm:bc,REGISTERm:cc,SUBSCRIBEm:dc,NOTIFYm:ec,Method:fc,Status_Line:gc,Status_Code:hc,extension_code:ic,Reason_Phrase:jc,Allow:kc,allow_method:lc,Allow_Events:mc,Call_ID:nc,call_id:oc,Contact:pc,contact_param:qc,name_addr:rc,display_name:sc,contact_params:tc,c_p_q:uc,c_p_expires:vc,delta_seconds:wc,qvalue:xc,generic_param:yc,gen_value:zc,Content_Disposition:Ac,disp_type:Bc,disp_param:Cc,handling_param:Dc,Content_Encoding:Ec,Content_Length:Fc,Content_Type:Gc,media_type:Hc,m_type:Ic,discrete_type:Jc,composite_type:Kc,extension_token:Lc,x_token:Mc,m_subtype:Nc,m_parameter:Oc,m_value:Pc,CSeq:Qc,CSeq_value:Rc,Expires:Sc,Event:Tc,event_type:Uc,From:Vc,from_param:Wc,tag_param:Xc,Max_Forwards:Yc,Min_Expires:Zc,Min_SE:$c,Name_Addr_Header:_c,Proxy_Authenticate:ad,challenge:bd,other_challenge:cd,auth_param:dd,digest_cln:ed,realm:fd,realm_value:gd,domain:hd,URI:id,nonce:jd,nonce_value:kd,opaque:ld,stale:md,algorithm:nd,qop_options:od,qop_value:pd,Proxy_Require:qd,option_tag:rd,Record_Route:sd,rec_route:td,Refer_To:ud,Require:vd,Route:wd,route_param:xd,Session_Expires:yd,se_param:zd,refresher_param:Ad,Subscription_State:Bd,substate_value:Cd,subexp_params:Dd,event_reason_value:Ed,Subject:Fd,Supported:Gd,Target_Dialog:Hd,td_param:Id,remote_param:Jd,local_param:Kd,To:Ld,to_param:Md,Via:Nd,via_parm:Od,via_params:Pd,via_ttl:Qd,via_maddr:Rd,via_received:Sd,via_branch:Td,response_port:Ud,sent_protocol:Vd,protocol_name:Wd,transport:Xd,sent_by:Yd,via_host:Zd,via_port:$d,ttl:_d,WWW_Authenticate:ae,extension_header:be,header_value:ce,message_body:de,stun_URI:ee,stun_scheme:fe,stun_host_port:ge,stun_host:he,reg_name:Wb,stun_unreserved:ie,sub_delims:je,turn_URI:ke,turn_scheme:le,turn_transport:me,uuid_URI:ne,uuid:oe,hex4:pe,hex8:qe,hex12:re};
if(void 0!==c){if(void 0===ue[c])throw new Error("Invalid rule name: "+a(c)+".")}else c="CRLF";var ve=0,we=0,xe=0,ye=[],ze={},Ae=ue[c]();if(null===Ae||ve!==b.length){var Be=Math.max(ve,xe),Ce=Be<b.length?b.charAt(Be):null,De=te();return new this.SyntaxError(se(ye),Ce,Be,De.line,De.column),-1}return ze},toSource:function(){return this._source}};return b.SyntaxError=function(b,c,d,e,f){function g(b,c){var d,e;switch(b.length){case 0:d="end of input";break;case 1:d=b[0];break;default:d=b.slice(0,b.length-1).join(", ")+" or "+b[b.length-1]}return e=c?a(c):"end of input","Expected "+d+" but "+e+" found."}this.name="SyntaxError",this.expected=b,this.found=c,this.message=g(b,c),this.offset=d,this.line=e,this.column=f},b.SyntaxError.prototype=Error.prototype,b}();var CrocMSRP=function(a){function b(a){a.size>0&&a.bufferedChunks.unshift(a.blob),a.blob=new Blob(a.bufferedChunks,{type:a.firstChunk.contentType}),a.size=a.blob.size,a.bufferedChunks=[],a.bufferedBytes=0}return a.ChunkReceiver=function(b,c){if(!b||!b instanceof a.Message.Request)throw new TypeError("Missing or unexpected parameter");this.firstChunk=b,this.totalBytes=b.byteRange.total,this.bufferedChunks=[],this.bufferedBytes=0,this.bufferSize=c,this.blob=new Blob,this.size=0,this.receivedBytes=0,this.aborted=!1,this.remoteAbort=!1,this.incontiguousChunks={},this.isFile=b.contentDisposition&&("attachment"===b.contentDisposition.type||"render"===b.contentDisposition.type),this.processChunk(b)},a.ChunkReceiver.prototype.processChunk=function(c){var d,e,f=this.size+this.bufferedBytes+1;if(this.aborted)return!1;if(c.messageId!==this.firstChunk.messageId)return console.error("Chunk has wrong message ID!"),!1;switch(this.lastReceive=(new Date).getTime(),c.body instanceof ArrayBuffer?(d=new Uint8Array(c.body),e=d.byteLength):(d=new Blob([c.body]),e=d.size),this.receivedBytes+=e,c.continuationFlag){case a.Message.Flag.continued:break;case a.Message.Flag.end:this.totalBytes=c.byteRange.start+e-1;break;case a.Message.Flag.abort:return this.abort(),this.remoteAbort=!0,!1}if(c.byteRange.start===f){for(this.bufferedChunks.push(d),this.bufferedBytes+=e,f+=e;!a.util.isEmpty(this.incontiguousChunks);){var g=this.incontiguousChunks[f];if(!g)break;delete this.incontiguousChunks[f],this.bufferedChunks.push(g),e=g instanceof ArrayBuffer?g.byteLength:g.size,this.bufferedBytes+=e,f+=e}(this.bufferedBytes>=this.bufferSize||this.size+this.bufferedBytes===this.totalBytes)&&b(this)}else if(c.byteRange.start>f)this.incontiguousChunks[c.byteRange.start]=d;else{var h=[];b(this),c.byteRange.start>1&&h.push(this.blob.slice(0,c.byteRange.start-1)),h.push(d),c.byteRange.start+e<=this.size&&h.push(this.blob.slice(c.byteRange.start+e-1)),this.blob=new Blob(h,{type:this.firstChunk.contentType}),this.size=this.blob.size}return!0},a.ChunkReceiver.prototype.isComplete=function(){return this.aborted||this.size===this.totalBytes},a.ChunkReceiver.prototype.abort=function(){this.aborted=!0},a}(CrocMSRP||{}),CrocMSRP=function(a){return a.ChunkSender=function(b,c,d,e,f){if(!b)throw new TypeError("Missing mandatory parameter");if(c)if(c instanceof File)this.blob=c,this.contentType=d||c.type,this.disposition=e||"attachment; filename="+c.name;else if(c instanceof Blob)this.blob=c,this.contentType=d||c.type,this.disposition=e;else if(c instanceof String||"string"==typeof c)this.blob=new Blob([c]),this.contentType=d||"text/plain",this.disposition=e;else if(c instanceof ArrayBuffer)this.blob=new Blob([new Uint8Array(c)]),this.contentType=d||"application/octet-stream",this.disposition=e;else{if(!(c instanceof ArrayBufferView))throw new TypeError("Body has unexpected type:",c);this.blob=new Blob([c]),this.contentType=d||"application/octet-stream",this.disposition=e}else this.blob=new Blob,this.contentType=null,this.disposition=null;this.session=b,this.config=b.config,this.messageId=a.util.newMID(),""===this.contentType&&(this.contentType="application/octet-stream"),this.description=f,this.size=this.blob.size,this.sentBytes=0,this.ackedBytes=0,this.incontiguousReports={},this.incontiguousReportCount=0,this.reportTimer=null,this.onReportTimeout=null,this.aborted=!1,this.remoteAbort=!1},a.ChunkSender.prototype.getNextChunk=function(){var b;if(b=new a.Message.OutgoingRequest(this.session,"SEND"),b.sender=this,b.addHeader("message-id",this.messageId),b.addHeader("success-report","yes"),b.addHeader("failure-report","yes"),this.aborted)b.continuationFlag=a.Message.Flag.abort;else{var c=this.sentBytes+1,d=Math.min(this.sentBytes+this.config.chunkSize,this.size);if(b.byteRange={start:c,end:d,total:this.size},this.size>0&&(0===this.sentBytes&&(this.disposition?b.addHeader("content-disposition",this.disposition):b.addHeader("content-disposition","inline"),this.description&&b.addHeader("content-description",this.description)),b.contentType=this.contentType,b.body=this.blob.slice(this.sentBytes,d)),d<this.size)b.continuationFlag=a.Message.Flag.continued;else if(this.onReportTimeout){var e=this;this.reportTimer=setTimeout(function(){e.onReportTimeout(),e.reportTimer=null},this.config.reportTimeout)}this.sentBytes=d}return b},a.ChunkSender.prototype.processReport=function(b){var c,d=!0;if(b.messageId!==this.messageId)return console.error("REPORT has wrong message ID!"),void 0;if(b.status!==a.Status.OK)this.abort(),this.remoteAbort=!0;else{if(!(b.byteRange.start<=this.ackedBytes+1))return this.incontiguousReportCount>16?(this.resume(),void 0):(this.incontiguousReports[b.byteRange.start]=b.byteRange.end,this.incontiguousReportCount++,void 0);for(b.byteRange.end>this.ackedBytes&&(this.ackedBytes=b.byteRange.end);d;){d=!1;for(c in this.incontiguousReports)c<=this.ackedBytes+1&&(this.incontiguousReports[c]>this.ackedBytes&&(this.ackedBytes=this.incontiguousReports[c]),delete this.incontiguousReports[c],this.incontiguousReportCount--,d=!0)}}this.isComplete()&&this.reportTimer&&(clearTimeout(this.reportTimer),this.reportTimer=null)},a.ChunkSender.prototype.isSendComplete=function(){return this.aborted||this.sentBytes>=this.size},a.ChunkSender.prototype.isComplete=function(){return this.aborted||this.ackedBytes>=this.size},a.ChunkSender.prototype.resume=function(){this.sentBytes=this.ackedBytes,this.incontiguousReports={},this.incontiguousReportCount=0,console.log("Resuming at offset "+this.sentBytes)},a.ChunkSender.prototype.abort=function(){if(this.aborted=!0,this.reportTimer){clearTimeout(this.reportTimer);var a=this;this.reportTimer=setTimeout(function(){a.onReportTimeout(),a.reportTimer=null},0)}},a}(CrocMSRP||{}),CrocMSRP=function(a){function b(b,c,d,e){if(e===a.Status.OK){if(!b.responseOn.success)return}else if(!b.responseOn.failure)return;c.ws.send(new a.Message.OutgoingResponse(b,d,e))}function c(a){for(var b,c=0;a.activeSenders.length>0&&a.outstandingSends<a.config.maxOutstandingSends&&2>c;){b=a.activeSenders[0],b.aborted&&b.remoteAbort&&a.activeSenders.shift();var d=b.getNextChunk();a.ws.send(d),a.outstandingSends++,c++,b.isSendComplete()?a.activeSenders.shift():a.activeSenders.length>1&&a.activeSenders.push(a.activeSenders.shift())}}var d=1e4;return a.Connection=function(b,c,d){var e,f=new a.ConnectionConfig;if(d)for(e in f)void 0===d[e]&&(d[e]=f[e]);else d=f;d.relayWsUri=b,d.relayMsrpUri=c,this.config=d,this.ws=null,this.localSessionIds={},this.reconnectTimer=null,this.activeSenders=[],this.outstandingSends=0},a.Connection.prototype.connect=function(){this.ws||(this.ws=new a.WSWrapper(this,this.config.relayWsUri))},a.Connection.prototype.createSession=function(b){var c,d;do c=a.util.newSID();while(this.localSessionIds[c]);return d=new a.Uri,d.secure="wss"===this.config.relayWsUri.substr(0,3),d.authority=this.config.authority,d.port=2855,d.sessionId=c,d.transport="ws",this.localSessionIds[c]=new a.Session(this,c,d,b),this.ws?this.ws.isConnected()&&this.localSessionIds[c].onWsConnect():this.connect(),this.localSessionIds[c]},a.Connection.prototype.createFileTransferSession=function(a,b,c){var d=this.createSession(a);return d.file=b,d.fileParams=c||{},d},a.Connection.prototype.disconnect=function(){var a;for(a in this.localSessionIds)this.localSessionIds[a].close()},a.Connection.prototype.onWsConnect=function(){var a;for(a in this.localSessionIds)this.localSessionIds[a].onWsConnect()},a.Connection.prototype.onWsError=function(){var b;if(console.log("WS Error"),this.ws&&!a.util.isEmpty(this.localSessionIds)){var c=this;this.reconnectTimer=setTimeout(function(){c.connect()},d)}this.ws=null,this.outstandingSends=0;for(b in this.localSessionIds)this.localSessionIds[b].onWsError()},a.Connection.prototype.onWsDisconnect=function(){console.log("WS Disconnected"),this.ws=null,this.outstandingSends=0},a.Connection.prototype.removeSession=function(b){delete this.localSessionIds[b],a.util.isEmpty(this.localSessionIds)&&this.ws&&this.ws.disconnect()},a.Connection.prototype.onMsrpRequest=function(c){var d,e;if(1!==c.toPath.length)return b(c,this,c.toPath[0],a.Status.SESSION_DOES_NOT_EXIST),void 0;if(d=new a.Uri(c.toPath[0]),!d)return b(c,this,c.toPath[0],a.Status.BAD_REQUEST),void 0;if(e=this.localSessionIds[d.sessionId],!e||!e.localUri.equals(d))return b(c,this,c.toPath[0],a.Status.SESSION_DOES_NOT_EXIST),void 0;switch(c.method){case"SEND":e.onIncomingSend(c);break;case"REPORT":e.onIncomingReport(c);break;default:return b(c,this,c.toPath[0],a.Status.NOT_IMPLEMENTED),void 0}},a.Connection.prototype.addSender=function(a){this.activeSenders.push(a),c(this)},a.Connection.prototype.onMsrpResponse=function(a){"SEND"===a.request.method&&this.outstandingSends--,a.request.session.onIncomingResponse(a),c(this)},a}(CrocMSRP||{}),CrocMSRP=function(a){return a.ConnectionConfig=function(){this.authority=a.util.newUriAuthority(),this.username="anonymous",this.password="",this.digestMethod=null,this.authExpires=null,this.reportTimeout=12e4,this.acceptTypes=["*"],this.acceptWrappedTypes=null,this.chunkSize=2048,this.maxOutstandingSends=32768/this.chunkSize,this.chunkTimeout=3e4,this.recvBuffer=1048576},a}(CrocMSRP||{}),CrocMSRP=function(a){return a.ContentType=function(){this.type="",this.subtype="",this.params={}},a.ContentType.prototype.parseSdpTypeSelector=function(b){var c,d,e,f=0;if(c=b.indexOf("/",f),-1!==c){for(this.type=b.slice(f,c),f=c+1,c=f;c<b.length&&";"!==b.charAt(c);)c++;for(this.subtype=b.slice(f,c),f=c+1,this.params={};";"===b.charAt(c);){if(c=b.indexOf("=",f),-1===c)return f=b.length,void 0;if(d=b.slice(f,c),f=c+1,'"'!==b.charAt(f))return f=b.length,void 0;if(f++,c=b.indexOf('"',f),-1===c)return f=b.length,void 0;e=b.slice(f,c),f=c+1,this.params[d]=a.util.decodeSdpFileName(e)}}},a.ContentType.prototype.toSdpTypeSelector=function(){var b,c="";c=c.concat(this.type,"/",this.subtype);for(b in this.params)c=c.concat(";",b,'="',a.util.encodeSdpFileName(this.params[b]),'"');return c},a.ContentType.prototype.parseContentTypeHeader=function(b){var c,d,e,f=0;if(c=b.indexOf("/",f),-1!==c){for(this.type=b.slice(f,c),f=c+1,c=f;c<b.length&&";"!==b.charAt(c);)c++;for(this.subtype=b.slice(f,c),f=c+1,this.params={};";"===b.charAt(c);){if(c=b.indexOf("=",f),-1===c)return f=b.length,void 0;if(d=b.slice(f,c),f=c+1,'"'===b.charAt(f)){if(f++,c=b.indexOf('"',f),-1===c)return f=b.length,void 0;for(;"\\"===b.charAt(c-1);)if(c=b.indexOf('"',c+1),-1===c)return f=b.length,void 0}else c=b.indexOf(" ",f),-1===c&&(c=b.length);e=b.slice(f,c),f=c+1,this.params[d]=a.util.decodeQuotedString(e)}}},a.ContentType.prototype.toContentTypeHeader=function(){var b,c="";c=c.concat(this.type,"/",this.subtype);for(b in this.params)c=c.concat(";",b,'="',a.util.encodeQuotedString(this.params[b]),'"');return c},a}(CrocMSRP||{}),CrocMSRP=function(a){return a.Events=function(){},a.Events.prototype.onAuthenticated=function(){},a.Events.prototype.onAuthFailed=function(){},a.Events.prototype.onError=function(){},a.Events.prototype.onMessageReceived=function(){},a.Events.prototype.onMessageSent=function(){},a.Events.prototype.onMessageDelivered=function(){},a.Events.prototype.onMessageSendFailed=function(){},a.Events.prototype.onFirstChunkReceived=function(){},a.Events.prototype.onChunkReceived=function(){},a.Events.prototype.onMessageReceiveAborted=function(){},a.Events.prototype.onMessageReceiveTimeout=function(){},a.Events.prototype.onChunkSent=function(){},a.mandatoryEvents=["onAuthenticated","onAuthFailed","onError","onMessageReceived","onMessageSendFailed","onFirstChunkReceived","onMessageReceiveAborted","onMessageReceiveTimeout","onMessageDelivered"],a}(CrocMSRP||{}),CrocMSRP=function(a){return a.Exceptions={},a.Exceptions.UnsupportedMedia=function(){},a.Exceptions.UnsupportedMedia.prototype=new Error,a.Exceptions.UnsupportedMedia.prototype.constructor=a.Exceptions.UnsupportedMedia,a.Exceptions.AbortTransfer=function(){},a.Exceptions.AbortTransfer.prototype=new Error,a.Exceptions.AbortTransfer.prototype.constructor=a.Exceptions.AbortTransfer,a}(CrocMSRP||{}),CrocMSRP=function(a){return a.FileParams=function(){this.selector={},this.selector.name="",this.selector.size=0,this.selector.type="",this.selector.hash={},this.id="",this.disposition="",this.description="",this.icon=""},a}(CrocMSRP||{}),CrocMSRP=function(a){var b="\r\n";return a.Message={},a.Message.Flag={continued:"+",end:"$",abort:"#"},a.Message.Message=function(){},a.Message.Message.prototype.initMessage=function(){this.tid=null,this.toPath=[],this.fromPath=[],this.headers={},this.continuationFlag=a.Message.Flag.end},a.Message.Message.prototype.addHeader=function(b,c){switch(b=a.util.normaliseHeader(b)){case"To-Path":return this.toPath=c.split(" "),void 0;case"From-Path":return this.fromPath=c.split(" "),void 0;case"Content-Type":return this.contentType=c,void 0}this.headers[b]?this.headers[b].push(c):this.headers[b]=[c]},a.Message.Message.prototype.getHeader=function(b){return b=a.util.normaliseHeader(b),b in this.headers?this.headers[b].length>1?this.headers[b]:this.headers[b][0]:null},a.Message.Message.prototype.getEndLineNoFlag=function(){return"-------"+this.tid},a.Message.Message.prototype.getEndLine=function(){return this.getEndLineNoFlag().concat(this.continuationFlag,b)},a.Message.Request=function(){},a.Message.Request.prototype=new a.Message.Message,a.Message.Request.prototype.constructor=a.Message.Request,a.Message.Request.prototype.initRequest=function(){this.initMessage(),this.method=null,this.contentType=null,this.body=null},a.Message.Request.prototype.addBody=function(a,b){this.contentType=a,this.body=b},a.Message.Request.prototype.addTextBody=function(a){this.addBody("text/plain",a)},a.Message.Response=function(){},a.Message.Response.prototype=new a.Message.Message,a.Message.Response.prototype.constructor=a.Message.Response,a.Message.Response.prototype.initResponse=function(){this.initMessage(),this.status=null,this.comment=null},a.Message.OutgoingRequest=function(b,c){if(!b||!c)throw new TypeError("Required parameter is missing");this.initRequest(),this.tid=a.util.newTID(),this.method=c,this.toPath=b.toPath,this.fromPath=[b.localUri],this.session=b,this.byteRange=null},a.Message.OutgoingRequest.prototype=new a.Message.Request,a.Message.OutgoingRequest.prototype.constructor=a.Message.OutgoingRequest,a.Message.OutgoingRequest.prototype.encode=function(){var c,d="",e=this.contentType,f=this.getEndLine();if(this.body&&(this.body instanceof String||"string"==typeof this.body))for(;-1!==this.body.indexOf(f);)this.tid=a.util.newTID(),f=this.getEndLine();if(d=d.concat("MSRP ",this.tid," ",this.method,b),d=d.concat("To-Path: ",this.toPath.join(" "),b),d=d.concat("From-Path: ",this.fromPath.join(" "),b),this.byteRange){var g=this.byteRange,h=g.total<0?"*":g.total;this.addHeader("byte-range",g.start+"-"+g.end+"/"+h)}for(c in this.headers)d=d.concat(c,": ",this.headers[c].join(" "),b);return e&&this.body?(e instanceof a.ContentType&&(e=e.toContentTypeHeader()),d=d.concat("Content-Type: ",e,b,b),d=this.body instanceof String||"string"==typeof this.body?d.concat(this.body,b,f):new Blob([d,this.body,b,f])):d+=f,d},a.Message.IncomingRequest=function(a,b){if(!a||!b)return null;switch(this.initRequest(),this.tid=a,this.method=b,b){case"SEND":this.responseOn={success:!0,failure:!0};break;case"REPORT":this.responseOn={success:!1,failure:!1}}this.byteRange={start:1,end:-1,total:-1}},a.Message.IncomingRequest.prototype=new a.Message.Request,a.Message.IncomingRequest.prototype.constructor=a.Message.IncomingRequest,a.Message.OutgoingResponse=function(b,c,d){return b&&c?(this.initResponse(),this.tid=b.tid,this.status=d||a.Status.OK,this.comment=a.StatusComment[this.status],this.toPath="SEND"===b.method?b.fromPath.slice(0,1):b.fromPath,this.fromPath=[c.toString()],void 0):null},a.Message.OutgoingResponse.prototype=new a.Message.Response,a.Message.OutgoingResponse.prototype.constructor=a.Message.OutgoingResponse,a.Message.OutgoingResponse.prototype.encode=function(){var a,c="";c=c.concat("MSRP ",this.tid," ",this.status),this.comment&&(c=c.concat(" ",this.comment)),c+=b,c=c.concat("To-Path: ",this.toPath.join(" "),b),c=c.concat("From-Path: ",this.fromPath.join(" "),b);for(a in this.headers)c=c.concat(a,": ",this.headers[a].join(" "),b);return c+this.getEndLine()},a.Message.IncomingResponse=function(a,b,c){return a&&b?(this.initResponse(),this.tid=a,this.status=b,this.comment=c,this.request=null,this.authenticate=[],void 0):null},a.Message.IncomingResponse.prototype=new a.Message.Response,a.Message.IncomingResponse.prototype.constructor=a.Message.IncomingResponse,a}(CrocMSRP||{}),CrocMSRP=function(a){var b="\r\n";return a.Sdp={},a.Sdp.Session=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Session.prototype.reset=function(){this.version=0,this.origin=new a.Sdp.Origin,this.sessionName=" ",this.sessionInfo=null,this.uri=null,this.email=null,this.phone=null,this.connection=new a.Sdp.Connection,this.bandwidth=[],this.timing=[new a.Sdp.Timing],this.timezone=null,this.key=null,this.resetAttributes(),this.media=[]},a.Sdp.Session.prototype.addAttribute=function(a,b){this.attributes[a]||(this.attributes[a]=[],this.attributeNameOrder.push(a)),this.attributes[a].push(b)},a.Sdp.Session.prototype.removeAttribute=function(a){this.attributes[a]&&(delete this.attributes[a],this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(a),1))},a.Sdp.Session.prototype.replaceAttribute=function(a,b,c){this.attributes[a]&&(delete this.attributes[a],this.addAttribute(b,c),this.attributeNameOrder.splice(this.attributeNameOrder.lastIndexOf(b),1),this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(a),1,b))},a.Sdp.Session.prototype.resetAttributes=function(){this.attributeNameOrder=[],this.attributes={}},a.Sdp.Session.prototype.parse=function(c){var d,e,f,g,h=c.split(b);if(this.reset(),""===h[h.length-1]&&h.pop(),h.length<4)return console.log("Unexpected SDP length: "+h.length),!1;if(d=h.shift(),"v=0"!==d)return console.log("Unexpected SDP version: "+d),!1;if(d=h.shift(),"o="!==d.substr(0,2)||!(this.origin=new a.Sdp.Origin(d.substr(2))))return console.log("Unexpected SDP origin: "+d),!1;if(d=h.shift(),"s="!==d.substr(0,2))return console.log("Unexpected SDP session name: "+d),!1;for(this.sessionName=d.substr(2);h.length>0&&"t"!==h[0].charAt(0);)switch(d=h.shift(),e=d.substr(2),d.substr(0,2)){case"i=":this.sessionInfo=e;break;case"u=":this.uri=e;break;case"e=":this.email=e;break;case"p=":this.phone=e;break;case"c=":if(e=new a.Sdp.Connection(e),!e)return!1;this.connection=e;break;case"b=":this.bandwidth.push(e);break;default:return console.log("Unexpected SDP line (pre-timing): "+d),!1}if(0===h.length)return console.log("Unexpected end of SDP (pre-timing)"),!1;for(this.timing=[];h.length>0&&"t"===h[0].charAt(0);){for(d=h.shift().substr(2);h.length>0&&"r"===h[0].charAt(0);)d+=b+h.shift();if(e=new a.Sdp.Timing(d),!e)return!1;this.timing.push(e)}if(0===this.timing.length)return console.log("No timing line found"),!1;for(;h.length>0&&"m"!==h[0].charAt(0);)switch(d=h.shift(),e=d.substr(2),d.substr(0,2)){case"z=":this.timezone=e;break;case"k=":this.key=e;break;case"a=":f=e.indexOf(":"),-1===f?(g=e,e=null):(g=e.substr(0,f),e=e.substr(f+1)),this.addAttribute(g,e);break;default:return console.log("Unexpected SDP line (pre-media): "+d),!1}for(;h.length>0&&"m"===h[0].charAt(0);){for(d=h.shift().substr(2);h.length>0&&"m"!==h[0].charAt(0);)d+=b+h.shift();if(e=new a.Sdp.Media(d),!e)return!1;this.media.push(e)}return!0},a.Sdp.Session.prototype.toString=function(){var a,c,d,e="";e+="v="+this.version+b,e+="o="+this.origin+b,e+="s="+this.sessionName+b,this.sessionInfo&&(e+="i="+this.sessionInfo+b),this.uri&&(e+="u="+this.uri+b),this.email&&(e+="e="+this.email+b),this.phone&&(e+="p="+this.phone+b),this.connection&&(e+="c="+this.connection+b);for(a in this.bandwidth)e+="b="+this.bandwidth[a]+b;for(a in this.timing)e+="t="+this.timing[a]+b;this.timezone&&(e+="z="+this.timezone+b),this.key&&(e+="k="+this.key+b);for(var f=0,g=this.attributeNameOrder.length;g>f;f++){c=this.attributeNameOrder[f],d=this.attributes[c];for(a in d)e+="a="+c,d[a]&&(e+=":"+d[a]),e+=b}for(a in this.media)e+="m="+this.media[a]+b;return e},a.Sdp.Origin=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Origin.prototype.reset=function(){this.username="-",this.id=a.util.dateToNtpTime(new Date),this.version=this.sessId,this.netType="IN",this.addrType="IP4",this.address="address.invalid"},a.Sdp.Origin.prototype.parse=function(a){var b;return b=a.split(" "),6!==b.length?(console.log("Unexpected origin line: "+a),!1):(this.username=b[0],this.id=b[1],this.version=b[2],this.netType=b[3],this.addrType=b[4],this.address=b[5],!0)},a.Sdp.Origin.prototype.toString=function(){var a="";return a+=this.username+" ",a+=this.id+" ",a+=this.version+" ",a+=this.netType+" ",a+=this.addrType+" ",a+=this.address},a.Sdp.Connection=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Connection.prototype.reset=function(){this.netType="IN",this.addrType="IP4",this.address="address.invalid"},a.Sdp.Connection.prototype.parse=function(a){var b;return b=a.split(" "),3!==b.length?(console.log("Unexpected connection line: "+a),!1):(this.netType=b[0],this.addrType=b[1],this.address=b[2],!0)},a.Sdp.Connection.prototype.toString=function(){var a="";return a+=this.netType+" ",a+=this.addrType+" ",a+=this.address},a.Sdp.Timing=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Timing.prototype.reset=function(){this.start=null,this.stop=null,this.repeat=[]},a.Sdp.Timing.prototype.parse=function(c){var d,e,f;return d=c.split(b),e=d.shift(),f=e.split(" "),2!==f.length?(console.log("Unexpected timing line: "+e),!1):(this.start="0"===f[0]?null:a.util.ntpTimeToDate(f[0]),this.stop="0"===f[1]?null:a.util.ntpTimeToDate(f[1]),this.repeat=d,!0)},a.Sdp.Timing.prototype.toString=function(){var c,d="";d+=this.start?a.util.dateToNtpTime(this.start):"0",d+=" ",d+=this.stop?a.util.dateToNtpTime(this.stop):"0";for(c in this.repeat)d+=b+this.repeat[c];return d},a.Sdp.Media=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Media.prototype.reset=function(){this.media="message",this.port=2855,this.proto="TCP/MSRP",this.format="*",this.title=null,this.connection=null,this.bandwidth=[],this.key=null,this.resetAttributes()},a.Sdp.Media.prototype.addAttribute=function(a,b){this.attributes[a]||(this.attributes[a]=[],this.attributeNameOrder.push(a)),this.attributes[a].push(b)},a.Sdp.Media.prototype.removeAttribute=function(a){this.attributes[a]&&(delete this.attributes[a],this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(a),1))},a.Sdp.Media.prototype.resetAttributes=function(){this.attributeNameOrder=[],this.attributes={}},a.Sdp.Media.prototype.replaceAttribute=function(a,b,c){this.attributes[a]&&(delete this.attributes[a],this.addAttribute(b,c),this.attributeNameOrder.splice(this.attributeNameOrder.lastIndexOf(b),1),this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(a),1,b))},a.Sdp.Media.prototype.parse=function(c){var d,e,f,g,h;if(this.reset(),d=c.split(b),e=d.shift(),f=e.split(" "),f.length<4)return console.log("Unexpected media line: "+e),!1;this.media=f.shift(),this.port=parseInt(f.shift(),10),this.proto=f.shift(),this.format=f.join(" ");for(g in d){var i,j=d[g].substr(2);switch(d[g].substr(0,2)){case"i=":this.title=j;break;case"c=":if(this.connection=new a.Sdp.Connection(j),!this.connection)return!1;break;case"b=":this.bandwidth.push(j);break;case"k=":this.key=j;break;case"a=":i=j.indexOf(":"),-1===i?(h=j,j=null):(h=j.substr(0,i),j=j.substr(i+1)),this.addAttribute(h,j);break;default:return console.log("Unexpected type (within media): "+d[g]),!1}}return!0},a.Sdp.Media.prototype.toString=function(){var a,c,d,e="";e+=this.media+" ",e+=this.port+" ",e+=this.proto+" ",e+=this.format,this.title&&(e+=b+"i="+this.title),this.connection&&(e+=b+"c="+this.connection);for(a in this.bandwidth)e+=b+"b="+this.bandwidth[a];this.key&&(e+=b+"k="+this.key);for(var f=0,g=this.attributeNameOrder.length;g>f;f++){c=this.attributeNameOrder[f],d=this.attributes[c];for(a in d)e+=b+"a="+c,d[a]&&(e+=":"+d[a])}return e},a.Sdp.parseFileAttributes=function(b){for(var c,d,e,f,g={},h=0,i={},j=b.attributes["file-selector"][0];h<j.length;)if(" "!==j.charAt(h)){if(c=j.indexOf(":",h),-1===c)break;if(d=j.slice(h,c),h=c+1,'"'===j.charAt(h)){if(h++,f=j.indexOf('"',h),-1===f)break;e=j.slice(h,f),h=f+1}else if("type"===d){var k=!1;for(f=h;f<j.length&&(k||" "!==j.charAt(f));)'"'===j.charAt(f)&&(k=!k),f++;e=new a.ContentType,e.parseSdpTypeSelector(j.slice(h,f)),h=f+1}else f=j.indexOf(" ",h),-1===f&&(f=j.length),e=j.slice(h,f),h=f+1;switch(d){case"name":i.name=a.util.decodeSdpFileName(e);break;case"size":i.size=parseInt(e,10);break;case"type":i.type=e;break;case"hash":i.hash||(i.hash={}),c=e.indexOf(":"),i.hash[e.substring(0,c)]=e.substring(c+1);break;default:continue}}else h++;return g.selector=i,g.id=b.attributes["file-transfer-id"][0],g.disposition=b.attributes["file-disposition"][0]||"render",b.title&&(g.description=b.title),b.attributes["file-icon"]&&(g.icon=b.attributes["file-icon"][0]),g},a}(CrocMSRP||{}),CrocMSRP=function(a){function b(b,c){return function(){delete b.chunkSenders[c];try{b.eventObj.onMessageSendFailed(c,a.Status.REQUEST_TIMEOUT,"Report Timeout")}catch(d){console.warn("Unexpected application exception: "+d.stack)}}}function c(b,e){switch(console.log("Change session state: sessionId="+b.sessionId+", old="+b.state+", new="+e),b.state=e,e){case j.AWAIT_CONNECT:b.established=!1,d(b);break;case j.AWAIT_CHALLENGE:case j.AWAIT_AUTH_RES:break;case j.AWAIT_SDP:b.sdpSessVer=a.util.dateToNtpTime(new Date);try{b.eventObj.onAuthenticated()}catch(f){console.warn("Unexpected application exception: "+f.stack)}break;case j.ESTABLISHED:if(!b.established&&!a.util.isEmpty(this.chunkSenders)){var g;for(g in this.chunkSenders)this.chunkSenders[g].resume()}b.established=!0;break;case j.AUTH_FAILED:b.established=!1,d(b);try{b.eventObj.onAuthFailed()}catch(f){console.warn("Unexpected application exception: "+f.stack)}b.con.removeSession(b.sessionId);break;case j.ERROR:b.established=!1,d(b);try{b.eventObj.onError()}catch(f){console.warn("Unexpected application exception: "+f.stack)}b.con.removeSession(b.sessionId);break;case j.CLOSED:b.established=!1,d(b),b.con.removeSession(b.sessionId);break;default:console.error("Invalid state: "+e),c(b,j.ERROR)}}function d(a){a.authTimer&&(clearTimeout(a.authTimer),a.authTimer=null),a.relayPath=[],a.farEndPath=[]}function e(b,d){var e;if(e=new a.Message.OutgoingRequest(b,"AUTH"),e.toPath=[b.config.relayMsrpUri],d){var f,g=null;if(!d.authenticate)return console.log("Auth failed: no WWW-Authenticate header available"),c(b,j.ERROR),void 0;for(f in d.authenticate)if(g=a.digestAuthentication(b.config,d.request,d.authenticate[f]))break;if(!g||0===g.length)return console.log("Construction of authorization failed"),c(b,j.ERROR),void 0;e.addHeader("authorization",g),c(b,j.AWAIT_AUTH_RES)}else c(b,j.AWAIT_CHALLENGE);b.config.authExpires&&e.addHeader("expires",b.config.authExpires),b.con.ws.send(e)}function f(a,b){return b.usePath?(a.relayPath=b.usePath,a.authTimer=setTimeout(function(){a.authTimer=null,d(a),e(a)},1e3*(b.expires-30)),c(a,j.AWAIT_SDP),void 0):(console.log("Use-Path header missing!"),c(a,j.ERROR),void 0)}function g(b,c,d,e){if(e===a.Status.OK){if(!b.responseOn.success)return}else if(!b.responseOn.failure)return;c.ws.send(new a.Message.OutgoingResponse(b,d,e))}function h(b,c){var d;if(d=new a.Message.OutgoingRequest(b,"REPORT"),d.addHeader("message-id",c.messageId),d.addHeader("status","000 200 OK"),c.byteRange||c.continuationFlag===a.Message.Flag.continued){var e,f=1,g=-1;if(c.byteRange&&(f=c.byteRange.start,g=c.byteRange.total),c.body)if(c.body instanceof ArrayBuffer)e=f+c.body.byteLength-1;else{var h=new Blob([c.body]);e=f+h.size-1}else e=0;e!==c.byteRange.end&&console.warn("Report Byte-Range end does not match request"),d.byteRange={start:f,end:e,total:g}}b.con.ws.send(d)}function i(b){var c,d,e=(new Date).getTime(),f=b.config.chunkTimeout;for(c in b.chunkReceivers)if(d=b.chunkReceivers[c],e-d.lastReceive>f){d.abort(),delete b.chunkReceivers[c];try{b.eventObj.onMessageReceiveTimeout(c,d.blob)}catch(g){console.warn("Unexpected application exception: "+g.stack)}}a.util.isEmpty(b.chunkReceivers)&&(clearInterval(b.receiverCheckInterval),b.receiverCheckInterval=null)}var j;return j={AWAIT_CONNECT:0,AWAIT_CHALLENGE:1,AWAIT_AUTH_RES:2,AWAIT_SDP:3,ESTABLISHED:4,ERROR:5,CLOSED:6},a.Session=function(b,c,e,f){var g;if(!f)throw"Event object required";for(g in a.mandatoryEvents)if(!f[a.mandatoryEvents[g]])throw"Event object missing mandatory event: "+a.mandatoryEvents[g];this.con=b,this.config=b.config,this.sessionId=c,this.localUri=e,this.toPath=[],this.eventObj=f,d(this),this.sdpSessId=a.util.dateToNtpTime(new Date),this.sdpSessVer=this.sdpSessId,this.acceptTypes=[],this.acceptWrappedTypes=[],this.chunkReceivers={},this.receiverCheckInterval=null,this.chunkSenders={},this.state=j.AWAIT_CONNECT,this.established=!1,this.fileParams=null},a.Session.prototype.getSdpOffer=function(){var b,c;switch(this.state){case j.AWAIT_SDP:case j.ESTABLISHED:break;default:return null}if(c=new a.Sdp.Media,c.port=this.localUri.port,c.proto=this.localUri.secure?"TCP/TLS/MSRP":"TCP/MSRP",c.addAttribute("accept-types",this.config.acceptTypes.join(" ")),this.config.acceptWrappedTypes&&this.config.acceptWrappedTypes.length>0&&c.addAttribute("accept-wrapped-types",this.config.acceptWrappedTypes.join(" ")),c.addAttribute("path",this.relayPath.slice().reverse().join(" ")+" "+this.localUri),this.file){var d,e=this.fileParams,f="";if(e.selector=e.selector||{},e.selector.name=e.selector.name||this.file.name,e.selector.size=e.selector.size||this.file.size,e.selector.type=e.selector.type||this.file.type,e.selector.hash=e.selector.hash||{},e.id=e.id||a.util.newFileTransferId(),e.disposition=e.disposition||"render",e.description&&(c.title=e.description),e.selector.name&&(f=f.concat('name:"',a.util.encodeSdpFileName(e.selector.name),'"')),e.selector.size&&(f&&(f+=" "),f=f.concat("size:",e.selector.size)),e.selector.type){var g;f&&(f+=" "),g=e.selector.type instanceof a.ContentType?e.selector.type.toSdpTypeSelector():e.selector.type,f=f.concat("type:",g)}for(d in e.selector.hash)f&&(f+=" "),f=f.concat("hash:",d,":",e.selector.hash[d]);c.addAttribute("file-selector",f),c.addAttribute("file-transfer-id",e.id),c.addAttribute("file-disposition",e.disposition),e.icon&&c.addAttribute("file-icon",e.icon),c.addAttribute("sendonly",null)}return b=new a.Sdp.Session,b.origin.username=this.config.username,b.origin.id=this.sdpSessId,b.origin.version=this.sdpSessVer,b.origin.address=this.config.authority,b.connection.address=this.config.authority,b.media.push(c),b.toString()},a.Session.prototype.processSdpAnswer=function(d){var e,f,g,h;switch(this.state){case j.AWAIT_SDP:case j.ESTABLISHED:break;default:return null}if(d=new a.Sdp.Session(d),!d)return null;for(e in d.media)if(f=d.media[e],"message"===f.media&&0!==f.port&&f.attributes.path&&f.attributes["accept-types"]){if(this.farEndPath=f.attributes.path[0].split(" "),this.toPath=this.relayPath.concat(this.farEndPath),this.acceptTypes=f.attributes["accept-types"][0].split(" "),this.acceptWrappedTypes=f.attributes["accept-wrapped-types"]?f.attributes["accept-wrapped-types"][0].split(" "):[],c(this,j.ESTABLISHED),a.util.isEmpty(this.chunkSenders)){var i=this;
if(this.file){var k=this.fileParams;g=new a.ChunkSender(this,this.file,k.selector.type,k.disposition,k.description)}else g=new a.ChunkSender(this,null);return g.onReportTimeout=b(i,g.messageId),this.con.addSender(g),this.chunkSenders[g.messageId]=g,g.messageId}for(h in this.chunkSenders)return h}return null},a.Session.prototype.getSdpAnswer=function(b){var d,e,f,g=!1;switch(this.state){case j.AWAIT_SDP:case j.ESTABLISHED:break;default:return null}if(d=new a.Sdp.Session(b),!d)return null;d.origin.username=this.config.username,d.origin.id=this.sdpSessId,d.origin.version=this.sdpSessVer,d.origin.address=this.config.authority,d.connection&&(d.connection.address=this.config.authority);for(e in d.media)f=d.media[e],g||"message"!==f.media||0===f.port||"TCP/MSRP"!==f.proto&&"TCP/TLS/MSRP"!==f.proto||!f.attributes.path||!f.attributes["accept-types"]?f.port=0:(this.farEndPath=f.attributes.path[0].split(" "),this.toPath=this.relayPath.concat(this.farEndPath),this.acceptTypes=f.attributes["accept-types"][0].split(" "),this.acceptWrappedTypes=f.attributes["accept-wrapped-types"]?f.attributes["accept-wrapped-types"][0].split(" "):[],f.attributes["file-selector"]&&(this.fileParams=a.Sdp.parseFileAttributes(f),f.replaceAttribute("sendonly","recvonly",null)),c(this,j.ESTABLISHED),g=!0,f.resetAttributes(),f.port=this.localUri.port,f.proto=this.localUri.secure?"TCP/TLS/MSRP":"TCP/MSRP",f.addAttribute("accept-types",this.config.acceptTypes.join(" ")),this.config.acceptWrappedTypes&&this.config.acceptWrappedTypes.length>0&&f.addAttribute("accept-wrapped-types",this.config.acceptWrappedTypes.join(" ")),f.addAttribute("path",this.relayPath.slice().reverse().join(" ")+" "+this.localUri));return d.toString()},a.Session.prototype.send=function(c,d){var e,f,g=this;if(!this.established)throw"Unable to send, session not yet established";return e=c instanceof String||"string"==typeof c?d||"text/plain":c instanceof Blob?d||c.type||"application/octet-stream":d||"application/octet-stream",f=new a.ChunkSender(this,c,e),f.onReportTimeout=b(g,f.messageId),this.con.addSender(f),this.chunkSenders[f.messageId]=f,f.messageId},a.Session.prototype.abortReceive=function(a){if(a){var b=this.chunkReceivers[a];if(!b)throw new RangeError("Invalid message id");b.abort()}else for(a in this.chunkReceivers)this.chunkReceivers[a].abort()},a.Session.prototype.abortSend=function(a){if(a){var b=this.chunkSenders[a];if(!b)throw new RangeError("Invalid message id");b.abort()}else for(a in this.chunkSenders)this.chunkSenders[a].abort()},a.Session.prototype.close=function(){this.abortReceive(),this.abortSend(),c(this,j.CLOSED)},a.Session.prototype.onWsConnect=function(){e(this)},a.Session.prototype.onWsError=function(){c(this,j.AWAIT_CONNECT)},a.Session.prototype.onIncomingSend=function(b){var c,d,e=null,f=null,j=-1;try{if(1===b.byteRange.start&&b.continuationFlag===a.Message.Flag.end)b.body&&(c=b.messageId||a.util.newMID(),j=b.byteRange.total,!b.contentDisposition||"attachment"!==b.contentDisposition.type&&"render"!==b.contentDisposition.type||(e=b.getHeader("content-description"),f=b.contentDisposition.param.filename),this.eventObj.onFirstChunkReceived(c,b.contentType,f,j,e),this.eventObj.onChunkReceived&&this.eventObj.onChunkReceived(c,j),this.eventObj.onMessageReceived(c,b.contentType,b.body));else{if(c=b.messageId,!c||!(c instanceof String||"string"==typeof c))return g(b,this.con,this.localUri,a.Status.BAD_REQUEST),void 0;if(1===b.byteRange.start&&b.continuationFlag===a.Message.Flag.continued){if(d=new a.ChunkReceiver(b,this.config.recvBuffer),e=b.getHeader("content-description")||null,f=b.contentDisposition.param.filename||null,this.eventObj.onFirstChunkReceived(c,b.contentType,f,b.byteRange.total,e),this.chunkReceivers[c]=d,!this.receiverCheckInterval){var k=this;this.receiverCheckInterval=setInterval(function(){i(k)},1e3)}}else{if(d=this.chunkReceivers[c],!d)return g(b,this.con,this.localUri,a.Status.STOP_SENDING),void 0;if(!d.processChunk(b)){delete this.chunkReceivers[c],d.remoteAbort?g(b,this.con,this.localUri,a.Status.STOP_SENDING):g(b,this.con,this.localUri,a.Status.STOP_SENDING);try{this.eventObj.onMessageReceiveAborted(c,d.blob)}catch(l){console.warn("Unexpected application exception: "+l.stack)}return}}if(d.isComplete()){delete this.chunkReceivers[c];var m=d.blob;this.eventObj.onMessageReceived(c,m.type,m)}else this.eventObj.onChunkReceived&&this.eventObj.onChunkReceived(c,d.receivedBytes)}}catch(l){var n=a.Status.INTERNAL_SERVER_ERROR;return l instanceof a.Exceptions.UnsupportedMedia?n=a.Status.UNSUPPORTED_MEDIA:console.warn("Unexpected application exception: "+l.stack),g(b,this.con,this.localUri,n),void 0}g(b,this.con,this.localUri,a.Status.OK),"yes"===b.getHeader("success-report")&&h(this,b)},a.Session.prototype.onIncomingReport=function(b){var c,d;if(c=b.messageId,!c)return console.log("Invalid REPORT: no message id"),void 0;if(d=this.chunkSenders[c],!d)return console.log("Invalid REPORT: unknown message id"),void 0;if(d.processReport(b),d.isComplete()&&(delete this.chunkSenders[c],!d.aborted||d.remoteAbort))try{b.status===a.Status.OK?this.eventObj.onMessageDelivered&&this.eventObj.onMessageDelivered(c):this.eventObj.onMessageSendFailed(c,b.status,b.comment)}catch(e){console.warn("Unexpected application exception: "+e.stack)}},a.Session.prototype.onIncomingResponse=function(b){var d;if("AUTH"!==b.request.method){if(d=b.request.getHeader("message-id"),!d)return console.log("Can't retrieve SEND message id"),void 0;var g=b.request.sender;if(b.status===a.Status.OK)try{!g.aborted&&this.eventObj.onChunkSent&&this.eventObj.onChunkSent(d,b.request.byteRange.end),b.request.continuationFlag===a.Message.Flag.end&&this.eventObj.onMessageSent&&this.eventObj.onMessageSent(d)}catch(h){console.warn("Unexpected application exception: "+h.stack)}else{g.abort(),g.remoteAbort=!0,delete this.chunkSenders[d];try{this.eventObj.onMessageSendFailed(d,b.status,b.comment)}catch(h){console.warn("Unexpected application exception: "+h.stack)}}}else switch(b.status){case a.Status.UNAUTHORIZED:this.state===j.AWAIT_AUTH_RES?c(this,j.AUTH_FAILED):e(this,b);break;case a.Status.OK:f(this,b);break;case a.Status.INTERVAL_OUT_OF_BOUNDS:this.config.authExpires=b.expires,e(this);break;default:c(this,j.AUTH_FAILED)}},a}(CrocMSRP||{}),CrocMSRP=function(a){return a.Status={OK:200,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,REQUEST_TIMEOUT:408,STOP_SENDING:413,UNSUPPORTED_MEDIA:415,INTERVAL_OUT_OF_BOUNDS:423,SESSION_DOES_NOT_EXIST:481,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,WRONG_CONNECTION:506},a.StatusComment={200:"OK",400:"Bad Request",401:"Unauthorized",403:"Forbidden",408:"Request Timeout",413:"Stop Sending Message",415:"Unsupported Media Type",423:"Interval Out-of-Bounds",481:"Session Does Not Exist",500:"Internal Server Error",501:"Not Implemented",506:"Wrong Connection"},a}(CrocMSRP||{}),CrocMSRP=function(a){return a.Uri=function(a){this.secure=!1,this.user=null,this.authority="",this.port=null,this.sessionId="",this.transport="tcp",a&&(this.uri=a,this.parse(a))},a.Uri.prototype.parse=function(a){var b,c,d,e,f,g=a.indexOf("://");if(-1===g)throw new TypeError("Invalid MSRP URI: "+a);switch(b=a.substring(0,g),b.toLowerCase()){case"msrp":this.secure=!1;break;case"msrps":this.secure=!0;break;default:throw new TypeError("Invalid MSRP URI (unknown scheme): "+a)}if(e=a.indexOf("/",g+3),-1===e)throw new TypeError("Invalid MSRP URI (no session ID): "+a);if(this.authority=a.substring(g+3,e),c=this.authority.indexOf("@"),-1!==c&&(this.user=this.authority.substr(0,c),this.authority=this.authority.substr(c+1)),d=this.authority.indexOf(":"),-1!==d&&(this.port=this.authority.substr(d+1),this.authority=this.authority.substr(0,d)),f=a.indexOf(";",g+3),-1===f)throw new TypeError("Invalid MSRP URI (no transport): "+a);return this.sessionId=a.substring(e+1,f),this.transport=a.substring(f+1),!0},a.Uri.prototype.toString=function(){var a="msrp";return this.uri?this.uri:(this.secure&&(a+="s"),a+="://",this.user&&(a+=this.user+"@"),a+=this.authority,this.port&&(a+=":"+this.port),a+="/"+this.sessionId+";"+this.transport,this.uri=a,a)},a.Uri.prototype.equals=function(b){return("string"==typeof b||b instanceof String)&&(b=new a.Uri(b)),!b instanceof Object?!1:b.secure!==this.secure?!1:b.authority.toLowerCase()!==this.authority.toLowerCase()?!1:parseInt(b.port,10)!==parseInt(this.port,10)?!1:b.sessionId!==this.sessionId?!1:b.transport.toLowerCase()!==this.transport.toLowerCase()?!1:!0},a}(CrocMSRP||{}),CrocMSRP=function(a){function b(b,c){delete c.timer,delete b.transactions[c.tid];var d=new a.Message.IncomingResponse(c.tid,408,a.StatusComment[408]);d.request=c,b.con.onMsrpResponse(d)}var c;return c={INIT:0,CONNECTING:1,CONNECTED:2,ERROR:3,DISCONNECTING:4,DISCONNECTED:5},a.WSWrapper=function(a,b){this.con=a,this.relayUri=b,this.state=c.INIT,this.ws=null,this.transactions={},this.connect()},a.WSWrapper.prototype.isConnected=function(){return this.state===c.CONNECTED},a.WSWrapper.prototype.connect=function(){var a,b=this;this.state=c.CONNECTING,console.log("Attempting WebSocket Connection to "+this.relayUri);try{a=new WebSocket(this.relayUri,"msrp")}catch(d){return console.log("Connection error: "+d),!1}return a.binaryType="arraybuffer",a.onopen=function(a){b.onOpen(a)},a.onerror=function(a){b.onError(a)},a.onclose=function(a){b.onClose(a)},a.onmessage=function(a){b.onMessage(a)},this.running=!0,this.ws=a,!0},a.WSWrapper.prototype.disconnect=function(){this.state=c.DISCONNECTING,this.ws&&this.ws.close()},a.WSWrapper.prototype.send=function(d){var e=this;if(this.state!==c.CONNECTED||!this.ws||this.ws.readyState!==WebSocket.OPEN)return console.log("Send failed: socket not ready"),!1;d instanceof a.Message.Request&&"REPORT"!==d.method&&(d.timer=setTimeout(function(){b(e,d)},3e4),this.transactions[d.tid]=d);try{this.ws.send(d.encode())}catch(f){return console.log("Send failed: "+f),!1}return!0},a.WSWrapper.prototype.onOpen=function(){this.state=c.CONNECTED,this.con.onWsConnect()},a.WSWrapper.prototype.onError=function(){this.state=c.ERROR,console.log("WebSocket error")},a.WSWrapper.prototype.onClose=function(a){this.state===c.DISCONNECTING?this.con.onWsDisconnect():(console.warn("WebSocket closed unexpectedly: wasClean="+a.wasClean+" code="+a.code),this.con.onWsError()),this.state=c.DISCONNECTED},a.WSWrapper.prototype.onMessage=function(b){var d=a.parseMessage(b.data);return d?d instanceof a.Message.Response?(d.request=this.transactions[d.tid],d.request?(clearTimeout(d.request.timer),delete d.request.timer,delete this.transactions[d.tid],this.con.onMsrpResponse(d)):console.log("Unexpected response received; not in transaction list"),void 0):(this.con.onMsrpRequest(d),void 0):(this.state=c.ERROR,console.log("MSRP message parsing error; closing websocket"),this.ws.close(),void 0)},a}(CrocMSRP||{}),CrocMSRP,CrocMSRP=function(a){var b=", ",c="undefined"==typeof JsSIP?hex_md5:JsSIP.Utils.calculateMD5;return a.digestAuthentication=function(a,d,e){var f,g,h,i="Digest ",j=d.toPath[d.toPath.length-1],k=null,l="00000001",m=Math.random().toString(36).substr(2,12);if(e.qop&&-1!==e.qop.split(" ").indexOf("auth")&&(k="auth"),i+='username="'+a.username+'"',i+=b+'realm="'+e.realm+'"',i+=b+'nonce="'+e.nonce+'"',i+=b+'uri="'+j+'"',f=c(a.username+":"+e.realm+":"+a.password),g=a.digestMethod?c(a.digestMethod+":"+j):c(d.method+":"+j),h=k?c(f+":"+e.nonce+":"+l+":"+m+":auth:"+g):c(f+":"+e.nonce+":"+g),i+=b+'response="'+h+'"',e.algorithm){if("MD5"!==e.algorithm)return console.log('Auth failure: unsupported "algorithm" parameter in challenge'),null;i+=b+"algorithm=MD5"}return k&&(i+=b+"qop="+k,i+=b+'cnonce="'+m+'"',i+=b+"nc="+l),e.opaque&&(i+=b+'opaque="'+e.opaque+'"'),i},a}(CrocMSRP),CrocMSRP=function(a){function b(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}function c(a){return a.replace(/^"/,"").replace(/"$/,"")}function d(a,c,d){var e,f,g,h,i=d.getEndLineNoFlag();return"\r\n"===a.substr(c,2)||a.substr(c,i.length)===i?0:(e=a.indexOf("\r\n",c),-1===e?(console.log("Error parsing header: no CRLF"),-1):(f=a.indexOf(":",c),-1===f?(console.log("Error parsing header: no colon"),-1):(g=b(a.substring(c,f)),0===g.length?(console.log("Error parsing header: no name"),-1):(h=b(a.substring(f+1,e)),0===g.length?(console.log("Error parsing header: no value"),-1):(d.addHeader(g,h),e+2)))))}function e(a,d,e){var f,g,h,i;return f=a.indexOf("=",d),-1===f?-1:(g=f+1,'"'===a.charAt(g)&&(g=a.indexOf('"',g+1),-1===g)?-1:(g=a.indexOf(",",g),-1===g&&(g=a.length),h=b(a.substring(d,f)),i=c(b(a.substring(f+1,g))),0===h.length||0===i.length?-1:(e[h]=i,g+1)))}function f(a,b){var c,d,f,g;for(c in a){if(d=a[c],f={},!d.match(/^Digest /))return!1;for(g=7;-1!==g&&g<d.length;)g=e(d,g,f);if(-1===g)return!1;b.authenticate.push(f)}return!0}function g(a,c){var d,e,f,g={};return 1!==a.length?!1:(d=a[0],e=d.indexOf("-"),f=d.indexOf("/",e),-1===e||-1===f?(console.log("Unexpected Byte-Range format: "+d),!1):(g.start=parseInt(b(d.substring(0,e)),10),g.end=b(d.substring(e+1,f)),g.end="*"===g.end?-1:parseInt(g.end,10),g.total=b(d.substring(f+1)),g.total="*"===g.total?-1:parseInt(g.total,10),isNaN(g.start)||isNaN(g.end)||isNaN(g.total)?(console.log("Unexpected Byte-Range values: "+d),!1):(c.byteRange=g,!0)))}function h(a,b){if(1!==a.length)return console.log("Multiple Failure-Report headers"),!1;switch(a[0].toLowerCase()){case"yes":b.responseOn={success:!0,failure:!0};break;case"no":b.responseOn={success:!1,failure:!1};break;case"partial":b.responseOn={success:!1,failure:!0};break;default:return console.log("Unexpected Failure-Report header: "+a[0]),!1}return!0}function i(b,c){var d;return c instanceof a.Message.Response?(console.log("Ignoring Status header on response"),!0):1!==b.length?(console.log("Multiple Status headers"),!1):(d=b[0].split(" "),d.length<2||"000"!==d.shift()?(console.log("Unexpected Status header: "+b[0]),!1):(c.status=parseInt(d.shift(),10),c.comment=d.join(" "),!0))}function j(a,b){return 1!==a.length?(console.log("Multiple Use-Path headers"),!1):(b.usePath=a[0].split(" "),b.usePath.length<1?(console.log("Unexpected Use-Path header: "+a[0]),!1):!0)}function k(a,b){return 1!==a.length?(console.log("Multiple Expires headers"),!1):(b.expires=parseInt(a[0],10),isNaN(b.expires)?(console.log("Unexpected Expires header: "+a[0]),!1):!0)}function l(d,e){var f,g,h;if(e instanceof a.Message.Response)return console.log("Ignoring Content-Disposition header on response"),!0;if(1!==d.length)return console.log("Multiple Content-Disposition headers"),!1;if(f=d[0].split(";"),f.length<1)return console.log("Unexpected Content-Disposition header: "+d[0]),!1;e.contentDisposition={},e.contentDisposition.type=b(f.shift()),e.contentDisposition.param={};for(g in f){if(h=f[g].split("="),2!==h.length)return console.log("Unexpected Content-Disposition param: "+f[g]),!1;e.contentDisposition.param[b(h[0])]=c(b(h[1]))}return!0}function m(a,c){return 1!==a.length?(console.log("Multiple Message-ID headers"),!1):(c.messageId=b(a[0]),c.messageId.length<1?(console.log("Unexpected Message-ID header: "+a[0]),!1):!0)}function n(a){var b,c;for(b in a.headers)if(c=p[b],c&&!c(a.headers[b],a))return console.log("Parsing failed for header "+b),!1;return!0}var o="\r\n";a.parseMessage=function(b){var c,e,f,g,h,i,j,k,l=0;if(b instanceof ArrayBuffer)c=String.fromCharCode.apply(null,new Uint8Array(b));else{if(!(b instanceof String||"string"==typeof b))return console.log("Unexpected parameter type"),null;c=b}if(e=c.indexOf(o),-1===e)return console.log("Error parsing message: no CRLF"),null;if(f=c.substring(l,e),g=f.split(" "),g.length<3||"MSRP"!==g[0]||0===g[1].length||0===g[2].length)return console.log("Error parsing message: unexpected first line format: "+f),null;if(3===g[2].length&&(h=parseInt(g[2],10)))if(g.length>3){var m=g.slice(3).join(" ");i=new a.Message.IncomingResponse(g[1],h,m)}else i=new a.Message.IncomingResponse(g[1],h);else{if(3!==g.length)return console.log("Error parsing message: unexpected first line format: "+f),null;i=new a.Message.IncomingRequest(g[1],g[2])}for(l=e+o.length;;){if(j=d(c,l,i),!(j>0)){if(0===j)break;return null}l=j}if(!n(i))return console.log("Error parsing message: parseKnownHeaders failed"),null;if(k=i.getEndLineNoFlag(),c.substr(l,o.length)===o){if(l+=o.length,e=c.indexOf(o+k,l),-1===e)return console.log("Error parsing message: no end line after body"),null;i.body=b instanceof ArrayBuffer?b.slice(l,e):c.substring(l,e),i.continuationFlag=c.charAt(e+o.length+k.length)}else i.continuationFlag=c.charAt(l+k.length);return i};var p={"Message-ID":m,"Failure-Report":h,"Byte-Range":g,Status:i,"Content-Disposition":l,"WWW-Authenticate":f,"Use-Path":j,Expires:k,"Min-Expires":k,"Max-Expires":k};return a}(CrocMSRP||{}),CrocMSRP=function(a){var b=2208988800;return a.util={newUriAuthority:function(){return Math.random().toString(36).substr(2,8)+".invalid"},newSID:function(){return Math.random().toString(36).substr(2,10)},newTID:function(){return Math.random().toString(36).substr(2,8)},newMID:function(){var b=new Date;return a.util.dateToNtpTime(b)+"."+Math.random().toString(36).substr(2,8)},newFileTransferId:function(){var b=new Date;return a.util.dateToNtpTime(b)+"."+Math.random().toString(36).substr(2)},normaliseHeader:function(a){var b,c=a.toLowerCase().split("-"),d="";for(b in c)"0"!==b&&(d+="-"),d+=c[b].charAt(0).toUpperCase()+c[b].substring(1);switch(d){case"Www-Authenticate":return"WWW-Authenticate";case"Message-Id":return"Message-ID"}return d},isEmpty:function(a){var b;for(b in a)if(a.hasOwnProperty(b))return!1;return!0},ntpTimeToDate:function(a){return new Date(1e3*(parseInt(a,10)-b))},dateToNtpTime:function(a){return parseInt(a.getTime()/1e3,10)+b},encodeSdpFileName:function(a){return a.replace(/%/g,"%25").replace(/\0/g,"%00").replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},decodeSdpFileName:function(a){return a.replace(/%00/g,"\0").replace(/%0A/gi,"\n").replace(/%0D/gi,"\r").replace(/%22/g,'"').replace(/%25/g,"%")},encodeQuotedString:function(a){var b,c=a.split("");for(b in c)switch(c[b]){case'"':case"\r":case"\\":c[b]="\\"+c[b]}return c.join("")},decodeQuotedString:function(a){var b,c=a.split(""),d=!1;for(b in c)d||"\\"===c[b]&&(d=!0,delete c[b]);return c.join("")}},a}(CrocMSRP||{});JSJAC_HAVEKEYS=!0,JSJAC_NKEYS=16,JSJAC_INACTIVITY=300,JSJAC_ERR_COUNT=10,JSJAC_ALLOW_PLAIN=!0,JSJAC_CHECKQUEUEINTERVAL=100,JSJAC_CHECKINQUEUEINTERVAL=100,JSJAC_TIMERVAL=2e3,JSJAC_RETRYDELAY=5e3,JSJACHBC_MAX_HOLD=1,JSJACHBC_MAX_WAIT=300,JSJACHBC_BOSH_VERSION="1.6",JSJACHBC_USE_BOSH_VER=!0,JSJACHBC_MAXPAUSE=120,String.prototype.htmlEnc=function(){if(!this)return this;var a=this.replace(/&/g,"&amp;");return a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=a.replace(/\"/g,"&quot;"),a=a.replace(/\n/g,"<br />")},String.prototype.revertHtmlEnc=function(){if(!this)return this;var a=this.replace(/&amp;/gi,"&");return a=a.replace(/&lt;/gi,"<"),a=a.replace(/&gt;/gi,">"),a=a.replace(/&quot;/gi,'"'),a=a.replace(/<br( )?(\/)?>/gi,"\n")},Date.jab2date=function(a){var b=new Date(Date.UTC(a.substr(0,4),a.substr(5,2)-1,a.substr(8,2),a.substr(11,2),a.substr(14,2),a.substr(17,2)));if("Z"!=a.substr(a.length-6,1)){var c=new Date;c.setTime(0),c.setUTCHours(a.substr(a.length-5,2)),c.setUTCMinutes(a.substr(a.length-2,2)),"+"==a.substr(a.length-6,1)?b.setTime(b.getTime()-c.getTime()):"-"==a.substr(a.length-6,1)&&b.setTime(b.getTime()+c.getTime())}return b},Date.hrTime=function(a){return Date.jab2date(a).toLocaleString()},Date.prototype.jabberDate=function(){var a=function(a){return 10>a?"0"+a:a},b=this.getUTCFullYear()+"-";return b+=a(this.getUTCMonth()+1)+"-",b+=a(this.getUTCDate())+"T",b+=a(this.getUTCHours())+":",b+=a(this.getUTCMinutes())+":",b+=a(this.getUTCSeconds())+"Z"},Number.max=function(a,b){return a>b?a:b},Number.min=function(a,b){return b>a?a:b},window.XDomainRequest&&(window.ieXDRToXHR=function(a){"use strict";var b=a.XMLHttpRequest;a.XMLHttpRequest=function(){this.onreadystatechange=Object,this.xhr=null,this.xdr=null,this.readyState=0,this.status="",this.statusText=null,this.responseText=null,this.getResponseHeader=null,this.getAllResponseHeaders=null,this.setRequestHeader=null,this.abort=null,this.send=null,this.isxdr=!1;var a=this;a.xdrLoadedBinded=function(){a.xdrLoaded()},a.xdrErrorBinded=function(){a.xdrError()},a.xdrProgressBinded=function(){a.xdrProgress()},a.xhrReadyStateChangedBinded=function(){a.xhrReadyStateChanged()}},XMLHttpRequest.prototype.open=function(c,d,e,f,g){var h=document.createElement("a");h.href=d,h.hostname!=document.domain?(null===this.xdr&&(this.xdr=new a.XDomainRequest),this.isxdr=!0,this.setXDRActive(),this.xdr.open(c,d)):(null===this.xhr&&(this.xhr=new b),this.isxdr=!1,this.setXHRActive(),this.xhr.open(c,d,e,f,g))},XMLHttpRequest.prototype.xdrGetResponseHeader=function(a){return"Content-Type"===a&&this.xdr.contentType>""?this.xdr.contentType:""},XMLHttpRequest.prototype.xdrGetAllResponseHeaders=function(){return this.xdr.contentType>""?"Content-Type: "+this.xdr.contentType:""},XMLHttpRequest.prototype.xdrSetRequestHeader=function(){},XMLHttpRequest.prototype.xdrLoaded=function(){if(null!==this.onreadystatechange){if(this.readyState=4,this.status=200,this.statusText="OK",this.responseText=this.xdr.responseText,a.ActiveXObject){var b=new ActiveXObject("Microsoft.XMLDOM");b.async="false",b.loadXML(this.responseText),this.responseXML=b}this.onreadystatechange()}},XMLHttpRequest.prototype.xdrError=function(){null!==this.onreadystatechange&&(this.readyState=4,this.status=0,this.statusText="",this.responseText="",this.onreadystatechange())},XMLHttpRequest.prototype.xdrProgress=function(){null!==this.onreadystatechange&&3!==this.status&&(this.readyState=3,this.status=3,this.statusText="",this.onreadystatechange())},XMLHttpRequest.prototype.finalXDRRequest=function(){var a=this.xdr;delete a.onload,delete a.onerror,delete a.onprogress},XMLHttpRequest.prototype.sendXDR=function(a){var b=this.xdr;b.onload=this.xdrLoadedBinded,b.onerror=this.xdr.ontimeout=this.xdrErrorBinded,b.onprogress=this.xdrProgressBinded,this.responseText=null,this.xdr.send(a)},XMLHttpRequest.prototype.abortXDR=function(){this.finalXDRRequest(),this.xdr.abort()},XMLHttpRequest.prototype.setXDRActive=function(){this.send=this.sendXDR,this.abort=this.abortXDR,this.getResponseHeader=this.xdrGetResponseHeader,this.getAllResponseHeaders=this.xdrGetAllResponseHeaders,this.setRequestHeader=this.xdrSetRequestHeader},XMLHttpRequest.prototype.xhrGetResponseHeader=function(a){return this.xhr.getResponseHeader(a)},XMLHttpRequest.prototype.xhrGetAllResponseHeaders=function(){return this.xhr.getAllResponseHeaders()},XMLHttpRequest.prototype.xhrSetRequestHeader=function(a,b){return this.xhr.setRequestHeader(a,b)},XMLHttpRequest.prototype.xhrReadyStateChanged=function(){if(null!==this.onreadystatechange&&this.readyState!==this.xhr.readyState){var a=this.xhr;this.readyState=a.readyState,4===this.readyState&&(this.status=a.status,this.statusText=a.statusText,this.responseText=a.responseText,this.responseXML=a.responseXML),this.onreadystatechange()}},XMLHttpRequest.prototype.finalXHRRequest=function(){delete this.xhr.onreadystatechange},XMLHttpRequest.prototype.abortXHR=function(){this.finalXHRRequest(),this.xhr.abort()},XMLHttpRequest.prototype.sendXHR=function(a){this.xhr.onreadystatechange=this.xhrReadyStateChangedBinded,this.xhr.send(a)},XMLHttpRequest.prototype.setXHRActive=function(){this.send=this.sendXHR,this.abort=this.abortXHR,this.getResponseHeader=this.xhrGetResponseHeader,this.getAllResponseHeaders=this.xhrGetAllResponseHeaders,this.setRequestHeader=this.xhrSetRequestHeader},a.ieXDRToXHR=void 0},window.ieXDRToXHR(window));var hexcase=0,b64pad="=",chrsz=8;("undefined"==typeof atob||"undefined"==typeof btoa)&&b64arrays(),b64decode="undefined"==typeof atob?function(a){return utf8d2t(b64t2d(a))}:function(a){return decodeURIComponent(escape(atob(a)))},b64encode="undefined"==typeof btoa?function(a){return b64d2t(utf8t2d(a))}:function(a){return btoa(unescape(encodeURIComponent(a)))},JSJaCJSON.toString=function(a){var b={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},c={array:function(a){var b,d,e,f,g=["["],h=a.length;for(e=0;h>e;e+=1)if(f=a[e],d=c[typeof f])try{f=d(f),"string"==typeof f&&(b&&(g[g.length]=","),g[g.length]=f,b=!0)}catch(i){}return g[g.length]="]",g.join("")},"boolean":function(a){return String(a)},"null":function(){return"null"},number:function(a){return isFinite(a)?String(a):"null"},object:function(a){if(a){if(a instanceof Array)return c.array(a);var b,d,e,f,g=["{"];for(e in a)if(a.hasOwnProperty(e)&&(f=a[e],d=c[typeof f]))try{f=d(f),"string"==typeof f&&(b&&(g[g.length]=","),g.push(c.string(e),":",f),b=!0)}catch(h){}return g[g.length]="}",g.join("")}return"null"},string:function(a){return/["\\\x00-\x1f]/.test(a)&&(a=a.replace(/([\x00-\x1f\\"])/g,function(a,c){var d=b[c];return d?d:(d=c.charCodeAt(),"\\u00"+Math.floor(d/16).toString(16)+(d%16).toString(16))})),'"'+a+'"'}};switch(typeof a){case"object":return c.object(a);case"array":return c.array(a)}},JSJaCJSON.parse=function(str){try{return!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(str.replace(/"(\\.|[^"\\])*"/g,""))&&eval("("+str+")")}catch(e){return!1}},XmlHttp.create=function(){try{if(window.XMLHttpRequest){var a=new XMLHttpRequest;return null===a.readyState&&(a.readyState=1,a.addEventListener("load",function(){a.readyState=4,"function"==typeof a.onreadystatechange&&a.onreadystatechange()},!1)),a}if(window.ActiveXObject)return new ActiveXObject(XmlHttp.getPrefix()+".XmlHttp")}catch(b){}throw new Error("Your browser does not support XmlHttp objects")},XmlHttp.getPrefix=function(){if(XmlHttp.prefix)return XmlHttp.prefix;for(var a,b=["MSXML2","Microsoft","MSXML","MSXML3"],c=0;c<b.length;c++)try{return a=new ActiveXObject(b[c]+".XmlHttp"),XmlHttp.prefix=b[c]}catch(d){}throw new Error("Could not find an installed XML parser")},XmlDocument.create=function(a,b){a=a||"foo",b=b||"";try{var c;if(document.implementation&&document.implementation.createDocument?(c=document.implementation.createDocument(b,a,null),null===c.readyState&&(c.readyState=1,c.addEventListener("load",function(){c.readyState=4,"function"==typeof c.onreadystatechange&&c.onreadystatechange()},!1))):window.ActiveXObject&&(c=new ActiveXObject(XmlDocument.getPrefix()+".DomDocument")),!c.documentElement||c.documentElement.tagName!=a||c.documentElement.namespaceURI&&c.documentElement.namespaceURI!=b)try{""!==b?c.appendChild(c.createElement(a)).setAttribute("xmlns",b):c.appendChild(c.createElement(a))}catch(d){c=document.implementation.createDocument(b,a,null),null===c.documentElement&&c.appendChild(c.createElement(a)),""!==b&&c.documentElement.getAttribute("xmlns")!=b&&c.documentElement.setAttribute("xmlns",b)}return c}catch(e){}throw new Error("Your browser does not support XmlDocument objects")},XmlDocument.getPrefix=function(){if(XmlDocument.prefix)return XmlDocument.prefix;for(var a,b=["MSXML2","Microsoft","MSXML","MSXML3"],c=0;c<b.length;c++)try{return a=new ActiveXObject(b[c]+".DomDocument"),XmlDocument.prefix=b[c]}catch(d){}throw new Error("Could not find an installed XML parser")},"undefined"!=typeof Document&&window.DOMParser&&(Document.prototype.loadXML=function(a){for(var b=(new DOMParser).parseFromString(a,"text/xml");this.hasChildNodes();)this.removeChild(this.lastChild);for(var c=0;c<b.childNodes.length;c++)this.appendChild(this.importNode(b.childNodes[c],!0))}),window.XMLSerializer&&window.Node&&Node.prototype&&Node.prototype.__defineGetter__&&(XMLDocument.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Document.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Node.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}));var JSJaCBuilder={buildNode:function(a,b){var c,d=arguments[4];if(arguments[2])if(JSJaCBuilder._isStringOrNumber(arguments[2])||arguments[2]instanceof Array)c=this._createElement(a,b,d),JSJaCBuilder._children(a,c,arguments[2]);else{d=arguments[2].xmlns||d,c=this._createElement(a,b,d);for(var e in arguments[2])arguments[2].hasOwnProperty(e)&&"xmlns"!=e&&c.setAttribute(e,arguments[2][e])}else c=this._createElement(a,b,d);return arguments[3]&&JSJaCBuilder._children(a,c,arguments[3],d),c},_createElement:function(a,b,c){try{if(c)return a.createElementNS(c,b)}catch(d){}var e=a.createElement(b);return c&&e.setAttribute("xmlns",c),e},_text:function(a,b){return a.createTextNode(b)},_children:function(a,b,c,d){if("object"==typeof c){for(var e in c)if(c.hasOwnProperty(e)){var f=c[e];if("object"==typeof f)if(f instanceof Array){var g=JSJaCBuilder.buildNode(a,f[0],f[1],f[2],d);b.appendChild(g)}else b.appendChild(f);else JSJaCBuilder._isStringOrNumber(f)&&b.appendChild(JSJaCBuilder._text(a,f))}}else JSJaCBuilder._isStringOrNumber(c)&&b.appendChild(JSJaCBuilder._text(a,c))},_attributes:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c+'="'+a[c].toString().htmlEnc()+'"');return b.join(" ")},_isStringOrNumber:function(a){return"string"==typeof a||"number"==typeof a}},NS_DISCO_ITEMS="http://jabber.org/protocol/disco#items",NS_DISCO_INFO="http://jabber.org/protocol/disco#info",NS_VCARD="vcard-temp",NS_AUTH="jabber:iq:auth",NS_AUTH_ERROR="jabber:iq:auth:error",NS_REGISTER="jabber:iq:register",NS_SEARCH="jabber:iq:search",NS_ROSTER="jabber:iq:roster",NS_PRIVACY="jabber:iq:privacy",NS_PRIVATE="jabber:iq:private",NS_VERSION="jabber:iq:version",NS_TIME="jabber:iq:time",NS_TIME_NEW="urn:xmpp:time",NS_LAST="jabber:iq:last",NS_XDATA="jabber:x:data",NS_IQDATA="jabber:iq:data",NS_DELAY="jabber:x:delay",NS_DELAY_NEW="urn:xmpp:delay",NS_EXPIRE="jabber:x:expire",NS_EVENT="jabber:x:event",NS_XCONFERENCE="jabber:x:conference",NS_PING="urn:xmpp:ping",NS_CHAT_STATES="http://jabber.org/protocol/chatstates",NS_STATS="http://jabber.org/protocol/stats",NS_MUC="http://jabber.org/protocol/muc",NS_MUC_USER="http://jabber.org/protocol/muc#user",NS_MUC_ADMIN="http://jabber.org/protocol/muc#admin",NS_MUC_OWNER="http://jabber.org/protocol/muc#owner",NS_PUBSUB="http://jabber.org/protocol/pubsub",NS_PUBSUB_EVENT="http://jabber.org/protocol/pubsub#event",NS_PUBSUB_OWNER="http://jabber.org/protocol/pubsub#owner",NS_PUBSUB_NMI="http://jabber.org/protocol/pubsub#node-meta-info",NS_COMMANDS="http://jabber.org/protocol/commands",NS_STREAM="http://etherx.jabber.org/streams",NS_CLIENT="jabber:client",NS_BOSH="http://jabber.org/protocol/httpbind",NS_XBOSH="urn:xmpp:xbosh",NS_STANZAS="urn:ietf:params:xml:ns:xmpp-stanzas",NS_STREAMS="urn:ietf:params:xml:ns:xmpp-streams",NS_TLS="urn:ietf:params:xml:ns:xmpp-tls",NS_SASL="urn:ietf:params:xml:ns:xmpp-sasl",NS_SESSION="urn:ietf:params:xml:ns:xmpp-session",NS_BIND="urn:ietf:params:xml:ns:xmpp-bind",NS_FEATURE_IQAUTH="http://jabber.org/features/iq-auth",NS_FEATURE_IQREGISTER="http://jabber.org/features/iq-register",NS_FEATURE_COMPRESS="http://jabber.org/features/compress",NS_COMPRESS="http://jabber.org/protocol/compress",ERR_BAD_REQUEST=STANZA_ERROR("400","modify","bad-request"),ERR_CONFLICT=STANZA_ERROR("409","cancel","conflict"),ERR_FEATURE_NOT_IMPLEMENTED=STANZA_ERROR("501","cancel","feature-not-implemented"),ERR_FORBIDDEN=STANZA_ERROR("403","auth","forbidden"),ERR_GONE=STANZA_ERROR("302","modify","gone"),ERR_INTERNAL_SERVER_ERROR=STANZA_ERROR("500","wait","internal-server-error"),ERR_ITEM_NOT_FOUND=STANZA_ERROR("404","cancel","item-not-found"),ERR_JID_MALFORMED=STANZA_ERROR("400","modify","jid-malformed"),ERR_NOT_ACCEPTABLE=STANZA_ERROR("406","modify","not-acceptable"),ERR_NOT_ALLOWED=STANZA_ERROR("405","cancel","not-allowed"),ERR_NOT_AUTHORIZED=STANZA_ERROR("401","auth","not-authorized"),ERR_PAYMENT_REQUIRED=STANZA_ERROR("402","auth","payment-required"),ERR_RECIPIENT_UNAVAILABLE=STANZA_ERROR("404","wait","recipient-unavailable"),ERR_REDIRECT=STANZA_ERROR("302","modify","redirect"),ERR_REGISTRATION_REQUIRED=STANZA_ERROR("407","auth","registration-required"),ERR_REMOTE_SERVER_NOT_FOUND=STANZA_ERROR("404","cancel","remote-server-not-found"),ERR_REMOTE_SERVER_TIMEOUT=STANZA_ERROR("504","wait","remote-server-timeout"),ERR_RESOURCE_CONSTRAINT=STANZA_ERROR("500","wait","resource-constraint"),ERR_SERVICE_UNAVAILABLE=STANZA_ERROR("503","cancel","service-unavailable"),ERR_SUBSCRIPTION_REQUIRED=STANZA_ERROR("407","auth","subscription-required"),ERR_UNEXPECTED_REQUEST=STANZA_ERROR("400","wait","unexpected-request");
JSJaCCookie.read=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf(b))return new JSJaCCookie(a,JSJaCCookie._unescape(e.substring(b.length,e.length)))}throw new JSJaCCookieException("Cookie not found")},JSJaCCookie.get=function(a){return JSJaCCookie.read(a).getValue()},JSJaCCookie.remove=function(a){JSJaCCookie.read(a).erase()},JSJaCCookie._escape=function(a){return a.replace(/;/g,"%3AB")},JSJaCCookie._unescape=function(a){return a.replace(/%3AB/g,";")};var JSJACJID_FORBIDDEN=['"'," ","&","'","/",":","<",">","@"];JSJaCJID.prototype.getBareJID=function(){return this.getNode()+"@"+this.getDomain()},JSJaCJID.prototype.getNode=function(){return this._node},JSJaCJID.prototype.getDomain=function(){return this._domain},JSJaCJID.prototype.getResource=function(){return this._resource},JSJaCJID.prototype.setNode=function(a){return JSJaCJID._checkNodeName(a),this._node=a||"",this},JSJaCJID.prototype.setDomain=function(a){if(!a||""===a)throw new JSJaCJIDInvalidException("domain name missing");return JSJaCJID._checkNodeName(a),this._domain=a,this},JSJaCJID.prototype.setResource=function(a){return this._resource=a||"",this},JSJaCJID.prototype.toString=function(){var a="";return this.getNode()&&""!==this.getNode()&&(a=this.getNode()+"@"),a+=this.getDomain(),this.getResource()&&""!==this.getResource()&&(a+="/"+this.getResource()),a},JSJaCJID.prototype.removeResource=function(){return this.setResource()},JSJaCJID.prototype.clone=function(){return new JSJaCJID(this.toString())},JSJaCJID.prototype.isEntity=function(a){return a="string"==typeof a?new JSJaCJID(a):a.clone(),a.removeResource(),this.clone().removeResource().toString()===a.toString()},JSJaCJID._checkNodeName=function(a){if(a&&""!==a)for(var b=0;b<JSJACJID_FORBIDDEN.length;b++)if(-1!=a.indexOf(JSJACJID_FORBIDDEN[b]))throw new JSJaCJIDInvalidException("forbidden char in nodename: "+JSJACJID_FORBIDDEN[b])};var JSJACPACKET_USE_XMLNS=!0;JSJaCPacket.prototype.pType=function(){return this.name},JSJaCPacket.prototype.getDoc=function(){return this.doc},JSJaCPacket.prototype.getNode=function(){return this.getDoc()&&this.getDoc().documentElement?this.getDoc().documentElement:null},JSJaCPacket.prototype.setTo=function(a){return a&&""!=a?"string"==typeof a?this.getNode().setAttribute("to",a):this.getNode().setAttribute("to",a.toString()):this.getNode().removeAttribute("to"),this},JSJaCPacket.prototype.setFrom=function(a){return a&&""!=a?"string"==typeof a?this.getNode().setAttribute("from",a):this.getNode().setAttribute("from",a.toString()):this.getNode().removeAttribute("from"),this},JSJaCPacket.prototype.setID=function(a){return a&&""!=a?this.getNode().setAttribute("id",a):this.getNode().removeAttribute("id"),this},JSJaCPacket.prototype.setType=function(a){return a&&""!=a?this.getNode().setAttribute("type",a):this.getNode().removeAttribute("type"),this},JSJaCPacket.prototype.setXMLLang=function(a){return a&&""!=a?this.getNode().setAttribute("xml:lang",a):this.getNode().removeAttribute("xml:lang"),this},JSJaCPacket.prototype.getTo=function(){return this.getNode().getAttribute("to")},JSJaCPacket.prototype.getFrom=function(){return this.getNode().getAttribute("from")},JSJaCPacket.prototype.getToJID=function(){return new JSJaCJID(this.getTo())},JSJaCPacket.prototype.getFromJID=function(){return new JSJaCJID(this.getFrom())},JSJaCPacket.prototype.getID=function(){return this.getNode().getAttribute("id")},JSJaCPacket.prototype.getType=function(){return this.getNode().getAttribute("type")},JSJaCPacket.prototype.getXMLLang=function(){return this.getNode().getAttribute("xml:lang")},JSJaCPacket.prototype.getXMLNS=function(){return this.getNode().namespaceURI||this.getNode().getAttribute("xmlns")},JSJaCPacket.prototype.getChild=function(a,b){if(!this.getNode())return null;if(a=a||"*",b=b||"*",this.getNode().getElementsByTagNameNS)return this.getNode().getElementsByTagNameNS(b,a).item(0);var c=this.getNode().getElementsByTagName(a);if("*"==b)return c.item(0);for(var d=0;d<c.length;d++)if(c.item(d).namespaceURI==b||c.item(d).getAttribute("xmlns")==b)return c.item(d);return null},JSJaCPacket.prototype.getChildVal=function(a,b){var c=this.getChild(a,b),d="";if(c&&c.hasChildNodes())for(var e=0;e<c.childNodes.length;e++)c.childNodes.item(e).nodeValue&&(d+=c.childNodes.item(e).nodeValue);return d},JSJaCPacket.prototype.clone=function(){return JSJaCPacket.wrapNode(this.getNode())},JSJaCPacket.prototype.isError=function(){return"error"==this.getType()},JSJaCPacket.prototype.errorReply=function(a){var b=this.clone();return b.setTo(this.getFrom()),b.setFrom(),b.setType("error"),b.appendNode("error",{code:a.code,type:a.type},[[a.cond,{xmlns:NS_STANZAS}]]),b},JSJaCPacket.prototype.xml="undefined"!=typeof XMLSerializer?function(){var a=(new XMLSerializer).serializeToString(this.getNode());return"undefined"==typeof a&&(a=(new XMLSerializer).serializeToString(this.doc)),a}:function(){return this.getDoc().xml},JSJaCPacket.prototype._getAttribute=function(a){return this.getNode().getAttribute(a)},null==document.ELEMENT_NODE&&(document.ELEMENT_NODE=1,document.ATTRIBUTE_NODE=2,document.TEXT_NODE=3,document.CDATA_SECTION_NODE=4,document.ENTITY_REFERENCE_NODE=5,document.ENTITY_NODE=6,document.PROCESSING_INSTRUCTION_NODE=7,document.COMMENT_NODE=8,document.DOCUMENT_NODE=9,document.DOCUMENT_TYPE_NODE=10,document.DOCUMENT_FRAGMENT_NODE=11,document.NOTATION_NODE=12),JSJaCPacket.prototype._importNode=function(a,b){switch(a.nodeType){case document.ELEMENT_NODE:var c;c=this.getDoc().createElementNS?this.getDoc().createElementNS(a.namespaceURI,a.nodeName):this.getDoc().createElement(a.nodeName);var d,e;if(a.attributes&&a.attributes.length>0)for(d=0,e=a.attributes.length;e>d;d++){var f=a.attributes.item(d);("xmlns"!=f.nodeName||null===c.getAttribute("xmlns")&&!c.namespaceURI)&&(c.setAttributeNS&&f.namespaceURI?c.setAttributeNS(f.namespaceURI,f.name,f.value):c.setAttribute(f.name,f.value))}if(b&&a.childNodes&&a.childNodes.length>0)for(d=0,e=a.childNodes.length;e>d;d++)c.appendChild(this._importNode(a.childNodes.item(d),b));return c;case document.TEXT_NODE:case document.CDATA_SECTION_NODE:case document.COMMENT_NODE:return this.getDoc().createTextNode(a.nodeValue)}},JSJaCPacket.prototype._setChildNode=function(a,b){var c=this.getChild(a),d=this.getDoc().createTextNode(b);if(c)try{c.replaceChild(d,c.firstChild)}catch(e){}else{try{c=this.getDoc().createElementNS(this.getNode().namespaceURI,a)}catch(f){c=this.getDoc().createElement(a)}this.getNode().appendChild(c),c.appendChild(d)}return c},JSJaCPacket.prototype.buildNode=function(a){return JSJaCBuilder.buildNode(this.getDoc(),a,arguments[1],arguments[2],arguments[3])},JSJaCPacket.prototype.appendNode=function(a){return"object"==typeof a?this.getNode().appendChild(a):this.getNode().appendChild(this.buildNode(a,arguments[1],arguments[2],this.getNode().namespaceURI)),this},JSJaCPresence.prototype=new JSJaCPacket,JSJaCPresence.prototype.setStatus=function(a){return this._setChildNode("status",a),this},JSJaCPresence.prototype.setShow=function(a){return("chat"==a||"away"==a||"xa"==a||"dnd"==a)&&this._setChildNode("show",a),this},JSJaCPresence.prototype.setPriority=function(a){return this._setChildNode("priority",a),this},JSJaCPresence.prototype.setPresence=function(a,b,c){return a&&this.setShow(a),b&&this.setStatus(b),c&&this.setPriority(c),this},JSJaCPresence.prototype.getStatus=function(){return this.getChildVal("status")},JSJaCPresence.prototype.getShow=function(){return this.getChildVal("show")},JSJaCPresence.prototype.getPriority=function(){return this.getChildVal("priority")},JSJaCIQ.prototype=new JSJaCPacket,JSJaCIQ.prototype.setIQ=function(a,b,c){return a&&this.setTo(a),b&&this.setType(b),c&&this.setID(c),this},JSJaCIQ.prototype.setQuery=function(a){var b;try{b=this.getDoc().createElementNS(a,"query")}catch(c){b=this.getDoc().createElement("query"),b.setAttribute("xmlns",a)}return this.getNode().appendChild(b),b},JSJaCIQ.prototype.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0)},JSJaCIQ.prototype.getQueryXMLNS=function(){return this.getQuery()?this.getQuery().namespaceURI||this.getQuery().getAttribute("xmlns"):null},JSJaCIQ.prototype.reply=function(a){var b=this.clone();if(b.setTo(this.getFrom()),b.setFrom(),b.setType("result"),a)if("string"==typeof a)b.getChild().appendChild(b.getDoc().loadXML(a));else if(a.constructor==Array)for(var c=b.getChild(),d=0;d<a.length;d++)"string"==typeof a[d]?c.appendChild(b.getDoc().loadXML(a[d])):"object"==typeof a[d]&&c.appendChild(a[d]);else"object"==typeof a&&b.getChild().appendChild(a);return b},JSJaCMessage.prototype=new JSJaCPacket,JSJaCMessage.prototype.setBody=function(a){return this._setChildNode("body",a),this},JSJaCMessage.prototype.setSubject=function(a){return this._setChildNode("subject",a),this},JSJaCMessage.prototype.setThread=function(a){return this._setChildNode("thread",a),this},JSJaCMessage.prototype.getThread=function(){return this.getChildVal("thread")},JSJaCMessage.prototype.getBody=function(){return this.getChildVal("body")},JSJaCMessage.prototype.getSubject=function(){return this.getChildVal("subject")},JSJaCPacket.wrapNode=function(a){var b=null;switch(a.nodeName.toLowerCase()){case"presence":b=new JSJaCPresence;break;case"message":b=new JSJaCMessage;break;case"iq":b=new JSJaCIQ}return b&&b.getDoc().replaceChild(b._importNode(a,!0),b.getNode()),b},JSJaCConnection.prototype.connect=function(a){if(this._setStatus("connecting"),"x-facebook-platform"!=a.authtype)this.domain=a.domain||"localhost",this.username=a.username,this.resource=a.resource,this.pass=a.password||a.pass,this.register=a.register,this.authhost=a.authhost||a.host||a.domain,this.authtype=a.authtype||"sasl";else{if(this.domain="chat.facebook.com",this.authtype=a.authtype,void 0===a.facebookApp)return this.oDbg.log("No Facebook application param specified!",1),void 0;if(this._facebookApp=a.facebookApp,!document.getElementById("fb-root")){var b=document.createElement("div");b.id="fb-root",document.body.appendChild(b)}if(void 0===a.facebookApp.getSession())return this._facebookApp.Login(this,a),void 0}this._xmllang=a.xmllang&&""!==a.xmllang?a.xmllang:"en",this._allow_plain=a.allow_plain?a.allow_plain:JSJAC_ALLOW_PLAIN,this.host=a.host,this.port=a.port||5222,this.secure=a.secure?"true":"false",this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,this._rid=Math.round(100000.5+799999.99999*Math.random());var c=this._getFreeSlot();this._req[c]=this._setupRequest(!0);var d=this._getInitialRequestString();this.oDbg.log(d,4),this._req[c].r.onreadystatechange=JSJaC.bind(function(){var a=this._req[c].r;4==a.readyState&&(this.oDbg.log("async recv: "+a.responseText,4),this._handleInitialResponse(a))},this),"undefined"!=typeof this._req[c].r.onerror&&(this._req[c].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this)),this._req[c].r.send(d)},JSJaCConnection.prototype.connected=function(){return this._connected},JSJaCConnection.prototype.disconnect=function(){if(this._setStatus("disconnecting"),this.connected()){this._connected=!1,clearInterval(this._interval),clearInterval(this._inQto),this._timeout&&clearTimeout(this._timeout);var a=this._getFreeSlot();this._req[a]=this._setupRequest(!1);var b=this._getRequestString(!1,!0);this.oDbg.log("Disconnecting: "+b,4);try{this._req[a].r.send(b)}catch(c){}this.oDbg.log("disconnected");try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(c){}this._handleEvent("ondisconnect")}},JSJaCConnection.prototype.getPollInterval=function(){return this._timerval},JSJaCConnection.prototype.registerHandler=function(event){event=event.toLowerCase();var eArg={handler:arguments[arguments.length-1],childName:"*",childNS:"*",type:"*"};arguments.length>2&&(eArg.childName=arguments[1]),arguments.length>3&&(eArg.childNS=arguments[2]),arguments.length>4&&(eArg.type=arguments[3]),this._events[event]=this._events[event]?this._events[event].concat(eArg):new Array(eArg),this._events[event]=this._events[event].sort(function(a,b){var aRank=0,bRank=0;with(a)"*"==type&&aRank++,"*"==childNS&&aRank++,"*"==childName&&aRank++;with(b)"*"==type&&bRank++,"*"==childNS&&bRank++,"*"==childName&&bRank++;return aRank>bRank?1:bRank>aRank?-1:0}),this.oDbg.log("registered handler for event '"+event+"'",2)},JSJaCConnection.prototype.unregisterHandler=function(a,b){if(a=a.toLowerCase(),this._events[a]){for(var c=this._events[a],d=[],e=0;e<c.length;e++)c[e].handler!=b&&d.push(c[e]);c.length!=d.length&&(this._events[a]=d,this.oDbg.log("unregistered handler for event '"+a+"'",2))}},JSJaCConnection.prototype.registerIQGet=function(a,b,c){this.registerHandler("iq",a,b,"get",c)},JSJaCConnection.prototype.registerIQSet=function(a,b,c){this.registerHandler("iq",a,b,"set",c)},JSJaCConnection.prototype.resume=function(){try{var a=JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").getValue();return this.oDbg.log("read cookie: "+a,2),JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase(),this.resumeFromData(JSJaCJSON.parse(a))}catch(b){}return!1},JSJaCConnection.prototype.resumeFromData=function(a){try{for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);if(this._keys){this._keys2=new JSJaCKeys;for(var c=this._keys2._getSuspendVars(),d=0;d<c.length;d++)this._keys2[c[d]]=this._keys[c[d]];this._keys=this._keys2}return this._connected?(this._setStatus("resuming"),this._handleEvent("onresume"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval()),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL)):this._setStatus("terminated"),this._connected===!0}catch(e){return e.message?this.oDbg.log("Resume failed: "+e.message,1):this.oDbg.log("Resume failed: "+e,1),!1}},JSJaCConnection.prototype.send=function(a,b,c){return a&&a.pType?this.connected()?(b&&(a.getID()||a.setID("JSJaCID_"+this._ID++),this._registerPID(a.getID(),b,c)),this._pQueue=this._pQueue.concat(a.xml()),this._handleEvent(a.pType()+"_out",a),this._handleEvent("packet_out",a),!0):!1:(this.oDbg.log("no packet: "+a,1),!1)},JSJaCConnection.prototype.sendIQ=function(a,b,c){if(!a||"iq"!=a.pType())return!1;b=b||{};var d=b.error_handler||JSJaC.bind(function(a){this.oDbg.log(a.xml(),1)},this),e=b.result_handler||JSJaC.bind(function(a){this.oDbg.log(a.xml(),2)},this),f=function(a,b){switch(a.getType()){case"error":d(a);break;case"result":e(a,b)}};return this.send(a,f,c)},JSJaCConnection.prototype.setPollInterval=function(a){return a&&!isNaN(a)&&(this._timerval=a),this._timerval},JSJaCConnection.prototype.status=function(){return this._status},JSJaCConnection.prototype.suspend=function(){var a=this.suspendToData();try{var b=new JSJaCCookie(this._cookie_prefix+"JSJaC_State",JSJaCJSON.toString(a));this.oDbg.log("writing cookie: "+b.getValue()+"\n"+"(length:"+b.getValue().length+")",2),b.write();var c=JSJaCCookie.get(this._cookie_prefix+"JSJaC_State");return b.getValue()!=c?(this.oDbg.log("Suspend failed writing cookie.\nread: "+c,1),b.erase(),!1):!0}catch(d){this.oDbg.log("Failed creating cookie '"+this._cookie_prefix+"JSJaC_State': "+d.message,1)}return!1},JSJaCConnection.prototype.suspendToData=function(){clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._suspend();var a="_connected,_keys,_ID,_xmllang,_inQ,_pQueue,_regIDs,_errcnt,_inactivity,domain,username,resource,jid,fulljid,_sid,_httpbase,_timerval,_is_polling".split(",");a=a.concat(this._getSuspendVars());for(var b={},c=0;c<a.length;c++)if(this[a[c]]){var d={};if(this[a[c]]._getSuspendVars)for(var e=this[a[c]]._getSuspendVars(),f=0;f<e.length;f++)d[e[f]]=this[a[c]][e[f]];else d=this[a[c]];b[a[c]]=d}return this._connected=!1,this._setStatus("suspending"),b},JSJaCConnection.prototype._abort=function(){clearTimeout(this._timeout),clearInterval(this._inQto),clearInterval(this._interval),this._connected=!1,this._setStatus("aborted"),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("500","cancel","service-unavailable"))},JSJaCConnection.prototype._checkInQ=function(){for(var a=0;a<this._inQ.length&&10>a;a++){var b=this._inQ[0];this._inQ=this._inQ.slice(1,this._inQ.length);var c=JSJaCPacket.wrapNode(b);if(!c)return;this._handleEvent("packet_in",c),c.pType&&!this._handlePID(c)&&(this._handleEvent(c.pType()+"_in",c),this._handleEvent(c.pType(),c))}},JSJaCConnection.prototype._checkQueue=function(){return this._pQueue.length>0&&this._process(),!0},JSJaCConnection.prototype._doAuth=function(){return this.has_sasl&&"nonsasl"==this.authtype&&this.oDbg.log("Warning: SASL present but not used",1),this._doSASLAuth()||this._doLegacyAuth()?!0:(this.oDbg.log("Auth failed for authtype "+this.authtype,1),this.disconnect(),!1)},JSJaCConnection.prototype._doInBandReg=function(){if("saslanon"!=this.authtype&&"anonymous"!=this.authtype){var a=new JSJaCIQ;a.setType("set"),a.setID("reg1"),a.appendNode("query",{xmlns:NS_REGISTER},[["username",this.username],["password",this.pass]]),this.send(a,this._doInBandRegDone)}},JSJaCConnection.prototype._doInBandRegDone=function(a){return a&&"error"==a.getType()?(this.oDbg.log("registration failed for "+this.username,0),this._handleEvent("onerror",a.getChild("error")),void 0):(this.oDbg.log(this.username+" registered succesfully",0),this._doAuth(),void 0)},JSJaCConnection.prototype._doLegacyAuth=function(){if("nonsasl"!=this.authtype&&"anonymous"!=this.authtype)return!1;var a=new JSJaCIQ;return a.setIQ(null,"get","auth1"),a.appendNode("query",{xmlns:NS_AUTH},[["username",this.username]]),this.send(a,this._doLegacyAuth2),!0},JSJaCConnection.prototype._doLegacyAuth2=function(a){if(!a||"result"!=a.getType())return a&&"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),this.disconnect(),void 0;var b=null!==a.getChild("digest"),c=new JSJaCIQ;c.setIQ(null,"set","auth2");var d=c.appendNode("query",{xmlns:NS_AUTH},[["username",this.username],["resource",this.resource]]);if(b)d.appendChild(c.buildNode("digest",{xmlns:NS_AUTH},hex_sha1(this.streamid+this.pass)));else{if(!this._allow_plain)return this.oDbg.log("no valid login mechanism found",1),this.disconnect(),void 0;d.appendChild(c.buildNode("password",{xmlns:NS_AUTH},this.pass))}this.send(c,this._doLegacyAuthDone)},JSJaCConnection.prototype._doLegacyAuthDone=function(a){"result"!=a.getType()?("error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),this.disconnect()):this._handleEvent("onconnect")},JSJaCConnection.prototype._doSASLAuth=function(){if("nonsasl"==this.authtype||"anonymous"==this.authtype)return!1;if("saslanon"==this.authtype){if(this.mechs.ANONYMOUS)return this.oDbg.log("SASL using mechanism 'ANONYMOUS'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>",this._doSASLAuthDone);this.oDbg.log("SASL ANONYMOUS requested but not supported",1)}else if("x-facebook-platform"==this.authtype){if(this.mechs["X-FACEBOOK-PLATFORM"])return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='X-FACEBOOK-PLATFORM' />",this._doFacebookAuth);this.oDbg.log("X-FACEBOOK-PLATFORM requested but not supported",1)}else{if(this.mechs["DIGEST-MD5"])return this.oDbg.log("SASL using mechanism 'DIGEST-MD5'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='DIGEST-MD5'/>",this._doSASLAuthDigestMd5S1);if(this._allow_plain&&this.mechs.PLAIN){this.oDbg.log("SASL using mechanism 'PLAIN'",2);var a=this.username+"@"+this.domain+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass;return this.oDbg.log("authenticating with '"+a+"'",2),a=b64encode(a),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>"+a+"</auth>",this._doSASLAuthDone)}this.oDbg.log("No SASL mechanism applied",1),this.authtype="nonsasl"}return!1},JSJaCConnection.prototype._doSASLAuthDigestMd5S1=function(a){if("challenge"!=a.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var b=b64decode(a.firstChild.nodeValue);if(this.oDbg.log("got challenge: "+b,2),this._nonce=b.substring(b.indexOf("nonce=")+7),this._nonce=this._nonce.substring(0,this._nonce.indexOf('"')),this.oDbg.log("nonce: "+this._nonce,2),""===this._nonce||-1!=this._nonce.indexOf('"'))return this.oDbg.log("nonce not valid, aborting",1),this.disconnect(),void 0;this._digest_uri="xmpp/",this._digest_uri+=this.domain,this._cnonce=cnonce(14),this._nc="00000001";var c=str_md5(this.username+":"+this.domain+":"+this.pass)+":"+this._nonce+":"+this._cnonce,d="AUTHENTICATE:"+this._digest_uri,e=hex_md5(hex_md5(c)+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+hex_md5(d)),f='username="'+this.username+'",realm="'+this.domain+'",nonce="'+this._nonce+'",cnonce="'+this._cnonce+'",nc="'+this._nc+'",qop=auth,digest-uri="'+this._digest_uri+'",response="'+e+'",charset="utf-8"';this.oDbg.log("response: "+f,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+binb2b64(str2binb(f))+"</response>",this._doSASLAuthDigestMd5S2)}},JSJaCConnection.prototype._doSASLAuthDigestMd5S2=function(a){if("failure"==a.nodeName)return a.xml?this.oDbg.log("auth error: "+a.xml,1):this.oDbg.log("auth error",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect(),void 0;var b=b64decode(a.firstChild.nodeValue);this.oDbg.log("response: "+b,2);var c=b.substring(b.indexOf("rspauth=")+8);this.oDbg.log("rspauth: "+c,2);var d=str_md5(this.username+":"+this.domain+":"+this.pass)+":"+this._nonce+":"+this._cnonce,e=":"+this._digest_uri,f=hex_md5(hex_md5(d)+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+hex_md5(e));return this.oDbg.log("rsptest: "+f,2),f!=c?(this.oDbg.log("SASL Digest-MD5: server repsonse with wrong rspauth",1),this.disconnect(),void 0):("success"==a.nodeName?this._reInitStream(JSJaC.bind(this._doStreamBind,this)):this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>",this._doSASLAuthDone),void 0)},JSJaCConnection.prototype._doSASLAuthDone=function(a){"success"!=a.nodeName?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))},JSJaCConnection.prototype._doFacebookAuth=function(a){if("challenge"!=a.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var b=b64decode(a.firstChild.nodeValue);this.oDbg.log("got challenge: "+b,2);for(var c=b.split("&"),d=Array(),e=0;e<c.length;e++){var f=c[e].split("=");d[f[0]]=f[1]}if(""!=d.nonce){var g=this._facebookApp.getSession(),h={api_key:this._facebookApp.getApiKey(),call_id:(new Date).getTime(),method:d.method,nonce:d.nonce,session_key:g.session_key,v:"1.0"};return h.sig="api_key="+h.api_key+"call_id="+h.call_id+"method="+h.method+"nonce="+h.nonce+"session_key="+h.session_key+"v="+h.v,h.sig=hex_md5(h.sig+this._facebookApp.getApiSecret()),h="api_key="+h.api_key+"&"+"call_id="+h.call_id+"&"+"method="+h.method+"&"+"nonce="+h.nonce+"&"+"session_key="+h.session_key+"&"+"v="+h.v+"&"+"sig="+h.sig,h=b64encode(h),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+h+"</response>",this._doFacebookAuthDone)}this.oDbg.log("nonce missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()}},JSJaCConnection.prototype._doFacebookAuthDone=function(a){"success"!=a.nodeName?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))},JSJaCConnection.prototype._doStreamBind=function(){var a=new JSJaCIQ;a.setIQ(null,"set","bind_1"),a.appendNode("bind",{xmlns:NS_BIND},[["resource",this.resource]]),this.oDbg.log(a.xml()),this.send(a,this._doXMPPSess)},JSJaCConnection.prototype._doXMPPSess=function(a){return"result"!=a.getType()||"error"==a.getType()?(this.disconnect(),"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),void 0):(this.fulljid=a.getChildVal("jid"),this.jid=this.fulljid.substring(0,this.fulljid.lastIndexOf("/")),a=new JSJaCIQ,a.setIQ(null,"set","sess_1"),a.appendNode("session",{xmlns:NS_SESSION},[]),this.oDbg.log(a.xml()),this.send(a,this._doXMPPSessDone),void 0)},JSJaCConnection.prototype._doXMPPSessDone=function(a){return"result"!=a.getType()||"error"==a.getType()?(this.disconnect(),"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),void 0):(this._handleEvent("onconnect"),void 0)},JSJaCConnection.prototype._handleEvent=function(a,b){if(a=a.toLowerCase(),this.oDbg.log("incoming event '"+a+"'",3),this._events[a]){this.oDbg.log("handling event '"+a+"'",2);for(var c=0;c<this._events[a].length;c++){var d=this._events[a][c];if("function"==typeof d.handler)if(b){if(b.pType){if(!b.getNode().hasChildNodes()&&"*"!=d.childName||b.getNode().hasChildNodes()&&!b.getChild(d.childName,d.childNS))continue;if("*"!=d.type&&b.getType()!=d.type)continue;this.oDbg.log(d.childName+"/"+d.childNS+"/"+d.type+" => match for handler "+d.handler,3)}if(d.handler(b))break}else if(d.handler())break}}},JSJaCConnection.prototype._handlePID=function(a){if(!a.getID())return!1;for(var b in this._regIDs)if(this._regIDs.hasOwnProperty(b)&&this._regIDs[b]&&b==a.getID()){var c=a.getID();return this.oDbg.log("handling "+c,3),this._regIDs[b].cb.call(this,a,this._regIDs[b].arg)===!1?!1:(this._unregisterPID(c),!0)}return!1},JSJaCConnection.prototype._handleResponse=function(a){var b=this._parseResponse(a);if(b)for(var c=0;c<b.childNodes.length;c++)if(this._sendRawCallbacks.length){var d=this._sendRawCallbacks[0];this._sendRawCallbacks=this._sendRawCallbacks.slice(1,this._sendRawCallbacks.length),d.fn.call(this,b.childNodes.item(c),d.arg)}else this._inQ=this._inQ.concat(b.childNodes.item(c))},JSJaCConnection.prototype._parseStreamFeatures=function(a){if(!a)return this.oDbg.log("nothing to parse ... aborting",1),!1;var b;if(a.getElementsByTagNameNS)b=a.getElementsByTagNameNS(NS_STREAM,"error").item(0);else for(var c=a.getElementsByTagName("error"),d=0;d<c.length;d++)if(c.item(d).namespaceURI==NS_STREAM||c.item(d).getAttribute("xmlns")==NS_STREAM){b=c.item(d);break}if(b)return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),!1;this.mechs={};var e=a.getElementsByTagName("mechanisms");if(!e.length)return!1;this.has_sasl=!1;for(var d=0;d<e.length;d++)if(e.item(d).getAttribute("xmlns")==NS_SASL){this.has_sasl=!0;for(var f=e.item(d).getElementsByTagName("mechanism"),g=0;g<f.length;g++)this.mechs[f.item(g).firstChild.nodeValue]=!0;break}return this.has_sasl?(this.oDbg.log("SASL detected",2),!0):(this.oDbg.log("No support for SASL detected",2),!0)},JSJaCConnection.prototype._process=function(a){if(!this.connected())return this.oDbg.log("Connection lost ...",1),this._interval&&clearInterval(this._interval),void 0;this.setPollInterval(a),this._timeout&&clearTimeout(this._timeout);var b=this._getFreeSlot();if(!(0>b)){if("undefined"!=typeof this._req[b]&&"undefined"!=typeof this._req[b].r&&4!=this._req[b].r.readyState)return this.oDbg.log("Slot "+b+" is not ready"),void 0;if(!this.isPolling()&&0===this._pQueue.length&&this._req[(b+1)%2]&&4!=this._req[(b+1)%2].r.readyState)return this.oDbg.log("all slots busy, standby ...",2),void 0;this.isPolling()||this.oDbg.log("Found working slot at "+b,2),this._req[b]=this._setupRequest(!0),this._req[b].r.onreadystatechange=JSJaC.bind(function(){this.connected()&&4==this._req[b].r.readyState&&(this.oDbg.log("async recv: "+this._req[b].r.responseText,4),this._handleResponse(this._req[b]),this._setStatus("processing"),this._pQueue.length?this._timeout=setTimeout(JSJaC.bind(this._process,this),100):(this.oDbg.log("scheduling next poll in "+this.getPollInterval()+" msec",4),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())))},this);try{this._req[b].r.onerror=JSJaC.bind(function(){if(this.connected()){if(this._errcnt++,this.oDbg.log("XmlHttpRequest error ("+this._errcnt+")",1),this._errcnt>JSJAC_ERR_COUNT)return this._abort(),void 0;this._setStatus("onerror_fallback"),setTimeout(JSJaC.bind(this._repeat,this),JSJAC_RETRYDELAY)}},this)}catch(c){}var d=this._getRequestString();"undefined"!=typeof this._rid&&(this._req[b].rid=this._rid),this.oDbg.log("sending: "+d,4),this._req[b].r.send(d)}},JSJaCConnection.prototype._registerPID=function(a,b,c){return a&&b?(this._regIDs[a]={},this._regIDs[a].cb=b,c&&(this._regIDs[a].arg=c),this.oDbg.log("registered "+a,3),!0):!1},JSJaCConnection.prototype._prepSendEmpty=function(a,b){return function(){b._sendEmpty(JSJaC.bind(a,b))}},JSJaCConnection.prototype._sendEmpty=function(a){var b=this._getFreeSlot();this._req[b]=this._setupRequest(!0),this._req[b].r.onreadystatechange=JSJaC.bind(function(){4==this._req[b].r.readyState&&(this.oDbg.log("async recv: "+this._req[b].r.responseText,4),a(this._req[b].r))},this),"undefined"!=typeof this._req[b].r.onerror&&(this._req[b].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this));var c=this._getRequestString();this.oDbg.log("sending: "+c,4),this._req[b].r.send(c)},JSJaCConnection.prototype._sendRaw=function(a,b,c){return b&&this._sendRawCallbacks.push({fn:b,arg:c}),this._pQueue.push(a),this._process(),!0},JSJaCConnection.prototype._setStatus=function(a){a&&""!==a&&a!=this._status&&(this._status=a,this._handleEvent("onstatuschanged",a),this._handleEvent("status_changed",a))},JSJaCConnection.prototype._unregisterPID=function(a){return this._regIDs[a]?(this._regIDs[a]=null,this.oDbg.log("unregistered "+a,3),!0):!1},JSJaCHttpBindingConnection.prototype=new JSJaCConnection,JSJaCHttpBindingConnection.prototype.inherit=function(a){if(a.jid){var b=new JSJaCJID(a.jid);this.domain=b.getDomain(),this.username=b.getNode(),this.resource=b.getResource()}else this.domain=a.domain||"localhost",this.username=a.username,this.resource=a.resource;this._sid=a.sid,this._rid=a.rid,this._min_polling=a.polling,this._inactivity=a.inactivity,this._setHold(a.requests-1),this.setPollInterval(this._timerval),a.wait&&(this._wait=a.wait),this._connected=!0,this._handleEvent("onconnect"),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())},JSJaCHttpBindingConnection.prototype.setPollInterval=function(a){return a&&!isNaN(a)&&(this._timerval=this.isPolling()?this._min_polling&&a<1e3*this._min_polling?1e3*this._min_polling:this._inactivity&&a>1e3*this._inactivity?1e3*this._inactivity:a:100),this._timerval},JSJaCHttpBindingConnection.prototype.isPolling=function(){return 0===this._hold},JSJaCHttpBindingConnection.prototype._getFreeSlot=function(){for(var a=0;a<this._hold+1;a++)if("undefined"==typeof this._req[a]||"undefined"==typeof this._req[a].r||4==this._req[a].r.readyState)return a;return-1},JSJaCHttpBindingConnection.prototype._getHold=function(){return this._hold},JSJaCHttpBindingConnection.prototype._getRequestString=function(a,b){a=a||"";var c="";if(this._rid<=this._last_rid&&"undefined"!=typeof this._last_requests[this._rid])c=this._last_requests[this._rid].xml;else{for(var d="";this._pQueue.length;){var e=this._pQueue[0];d+=e,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}c="<body rid='"+this._rid+"' sid='"+this._sid+"' xmlns='http://jabber.org/protocol/httpbind' ",JSJAC_HAVEKEYS&&(c+="key='"+this._keys.getKey()+"' ",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),c+="newkey='"+this._keys.getKey()+"' ")),b?c+="type='terminate'":this._reinit&&(JSJACHBC_USE_BOSH_VER&&(c+="xml:lang='"+this._xmllang+"' xmpp:restart='true' xmlns:xmpp='urn:xmpp:xbosh' to='"+this.domain+"'"),this._reinit=!1),c+=""!=d||""!=a?">"+a+d+"</body>":"> </body>",this._last_requests[this._rid]={},this._last_requests[this._rid].xml=c,this._last_rid=this._rid;
for(var f in this._last_requests)this._last_requests.hasOwnProperty(f)&&f<this._rid-this._hold&&delete this._last_requests[f]}return c},JSJaCHttpBindingConnection.prototype._getInitialRequestString=function(){var a="<body content='text/xml; charset=utf-8' hold='"+this._hold+"' xmlns='http://jabber.org/protocol/httpbind' to='"+this.authhost+"' wait='"+this._wait+"' rid='"+this._rid+"'";if(this.host&&this.port&&(a+=" route='xmpp:"+this.host+":"+this.port+"'"),this.secure&&(a+=" secure='"+this.secure+"'"),JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);var b=this._keys.getKey();a+=" newkey='"+b+"'"}return a+=" xml:lang='"+this._xmllang+"'",JSJACHBC_USE_BOSH_VER&&(a+=" ver='"+JSJACHBC_BOSH_VERSION+"'",a+=" xmlns:xmpp='urn:xmpp:xbosh'",("sasl"==this.authtype||"saslanon"==this.authtype||"x-facebook-platform"==this.authtype)&&(a+=" xmpp:version='1.0'")),a+="/>"},JSJaCHttpBindingConnection.prototype._getStreamID=function(a){if(this.oDbg.log(a.responseText,4),!a.responseXML||!a.responseXML.documentElement)return this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),void 0;var b=a.responseXML.documentElement;return"terminate"==b.getAttribute("type")?(this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),void 0):(b.getAttribute("authid")&&(this.streamid=b.getAttribute("authid"),this.oDbg.log("got streamid: "+this.streamid,2)),this._parseStreamFeatures(b)?(this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval()),this.register?this._doInBandReg():this._doAuth(),void 0):(this._sendEmpty(JSJaC.bind(this._getStreamID,this)),void 0))},JSJaCHttpBindingConnection.prototype._getSuspendVars=function(){return"host,port,secure,_rid,_last_rid,_wait,_min_polling,_inactivity,_hold,_last_requests,_pause".split(",")},JSJaCHttpBindingConnection.prototype._handleInitialResponse=function(a){try{this.oDbg.log(a.getAllResponseHeaders(),4),this.oDbg.log(a.responseText,4)}catch(b){this.oDbg.log("No response",4)}if(200!=a.status||!a.responseXML)return this.oDbg.log("initial response broken (status: "+a.status+")",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),void 0;var c=a.responseXML.documentElement;return c&&"body"==c.tagName&&c.namespaceURI==NS_BOSH?"terminate"==c.getAttribute("type")?(this.oDbg.log("invalid response:\n"+a.responseText,1),clearTimeout(this._timeout),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),void 0):(this._sid=c.getAttribute("sid"),this.oDbg.log("got sid: "+this._sid,2),c.getAttribute("polling")&&(this._min_polling=c.getAttribute("polling")),c.getAttribute("inactivity")&&(this._inactivity=c.getAttribute("inactivity")),c.getAttribute("requests")&&this._setHold(c.getAttribute("requests")-1),this.oDbg.log("set hold to "+this._getHold(),2),c.getAttribute("ver")&&(this._bosh_version=c.getAttribute("ver")),c.getAttribute("maxpause")&&(this._pause=Number.min(c.getAttribute("maxpause"),JSJACHBC_MAXPAUSE)),this.setPollInterval(this._timerval),this._connected=!0,this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._getStreamID(a),void 0):(this.oDbg.log("no body element or incorrect body in initial response",1),this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error")),void 0)},JSJaCHttpBindingConnection.prototype._parseResponse=function(a){if(!this.connected()||!a)return null;var b=a.r;try{if(404==b.status||403==b.status)return this._abort(),null;if(200!=b.status||!b.responseXML){this._errcnt++;var c="invalid response ("+b.status+"):\n"+b.getAllResponseHeaders()+"\n"+b.responseText;return b.responseXML||(c+="\nResponse failed to parse!"),this.oDbg.log(c,1),this._errcnt>JSJAC_ERR_COUNT?(this._abort(),null):(this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null)}}catch(d){return this.oDbg.log("XMLHttpRequest error: status not available",1),this._errcnt++,this._errcnt>JSJAC_ERR_COUNT?this._abort():this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null}var e=b.responseXML.documentElement;if(!e||"body"!=e.tagName||e.namespaceURI!=NS_BOSH)return this.oDbg.log("invalid response:\n"+b.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._setStatus("internal_server_error"),this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error")),null;if("undefined"!=typeof a.rid&&this._last_requests[a.rid]){if(this._last_requests[a.rid].handled)return this.oDbg.log("already handled "+a.rid,2),null;this._last_requests[a.rid].handled=!0}if("terminate"==e.getAttribute("type")){var f=e.getAttribute("condition");this.oDbg.log("session terminated:\n"+b.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto);try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(d){}this._connected=!1,"remote-stream-error"==f?e.getElementsByTagName("conflict").length>0?this._setStatus("session-terminate-conflict"):this._setStatus("terminated"):this._setStatus("terminated"),null===f&&(f="session-terminate"),this._handleEvent("onerror",JSJaCError("503","cancel",f)),this.oDbg.log("Aborting remaining connections",4);for(var g=0;g<this._hold+1;g++)try{this._req[g]&&this._req[g]!=a&&this._req[g].r.abort()}catch(d){this.oDbg.log(d,1)}return this.oDbg.log("parseResponse done with terminating",3),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),null}return this._errcnt=0,b.responseXML.documentElement},JSJaCHttpBindingConnection.prototype._reInitStream=function(a){this._reinit=!0,this._sendEmpty(this._prepReInitStreamWait(a))},JSJaCHttpBindingConnection.prototype._prepReInitStreamWait=function(a){return JSJaC.bind(function(b){this._reInitStreamWait(b,a)},this)},JSJaCHttpBindingConnection.prototype._reInitStreamWait=function(a,b){this.oDbg.log("checking for stream features");var c,d,e=a.responseXML.documentElement;if(this.oDbg.log(e),e.getElementsByTagNameNS)this.oDbg.log("checking with namespace"),c=e.getElementsByTagNameNS(NS_STREAM,"features").item(0),c&&(d=c.getElementsByTagNameNS(NS_BIND,"bind").item(0));else{var f,g,h=e.getElementsByTagName("stream:features");for(f=0,g=h.length;g>f;f++)if(h.item(f).namespaceURI==NS_STREAM||h.item(f).getAttribute("xmlns")==NS_STREAM){c=h.item(f);break}if(c)for(d=c.getElementsByTagName("bind"),f=0,g=d.length;g>f;f++)if(d.item(f).namespaceURI==NS_BIND||d.item(f).getAttribute("xmlns")==NS_BIND){d=d.item(f);break}}this.oDbg.log(c),this.oDbg.log(d),c?d?b():(this.oDbg.log("no bind feature - giving up",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this._sendEmpty(this._prepReInitStreamWait(b))},JSJaCHttpBindingConnection.prototype._repeat=function(){this._rid>=this._last_rid&&(this._rid=this._last_rid-1),this._process()},JSJaCHttpBindingConnection.prototype._resume=function(){0===this._pause?this._repeat():this._process()},JSJaCHttpBindingConnection.prototype._setHold=function(a){return!a||isNaN(a)||0>a?a=0:a>JSJACHBC_MAX_HOLD&&(a=JSJACHBC_MAX_HOLD),this._hold=a,this._hold},JSJaCHttpBindingConnection.prototype._setupRequest=function(a){var b={},c=XmlHttp.create();try{c.open("POST",this._httpbase,a),c.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(d){this.oDbg.log(d,1)}return b.r=c,this._rid++,b.rid=this._rid,b},JSJaCHttpBindingConnection.prototype._suspend=function(){if(0!==this._pause){var a=this._getFreeSlot();this._req[a]=this._setupRequest(!1);var b="<body pause='"+this._pause+"' xmlns='http://jabber.org/protocol/httpbind' sid='"+this._sid+"' rid='"+this._rid+"'";for(JSJAC_HAVEKEYS&&(b+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),b+=" newkey='"+this._keys.getKey()+"'")),b+=">";this._pQueue.length;){var c=this._pQueue[0];b+=c,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}b+="</body>",this.oDbg.log("Disconnecting: "+b,4),this._req[a].r.send(b)}},JSJaCWebSocketConnection.prototype=new JSJaCConnection,JSJaCWebSocketConnection.prototype._cleanupWebSocket=function(){null!==this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)},JSJaCWebSocketConnection.prototype.connect=function(a){return this._setStatus("connecting"),this.domain=a.domain||"localhost",this.username=a.username,this.resource=a.resource,this.pass=a.password||a.pass,this.register=a.register,this.authhost=a.authhost||this.domain,this.authtype=a.authtype||"sasl",this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,this._allow_plain=a.allow_plain?a.allow_plain:JSJAC_ALLOW_PLAIN,this._xmllang=a.xmllang&&""!==a.xmllang?a.xmllang:"en","undefined"==typeof WebSocket?(this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),void 0):(this._ws=new WebSocket(this._httpbase,"xmpp"),this._ws.onclose=JSJaC.bind(this._onclose,this),this._ws.onerror=JSJaC.bind(this._onerror,this),this._ws.onopen=JSJaC.bind(this._onopen,this),void 0)},JSJaCWebSocketConnection.prototype._onopen=function(){var a=this._getInitialRequestString();this.oDbg.log(a,4),this._ws.onmessage=JSJaC.bind(this._handleOpenStream,this),this._ws.send(a)},JSJaCWebSocketConnection.prototype._handleOpenStream=function(a){var b,c;return this.oDbg.log(a.data,4),b=a.data,b=b.substr(b.indexOf("<stream:stream")),"/>"!==b.substr(-2)&&"</stream:stream>"!==b.substr(-16)&&(b+="</stream:stream>"),(c=this._parseXml(b))?(this.streamid=c.getAttribute("id"),this.oDbg.log("got streamid: "+this.streamid,2),this._ws.onmessage=JSJaC.bind(this._handleInitialResponse,this),void 0):(this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),void 0)},JSJaCWebSocketConnection.prototype._handleInitialResponse=function(a){var b=this._parseXml(a.data);return this._parseStreamFeatures(b)?(this._connected=!0,this.register?this._doInBandReg():this._doAuth(),void 0):(this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),void 0)},JSJaCWebSocketConnection.prototype.disconnect=function(){this._setStatus("disconnecting"),this.connected()&&(this._connected=!1,this.oDbg.log("Disconnecting",4),this._sendRaw("</stream:stream>",JSJaC.bind(this._cleanupWebSocket,this)),this.oDbg.log("Disconnected",2),this._handleEvent("ondisconnect"))},JSJaCWebSocketConnection.prototype._onclose=function(){this.oDbg.log("websocket closed",2),"disconnecting"!==this._status&&(this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")))},JSJaCWebSocketConnection.prototype._onerror=function(){this.oDbg.log("websocket error",1),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype._onmessage=function(a){var b,c,d;if(b=a.data,this._setStatus("processing"),b&&""!==b){if(c=this._parseXml(b),c.namespaceURI===NS_STREAM&&"error"===c.localName)return c.getElementsByTagNameNS(NS_STREAMS,"conflict").length>0&&this._setStatus("session-terminate-conflict"),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","remote-stream-error")),void 0;d=JSJaCPacket.wrapNode(c),d&&(this.oDbg.log("async recv: "+a.data,4),this._handleEvent("packet_in",d),d.pType&&!this._handlePID(d)&&(this._handleEvent(d.pType()+"_in",d),this._handleEvent(d.pType(),d)))}},JSJaCWebSocketConnection.prototype._parseXml=function(a){var b;this.oDbg.log("Parsing: "+a,4);try{return b=XmlDocument.create("stream",NS_STREAM),-1===a.indexOf("<stream:stream")?(b.loadXML("<stream:stream xmlns:stream='"+NS_STREAM+"' xmlns='jabber:client'>"+a+"</stream:stream>"),b.documentElement.firstChild):(b.loadXML(a),b.documentElement)}catch(c){this.oDbg.log("Error: "+c),this._connected=!1,this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"))}return null},JSJaCWebSocketConnection.prototype._getInitialRequestString=function(){var a,b;return a=this.domain,this.authhost&&(a=this.authhost),b='<stream:stream to="'+a+'" xmlns="jabber:client" xmlns:stream="'+NS_STREAM+'"',("sasl"===this.authtype||"saslanon"===this.authtype)&&(b+=' version="1.0"'),b+=">"},JSJaCWebSocketConnection.prototype.send=function(a,b,c){if(this._ws.onmessage=JSJaC.bind(this._onmessage,this),!a||!a.pType)return this.oDbg.log("no packet: "+a,1),!1;if(!this.connected())return!1;b&&(a.getID()||a.setID("JSJaCID_"+this._ID++),this._registerPID(a.getID(),b,c));try{this._handleEvent(a.pType()+"_out",a),this._handleEvent("packet_out",a),this._ws.send(a.xml())}catch(d){return this.oDbg.log(d.toString(),1),!1}return!0},JSJaCWebSocketConnection.prototype.resume=function(){return!1},JSJaCWebSocketConnection.prototype.suspend=function(){return!1},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S1=function(a){var b=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S1,this)(b)},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S2=function(a){var b=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S2,this)(b)},JSJaCWebSocketConnection.prototype._doSASLAuthDone=function(a){var b=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDone,this)(b)},JSJaCWebSocketConnection.prototype._reInitStream=function(a){var b,c=this.domain;this.authhost&&(c=this.authhost),b='<stream:stream xmlns:stream="'+NS_STREAM+'" xmlns="jabber:client" to="'+c+'" version="1.0">',this._sendRaw(b,a)},JSJaCWebSocketConnection.prototype._sendRaw=function(a,b,c){return this._ws?(b&&(this._ws.onmessage=JSJaC.bind(b,this,c)),this._ws.send(a),!0):!1},JSJaCFBApplication.prototype.Login=function(a,b){var c=this;FB.init({appId:this._appID,status:!0}),FB.login(function(d){d.session&&d.perms&&(c._perms=d.perms,c._session=d.session,a.connect(b))},{perms:"xmpp_login"})},JSJaCFBApplication.prototype.getAppID=function(){return this._appID},JSJaCFBApplication.prototype.getApiKey=function(){return this._apiKey},JSJaCFBApplication.prototype.getApiSecret=function(){return this._apiSecret},JSJaCFBApplication.prototype.getSession=function(){return this._session};var JSJaC={Version:"1.4",require:function(a){document.write('<script type="text/javascript" src="'+a+'"></script>')},load:function(){var a,b=["xmlextras","jsextras","crypt","JSJaCConfig","JSJaCConstants","JSJaCCookie","JSJaCJSON","JSJaCJID","JSJaCBuilder","JSJaCPacket","JSJaCError","JSJaCKeys","JSJaCConnection","JSJaCHttpPollingConnection","JSJaCHttpBindingConnection","JSJaCConsoleLogger","JSJaCFBApplication","JSJaCWebSocketConnection"],c=document.getElementsByTagName("script"),d="./";for(a=0;a<c.length;a++)if(c.item(a).src&&c.item(a).src.match(/JSJaC\.js$/)){d=c.item(a).src.replace(/JSJaC.js$/,"");break}for(a=0;a<b.length;a++)this.require(d+b[a]+".js")},bind:function(a,b,c){return function(d){return a.apply(b,[d,c])}}};"undefined"==typeof JSJaCConnection&&JSJaC.load();var CrocSDK={};!function(a){function b(b){var c=null;if(!b)throw new a.Exceptions.ValueError("Configuration object missing");for(c in b){var d=j[c];if(!d)throw new a.Exceptions.ValueError("Unexpected config property: "+c);for(var e=b[c],f=!1,g=0,h=d.length;h>g;g++)if(a.Util.isType(e,d[g])){f=!0;break}if(!f)throw new TypeError(c+" is not set to a valid type")}if(b.apiKey){if(b.sipProxySet)throw new a.Exceptions.ValueError("Both apiKey and sipProxySet are configured");if(b.msrpRelaySet)throw new a.Exceptions.ValueError("Both apiKey and msrpRelaySet are configured")}else{if(!b.sipProxySet)throw new a.Exceptions.ValueError("Either apiKey or sipProxySet must be configured");if(b.sipProxySet instanceof Array&&0===b.sipProxySet.length)throw new a.Exceptions.ValueError("sipProxySet is empty")}for(var i in k)for(c in b[i]){var l=k[i][c];if(!l)throw new a.Exceptions.ValueError("Unexpected config property: "+i+"."+c);if(!a.Util.isType(b[i][c],l))throw new TypeError(i+"."+c+" is not set to a valid type")}}function c(b){var c={"sip.audio":!0,"sip.video":!0,"sip.text":!0,"sip.data":!0,"croc.sdkversion":"1"},d=b.features;return d&&(c["sip.audio"]=d.indexOf(a.C.FEATURES.AUDIO)>=0,c["sip.video"]=d.indexOf(a.C.FEATURES.VIDEO)>=0),b.apiKey||b.msrpRelaySet||(c["sip.text"]=!1,c["sip.data"]=!1),JsSIP.WebRTC.getUserMedia||(c["sip.audio"]=!1,c["sip.video"]=!1),c}function d(b){-1===JsSIP.C.USER_AGENT.indexOf("Crocodile")&&(JsSIP.C.USER_AGENT="Crocodile SDK v1.0; ".concat(JsSIP.C.USER_AGENT,"; ",navigator.userAgent));var c=b.sipProxySet,d=b.apiKey||"";a.Util.isType(b.sipProxySet,"string")&&(c=[c]);var e="ws";b.useTLS&&(e="wss");for(var f=0,g=c.length;g>f;f++)c[f]=e.concat("://",c[f],"/",d);var h=localStorage["croc.rtc.sip.instance"];h||(h=JsSIP.Utils.newUUID(),localStorage["croc.rtc.sip.instance"]=h);var i={ws_servers:c,register:b.register,register_expires:b.expiresTime,uri:"sip:"+(b.address||"anonymous@anonymous.invalid"),password:b.password,authorization_user:b.authorizationUser,display_name:b.displayName,no_answer_timeout:b.acceptTimeout,handle_media:!1,instance_id:h};b.sipUA=new JsSIP.UA(i),b.sipUA.on("connected",function(){a.Util.fireEvent(b,"onConnected",{})}),b.sipUA.on("disconnected",function(c){a.Util.fireEvent(b,"onDisconnected",{status:a.Util.websocketCauseToSdkStatus(c.data.code)})}),b.sipUA.on("registered",function(c){var d,e,f=c.data.response,g=f.countHeader("contact"),h=[];for(d=0;g>d;d++)if(e=f.parseHeader("contact",d),e.uri.user!==b.sipUA.contact.uri.user){var i=e.getParam("pub-gruu");i&&h.push(i.replace(/"/g,""))}a.Util.fireEvent(b,"onRegistered",{instanceAddresses:h})}),b.sipUA.on("unregistered",function(c){switch(a.Util.fireEvent(b,"onUnregistered",{}),c.data.cause){case JsSIP.C.causes.AUTHENTICATION_ERROR:case JsSIP.C.causes.REJECTED:console.log("Registration authentication failed - stopping"),b.stop()}}),b.sipUA.on("registrationFailed",function(c){var d="other";switch(c.data.cause){case JsSIP.C.causes.REQUEST_TIMEOUT:d="timeout";break;case JsSIP.C.causes.AUTHENTICATION_ERROR:case JsSIP.C.causes.REJECTED:d="auth"}switch(a.Util.fireEvent(b,"onRegistrationFailed",{cause:d}),c.data.cause){case JsSIP.C.causes.AUTHENTICATION_ERROR:case JsSIP.C.causes.REJECTED:console.log("Registration authentication failed - stopping"),b.stop()}}),b.sipUA.on("newRTCSession",function(c){var d=c.data;if("remote"===d.originator){d.session.contact+=b.capability.createFeatureTags(b.capabilities);var e=new a.Sdp.Session(d.request.body);if(!e)return d.sdpInvalid(),void 0;for(var f=0,g=e.media.length;g>f;f++){var h=e.media[f];if("message"===h.media)switch(h.proto){case"TCP/MSRP":case"TCP/TLS/MSRP":return b.data.init_incoming(d.session,d.request,h,d.sdpValid,d.sdpInvalid),void 0}}b.media.init_incoming(d.session,d.request,e,d.sdpValid,d.sdpInvalid)}})}function e(b){if(b.xmppProxySet&&!(b.xmppProxySet.length<1)&&b.address){var c=Math.floor(Math.random()*b.xmppProxySet.length),d=b.xmppProxySet[c],e="ws";b.useTLS&&(e="wss");var f="";if(b.apiKey){var g=b.address.split("@");f=b.apiKey.concat("/",g[1],"/",g[0])}var h=e.concat("://",d,"/",f);b.xmppCon=new JSJaCWebSocketConnection({httpbase:h}),b.xmppResource||(b.xmppResource=a.Util.randomAlphanumericString(10))}}function f(a,b,c,d,e){this.jQuery=a,this.service=c,this.url=b,this.username=d,this.retryPeriod=e,this.timerId=null}function g(a,b,c,d){this.jQuery=a,this.path="/crocodile-sdk-hub/rest/1.0/browser/login",this.url="https://hub.crocodilertc.net:8443"+this.path,this.username=b,this.password=c,this.retryPeriod=d||60,this.timerId=null}var h={acceptTimeout:300,autostart:!0,capabilities:{},capability:{refreshPeriod:15},data:{idleTimeout:300},expiresTime:600,features:["audio","video","pagedata"],register:!1,requireMatchingVersion:!1,useTLS:!0,iceServers:[{url:"stun:stun.l.google.com:19302"}]},i={sipProxySet:["edge00.crocodilertc.net","edge01.crocodilertc.net"],xmppProxySet:["cm.crocodilertc.net"],turnManagerUrl:"https://hub.crocodilertc.net:8443/crocodile-sdk-hub/rest/1.0/ephemeral",msrpManagerUrl:"https://hub.crocodilertc.net:8443/crocodile-sdk-hub/rest/1.0/ephemeral"},j={acceptTimeout:["number"],address:["string"],apiKey:["string"],authorizationUser:["string"],autostart:["boolean"],capabilities:["object"],capability:["object"],data:["object"],displayName:["string"],expiresTime:["number"],features:["string[]"],iceServers:["object[]"],jQuery:["function"],media:["object"],msrpManagerUrl:["string"],msrpManagerUsername:["string"],msrpRelaySet:["string","string[]"],onConnected:["function"],onDisconnected:["function"],onRegistered:["function"],onUnregistered:["function"],onRegistrationFailed:["function"],password:["string"],presence:["object"],register:["boolean"],requireMatchingVersion:["boolean"],sipProxySet:["string","string[]"],turnManagerUrl:["string"],turnManagerUsername:["string"],useTLS:["boolean"],xmppProxySet:["string[]"],xmppResource:["string"]},k={capability:{refreshPeriod:"number",onWatchRequest:"function",onWatchChange:"function"},data:{idleTimeout:"number",onDataSession:"function",onData:"function",onXHTMLReceived:"function"},media:{onMediaSession:"function"},presence:{onConnected:"function",onContactsReceived:"function",onDirectNotify:"function",onDisconnected:"function",onNewContact:"function",onSelfNotify:"function",onWatchRequest:"function"}};f.prototype.start=function(){this.url&&!this.timerId&&this.query()},f.prototype.stop=function(){null!==this.timerId&&(clearTimeout(this.timerId),this.timerId=null)},f.prototype.query=function(){var b=this,c={service:this.service};this.username&&(c.username=this.username),null!==this.timerId&&(clearTimeout(this.timerId),this.timerId=null),this.jQuery.getJSON(this.url,c).done(function(c){var d=Math.max(c.ttl-5,60);console.log("Next credential refresh in",d,"seconds"),b.timerId=setTimeout(function(){b.timerId=null,b.query()},1e3*d),a.Util.fireEvent(b,"onUpdate",c)}).fail(function(a,c,d){console.warn("Ephemeral credential request failed:",c,d),b.timerId=setTimeout(function(){b.timerId=null,b.query()},1e3*b.retryPeriod)})},g.prototype.start=function(){this.timerId||this.auth()},g.prototype.stop=function(){this.timerId&&(clearTimeout(this.timerId),this.timerId=null)},g.prototype.auth=function(){var b=this,c=JsSIP.Utils.calculateMD5,d=function(a,c,d){console.warn("Auth nonce request failed:",c,d),b.timerId=setTimeout(function(){b.auth()},1e3*b.retryPeriod)};this.jQuery.ajax(this.url,{dataType:"json",cache:!1}).done(function(e){var f="00000001",g=a.Util.randomAlphanumericString(10),h=c(b.username.concat(":",e.realm,":",b.password)),i=c("POST:"+b.path),j=c(h.concat(":",e.nonce,":",f,":",g,":auth:",i));if("auth"!==e.qop)return console.warn("Unexpected qop value:",e.qop),void 0;var k={username:b.username,realm:e.realm,nonce:e.nonce,cnonce:g,nc:f,qop:e.qop,uri:b.path,response:j};b.jQuery.ajax(this.url,{type:"POST",dataType:"json",data:JSON.stringify(k),contentType:"application/json; charset=UTF-8",xhrFields:{withCredentials:!0}}).done(function(a){var c=Math.max(a.ttl-5,b.retryPeriod);b.timerId=setTimeout(function(){b.auth()},1e3*c),console.log("Next auth refresh in",c,"seconds")}).fail(d)}).fail(d)},a.Croc=function(j){var k=this;this.started=!1,this.xmppCon=null,this.turnManager=null,this.authManager=null,b(j),j.address&&(j.address=j.address.toLowerCase());var l,m={capabilities:c(j),register:!!j.address};l=j.apiKey?j.jQuery.extend(!0,{},h,i,m,j):j.jQuery.extend(!0,{},h,m,j),j.sipProxySet&&(l.sipProxySet=j.sipProxySet),j.msrpRelaySet&&(l.msrpRelaySet=j.msrpRelaySet),j.xmppProxySet&&(l.xmppProxySet=j.xmppProxySet),j.iceServers&&(l.iceServers=j.iceServers),j.features&&(l.features=j.features);var n={capability:new a.CapabilityAPI(this,l),data:new a.DataAPI(this,l),media:new a.MediaAPI(this,l),presence:new a.XmppPresenceAPI(this,l)};if(j.jQuery.extend(this,l,n),this._detectCapabilities(),d(this),e(this),this.apiKey&&this.address&&(this.authManager=new g(this.jQuery,this.address,this.password)),this.turnManagerUrl){if(!this.turnManagerUsername){var o=j.apiKey.concat("+");j.address&&(o+=j.address.concat("+")),o+=a.Util.randomAlphanumericString(8),this.turnManagerUsername=o}this.turnManager=new f(this.jQuery,this.turnManagerUrl,"turn",this.turnManagerUsername,3600),this.turnManager.onUpdate=function(a){console.log("Received TURN config:",a);for(var b=[],c=0;c<a.uris.length;++c){var d=a.uris[c],e=navigator.userAgent.match(/Chrome\/([0-9]*)/);if(e&&parseInt(e[1],10)<28){var f=encodeURIComponent(a.username);d=d.replace(":",":".concat(f,"@"))}b.push({url:d,username:a.username,credential:a.password})}k.dynamicIceServers=b,k.media._updateIceServers()}}if(this.msrpManagerUrl){if(!this.msrpManagerUsername){var p=j.apiKey.concat("+");j.address&&(p+=j.address.concat("+")),p+=a.Util.randomAlphanumericString(8),this.msrpManagerUsername=p}this.msrpManager=new f(this.jQuery,this.msrpManagerUrl,"msrp",this.msrpManagerUsername,3600),this.msrpManager.onUpdate=function(a){console.log("Received MSRP config:",a),k.msrpRelaySet||(k.msrpRelaySet=a.relays),k.data.initMsrp(k,a.username,a.password)}}this.capability.init(),this.data.init(),this.media.init(),this.presence.init(),this.autostart&&this.start()},a.Croc.prototype._detectCapabilities=function(){var a=this.capabilities,b=window.MediaStreamTrack;if(b&&b.getSources){var c={audio:!1,video:!1};try{return b.getSources(function(b){for(var d=0,e=b.length;e>d;d++)c[b[d].kind]=!0;a["sip.audio"]=a["sip.audio"]&&c.audio,a["sip.video"]=a["sip.video"]&&c.video}),void 0}catch(d){}}if(JsSIP.WebRTC.getUserMedia){var e=function(a){a.stop()},f=function(){a["sip.audio"]&&JsSIP.WebRTC.getUserMedia({audio:!0},e,function(){a["sip.audio"]=!1})};a["sip.video"]?JsSIP.WebRTC.getUserMedia({video:!0,audio:!0},e,function(){a["sip.video"]=!1,f()}):f()}},a.Croc.prototype.start=function(){if(!this.started){var b=this;this.started=!0,this.beforeunload=function(){b.stop(),b.sipUA.transport.disconnect()},window.addEventListener("beforeunload",this.beforeunload,!1),this.sipUA.start(),this.capability.start(),this.authManager&&this.authManager.start(),this.turnManager&&this.turnManager.start(),this.msrpManager&&this.msrpManager.start(),b.features.indexOf(a.C.FEATURES.PRESENCE)>=0&&this.presence.start()}},a.Croc.prototype.connect=function(){this.start()},a.Croc.prototype.stop=function(){this.started&&(this.started=!1,window.removeEventListener("beforeunload",this.beforeunload,!1),this.authManager&&this.authManager.stop(),this.turnManager&&this.turnManager.stop(),this.msrpManager&&this.msrpManager.stop(),this.capability.stop(),this.presence.stop(),this.data.close(),this.media.close(),this.sipUA.stop())},a.Croc.prototype.disconnect=function(){this.stop()},a.Croc.prototype.isConnected=function(){return this.sipUA.isConnected()},a.Croc.prototype.reregister=function(){this.sipUA.register()},a.Croc.prototype.unregister=function(){this.sipUA.unregister()}}(CrocSDK),function(a){function b(){this.status=null,this.capabilities=null,this.userAgent=null,this.instanceAddress=null}function c(b,c,d){var e=b.crocObject,f="normal",g=200,h="Contact: ",i=null;switch(h+=e.sipUA.contact.toString(),a.Util.fireEvent(b,"onWatchRequest",{address:c.parseHeader("from",0).uri.toAor().replace(/^sip:/,""),setWatchStatus:function(b){if(!a.Util.isType(b,"string"))throw new TypeError(b+" is not set to a valid type");switch(b){case"normal":case"blocked":case"offline":case"notfound":f=b;break;default:throw new a.Exceptions.ValueError("Invalid status:",b)}},setCapabilities:function(a){i=a}}),f){case"normal":var j;i?(j={},a.Util.shallowCopy(j,e.capabilities),a.Util.shallowCopy(j,i)):j=e.capabilities,h+=b.createFeatureTags(j);break;case"blocked":g=403;break;case"notfound":g=404;break;case"offline":g=480}d.push(h),c.reply(g,null,d)}function d(a,b,c){var d=b.status,e=b.capabilities;switch(c.status_code){case 200:b.status="normal";break;case 403:b.status="blocked";break;case 404:b.status="notfound";break;case 408:case 480:b.status="offline";break;default:b.status="error"}if(c.hasHeader("contact")){var f=c.parseHeader("contact",0);b.instanceAddress=f.uri.toString(),b.capabilities=a.parseFeatureTags(f.parameters)}b.userAgent=c.getHeader("user-agent");var g=!1;if(d!==b.status)g=!0;else if(e&&c.hasHeader("contact")){var h=b.capabilities;for(var i in h)e.hasOwnProperty(i)?e[i]!==h[i]&&(g=!0):g=!0}return g}function e(a){var b=a.nextRefreshIndex,c=a.watchList,d=c.length,e=Math.ceil(d/a.refreshPeriod);if(0===a.lastRefreshStart&&(a.lastRefreshStart=Date.now(),b=a.nextRefreshIndex=d),b>=d){var f=Date.now()-a.lastRefreshStart;if(f<1e3*a.refreshPeriod)return;b=0,a.lastRefreshStart=Date.now()}for(var g=0;d>b&&e>g;b++,g++)a.refresh(c[b]);a.nextRefreshIndex=b}var f={audio:"boolean",video:"boolean",text:"boolean",data:"boolean"},g={croc:{sdkversion:"string"}};a.CapabilityAPI=function(a,b){this.crocObject=a,this.watchList=[],this.nextRefreshIndex=0,this.lastRefreshStart=0,this.watchDataCache={},this.refreshIntervalId=null,b.jQuery.extend(this,b.capability)},a.CapabilityAPI.prototype.init=function(){var a=this;this.crocObject.sipUA.on("newOptions",function(b){var d=b.data;"remote"===d.originator&&c(a,d.request,d.extraHeaders)})},a.CapabilityAPI.prototype.start=function(){var a=this;null===this.refreshIntervalId&&this.watchList.length>0&&(this.refreshIntervalId=setInterval(function(){e(a)},1e3))},a.CapabilityAPI.prototype.stop=function(){this.refreshIntervalId&&(clearInterval(this.refreshIntervalId),this.refreshIntervalId=null)},a.CapabilityAPI.prototype.createFeatureTags=function(b){var c="";for(var d in b){var e=d.split(".");if(2===e.length){var h=e[0],i=e[1],j=null,k=b[d];if("sip"===h&&(j=f[i]),j||(g[h]?(j=g[h][i],i="+"+d):"custom"===h&&(j=typeof k,i="+"+d)),j)if(a.Util.isType(k,j))switch(j){case"boolean":b[d]&&"custom"!==h?c+=";"+i:b[d]&&"custom"===h?c+=";"+i+'="TRUE"':b[d]||"custom"!==h||(c+=";"+i+'="FALSE"');break;case"string":c+=";"+i+'="<'+k+'>"';break;default:console.warn("Unsupported capability type:",d,j)}else console.warn("Unexpected capability value:",d,k);else console.warn("Ignoring unknown capability:",d)}else console.warn("Ignoring invalid capability:",d)}return c},a.CapabilityAPI.prototype.parseFeatureTags=function(a){var b={},c=null;for(c in f)b["sip."+c]=!1;for(c in a)if("+"===c.charAt(0)){var d=a[c],e=c.slice(1),h=e.split(".");if(2===h.length){var i=h[0];c=h[1];var j=null;if(g.hasOwnProperty(i)){if(j=g[i][c])switch(j){case"string":'"<'===d.slice(0,2)&&'>"'===d.slice(-2)?b[e]=d.slice(2,-2):console.warn("Unexpected string format in feature tag:",d)}}else"custom"===i?"string"==typeof d&&('"<'===d.slice(0,2)&&'>"'===d.slice(-2)?b[e]=d.slice(2,-2):'"TRUE"'===d?b[e]=!0:'"FALSE"'===d?b[e]=!1:console.warn("Unexpected string format in feature tag:",d)):console.warn("Invalid feature tag:",c)}else console.warn("Invalid feature tag:",c)}else c in f&&(b["sip."+c]=!0);return b},a.CapabilityAPI.prototype.watch=function(c){var d=a.Util.normaliseAddress(c);c=d.toAor().replace(/^sip:/,""),this.watchDataCache[c]||(this.watchList.push(c),this.watchDataCache[c]=new b,this.refresh(c),this.start())},a.CapabilityAPI.prototype.unwatch=function(b){var c=a.Util.normaliseAddress(b);if(b=c.toAor().replace(/^sip:/,""),this.watchDataCache[b]){var d=this.watchList.indexOf(b);this.watchList.splice(d,1),delete this.watchDataCache[b]}0===this.watchList.length&&this.stop()},a.CapabilityAPI.prototype.refresh=function(b){var c=this,e=a.Util.normaliseAddress(b);b=e.toAor().replace(/^sip:/,"");var f=this.watchDataCache[b];if(!f)throw new a.Exceptions.ValueError("Address not in watch list");var g={request:new JsSIP.OutgoingRequest(JsSIP.C.OPTIONS,e,this.crocObject.sipUA),receiveResponse:function(e){d(c,f,e)&&a.Util.fireEvent(c,"onWatchChange",{address:b,instanceAddress:f.instanceAddress,status:f.status,capabilities:f.capabilities}),a.Util.isAuthFailure(e.status_code)&&(console.log("Request authentication failed - stopping"),c.crocObject.stop())
},onRequestTimeout:function(){console.log("request timeout"),f.status="offline"},onTransportError:function(){console.warn("request transport error")}},h=new JsSIP.RequestSender(g,this.crocObject.sipUA);h.send()},a.CapabilityAPI.prototype.query=function(c,e){var f=this,g=new b,h=a.Util.normaliseAddress(c);c=h.toAor().replace(/^sip:/,"");var i={request:new JsSIP.OutgoingRequest(JsSIP.C.OPTIONS,h,this.crocObject.sipUA),receiveResponse:function(b){d(f,g,b),e({address:c,instanceAddress:g.instanceAddress,status:g.status,capabilities:g.capabilities}),a.Util.isAuthFailure(b.status_code)&&(console.log("Request authentication failed - stopping"),f.crocObject.stop())},onRequestTimeout:function(){console.log("request timeout"),e(null)},onTransportError:function(){console.warn("request transport error"),e(null)}},j=new JsSIP.RequestSender(i,this.crocObject.sipUA);j.send()},a.CapabilityAPI.prototype.getCapabilities=function(b){var c=a.Util.normaliseAddress(b);b=c.toAor().replace(/^sip:/,"");var d=this.watchDataCache[b];return d?d.capabilities:null},a.CapabilityAPI.prototype.getWatchStatus=function(b){var c=a.Util.normaliseAddress(b);b=c.toAor().replace(/^sip:/,"");var d=this.watchDataCache[b];return d?d.status:null},a.CapabilityAPI.prototype.getWatchData=function(b){var c=a.Util.normaliseAddress(b);return b=c.toAor().replace(/^sip:/,""),this.watchDataCache[b]||null},a.CapabilityAPI.prototype.onWatchRequest=function(){},a.CapabilityAPI.prototype.onWatchChange=function(){}}(CrocSDK),function(a){a.C={FEATURES:{AUDIO:"audio",VIDEO:"video",PAGEDATA:"pagedata",PRESENCE:"presence",TRANSFER:"transfer"},NS:{XHTML:"http://www.w3.org/1999/xhtml",XMPP_XHTML_IM:"http://jabber.org/protocol/xhtml-im",XMPP_RECEIPTS:"urn:xmpp:receipts",XMPP_REACH:"urn:xmpp:reach:0"},MT:{XHTML:"application/xhtml+xml",IS_COMPOSING:"application/im-iscomposing+xml"},states:{dataSession:{PENDING:"pending",ESTABLISHED:"established",CLOSED:"closed"},rfcComposing:{ACTIVE:"active",IDLE:"idle"},sdkComposing:{COMPOSING:"composing",IDLE:"idle"},xmppChatState:{ACTIVE:"active",COMPOSING:"composing",PAUSED:"paused",INACTIVE:"inactive",GONE:"gone"}},COMPOSING_TIMEOUT:15}}(CrocSDK),function(a){a.CustomHeaders=function(a){if(a instanceof JsSIP.IncomingRequest)this.fromJsSipHeaders(a.headers);else if(a instanceof JsSIP.OutgoingRequest)this.fromExtraHeaders(a.extraHeaders);else if(a){var b,c;for(b in a)c=a[b],this.isValidCustomHeader(b,c)?this[b]=c:console.warn("Ignored custom header:",b,c)}},a.CustomHeaders.prototype.isValidCustomHeader=function(b,c){var d=/[^a-zA-Z0-9\-\.!%\*_\+`'~]/;return"X-"!==b.slice(0,2).toUpperCase()?!1:b.match(d)?!1:a.Util.isType(c,"string")?c.match(/[\r\n]/)?!1:!0:!1},a.CustomHeaders.prototype.equals=function(a){var b=Object.keys(this);if(b.length!==Object.keys(a).length)return!1;for(var c=0,d=b.length;d>c;c++){var e=b[c];if(a[e]!==this[e])return!1}return!0},a.CustomHeaders.prototype.fromJsSipHeaders=function(a){for(var b in a)if("X-"===b.slice(0,2).toUpperCase()){var c=a[b][0].raw;this.isValidCustomHeader(b,c)?this[b]=c:console.warn("Ignored custom header:",b,c)}},a.CustomHeaders.prototype.fromExtraHeaders=function(a){for(var b=0,c=a.length;c>b;b++){var d=a[b],e=d.match(/([^:]*)\s*:\s*(.*)/),f=e[1],g=e[2];"X-"===f.slice(0,2).toUpperCase()&&this.isValidCustomHeader(f,g)&&(this[f]=g)}},a.CustomHeaders.prototype.toExtraHeaders=function(){for(var a=[],b=Object.keys(this),c=0,d=b.length;d>c;c++){var e=b[c],f=this[e];this.isValidCustomHeader(e,f)?a.push(e+": "+f):console.warn("Ignored invalid custom header:",e,f)}return a},a.CustomHeaders.prototype.isEmpty=function(){var a=Object.keys(this);return 0===a.length}}(CrocSDK),function(a){function b(b,c,d,f){var g=b.sipDataSessions[c],h=b.crocObject.capability;return g&&"closed"!==g.getState||(g=new a.SipDataSession(b,c),g.capabilities=h.getCapabilities(c),g.customHeaders=new a.CustomHeaders(f.customHeaders),b.checkSessionsIntervalId||(b.checkSessionsIntervalId=window.setInterval(function(){e(b)},1e4)),b.sipDataSessions[c]=g),g.send(d,f),g}function c(b,c,d,f){var g=a.Util.normaliseAddress(c),h=g.toAor().replace(/^sip:/,""),i=null;return f.customHeaders||f.fileTransfer||c!==h||(i=b.reusableMsrpDataSessions[c]),i&&"closed"!==i.getState?i.send(d,f):(i=new a.OutgoingMsrpSession(b,g,d,f),b.checkSessionsIntervalId||(b.checkSessionsIntervalId=window.setInterval(function(){e(b)},1e4)),f.customHeaders||f.fileTransfer||c!==h||(b.reusableMsrpDataSessions[c]=i),b.msrpDataSessions.push(i)),i}function d(b,c,d,f){var g=b.crocObject,h=g.xmppCon;if(!h)throw new a.Exceptions.StateError("XMPP not configured");if(!h.connected())throw new a.Exceptions.StateError("XMPP not connected");if(!a.Util.isType(c,"string"))throw new TypeError("Unexpected address:",c);if(!a.Util.isType(d,"string")&&f.contentType!==a.C.MT.XHTML)throw new TypeError("Unexpected data:",d);var i=b.xmppDataSessions[c];return i&&"closed"!==i.getState()||(i=new a.XmppDataSession(b,c),b.xmppDataSessions[c]=i,b.checkSessionsIntervalId||(b.checkSessionsIntervalId=window.setInterval(function(){e(b)},1e4))),f.contentType===a.C.MT.XHTML?i.sendXHTML(d,f):i.send(d,f),i}function e(a){for(var b,c=0,d=Date.now()-1e3*a.idleTimeout,e=a.msrpDataSessions,f=a.xmppDataSessions,g=a.sipDataSessions,h=!1;c<e.length;)b=e[c],b._isIdle(d)&&(console.log("Closing idle session:",b),b.close()),"closed"===b.getState()?(e.splice(c,1),a.reusableMsrpDataSessions[b.address]===b&&delete a.reusableMsrpDataSessions[b.address]):c++;var i=[f,g];for(c=0;c<i.length;c++){var j=i[c];for(var k in j)b=j[k],b._isIdle(d)&&(console.log("Closing idle session:",b),b.close()),"closed"===b.getState()?delete j[k]:h=!0}e.length<1&&!h&&(window.clearInterval(a.checkSessionsIntervalId),a.checkSessionsIntervalId=null)}function f(a,b,c,d){d=d||"";var e="ws://".concat(a,"/",d),f="msrp://".concat(a,";tcp");return c&&(e=e.replace("ws:","wss:"),f=f.replace("msrp:","msrps:")),new CrocMSRP.Connection(e,f,b)}a.DataAPI=function(a,b){this.crocObject=a,b.jQuery.extend(this,b.data),this.nextMsrpConnection=0,this.msrpConnections=[],this.checkSessionsIntervalId=null,this.reusableMsrpDataSessions={},this.msrpDataSessions=[],this.xmppDataSessions={},this.sipDataSessions={},this.initMsrp(b)},a.DataAPI.prototype.init=function(){var b=this.crocObject,c=b.xmppCon;b.features.indexOf(a.C.FEATURES.PAGEDATA)>=0&&b.sipUA.on("newMessage",this._handleSipMessage.bind(this)),c&&(c.registerHandler("message","*","*","error",this._handleXmppMessageError.bind(this)),c.registerHandler("message",this._handleXmppMessage.bind(this)))},a.DataAPI.prototype.initMsrp=function(b,c,d){var e,g,h={username:c||b.authorizationUser||b.address,password:d||b.password},i=this.msrpConnections;if(0===i.length){var j=b.msrpRelaySet||[];for(a.Util.isType(j,"string")&&(j=[j]),e=0,g=j.length;g>e;e++)i.push(f(j[e],h,b.useTLS,b.apiKey))}else for(e=0,g=i.length;g>e;e++){var k=i[e].config;k.username=h.username,k.password=h.password}},a.DataAPI.prototype.init_incoming=function(b,c,d,f,g){if(this.hasOwnProperty("onDataSession")){var h=new a.IncomingMsrpSession(this,b,c);if(!this.checkSessionsIntervalId){var i=this;this.checkSessionsIntervalId=window.setInterval(function(){e(i)},1e4)}this.msrpDataSessions.push(h);var j=null,k=d.parseFileAttributes();k&&(j={name:k.selector.name,description:k.description,disposition:k.disposition,size:k.selector.size}),f(),h.customHeaders.isEmpty()&&!j&&(this.reusableMsrpDataSessions[h.address]=h),a.Util.fireEvent(this,"onDataSession",{session:h,fileTransfer:j})}else g()},a.DataAPI.prototype._handleSipMessage=function(b){if("remote"===b.data.originator){var c=b.data.request,d=c.parseHeader("from",0).uri.toAor().replace(/^sip:/,""),f=c.headers["Content-Type"][0].parsed,g=this.sipDataSessions[d],h=c.parseHeader("contact",0),i=null;h&&(i=this.crocObject.capability.parseFeatureTags(h.parameters));var j=c.from.display_name;if(g&&"closed"!==g.getState())g.capabilities=i,g.customHeaders=new a.CustomHeaders(c),g.displayName=j;else{if(g=new a.SipDataSession(this,d),this.sipDataSessions[d]=g,g.capabilities=i,g.customHeaders=new a.CustomHeaders(c),g.displayName=j,!this.checkSessionsIntervalId){var k=this;this.checkSessionsIntervalId=window.setInterval(function(){e(k)},1e4)}var l=!1;if(g.close=function(){l=!0},a.Util.fireEvent(this,"onDataSession",{session:g,fileTransfer:null}),delete g.close,l)return b.data.message.reject(),g.close(),void 0;b.data.message.accept()}g._receiveMessage(d,f,c.body)}},a.DataAPI.prototype._handleXmppMessage=function(b){var c=b.getFrom(),d=b.getFromJID().getBareJID(),f=this.xmppDataSessions[d];if(!f||"closed"===f.getState()){if(f=new a.XmppDataSession(this,d,c),this.xmppDataSessions[d]=f,!this.checkSessionsIntervalId){var g=this;this.checkSessionsIntervalId=window.setInterval(function(){e(g)},1e4)}a.Util.fireEvent(this,"onDataSession",{session:f,fileTransfer:null})}return f._receiveMessage(b),!0},a.DataAPI.prototype._handleXmppMessageError=function(a){var b=a.getFromJID().getBareJID(),c=this.xmppDataSessions[b];return c&&"closed"!==c.getState()?c._receiveMessageError(a):console.log("Unhandled XMPP error: ",a.xml()),!0},a.DataAPI.prototype.send=function(e,f,g){switch(g=g||{},a.Util.checkSendConfig(g),g.type||(g.type="page"),g.type){case"msrp":return c(this,e,f,g);case"page":return b(this,e,f,g);case"xmpp":return d(this,e,f,g);default:throw new a.Exceptions.ValueError("Invalid type value")}},a.DataAPI.prototype.sendXHTML=function(e,f,g){var h;switch(g=g||{},a.Util.checkSendConfig(g),g.type||(g.type="page"),g.contentType=a.C.MT.XHTML,"xmpp"!==g.type&&(h=a.Util.createValidXHTMLDoc(f)),g.type){case"msrp":return c(this,e,h,g);case"page":return b(this,e,h,g);case"xmpp":return d(this,e,f,g);default:throw new a.Exceptions.ValueError("Invalid type value")}},a.DataAPI.prototype.close=function(){for(var a=null,b=0,c=this.msrpDataSessions.length;c>b;b++)this.msrpDataSessions[b].close();for(a in this.sipDataSessions)this.sipDataSessions[a].close()},a.DataAPI.prototype.onDataSession=function(){},a.DataAPI.prototype.onData=function(){}}(CrocSDK),function(a){a.Exceptions={};var b=function(a){var b=new Error;b.stack&&(this.stack=b.stack),this.message=a||"Unexpected value error"};b.prototype=new Error,b.prototype.constructor=b,b.prototype.name="ValueError";var c=function(a){var b=new Error;b.stack&&(this.stack=b.stack),this.message=a||"Unexpected state error"};c.prototype=new Error,c.prototype.constructor=c,c.prototype.name="StateError";var d=function(a){var b=new Error;b.stack&&(this.stack=b.stack),this.message=a||"Version error"};d.prototype=new Error,d.prototype.constructor=d,d.prototype.name="VersionError";var e=function(a){var b=new Error;b.stack&&(this.stack=b.stack),this.message=a||"Unsupported error"};e.prototype=new Error,e.prototype.constructor=e,e.prototype.name="UnsupportedError",a.Exceptions.ValueError=b,a.Exceptions.StateError=c,a.Exceptions.VersionError=d,a.Exceptions.UnsupportedError=e}(CrocSDK),function(a){var b=function(a,b){this.crocObject=a,this.mediaSessions=[],b.jQuery.extend(this,b.media)};b.prototype.init=function(){var b=this.crocObject;b.features.indexOf(a.C.FEATURES.TRANSFER)>=0&&b.sipUA.on("newRefer",this._handleRefer.bind(this))},b.prototype.init_incoming=function(b,c,d,e,f){if(this.hasOwnProperty("onMediaSession")){var g=this,h=this.crocObject,i=h.capability,j=b.remote_identity.uri.toAor().replace(/^sip:/,""),k=new a.MediaSession(this,b,j),l=function(){console.log("Remote offer set"),e(),a.Util.fireEvent(g,"onMediaSession",{session:k})},m=function(a){console.warn("setRemoteDescription failed:",a),f(),k.close()};k._handleInitialInvite(c.body,d,l,m),k.displayName=b.remote_identity.display_name,k.customHeaders=new a.CustomHeaders(c);var n=c.parseHeader("contact",0);k.capabilities=i.parseFeatureTags(n.parameters),this.mediaSessions.push(k),h.requireMatchingVersion&&k.capabilities["croc.sdkversion"]!==h.capabilities["croc.sdkversion"]&&(console.log("Remote client SDK version does not match"),f(),k.close())}else f()},b.prototype._updateIceServers=function(){var a=this.crocObject,b=a.iceServers;a.dynamicIceServers&&(b=a.dynamicIceServers.concat(b));for(var c=0,d=this.mediaSessions.length;d>c;c++)this.mediaSessions[c]._updateIceServers(b)},b.prototype._handleRefer=function(a){var b=a.data;if("remote"===b.originator){var c=b.session;if(!c)return b.refer.reject({status_code:403,reason_phrase:"Missing Target-Session Header"}),void 0;b.refer.refer_uri.scheme!==JsSIP.C.SIP&&b.refer.reject({status_code:416,reason_phrase:"Unsupported Refer URI Scheme"});for(var d=this.mediaSessions,e=null,f=0,g=d.length;g>f;f++)if(e=d[f],e.sipSession===c)return e._handleRefer(b.refer),void 0;b.refer.reject({status_code:481,reason_phrase:"Target Session Does Not Exist"})}},b.prototype.connect=function(b,c){var d=this.crocObject,e=d.capability,f=new JsSIP.RTCSession(d.sipUA),g=e.getWatchData(b);c||(c={});var h=c.constraints||null;g&&/Chrome/.test(navigator.userAgent)&&/Firefox/.test(g.userAgent)&&(h||(h={}),h.optional||(h.optional=[]),h.optional.push({DtlsSrtpKeyAgreement:!0}),console.log("Enabling DTLS for Firefox compatibility"));var i=new a.MediaSession(this,f,b,h);return i.customHeaders=new a.CustomHeaders(c.customHeaders),i.capabilities=g?g.capabilities:null,i.streamConfig=c.streamConfig||new a.StreamConfig,i._connect(),this.mediaSessions.push(i),i},b.prototype.close=function(){for(var a=0,b=this.mediaSessions.length;b>a;a++)this.mediaSessions[a].close()},a.MediaAPI=b}(CrocSDK),function(a){function b(b,c){var d,e,f=new a.Sdp.Session(b.sdp),g=["sendrecv","sendonly","recvonly","inactive"],h=!1;for(var i in f.media){var j=f.media[i],k=c[j.media];if("application"!==j.media)if(k){d=null;for(var l in g)j.attributes[g[l]]&&(d=g[l]);null===d&&(d="sendrecv",j.addAttribute(d,null),h=!0),e=k.send?k.receive?"sendrecv":"sendonly":k.receive?"recvonly":"inactive",d!==e&&(j.replaceAttribute(d,e,null),h=!0)}else j.port=0,h=!0}h&&(b.sdp=f.toString())}function c(a,b){var c=Date.now(),d=null,e=!1,f=function(){console.log("Proceeding without null candidate!",Date.now()-c),e=!0,d=null,b()},g=navigator.userAgent.match(/Chrome\/([0-9]*)/);g&&parseInt(g[1],10)<29&&(d=setTimeout(f,5e3)),a.onicecandidate=function(a){console.log("onicecandidate",Date.now()-c,a.candidate,this.iceGatheringState,this.iceConnectionState),d&&clearTimeout(d),a.candidate?d&&(d=setTimeout(f,5e3)):(this.onicecandidate=null,e||b())}}function d(b){var c=function(){b.remoteMediaReceived||(b.remoteMediaReceived=!0,setTimeout(function(){a.Util.fireEvent(b,"onRemoteMediaReceived",{})},0))},d=function(a){"live"===a.readyState?c():a.onunmute=c};b.peerConnection.onaddstream=function(a){if(!b.remoteMediaReceived){var c=a.stream,e=c.getAudioTracks(),f=c.getVideoTracks();e.length>0&&d(e[0]),f.length>0&&d(f[0])}}}function e(a){var b=function(){console.log("PC: signalling state change:",this.signalingState)};"onsignalingstatechange"in a&&(a.onsignalingstatechange=b),"onstatechange"in a&&(a.onstatechange=b);var c=function(){console.log("PC: ICE connection state change:",this.iceConnectionState)};"oniceconnectionstatechange"in a&&(a.oniceconnectionstatechange=c),"onicechange"in a&&(a.onicechange=c)}var f={PENDING:"pending",ESTABLISHED:"established",CLOSED:"closed"},g=function(b,c,g,h){var i=b.crocObject,j=i.iceServers;i.dynamicIceServers&&(j=i.dynamicIceServers.concat(j)),console.log("Using ICE servers:",j),this.mediaApi=b,this.sipSession=c,this.state=f.PENDING,this.peerConnection=new JsSIP.WebRTC.RTCPeerConnection({iceServers:j},h),this.videoConstraints=null,this.audioConstraints=null,this.localStream=null,this.oldLocalStream=null,this.screenStream=null,this.oldScreenStream=null,this.remoteMediaReceived=!1,this.accepted=!1,this.offerOutstanding=!1,this.remoteHold=!1,this.remoteHoldStreams=null,this.localHold=!1,this.localHoldStreams=null,this.dtmfSender=null,this.transferFeedback=null,this.address=g,this.displayName=null,this.customHeaders=null,this.capabilities=null,this.streamConfig=null,this.remoteAudioElement=null,this.remoteVideoElement=null,this.localVideoElement=null,d(this),e(this.peerConnection),this.peerConnection.onnegotiationneeded=this._handleNegotiationNeeded.bind(this);var k=this;c.on("progress",function(){a.Util.fireEvent(k,"onProvisional",{})}),c.on("started",this._handleStarted.bind(this)),c.on("ended",function(b){var c=b.data;if("local"!==c.originator){var d=a.Util.jsSipCauseToSdkStatus(c.cause);k.sipSession=null,k.close(d)}}),c.on("failed",function(b){var c=a.Util.jsSipCauseToSdkStatus(b.data.cause);k.sipSession=null,k.close(c),b.data.cause===JsSIP.C.causes.AUTHENTICATION_ERROR&&i.stop()}),c.on("reinvite",this._handleReinvite.bind(this)),c.on("refresh",this._handleRefresh.bind(this))};g.prototype._getUserMedia=function(b,c){var d=this,e=b||this.streamConfig,g={audio:!!e.audio&&e.audio.send,video:!!e.video&&e.video.send},h=!1,i=function(){var a=d.localStream;a&&(d.oldLocalStream=a,d.peerConnection.removeStream(a),d.localStream=null)},j=function(a){return d.state===f.CLOSED?(a.stop(),void 0):(console.log("Got local media stream"),i(),d.localStream=a,d.peerConnection.addStream(a),g.video&&d.localVideoElement&&(d.localVideoElement.src=window.URL.createObjectURL(a),d.localVideoElement.muted=!0),d._getScreenMedia(h,c),void 0)},k=function(a){console.warn("getUserMedia failed:",a),d.close()};g.audio&&(this.audioConstraints&&a.Util.isType(g.audio,"boolean")?g.audio=this.audioConstraints:a.Util.isType(g.audio,"object")&&(this.audioConstraints=g.audio)),g.video&&(this.videoConstraints&&a.Util.isType(g.video,"boolean")?g.video=this.videoConstraints:a.Util.isType(g.video,"object")&&(this.videoConstraints=g.video));var l=g.video;return l&&l.mandatory&&"screen"===l.mandatory.chromeMediaSource&&(g.video=!1,h=!0),g.audio||g.video?(console.log("Requesting user media:",g),JsSIP.WebRTC.getUserMedia(g,j,k),void 0):(i(),this._getScreenMedia(h,c),void 0)},g.prototype._getScreenMedia=function(a,b){var c=this,d={audio:!1,video:{mandatory:{chromeMediaSource:"screen"}}},e=function(){var a=c.screenStream;a&&(c.oldScreenStream=a,c.peerConnection.removeStream(a),c.screenStream=null)},g=function(a){return c.state===f.CLOSED?(a.stop(),void 0):(console.log("Got local screen stream"),c.screenStream=a,c.peerConnection.addStream(a),b&&b(),void 0)},h=function(a){console.warn("getUserMedia failed:",a),c.close()};a?this.screenStream&&!this.screenStream.ended&&(a=!1):e(),a?(console.log("Requesting user media:",d),JsSIP.WebRTC.getUserMedia(d,g,h)):b&&setTimeout(function(){b()},0)},g.prototype._createOffer=function(a,d){var e=this,f=this.peerConnection,g=a||this.streamConfig,h=function(){console.log("Local description set, ice gathering state:",f.iceGatheringState),"complete"===f.iceGatheringState?d():c(f,d)},i=function(a){console.warn("setLocalDescription failed:",a),e.close()},j=function(a){console.log("Offer created"),b(a,g),f.setLocalDescription(a,h,i)},k=function(a){console.warn("createOffer failed:",a),e.close()},l={mandatory:{OfferToReceiveAudio:!!g.audio&&g.audio.receive,OfferToReceiveVideo:!!g.video&&g.video.receive}};try{f.createOffer(j,k,l)}catch(m){console.warn("createOffer failed:",m.stack),e.close()}},g.prototype._createAnswer=function(a){var d=this,e=this.peerConnection,f=function(){console.log("Local description set, ice gathering state:",e.iceGatheringState),"complete"===e.iceGatheringState?a():c(e,a)},g=function(a){console.warn("setLocalDescription failed:",a),d.close()},h=function(a){console.log("Answer created"),b(a,d.streamConfig),e.setLocalDescription(a,f,g)},i=function(a){console.warn("createOffer failed:",a),d.close()},j=this.streamConfig,k={mandatory:{OfferToReceiveAudio:!!j.audio&&j.audio.receive,OfferToReceiveVideo:!!j.video&&j.video.receive}};e.createAnswer(h,i,k)},g.prototype._updateIceServers=function(a){this.peerConnection.updateIce({iceServers:a})},g.prototype._setRemoteStreamOutput=function(){var a,b,c,d,e=this.peerConnection;a=e.getRemoteStreams?e.getRemoteStreams():e.remoteStreams;for(var f=0,g=a.length;g>f;f++)b=a[f],c=b.getAudioTracks(),d=b.getVideoTracks(),d.length>0?this.remoteVideoElement?this.remoteVideoElement.src=window.URL.createObjectURL(b):console.warn("Video received, but no remoteVideoElement provided"):c.length>0&&(this.remoteAudioElement?this.remoteAudioElement.src=window.URL.createObjectURL(b):console.warn("Audio stream received, but no remoteAudioElement provided"))},g.prototype._connect=function(){var a=this;this._getUserMedia(null,function(){a._sendInvite()})},g.prototype._sendInvite=function(){var b=this,c=this.mediaApi.crocObject,d=c.capability;this._createOffer(null,function(){var e={};e.sdp=b.peerConnection.localDescription.sdp,e.extraHeaders=b.customHeaders.toExtraHeaders(),e.featureTags=d.createFeatureTags(c.capabilities),e.extraHeaders.push("Call-Info: <xmpp:"+c.address+"> ;purpose=impp"),b.sipSession.connect(b.address,e),a.Util.fireEvent(b,"onConnecting",{})})},g.prototype._sendReinvite=function(a,b){var c=this;b=b||this.customHeaders,this._createOffer(a,function(){c.sipSession.sendReinvite({sdp:c.peerConnection.localDescription.sdp,extraHeaders:b.toExtraHeaders()})})},g.prototype._handleNegotiationNeeded=function(){return this.state!==f.ESTABLISHED?(console.log("Ignoring negotiationneeded event - session not established"),void 0):this.offerOutstanding?(console.log("Ignoring negotiationneeded event - already due"),void 0):(console.log("Starting O/A negotiation at PC's request"),this._sendReinvite(),void 0)},g.prototype._handleInitialInvite=function(b,c,d,e){var f=new JsSIP.WebRTC.RTCSessionDescription({type:"offer",sdp:b});this.peerConnection.setRemoteDescription(f,d,e),this.streamConfig=new a.StreamConfig(c)},g.prototype._handleStarted=function(b){var c=b.data.response;if(this.state=f.ESTABLISHED,c){var d=this,e=function(){console.log("Remote answer set"),a.Util.fireEvent(d,"onConnect",{}),d._setRemoteStreamOutput()},g=function(a){console.warn("setRemoteDescription failed:",a),d.sipSession.terminate({status_code:488}),d.sipSession=null,d.close()},h=c.body;console.log("Setting remote description"),this.streamConfig=new a.StreamConfig(new a.Sdp.Session(h)),this.streamConfig.video&&this.screenStream&&(this.streamConfig.video.source="screen");var i=new JsSIP.WebRTC.RTCSessionDescription({type:"answer",sdp:h});this.peerConnection.setRemoteDescription(i,e,g)}},g.prototype._handleReinvite=function(b){var c,d,e=this,f=b.data;if("remote"===f.originator){this.offerOutstanding=!0;var g=f.sdp,h=new a.Sdp.Session(g),i=!1,j=!1;h||f.reinvite.sdpInvalid();var k=new a.StreamConfig(h),l=new a.CustomHeaders(f.request);if(this.remoteHold&&k.isSending()){var m=this.remoteHoldStreams,n=k.getSendingStreams();for(c=0,d=n.length;d>c;c++)-1===m.indexOf(n[c])&&(console.warn("Remote UA tried to activate additional stream during resume:",n[c]),f.reinvite.sdpInvalid())}else k.equals(this.streamConfig)||(console.log("re-INVITE changing stream configuration"),i=!0),l.equals(this.customHeaders)||(console.log("re-INVITE changing custom headers"),j=!0);var o=new JsSIP.WebRTC.RTCSessionDescription({type:"offer",sdp:g}),p=function(){var b=e.streamConfig;console.log("Remote offer set"),f.reinvite.sdpValid();var c=function(c){e.streamConfig=c?new a.StreamConfig(c):k,e.customHeaders=l;var d=function(){e._createAnswer(function(){f.reinvite.accept({sdp:e.peerConnection.localDescription.sdp}),e._setRemoteStreamOutput()})};e.remoteHold||e.streamConfig.sendingStreamsEqual(b)?d():e._getUserMedia(null,d)};if(b.isSending()&&!k.isSending())e.remoteHold=!0,e.remoteHoldStreams=b.getSendingStreams(),c(),a.Util.fireEvent(e,"onHold",{});else if(e.remoteHold&&k.isSending())c(),e.remoteHold=!1,a.Util.fireEvent(e,"onResume",{});else{var d=function(){f.reinvite.reject({status_code:488})},g=!0;(j||!b.isSafeChange(k))&&(g=!1),a.Util.fireEvent(e,"onRenegotiateRequest",{streamConfig:i?k:null,customHeaders:j?l:null,safe:g,accept:c,reject:d},!0)}},q=function(a){console.warn("setRemoteDescription failed:",a),f.reinvite.sdpInvalid()};this.peerConnection.setRemoteDescription(o,p,q)}else f.reinvite.on("succeeded",function(b){var c=function(){console.log("Remote answer set"),e._setRemoteStreamOutput()},d=function(a){console.warn("setRemoteDescription failed:",a),e.sipSession.terminate({status_code:488}),e.sipSession=null,e.close()},g=b.data.sdp;console.log("Setting remote description"),e.streamConfig=new a.StreamConfig(new a.Sdp.Session(g)),e.customHeaders=new a.CustomHeaders(f.request);var h=new JsSIP.WebRTC.RTCSessionDescription({type:"answer",sdp:g});e.peerConnection.setRemoteDescription(h,c,d),a.Util.fireEvent(e,"onRenegotiateResponse",{accepted:!0})}),f.reinvite.on("failed",function(b){console.log("Reinvite failed, closing session",b.data),a.Util.fireEvent(e,"onRenegotiateResponse",{accepted:!1}),e.close()});f.reinvite.on("completed",function(){e.offerOutstanding=!1,e.oldLocalStream&&(e.oldLocalStream.stop(),e.oldLocalStream=null),e.oldScreenStream&&(e.oldScreenStream.stop(),e.oldScreenStream=null),a.Util.fireEvent(e,"onRenegotiateComplete",{})})},g.prototype._handleRefresh=function(){this.sipSession.isMethodAllowed(JsSIP.C.UPDATE,!1)?this.sipSession.sendUpdate():this._sendReinvite()},g.prototype._handleRefer=function(b){var c=new i(this,b);a.Util.fireEvent(this,"onTransferRequest",c,!0)},g.prototype.accept=function(b){var c=this;if(b&&(this.streamConfig=b instanceof a.StreamConfig?b:new a.StreamConfig(b)),this.state!==f.PENDING)throw new a.Exceptions.StateError("Session cannot be accepted in state",this.state);if("incoming"!==this.sipSession.direction)throw new a.Exceptions.StateError("Cannot call accept() on outgoing sessions");this._getUserMedia(null,function(){c._createAnswer(function(){c.state===f.PENDING&&(c.sipSession.answer({sdp:c.peerConnection.localDescription.sdp}),a.Util.fireEvent(c,"onConnect",{}))})}),this._setRemoteStreamOutput()},g.prototype.hold=function(){if(!this.localHold){if(this.offerOutstanding)throw new a.Exceptions.StateError("Existing renegotiation still in progress");this.localHold=!0,this.offerOutstanding=!0;var b,c=this.localStream.getVideoTracks(),d=this.localStream.getAudioTracks();b=this.screenStream?this.screenStream.getVideoTracks():[];for(var e=c.concat(d,b),f=0,g=e.length;g>f;f++)e[f].enabled=!1;var h=new a.StreamConfig(this.streamConfig);this.localHoldStreams=h.hold(),this._sendReinvite(h)}},g.prototype.resume=function(){if(this.localHold){if(this.offerOutstanding)throw new a.Exceptions.StateError("Existing renegotiation still in progress");this.offerOutstanding=!0;var b=new a.StreamConfig(this.streamConfig);b.resume(this.localHoldStreams),this._sendReinvite(b);var c,d=this.localStream.getVideoTracks(),e=this.localStream.getAudioTracks();c=this.screenStream?this.screenStream.getVideoTracks():[];for(var f=d.concat(e,c),g=0,h=f.length;h>g;g++)f[g].enabled=!0;this.localHold=!1}},g.prototype.renegotiate=function(b){b||(b={});var c=b.streamConfig,d=b.customHeaders;if(c&&(c=new a.StreamConfig(c)),d&&(d=new a.CustomHeaders(d)),(this.localHold||this.remoteHold)&&c)throw new a.Exceptions.StateError("Cannot modify streams whilst on hold");if(this.offerOutstanding)throw new a.Exceptions.StateError("Existing renegotiation still in progress");if(this.offerOutstanding=!0,c&&!c.sendingStreamsEqual(this.streamConfig)){var e=this;this._getUserMedia(c,function(){e._sendReinvite(c,d)})}else this._sendReinvite(c,d)},g.prototype.mute=function(){for(var a=this.localStream.getAudioTracks(),b=0,c=a.length;c>b;b++)a[b].enabled=!1},g.prototype.unmute=function(){if(this.localHold)throw new a.Exceptions.StateError("Cannot unmute a held call");for(var b=this.localStream.getAudioTracks(),c=0,d=b.length;d>c;c++)b[c].enabled=!0},g.prototype.sendDTMF=function(b,c){c=c||{};var d=c.type||"pc",e=c.duration||200,f=c.interToneGap||"info"===d?500:50,g=this;if(b=b.toString().toUpperCase(),/[^0-9A-D\*#,]/.test(b))throw new a.Exceptions.ValueError("Invalid characters in DTMF tones:",b);switch(e=Math.max(e,70),e=Math.min(e,6e3),f=Math.max(f,50),d){default:case"pc":var h=this.dtmfSender;if(h)return h.insertDTMF(h.toneBuffer+b,h.duration,h.interToneGap),void 0;var i=this.localStream.getAudioTracks();if(i.length<1)throw new a.Exceptions.ValueError("Cannot send DTMF without an audio track");h=this.peerConnection.createDTMFSender(i[0]),h.insertDTMF(b,e,f),h.ontonechange=function(a){a.tone||(g.dtmfSender=null)},this.dtmfSender=h;break;case"info":this.sipSession.sendDTMF(b,{duration:e,interToneGap:f})}},g.prototype.transfer=function(b){if(this.state!==f.ESTABLISHED)throw new a.Exceptions.StateError("Media session not established: "+this.state);if(this.transferFeedback)throw new a.Exceptions.StateError("Previous transfer outstanding");var c=new h(this),d={};d.eventHandlers=c._getJsSipHandlers();try{this.sipSession.sendRefer(b,d)}catch(e){if(e instanceof JsSIP.Exceptions.RemoteSupportError)throw new a.Exceptions.UnsupportedError("Remote party does not support transfers")}return this.transferFeedback=c,c},g.prototype.close=function(b){if(this.state!==f.CLOSED){var c=this.state;if(this.state=f.CLOSED,b||(b="normal"),this.peerConnection&&this.peerConnection.close(),this.screenStream&&this.screenStream.stop(),this.localStream&&this.localStream.stop(),this.sipSession){var d=null;if(c===f.PENDING&&"incoming"===this.sipSession.direction){var e=a.Util.sdkStatusToSipStatus("invite",b);d={status_code:e}}try{this.sipSession.terminate(d)}catch(g){console.error("Error terminating SIP session:\n",g.stack)}}var h=this.mediaApi.mediaSessions;h.splice(h.indexOf(this),1),a.Util.fireEvent(this,"onClose",{status:b})}},g.prototype.onConnecting=function(){},g.prototype.onProvisional=function(){},g.prototype.onConnect=function(){},g.prototype.onRemoteMediaReceived=function(){},g.prototype.onRenegotiateRequest=function(a){return a.safe?(console.log("Auto-accepting re-INVITE (no significant changes)"),a.accept(),void 0):(console.log("Auto-rejecting re-INVITE (significant changes)"),a.reject(),void 0)},g.prototype.onTransferRequest=function(a){a.reject()},g.prototype.onClose=function(){};var h=function(a){this.session=a};h.prototype.onAccepted=function(){this.session.close()},h.prototype.onRejected=function(){this.session.close()},h.prototype._getJsSipHandlers=function(){var b=this;return{accepted:function(){a.Util.fireEvent(b,"onAccepted",{},!0)},failed:function(){b.session.transferFeedback=null,a.Util.fireEvent(b,"onRejected",{},!0)},notify:function(c){var d=c.data;if(d.finalNotify)switch(b.session.transferFeedback=null,d.sessionEvent){case"started":a.Util.fireEvent(b,"onTransferSucceeded",{});break;case"failed":a.Util.fireEvent(b,"onTransferFailed",{});break;default:a.Util.fireEvent(b,"onTransferResultUnknown",{})}}}};var i=function(a,b){var c=this;this.session=a,this.refer=b,this.timer=setTimeout(function(){c.reject(),c.timer=null},1e3*a.mediaApi.acceptTimeout),this.address=b.refer_uri.toString().replace(/^sip:/,"")};i.prototype.accept=function(a){if(null!==this.timer){clearTimeout(this.timer),this.timer=null,a=a||{},a.streamConfig||(a.streamConfig=this.session.streamConfig);var b=this.session.mediaApi.connect(this.address,a);return this.refer.addSessionNotifyHandlers(b.sipSession),b}},i.prototype.reject=function(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null,this.refer.reject({status_code:603}))},a.MediaSession=g}(CrocSDK),function(a){function b(b){var c=b.msrpConnections.length;if(1>c)throw new a.Exceptions.StateError("MSRP relays not configured");var d=b.nextMsrpConnection++;return b.nextMsrpConnection>=c&&(b.nextMsrpConnection=0),b.msrpConnections[d]}function c(b,c){c.onAuthFailed=function(){console.warn("MSRP authentication failed - closing session"),b.msrpSession=null,b.close()},c.onError=function(){console.warn("MSRP error occurred - closing session"),b.msrpSession=null,b.close()},c.onChunkSent=function(c,d){var e=b.sendTransferProgress[c];if(e){var f=null;e.size&&(f=Math.floor(100*d/e.size)),a.Util.fireEvent(e,"onProgress",{bytesComplete:d,percentComplete:f})}b.lastActivity=Date.now()},c.onMessageDelivered=function(c){var d=b.sendTransferProgress[c];d&&a.Util.fireEvent(d,"onSuccess",{data:null}),delete b.sendTransferProgress[c]
},c.onMessageSendFailed=function(c,d,e){var f=b.sendTransferProgress[c];f&&a.Util.fireEvent(f,"onFailure",{partialData:null}),delete b.sendTransferProgress[c],console.log("MSRP send failed: status=",d,"comment=",e)},c.onFirstChunkReceived=function(c,d,f,g,h){var i=new e(b,c,!1,d,g,f,h);b.recvTransferProgress[c]=i,a.Util.fireEvent(b,"onDataStart",{transferProgress:i},!0)},c.onChunkReceived=function(c,d){var e=b.recvTransferProgress[c];if(e){var f=null;e.size&&(f=Math.floor(100*d/e.size)),a.Util.fireEvent(e,"onProgress",{bytesComplete:d,percentComplete:f})}b.lastActivity=Date.now()},c.onMessageReceived=function(c,d,e){var f=b.recvTransferProgress[c];f&&a.Util.fireEvent(f,"onSuccess",{data:e});var g=a.C.states.sdkComposing.IDLE;if(b.remoteActiveTimeoutId&&(clearTimeout(b.remoteActiveTimeoutId),b.remoteActiveTimeoutId=null,g=a.C.states.sdkComposing.COMPOSING),d===a.C.MT.IS_COMPOSING&&b.hasOwnProperty("onComposingStateChange")){var h=new DOMParser,i=h.parseFromString(e,d),j=i.getElementsByTagName("state")[0].firstChild.data,k=a.Util.rfc3994StateToSdkState(j);if(k===a.C.states.sdkComposing.COMPOSING){var l=120,m=i.getElementsByTagName("refresh")[0];m&&(l=parseInt(m.firstChild.data,10),l=1.1*l),b.remoteActiveTimeoutId=setTimeout(function(){a.Util.fireEvent(b,"onComposingStateChange",{state:a.C.states.sdkComposing.IDLE})},1e3*l)}k!==g&&a.Util.fireEvent(b,"onComposingStateChange",{state:k})}else d===a.C.MT.XHTML&&b.hasOwnProperty("onXHTMLReceived")||b.dataApi.hasOwnProperty("onXHTMLReceived")?a.Util.fireEvent(b,"onXHTMLReceived",{address:b.address,body:a.Util.extractXHTMLBody(e)},!0):a.Util.fireEvent(b,"onData",{address:b.address,contentType:d,data:e},!0);delete b.recvTransferProgress[c]},c.onMessageReceiveAborted=function(c,d){var e=b.recvTransferProgress[c];e&&a.Util.fireEvent(e,"onFailure",{partialData:d}),delete b.recvTransferProgress[c]},c.onMessageReceiveTimeout=function(c,d){var e=b.recvTransferProgress[c];e&&a.Util.fireEvent(e,"onFailure",{partialData:d}),delete b.recvTransferProgress[c]}}function d(b,c,d,f,g,h){var i=b.capability,j=c.msrpSession.processSdpAnswer(d.body);if(j){c.state=a.C.states.dataSession.ESTABLISHED,c.lastActivity=Date.now();var k=d.parseHeader("contact",0);if(c.capabilities=i.parseFeatureTags(k.parameters),f.fileTransfer||(j=c.msrpSession.send(g,h)),f.onSuccess||f.onFailure||f.onProgress){var l=null,m=null;f.fileTransfer&&(l=f.fileTransfer.name,m=f.fileTransfer.description);var n=c.msrpSession.chunkSenders[j],o=new e(c,j,!0,h,n.size,l,m);f.onSuccess&&(o.onSuccess=f.onSuccess),f.onFailure&&(o.onFailure=f.onFailure),f.onProgress&&(o.onProgress=f.onProgress),c.sendTransferProgress[j]=o}}else c.sipSession.terminate({status_code:488}),c.sipSession=null,f.constructor=e,a.Util.fireEvent(f,"onFailure",{partialData:null}),c.close()}function e(a,b,c,d,e,f,g){this.msgId=b,this.outbound=c,this.session=a,this.contentType=d,this.size=e,this.filename=f,this.description=g}function f(){}e.prototype.abort=function(){this.outbound?this.session.msrpSession.abortSend(this.msgId):this.session.msrpSession.abortReceive(this.msgId)},e.prototype.onSuccess=function(){},e.prototype.onFailure=function(){},e.prototype.onProgress=function(){},f.prototype.init=function(b,c){var d=this;this.dataApi=b,this.uri=c,this.sipSession=null,this.msrpSession=null,this.state=a.C.states.dataSession.PENDING,this.lastActivity=Date.now(),this.sendTransferProgress={},this.recvTransferProgress={},this.localActiveRefreshIntervalId=null,this.localActiveTimeoutId=null,this.remoteActiveTimeoutId=null,this.idleXml=a.Util.createIsComposingXml(a.C.states.rfcComposing.IDLE),this.isComposingSendConfig={contentType:a.C.MT.IS_COMPOSING},this.localActiveTimeout=function(){clearInterval(d.localActiveRefreshIntervalId),d.localActiveRefreshIntervalId=null,d.localActiveTimeoutId=null,d.send(d.idleXml,d.isComposingSendConfig)},this.address=c.toAor().replace(/^sip:/,""),this.displayName=null,this.customHeaders=null,this.capabilities=null,this.type="msrp"},f.prototype._isIdle=function(a){return this.lastActivity<a},f.prototype.send=function(b,c){var d=null,f=null,g=null;if(this.state!==a.C.states.dataSession.ESTABLISHED)throw new a.Exceptions.StateError("Cannot call send() in current state: "+this.state);c&&(a.Util.checkSendConfig(c),d=c.contentType,c.fileTransfer&&(f=c.fileTransfer.name,g=c.fileTransfer.description));var h=this.msrpSession.send(b,d);if(this.lastActivity=Date.now(),this.localActiveRefreshIntervalId&&(clearInterval(this.localActiveRefreshIntervalId),this.localActiveRefreshIntervalId=null),this.localActiveTimeoutId&&(clearTimeout(this.localActiveTimeoutId),this.localActiveTimeoutId=null),c.onSuccess||c.onFailure||c.onProgress){var i=this.msrpSession.chunkSenders[h],j=new e(this,h,!0,i.contentType,i.size,f,g);c.onSuccess&&(j.onSuccess=c.onSuccess),c.onFailure&&(j.onFailure=c.onFailure),c.onProgress&&(j.onProgress=c.onProgress),this.sendTransferProgress[h]=j}},f.prototype.sendXHTML=function(b,c){c=c||{},c.contentType=a.C.MT.XHTML;var d=a.Util.createValidXHTMLDoc(b);this.send(d,c)},f.prototype.setComposingState=function(b){var c=this;if(b=b||a.C.states.sdkComposing.COMPOSING,this.localActiveTimeoutId&&(clearTimeout(this.localActiveTimeoutId),b===a.C.states.sdkComposing.IDLE&&this.send(this.idleXml,this.isComposingSendConfig)),b===a.C.states.sdkComposing.COMPOSING){if(!this.localActiveRefreshIntervalId){var d=this.dataApi.idleTimeout/2,e=a.Util.createIsComposingXml(b,d);this.send(e,this.isComposingSendConfig),this.localActiveRefreshIntervalId=setInterval(function(){c.send(e,c.isComposingSendConfig)},1e3*d)}this.localActiveTimeoutId=setTimeout(this.localActiveTimeout,1e3*a.C.COMPOSING_TIMEOUT)}},f.prototype.accept=function(){throw new a.Exceptions.StateError("Cannot call accept() on outgoing sessions")},f.prototype.close=function(b){if(this.state!==a.C.states.dataSession.CLOSED){var c=this.state;if(this.state=a.C.states.dataSession.CLOSED,b||(b="normal"),this.msrpSession)try{this.msrpSession.close()}catch(d){console.error("Error closing MSRP session:\n",d.stack)}if(this.sipSession){var e=null;if(c===a.C.states.dataSession.PENDING&&"incoming"===this.sipSession.direction){var f=a.Util.sdkStatusToSipStatus("invite",b);e={status_code:f}}try{this.sipSession.terminate(e)}catch(d){console.error("Error terminating SIP session:\n",d.stack)}}this.localActiveRefreshIntervalId&&(clearInterval(this.localActiveRefreshIntervalId),this.localActiveRefreshIntervalId=null),this.localActiveTimeoutId&&(clearTimeout(this.localActiveTimeoutId),this.localActiveTimeoutId=null),this.remoteActiveTimeoutId&&(clearTimeout(this.remoteActiveTimeoutId),this.remoteActiveTimeoutId=null),a.Util.fireEvent(this,"onClose",{status:b})}},f.prototype.getState=function(){return this.state},f.prototype.onData=function(a){this.dataApi.onData(a)},f.prototype.onXHTMLReceived=function(a){this.dataApi.onXHTMLReceived(a)},f.prototype.onDataStart=function(){},f.prototype.onClose=function(){},a.OutgoingMsrpSession=function(f,g,h,i){var j=b(f),k={},l=i.contentType||h.type,m=this,n=f.crocObject,o=n.capability;if(this.init(f,g),this.customHeaders=i.customHeaders instanceof a.CustomHeaders?i.customHeaders:new a.CustomHeaders(i.customHeaders),this.capabilities=o.getCapabilities(g),l||(l=a.Util.isType(h,"string")?"text/plain":"application/octet-stream"),k.onAuthenticated=function(){var b={started:function(a){d(n,m,a.data.response,i,h,l)},ended:function(b){var c=b.data;if("local"!==c.originator){var d=a.Util.jsSipCauseToSdkStatus(c.cause);m.sipSession=null,m.close(d)}},failed:function(b){var c=a.Util.jsSipCauseToSdkStatus(b.data.cause);m.sipSession=null,i.constructor=e,a.Util.fireEvent(i,"onFailure",{partialData:null}),m.close(c),b.data.cause===JsSIP.C.causes.AUTHENTICATION_ERROR&&n.stop()}},c={eventHandlers:b,extraHeaders:m.customHeaders.toExtraHeaders(),featureTags:o.createFeatureTags(n.capabilities),sdp:m.msrpSession.getSdpOffer()};m.sipSession=new JsSIP.RTCSession(n.sipUA),m.sipSession.connect(g,c)},c(m,k),i.fileTransfer){var p=new CrocMSRP.FileParams;p.selector.name=i.fileTransfer.name,p.selector.type=l,p.selector.size=i.fileTransfer.size,p.description=i.fileTransfer.description,this.msrpSession=j.createFileTransferSession(k,h,p)}else this.msrpSession=j.createSession(k)},a.OutgoingMsrpSession.prototype=new f,a.OutgoingMsrpSession.prototype.contructor=a.OutgoingMsrpSession,a.IncomingMsrpSession=function(d,e,f){var g=b(d),h={},i=this,j=d.crocObject.capability;this.init(d,e.remote_identity.uri),this.sipSession=e,this.displayName=e.remote_identity.display_name,this.customHeaders=new a.CustomHeaders(f);var k=f.parseHeader("contact",0);this.capabilities=j.parseFeatureTags(k.parameters),this.accepted=!1,h.onAuthenticated=function(){var b=i.msrpSession.getSdpAnswer(f.body);b?i.accepted?(i.state=a.C.states.dataSession.ESTABLISHED,i.sipSession.answer({sdp:b})):i.accept=function(){this.state=a.C.states.dataSession.ESTABLISHED,this.sipSession.answer({sdp:b}),delete this.accept}:i.close()},c(i,h),this.msrpSession=g.createSession(h),e.on("ended",function(b){var c=b.data;if("local"!==c.originator){var d=a.Util.jsSipCauseToSdkStatus(c.cause);i.sipSession=null,i.close(d)}}),e.on("failed",function(b){var c=a.Util.jsSipCauseToSdkStatus(b.data.cause);i.sipSession=null,i.close(c)})},a.IncomingMsrpSession.prototype=new f,a.IncomingMsrpSession.prototype.contructor=a.IncomingMsrpSession,a.IncomingMsrpSession.prototype.accept=function(){if(this.state!==a.C.states.dataSession.PENDING)throw new a.Exceptions.StateError("Session has already been accepted");this.accepted=!0}}(CrocSDK),function(a){function b(a){return new Date(1e3*(parseInt(a,10)-f))}function c(a){return parseInt(a.getTime()/1e3,10)+f}function d(a){return a.replace(/%00/g,"\0").replace(/%0A/gi,"\n").replace(/%0D/gi,"\r").replace(/%22/g,'"').replace(/%25/g,"%")}var e="\r\n",f=2208988800;a.Sdp={},a.Sdp.Session=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Session.prototype.reset=function(){this.version=0,this.origin=new a.Sdp.Origin,this.sessionName=" ",this.sessionInfo=null,this.uri=null,this.email=null,this.phone=null,this.connection=new a.Sdp.Connection,this.bandwidth=[],this.timing=[new a.Sdp.Timing],this.timezone=null,this.key=null,this.resetAttributes(),this.media=[]},a.Sdp.Session.prototype.addAttribute=function(a,b){this.attributes[a]||(this.attributes[a]=[],this.attributeNameOrder.push(a)),this.attributes[a].push(b)},a.Sdp.Session.prototype.removeAttribute=function(a){this.attributes[a]&&(delete this.attributes[a],this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(a),1))},a.Sdp.Session.prototype.replaceAttribute=function(a,b,c){this.attributes[a]&&(delete this.attributes[a],this.addAttribute(b,c),this.attributeNameOrder.splice(this.attributeNameOrder.lastIndexOf(b),1),this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(a),1,b))},a.Sdp.Session.prototype.resetAttributes=function(){this.attributeNameOrder=[],this.attributes={}},a.Sdp.Session.prototype.parse=function(b){var c,d,f,g,h=b.split(e);if(this.reset(),""===h[h.length-1]&&h.pop(),h.length<4)return console.log("Unexpected SDP length: "+h.length),!1;if(c=h.shift(),"v=0"!==c)return console.log("Unexpected SDP version: "+c),!1;if(c=h.shift(),"o="!==c.substr(0,2)||!(this.origin=new a.Sdp.Origin(c.substr(2))))return console.log("Unexpected SDP origin: "+c),!1;if(c=h.shift(),"s="!==c.substr(0,2))return console.log("Unexpected SDP session name: "+c),!1;for(this.sessionName=c.substr(2);h.length>0&&"t"!==h[0].charAt(0);)switch(c=h.shift(),d=c.substr(2),c.substr(0,2)){case"i=":this.sessionInfo=d;break;case"u=":this.uri=d;break;case"e=":this.email=d;break;case"p=":this.phone=d;break;case"c=":if(d=new a.Sdp.Connection(d),!d)return!1;this.connection=d;break;case"b=":this.bandwidth.push(d);break;default:return console.log("Unexpected SDP line (pre-timing): "+c),!1}if(0===h.length)return console.log("Unexpected end of SDP (pre-timing)"),!1;for(this.timing=[];h.length>0&&"t"===h[0].charAt(0);){for(c=h.shift().substr(2);h.length>0&&"r"===h[0].charAt(0);)c+=e+h.shift();if(d=new a.Sdp.Timing(c),!d)return!1;this.timing.push(d)}if(0===this.timing.length)return console.log("No timing line found"),!1;for(;h.length>0&&"m"!==h[0].charAt(0);)switch(c=h.shift(),d=c.substr(2),c.substr(0,2)){case"z=":this.timezone=d;break;case"k=":this.key=d;break;case"a=":f=d.indexOf(":"),-1===f?(g=d,d=null):(g=d.substr(0,f),d=d.substr(f+1)),this.addAttribute(g,d);break;default:return console.log("Unexpected SDP line (pre-media): "+c),!1}for(;h.length>0&&"m"===h[0].charAt(0);){for(c=h.shift().substr(2);h.length>0&&"m"!==h[0].charAt(0);)c+=e+h.shift();if(d=new a.Sdp.Media(c),!d)return!1;this.media.push(d)}return!0},a.Sdp.Session.prototype.toString=function(){var a,b,c,d="";d+="v="+this.version+e,d+="o="+this.origin+e,d+="s="+this.sessionName+e,this.sessionInfo&&(d+="i="+this.sessionInfo+e),this.uri&&(d+="u="+this.uri+e),this.email&&(d+="e="+this.email+e),this.phone&&(d+="p="+this.phone+e),this.connection&&(d+="c="+this.connection+e);for(a in this.bandwidth)d+="b="+this.bandwidth[a]+e;for(a in this.timing)d+="t="+this.timing[a]+e;this.timezone&&(d+="z="+this.timezone+e),this.key&&(d+="k="+this.key+e);for(var f=0,g=this.attributeNameOrder.length;g>f;f++){b=this.attributeNameOrder[f],c=this.attributes[b];for(a in c)d+="a="+b,c[a]&&(d+=":"+c[a]),d+=e}for(a in this.media)d+="m="+this.media[a]+e;return d},a.Sdp.Session.prototype.isHeld=function(){var a,b,c;for(a=0,b=this.media.length;b>a;a++)switch(c=this.media[a],c.media){case"audio":case"video":if(c.isReceiving())return!1}return!0},a.Sdp.Origin=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Origin.prototype.reset=function(){this.username="-",this.id=c(new Date),this.version=this.sessId,this.netType="IN",this.addrType="IP4",this.address="address.invalid"},a.Sdp.Origin.prototype.parse=function(a){var b;return b=a.split(" "),6!==b.length?(console.log("Unexpected origin line: "+a),!1):(this.username=b[0],this.id=b[1],this.version=b[2],this.netType=b[3],this.addrType=b[4],this.address=b[5],!0)},a.Sdp.Origin.prototype.toString=function(){var a="";return a+=this.username+" ",a+=this.id+" ",a+=this.version+" ",a+=this.netType+" ",a+=this.addrType+" ",a+=this.address},a.Sdp.Connection=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Connection.prototype.reset=function(){this.netType="IN",this.addrType="IP4",this.address="address.invalid"},a.Sdp.Connection.prototype.parse=function(a){var b;return b=a.split(" "),3!==b.length?(console.log("Unexpected connection line: "+a),!1):(this.netType=b[0],this.addrType=b[1],this.address=b[2],!0)},a.Sdp.Connection.prototype.toString=function(){var a="";return a+=this.netType+" ",a+=this.addrType+" ",a+=this.address},a.Sdp.Timing=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Timing.prototype.reset=function(){this.start=null,this.stop=null,this.repeat=[]},a.Sdp.Timing.prototype.parse=function(a){var c,d,f;return c=a.split(e),d=c.shift(),f=d.split(" "),2!==f.length?(console.log("Unexpected timing line: "+d),!1):(this.start="0"===f[0]?null:b(f[0]),this.stop="0"===f[1]?null:b(f[1]),this.repeat=c,!0)},a.Sdp.Timing.prototype.toString=function(){var a,b="";b+=this.start?c(this.start):"0",b+=" ",b+=this.stop?c(this.stop):"0";for(a in this.repeat)b+=e+this.repeat[a];return b},a.Sdp.Media=function(a){if(a){if(!this.parse(a))return null}else this.reset()},a.Sdp.Media.prototype.reset=function(){this.media="message",this.port=2855,this.proto="TCP/MSRP",this.format="*",this.title=null,this.connection=null,this.bandwidth=[],this.key=null,this.resetAttributes()},a.Sdp.Media.prototype.addAttribute=function(a,b){this.attributes[a]||(this.attributes[a]=[],this.attributeNameOrder.push(a)),this.attributes[a].push(b)},a.Sdp.Media.prototype.removeAttribute=function(a){this.attributes[a]&&(delete this.attributes[a],this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(a),1))},a.Sdp.Media.prototype.resetAttributes=function(){this.attributeNameOrder=[],this.attributes={}},a.Sdp.Media.prototype.replaceAttribute=function(a,b,c){this.attributes[a]&&(delete this.attributes[a],this.addAttribute(b,c),this.attributeNameOrder.splice(this.attributeNameOrder.lastIndexOf(b),1),this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(a),1,b))},a.Sdp.Media.prototype.parse=function(b){var c,d,f,g,h;if(this.reset(),c=b.split(e),d=c.shift(),f=d.split(" "),f.length<4)return console.log("Unexpected media line: "+d),!1;this.media=f.shift(),this.port=parseInt(f.shift(),10),this.proto=f.shift(),this.format=f.join(" ");for(g in c){var i,j=c[g].substr(2);switch(c[g].substr(0,2)){case"i=":this.title=j;break;case"c=":if(this.connection=new a.Sdp.Connection(j),!this.connection)return!1;break;case"b=":this.bandwidth.push(j);break;case"k=":this.key=j;break;case"a=":i=j.indexOf(":"),-1===i?(h=j,j=null):(h=j.substr(0,i),j=j.substr(i+1)),this.addAttribute(h,j);break;default:return console.log("Unexpected type (within media): "+c[g]),!1}}return!0},a.Sdp.Media.prototype.toString=function(){var a,b,c,d="";d+=this.media+" ",d+=this.port+" ",d+=this.proto+" ",d+=this.format,this.title&&(d+=e+"i="+this.title),this.connection&&(d+=e+"c="+this.connection);for(a in this.bandwidth)d+=e+"b="+this.bandwidth[a];this.key&&(d+=e+"k="+this.key);for(var f=0,g=this.attributeNameOrder.length;g>f;f++){b=this.attributeNameOrder[f],c=this.attributes[b];for(a in c)d+=e+"a="+b,c[a]&&(d+=":"+c[a])}return d},a.Sdp.Media.prototype.parseFileAttributes=function(){var a,b,c,e,f={},g=0,h={};if(!this.attributes["file-selector"])return null;for(var i=this.attributes["file-selector"][0];g<i.length;)if(" "!==i.charAt(g)){if(a=i.indexOf(":",g),-1===a)break;if(b=i.slice(g,a),g=a+1,'"'===i.charAt(g)){if(g++,e=i.indexOf('"',g),-1===e)break;c=i.slice(g,e),g=e+1}else if("type"===b){var j=!1;for(e=g;e<i.length&&(j||" "!==i.charAt(e));)'"'===i.charAt(e)&&(j=!j),e++;c=i.slice(g,e),g=e+1}else e=i.indexOf(" ",g),-1===e&&(e=i.length),c=i.slice(g,e),g=e+1;switch(b){case"name":h.name=d(c);break;case"size":h.size=parseInt(c,10);break;case"type":h.type=c;break;case"hash":h.hash||(h.hash={}),a=c.indexOf(":"),h.hash[c.substring(0,a)]=c.substring(a+1);break;default:continue}}else g++;return f.selector=h,f.id=this.attributes["file-transfer-id"][0],f.disposition=this.attributes["file-disposition"][0]||"render",this.title&&(f.description=this.title),this.attributes["file-icon"]&&(f.icon=this.attributes["file-icon"][0]),f},a.Sdp.Media.prototype.isSending=function(){return this.attributes.recvonly||this.attributes.inactive?!1:!0},a.Sdp.Media.prototype.isReceiving=function(){return this.attributes.sendonly||this.attributes.inactive?!1:!0}}(CrocSDK),function(a){a.SipDataSession=function(b,c){var d=this;this.dataApi=b,this.state=a.C.states.dataSession.ESTABLISHED,this.lastActivity=Date.now(),this.localActiveRefreshIntervalId=null,this.localActiveTimeoutId=null,this.remoteActiveTimeoutId=null,this.idleXml=a.Util.createIsComposingXml(a.C.states.rfcComposing.IDLE),this.isComposingSendConfig={contentType:a.C.MT.IS_COMPOSING},this.localActiveTimeout=function(){clearInterval(d.localActiveRefreshIntervalId),d.localActiveRefreshIntervalId=null,d.localActiveTimeoutId=null,d.send(d.idleXml,d.isComposingSendConfig)},this.address=c,this.capabilities=null,this.customHeaders=null,this.displayName=null},a.SipDataSession.prototype._receiveMessage=function(b,c,d){var e=a.C.states.sdkComposing.IDLE;if(this.remoteActiveTimeoutId&&(clearTimeout(this.remoteActiveTimeoutId),this.remoteActiveTimeoutId=null,e=a.C.states.sdkComposing.COMPOSING),c===a.C.MT.IS_COMPOSING&&this.hasOwnProperty("onComposingStateChange")){var f=new DOMParser,g=f.parseFromString(d,c),h=g.getElementsByTagName("state")[0].firstChild.data,i=a.Util.rfc3994StateToSdkState(h);if(i===a.C.states.sdkComposing.COMPOSING){var j=120,k=g.getElementsByTagName("refresh")[0];k&&(j=parseInt(k.firstChild.data,10),j=1.1*j);var l=this;this.remoteActiveTimeoutId=setTimeout(function(){a.Util.fireEvent(l,"onComposingStateChange",{state:a.C.states.sdkComposing.IDLE})},1e3*j)}i!==e&&a.Util.fireEvent(this,"onComposingStateChange",{state:i})}else c===a.C.MT.XHTML&&(this.hasOwnProperty("onXHTMLReceived")||this.dataApi.hasOwnProperty("onXHTMLReceived"))?a.Util.fireEvent(this,"onXHTMLReceived",{address:b,body:a.Util.extractXHTMLBody(d)},!0):a.Util.fireEvent(this,"onData",{address:b,contentType:c,data:d},!0);this.lastActivity=Date.now()},a.SipDataSession.prototype._isIdle=function(a){return this.lastActivity<a},a.SipDataSession.prototype.accept=function(){},a.SipDataSession.prototype.send=function(a,b){var c=this.dataApi,d={eventHandlers:{}};if(b.customHeaders){d.extraHeaders=[];for(var e in b.customHeaders)"X-"!==e.slice(0,2)?console.warn("Ignoring invalid header: "+e):d.extraHeaders.push(e+": "+b.customHeaders[e])}b.contentType&&(d.contentType=b.contentType),b.onSuccess&&(d.eventHandlers.succeeded=b.onSuccess.bind(c)),d.eventHandlers.failed=function(a){b.onFailure&&b.onFailure.call(c),a.data.cause===JsSIP.C.causes.AUTHENTICATION_ERROR&&c.crocObject.stop()},c.crocObject.sipUA.sendMessage(this.address,a,d),this.lastActivity=Date.now(),this.localActiveRefreshIntervalId&&(clearInterval(this.localActiveRefreshIntervalId),this.localActiveRefreshIntervalId=null),this.localActiveTimeoutId&&(clearTimeout(this.localActiveTimeoutId),this.localActiveTimeoutId=null)},a.SipDataSession.prototype.sendXHTML=function(b,c){c=c||{},c.contentType=a.C.MT.XHTML;var d=a.Util.createValidXHTMLDoc(b);this.send(d,c)},a.SipDataSession.prototype.setComposingState=function(b){var c=this;if(b=b||a.C.states.sdkComposing.COMPOSING,this.localActiveTimeoutId&&(clearTimeout(this.localActiveTimeoutId),b===a.C.states.sdkComposing.IDLE&&this.send(this.idleXml,this.isComposingSendConfig)),b===a.C.states.sdkComposing.COMPOSING){if(!this.localActiveRefreshIntervalId){var d=this.dataApi.idleTimeout/2,e=a.Util.createIsComposingXml(b,d);this.send(e,this.isComposingSendConfig),this.localActiveRefreshIntervalId=setInterval(function(){c.send(e,c.isComposingSendConfig)},1e3*d)}this.localActiveTimeoutId=setTimeout(this.localActiveTimeout,1e3*a.C.COMPOSING_TIMEOUT)}},a.SipDataSession.prototype.close=function(b){this.state!==a.C.states.dataSession.CLOSED&&(this.state=a.C.states.dataSession.CLOSED,b||(b="normal"),this.localActiveRefreshIntervalId&&(clearInterval(this.localActiveRefreshIntervalId),this.localActiveRefreshIntervalId=null,this.send(this.idleXml,this.isComposingSendConfig)),this.localActiveTimeoutId&&(clearTimeout(this.localActiveTimeoutId),this.localActiveTimeoutId=null),this.remoteActiveTimeoutId&&(clearTimeout(this.remoteActiveTimeoutId),this.remoteActiveTimeoutId=null),a.Util.fireEvent(this,"onClose",{status:b}))},a.SipDataSession.prototype.getState=function(){return this.state},a.SipDataSession.prototype.onData=function(a){this.dataApi.onData(a)},a.SipDataSession.prototype.onXHTMLReceived=function(a){this.dataApi.onXHTMLReceived(a)}}(CrocSDK),function(a){var b=["audio","video"];a.StreamConfig=function(c){if(c instanceof a.Sdp.Session)this.fromSdp(c);else if(c){var d=!1;if("object"!=typeof c)throw new TypeError("Unexpected streamConfig type: "+typeof c);for(var e=0,f=b.length;f>e;e++){var g=b[e];c[g]?(this[g]=c[g],d=!0):this[g]=null}if(!d)throw new a.Exceptions.ValueError("No allowed streams found")}else this.audio={send:!0,receive:!0},this.video=null},a.StreamConfig.prototype.fromSdp=function(a){var c,d;for(c=0,d=b.length;d>c;c++){var e=b[c];this[e]=null}for(c=0,d=a.media.length;d>c;c++){var f=a.media[c];-1!==b.indexOf(f.media)&&0!==f.port&&(this[f.media]={send:f.isReceiving(),receive:f.isSending()})}},a.StreamConfig.prototype.isSending=function(){for(var a=0,c=b.length;c>a;a++){var d=b[a];if(this[d]&&this[d].send)return!0}return!1},a.StreamConfig.prototype.getSendingStreams=function(){for(var a=[],c=0,d=b.length;d>c;c++){var e=b[c];this[e]&&this[e].send&&a.push(e)}return a},a.StreamConfig.prototype.hold=function(){for(var a=[],c=0,d=b.length;d>c;c++){var e=b[c];this[e]&&this[e].receive&&(a.push(e),this[e].receive=!1)}return a},a.StreamConfig.prototype.resume=function(a){for(var c=0,d=b.length;d>c;c++){var e=b[c];this[e]&&-1!==a.indexOf(e)&&(this[e].receive=!0)}},a.StreamConfig.prototype.equals=function(a){for(var c=0,d=b.length;d>c;c++){var e=b[c];if(typeof this[e]!=typeof a[e])return!1;if(this[e]&&a[e]){if(this[e].send!==a[e].send)return!1;if(this[e].receive!==a[e].receive)return!1}else{if(this[e])return!1;if(a[e])return!1}}return!0},a.StreamConfig.prototype.sendingStreamsEqual=function(a){for(var c=0,d=b.length;d>c;c++){var e=b[c];if(typeof this[e]!=typeof a[e])return!1;if(this[e]&&a[e]){if(this[e].send!==a[e].send)return!1}else{if(this[e])return!1;if(a[e])return!1}}return!0},a.StreamConfig.prototype.isSafeChange=function(a){for(var c=0,d=b.length;d>c;c++){var e=b[c];if(a[e]&&a[e].send&&(!this[e]||!this[e].send))return!1}return!0}}(CrocSDK),function(a){var b={},c={string:String,"boolean":Boolean,number:Number,"function":Function};b.isType=function(b,d){if(-1===d.lastIndexOf("[]")){if(typeof b===d)return!0;if("object"==typeof b&&b instanceof c[d])return!0}else if(b instanceof Array){for(var e=d.slice(0,-2),f=0,g=b.length;g>f;f++)if(!a.Util.isType(b[f],e))return!1;return!0}return!1};var d={type:"string",customHeaders:"object",contentType:"string",fileTransfer:"object",onSuccess:"function",onFailure:"function",onProgress:"function"};b.checkSendConfig=function(b){for(var c in b){var e=d[c];if(!e)throw new a.Exceptions.ValueError("Unexpected config property: "+c);var f=b[c];if(!a.Util.isType(f,e))throw new TypeError(c+" is not set to a valid type")}},b.websocketCauseToSdkStatus=function(a){switch(a){case 1e3:return"normal";default:return"error"}},b.jsSipCauseToSdkStatus=function(a){switch(a){case JsSIP.C.causes.BUSY:return"normal";case JsSIP.C.causes.CONNECTION_ERROR:return"error";case JsSIP.C.causes.REQUEST_TIMEOUT:return"offline";case JsSIP.C.causes.REJECTED:return"blocked";case JsSIP.C.causes.NOT_FOUND:return"notfound";case JsSIP.C.causes.UNAVAILABLE:return"offline";default:return"normal"}};var e={200:"normal",403:"blocked",404:"notfound",408:"offline",480:"offline"};b.sipStatusToSdkStatus=function(a){return e[a]};var f={options:{normal:200,blocked:403,notfound:404,offline:480},invite:{normal:486,blocked:403,notfound:404,offline:480}};b.sdkStatusToSipStatus=function(a,b){return f[a][b]},b.fireEvent=function(a,b,c,d){if(d||a.hasOwnProperty(b))try{a[b](c)}catch(e){console.warn(a.constructor.name+"."+b+" handler threw exception:\n",e.stack)}},b.randomAlphanumericString=function(a){for(var b=Math.random().toString(36).substr(2);b.length<a;)b+=Math.random().toString(36).substr(2);return b.substr(0,a)};var g='<html xmlns="http://www.w3.org/1999/xhtml"><body>',h="</body></html>";b.createValidXHTMLDoc=function(b){if(b instanceof window.DocumentFragment){var c=new XMLSerializer;b=c.serializeToString(b)}if(!a.Util.isType(b,"string"))throw new TypeError("Unexpected body:",b);return g+b+h},b.extractXHTMLBody=function(a){for(var b=new DOMParser,c=b.parseFromString(a,"application/xhtml+xml"),d=c.createDocumentFragment(),e=c.getElementsByTagName("body")[0].firstChild;e;){var f=e.nextSibling;d.appendChild(e),e=f}return d};var i={active:"composing",idle:"idle"};b.rfc3994StateToSdkState=function(a){return i[a]},b.createIsComposingXml=function(a,b){var c,d='<isComposing xmlns="urn:ietf:params:xml:ns:im-iscomposing">';return c="composing"===a?"active":"idle",d=d.concat("<state>",c,"</state>"),b&&(d=d.concat("<refresh>",b,"</refresh>")),d+"</isComposing>"},b.shallowCopy=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])},b.normaliseAddress=function(b){try{return JsSIP.Utils.normalizeURI(b,"crocodilertc.net")}catch(c){throw new a.Exceptions.ValueError("Invalid address: "+b)}},b.isAuthFailure=function(a){var b=JsSIP.C.SIP_ERROR_CAUSES.AUTHENTICATION_ERROR;return b.indexOf(a)>=0},a.Util=b}(CrocSDK),function(a){a.XmppDataSession=function(b,c,d){var e=this;this.dataApi=b,this.state=a.C.states.dataSession.ESTABLISHED,this.lastActivity=Date.now(),this.awaitingFirstChatState=!0,this.supportsChatState=!0,this.supportsReceipts=!0,this.localComposingTimeoutId=null,this.localChatState=a.C.states.xmppChatState.ACTIVE,this.remoteChatState=a.C.states.xmppChatState.ACTIVE,this.outstandingMsgMap={},this.outstandingMsgs=[],this.localComposingTimeout=function(){e._sendChatState(a.C.states.xmppChatState.ACTIVE),e.localComposingTimeoutId=null},this.address=c,this.instanceAddress=d||null,this.displayName=null,this.customHeaders=null,this.capabilities=null,this.type="xmpp"},a.XmppDataSession.prototype._receiveMessage=function(b){var c=b.getBody(),d=b.getChild("body",a.C.NS.XHTML),e=b.getChild("*",NS_CHAT_STATES),f=b.getChild("received",a.C.NS.XMPP_RECEIPTS);if(this.lastActivity=Date.now(),this.awaitingFirstChatState&&(c||e)&&(e&&this.hasOwnProperty("onComposingStateChange")||(this.supportsChatState=!1),this.awaitingFirstChatState=!1),d&&(this.hasOwnProperty("onXHTMLReceived")||this.dataApi.hasOwnProperty("onXHTMLReceived"))){for(var g=b.getDoc().createDocumentFragment(),h=d.firstChild;h;){var i=h.nextSibling;g.appendChild(h),h=i}this.instanceAddress=b.getFrom(),a.Util.fireEvent(this,"onXHTMLReceived",{address:this.address,instanceAddress:this.instanceAddress,uniqueAddress:this.instanceAddress,body:g},!0)}else if(c)this.instanceAddress=b.getFrom(),a.Util.fireEvent(this,"onData",{address:this.address,instanceAddress:this.instanceAddress,uniqueAddress:this.instanceAddress,contentType:"text/plain",data:c},!0);else if(this.supportsChatState&&e)e=e.tagName,e===a.C.states.xmppChatState.GONE?(this.state=a.C.states.dataSession.CLOSED,a.Util.fireEvent(this,"onClose",{status:"normal"})):e===a.C.states.xmppChatState.COMPOSING?a.Util.fireEvent(this,"onComposingStateChange",{state:a.C.states.sdkComposing.COMPOSING}):a.Util.fireEvent(this,"onComposingStateChange",{state:a.C.states.sdkComposing.IDLE});else if(f){var j=f.getAttribute("id"),k=this.outstandingMsgMap[j];k&&(a.Util.fireEvent(k,"onSuccess",{}),delete this.outstandingMsgMap[j])}if(b.getChild("request",a.C.NS.XMPP_RECEIPTS)){var l=new JSJaCMessage;l.appendNode(l.buildNode("received",{id:b.getID()},null,a.C.NS.XMPP_RECEIPTS)),l.setTo(b.getFrom()),this.dataApi.crocObject.xmppCon.send(l)}},a.XmppDataSession.prototype._receiveMessageError=function(b){var c=b.getID(),d=this.outstandingMsgMap[c];d&&(a.Util.fireEvent(d,"onFailure",{}),delete this.outstandingMsgMap[c])},a.XmppDataSession.prototype._sendChatState=function(a){var b=new JSJaCMessage;b.setTo(this.instanceAddress||this.address),b.appendNode(b.buildNode(a,null,null,NS_CHAT_STATES)),this.dataApi.crocObject.xmppCon.send(b),this.localChatState=a},a.XmppDataSession.prototype._createReceiptId=function(b){var c=a.Util.randomAlphanumericString(8);this.outstandingMsgMap[c]=b,this.outstandingMsgs.push({sent:Date.now(),id:c});for(var d=this.outstandingMsgs[0],e=Date.now()-1e4;d&&d.sent<e;)this.outstandingMsgs.shift(),delete this.outstandingMsgMap[d.id],d=this.outstandingMsgs[0];return c},a.XmppDataSession.prototype._isIdle=function(b){return this.localChatState!==a.C.states.xmppChatState.COMPOSING&&this.remoteChatState!==a.C.states.xmppChatState.COMPOSING&&this.lastActivity<b},a.XmppDataSession.prototype.send=function(b,c){if(c&&(c.customHeaders||c.contentType||c.fileTransfer))throw new a.Exceptions.ValueError("customHeaders/contentType/fileTransfer not supported forXMPP data sessions");if(!a.Util.isType(b,"string"))throw new TypeError("XMPP data sessions only support string data");if(this.state!==a.C.states.dataSession.ESTABLISHED)throw new a.Exceptions.StateError("Cannot call send() in current state: "+this.state);var d=new JSJaCMessage;d.setTo(this.instanceAddress||this.address),d.setBody(b),this.supportsChatState&&d.appendNode(d.buildNode("active",null,null,NS_CHAT_STATES)),(c.onSuccess||c.onFailure)&&(d.setID(this._createReceiptId(c)),this.supportsReceipts&&d.appendNode(d.buildNode("request",null,null,a.C.NS.XMPP_RECEIPTS))),this.dataApi.crocObject.xmppCon.send(d)||(a.Util.fireEvent(c,"onFailure",{}),delete this.outstandingMsgMap[d.getID()]),this.lastActivity=Date.now(),this.localComposingTimeoutId&&(clearTimeout(this.localComposingTimeoutId),this.localComposingTimeoutId=null)
},a.XmppDataSession.prototype.sendXHTML=function(b,c){if(c&&(c.customHeaders||c.contentType&&"application/xhtml+xml"!==c.contentType||c.fileTransfer))throw new a.Exceptions.ValueError("customHeaders/contentType/fileTransfer not supported forXMPP data sessions");if(this.state!==a.C.states.dataSession.ESTABLISHED)throw new a.Exceptions.StateError("Cannot call send() in current state: "+this.state);var d=new JSJaCMessage;d.setTo(this.instanceAddress||this.address);var e;if(a.Util.isType(b,"string")){var f=new DOMParser,g=f.parseFromString("<body xmlns='"+a.C.NS.XHTML+"'>"+b+"</body>","text/xml");e=g.documentElement}else e=d.buildNode("body",null,[b],a.C.NS.XHTML);d.setBody(this.dataApi.crocObject.jQuery(e).text());var h=d.buildNode("html",null,[e],a.C.NS.XMPP_XHTML_IM);d.appendNode(h),this.supportsChatState&&d.appendNode(d.buildNode("active",null,null,NS_CHAT_STATES)),(c.onSuccess||c.onFailure)&&(d.setID(this._createReceiptId(c)),this.supportsReceipts&&d.appendNode(d.buildNode("request",null,null,a.C.NS.XMPP_RECEIPTS))),this.dataApi.crocObject.xmppCon.send(d)||(a.Util.fireEvent(c,"onFailure",{}),delete this.outstandingMsgMap[d.getID()]),this.lastActivity=Date.now(),this.localComposingTimeoutId&&(clearTimeout(this.localComposingTimeoutId),this.localComposingTimeoutId=null)},a.XmppDataSession.prototype.accept=function(){},a.XmppDataSession.prototype.close=function(b){this.state!==a.C.states.dataSession.CLOSED&&(this.supportsChatState&&this._sendChatState(a.C.states.xmppChatState.GONE),this.state=a.C.states.dataSession.CLOSED,this.localComposingTimeoutId&&(clearTimeout(this.localComposingTimeoutId),this.localComposingTimeoutId=null),b||(b="normal"),a.Util.fireEvent(this,"onClose",{status:b}))},a.XmppDataSession.prototype.getState=function(){return this.state},a.XmppDataSession.prototype.setComposingState=function(b){if(this.supportsChatState){var c=a.C.states.sdkComposing.IDLE;b=b||a.C.states.sdkComposing.COMPOSING,this.localComposingTimeoutId&&(c=a.C.states.sdkComposing.COMPOSING,clearTimeout(this.localComposingTimeoutId),this.localComposingTimeoutId=null,b===a.C.states.sdkComposing.IDLE&&this._sendChatState(a.C.states.xmppChatState.ACTIVE)),b===a.C.states.sdkComposing.COMPOSING&&(c!==a.C.states.sdkComposing.COMPOSING&&this._sendChatState(a.C.states.xmppChatState.COMPOSING),this.localComposingTimeoutId=setTimeout(this.localComposingTimeout,1e3*a.C.COMPOSING_TIMEOUT))}},a.XmppDataSession.prototype.onData=function(a){this.dataApi.onData(a)},a.XmppDataSession.prototype.onXHTMLReceived=function(a){this.dataApi.onXHTMLReceived(a)}}(CrocSDK),function(a){function b(a){var b=a.address.split("@");a.xmppCon.connect({username:a.authorizationUser||b[0],domain:b[1],password:a.password,resource:a.xmppResource,allow_plain:!0})}function c(b,c){var e=[],f={};if(b.isError())return null!==b.getChild("item-not-found",NS_STANZAS)?(console.log("Roster does not exist yet"),c.contactList=[],c.contactMap=f,a.Util.fireEvent(c,"onContactsReceived",{contacts:e})):console.warn("Unexpected roster result:",b.xml()),void 0;for(var g=b.getQuery().childNodes,h=0,i=g.length;i>h;h++){var j=d(c,g.item(h));if(!j)return console.error("Error parsing contact roster item",g.item(h)),void 0;e.push(j),f[j.address]=j}var k=c.contactList;for(h=0,i=k.length;i>h;h++){var l=k[h],m=f[l.address];m&&(m.availability=l.availability,m.status=l.status,m.extraNodes=l.extraNodes)}c.contactList=e,c.contactMap=f,a.Util.fireEvent(c,"onContactsReceived",{contacts:[].concat(e)})}function d(a,b){var c=new h(a,b.getAttribute("jid"));if(!c.address)return null;"true"===b.getAttribute("approved")&&(c.watchingApproved=!0),"subscribe"===b.getAttribute("ask")&&(c.watchPending=!0);var d=b.getAttribute("name");switch(d&&(c.name=d),b.getAttribute("subscription")){case"":case"none":break;case"both":c.watching=!0,c.watchingMe=!0;break;case"from":c.watchingMe=!0;break;case"to":c.watching=!0;break;case"remove":c.removed=!0;break;default:return null}for(var e=b.firstChild;e;){if("group"===e.nodeName){for(var f=e.childNodes,g="",i=0,j=f.length;j>i;i++)f.item(i).nodeValue&&(g+=f.item(i).nodeValue);c.groups.push(g)}e=e.nextSibling}return c}function e(a,b){var c=a.presenceApi,d=c.crocObject.xmppCon,e={jid:a.address};a.name&&(e.name=a.name);for(var g=new JSJaCIQ,h=g.buildNode("item",e),i=0,j=a.groups.length;j>i;i++)h.appendChild(g.buildNode("group",a.groups[i]));return g.setType("set"),g.setQuery(NS_ROSTER).appendChild(h),d.send(g,f,b)}function f(a,b){a.isError()?console.warn("Roster set failed",a.xml()):b&&b()}function g(b,c){var d=new JSJaCPresence;if(c){c.availability&&-1!==j.indexOf(c.availability)&&d.setShow(c.availability),c.status&&d.setStatus(c.status);var e=c.extraNodes;if(e){if(!e instanceof Node)throw new TypeError("Unexpected type for extraNodes");d.appendNode(e)}}if(!d.getChild("reach",a.C.NS.XMPP_REACH)){var f=d.buildNode("addr",{uri:"sip:"+b.address});d.appendNode("reach",{},[f],a.C.NS.XMPP_REACH)}return d}function h(a,b){this.presenceApi=a,this.removed=!1,this.address=b,this.watching=!1,this.watchPending=!1,this.watchingMe=!1,this.watchingApproved=!1,this.name=null,this.groups=[],this.availability=null,this.status=null,this.extraNodes=null}function i(a,b,c){this.presenceApi=a,this.address=b,this.status=c||null}var j=["away","dnd"];h.prototype.watch=function(){var a=new JSJaCPresence;return a.setTo(this.address),a.setType("subscribe"),this.presenceApi.crocObject.xmppCon.send(a)},h.prototype.unwatch=function(){var a=new JSJaCPresence;return a.setTo(this.address),a.setType("unsubscribe"),this.presenceApi.crocObject.xmppCon.send(a)},h.prototype.allowWatch=function(){var a=new JSJaCPresence;return a.setTo(this.address),a.setType("subscribed"),this.presenceApi.crocObject.xmppCon.send(a)},h.prototype.denyWatch=function(){var a=new JSJaCPresence;return a.setTo(this.address),a.setType("unsubscribed"),this.presenceApi.crocObject.xmppCon.send(a)},h.prototype.update=function(a){for(var b,c=new h(this.presenceApi,this.address),d=["name","groups"],f=0,g=d.length;g>f;f++)b=d[f],c[b]=a.hasOwnProperty(b)?a[b]:this[b];e(c)},h.prototype.remove=function(){var a=this.presenceApi.crocObject.xmppCon,b=new JSJaCIQ,c=b.buildNode("item",{jid:this.address,subscription:"remove"});return b.setType("set"),b.setQuery(NS_ROSTER).appendChild(c),a.send(b,f)},h.prototype._update=function(b){for(var c,d=["watching","watchPending","watchingMe","watchingApproved","name","groups"],e=0,f=d.length;f>e;e++)c=d[e],this[c]=b[c];a.Util.fireEvent(this,"onUpdate")},i.prototype.accept=function(){var a=new JSJaCPresence;a.setTo(this.address),a.setType("subscribed"),this.presenceApi.crocObject.xmppCon.send(a)},i.prototype.reject=function(){var a=new JSJaCPresence;a.setTo(this.address),a.setType("unsubscribed"),this.presenceApi.crocObject.xmppCon.send(a)},a.XmppPresenceAPI=function(a,b){this.crocObject=a,b.jQuery.extend(this,b.presence),this.running=!1,this.reconnectTimerId=null,this.contactList=[],this.contactMap={},this.currentPresence=new JSJaCPresence},a.XmppPresenceAPI.prototype.init=function(){var c=this,d=this.crocObject,e=d.xmppCon;if(e){this.currentPresence=g(d),e.registerHandler("onconnect",function(){c.getContacts(),e.send(c.currentPresence.clone()),a.Util.fireEvent(c,"onConnected",{})}),e.registerHandler("ondisconnect",function(){c.running?c.reconnectTimerId||(c.reconnectTimerId=setTimeout(function(){c.running&&b(d),c.reconnectTimerId=null},1e4),a.Util.fireEvent(c,"onDisconnected",{})):a.Util.fireEvent(c,"onDisconnected",{})}),e.registerHandler("onerror",function(f){console.warn("XMPP error:",f),e.connected()&&e.disconnect(),c.running&&!c.reconnectTimerId&&(c.reconnectTimerId=setTimeout(function(){c.running&&b(d),c.reconnectTimerId=null},1e4),a.Util.fireEvent(c,"onDisconnected",{}))}),e.registerIQGet("query",NS_DISCO_INFO,this._processServiceDiscovery.bind(this)),e.registerIQSet("query",NS_ROSTER,this._processRosterPush.bind(this)),e.registerHandler("iq",function(a){console.log("Received unhandled IQ:",a.xml()),e.send(a.errorReply(ERR_FEATURE_NOT_IMPLEMENTED))}),e.registerHandler("presence","*","*","subscribe",this._processSubscribe.bind(this));var f=function(){return!0};e.registerHandler("presence","*","*","unsubscribe",f),e.registerHandler("presence","*","*","subscribed",f),e.registerHandler("presence","*","*","unsubscribed",f),e.registerHandler("presence",this._processPresence.bind(this))}},a.XmppPresenceAPI.prototype._processServiceDiscovery=function(b){var c=this.crocObject.xmppCon,d=new JSJaCIQ;d.setIQ(b.getFrom(),"result",b.getID());var e=d.buildNode("feature",{"var":a.C.NS.XMPP_RECEIPTS}),f=d.buildNode("feature",{"var":NS_CHAT_STATES}),g=d.buildNode("feature",{"var":a.C.NS.XMPP_XHTML_IM}),h=d.buildNode("query",{xmlns:NS_DISCO_INFO},[e,f,g]);return d.appendNode(h),c.send(d),!0},a.XmppPresenceAPI.prototype._processRosterPush=function(b){var c=b.getQuery().childNodes,e=this.crocObject.xmppCon;if(1!==c.length)return console.warn("Received invalid roster push (rule 1):",b.xml()),e.send(b.errorReply(ERR_BAD_REQUEST)),!0;if(b.getFrom()&&b.getFrom()!==this.crocObject.address)return console.warn("Received invalid roster push (rule 2):",b.xml()),e.send(b.errorReply(ERR_BAD_REQUEST)),!0;var f=d(this,c.item(0));if(!f)return console.error("Error parsing contact roster item",c.item(0)),e.send(b.errorReply(ERR_BAD_REQUEST)),!0;var g=this.contactMap[f.address];g?f.removed?(console.log("Removing contact",f.address),this.contactList.splice(this.contactList.indexOf(g),1),delete this.contactMap[f.address],a.Util.fireEvent(g,"onRemove",{})):(console.log("Updating contact",f.address),g._update(f)):f.removed?console.log("Received roster removal push for unknown contact!"):(console.log("Adding contact",f.address),this.contactList.push(f),this.contactMap[f.address]=f,a.Util.fireEvent(this,"onNewContact",{contact:f}));var h=new JSJaCIQ;return h.setIQ(b.getFrom(),"result",b.getID()),e.send(h),!0},a.XmppPresenceAPI.prototype._processSubscribe=function(b){var c=b.getChildVal("status"),d=new i(this,b.getFrom(),c);return a.Util.fireEvent(this,"onWatchRequest",d),!0},a.XmppPresenceAPI.prototype._processPresence=function(b){var c=b.getFromJID(),d=c.getBareJID(),e=b.getChildVal("status")||null,f="available",g=null,h=b.getType();if(h){if("unavailable"!==h)return console.warn("Unexpected presence message",b.xml()),!0;f="unavailable";var i=this.crocObject.data.xmppDataSessions[d];i&&i.instanceAddress===b.getFrom()&&i.close()}else{var j=b.getChildVal("show");switch(j){case"away":case"dnd":f=j;break;case"xa":f="away"}}for(var k=b.getNode().firstChild;k;){switch(k.nodeName){case"show":case"status":break;default:g||(g=b.getDoc().createDocumentFragment()),g.appendChild(k)}k=k.nextSibling}var l=this.contactMap[d];return l?(l.availability=f,l.status=e,l.extraNodes=g,a.Util.fireEvent(l,"onNotify",{})):d===this.crocObject.address?(a.Util.fireEvent(this,"onSelfNotify",{instanceAddress:c.toString(),uniqueAddress:c.toString(),availability:f,status:e,extraNodes:g}),c.getResource()===this.crocObject.xmppResource&&"unavailable"===f&&this.disconnectTimerId&&(clearTimeout(this.disconnectTimerId),this.crocObject.xmppCon.disconnect())):a.Util.fireEvent(this,"onDirectNotify",{address:d,instanceAddress:c.toString(),uniqueAddress:c.toString(),availability:f,status:e,extraNodes:g}),!0},a.XmppPresenceAPI.prototype.start=function(){var a=this.crocObject;this.running||a.xmppCon&&(this.running=!0,b(a))},a.XmppPresenceAPI.prototype.stop=function(){if(this.running){this.running=!1;var a=this.crocObject.xmppCon;if(a.connected()){var b=null,c=this.crocObject.data.xmppDataSessions;for(b in c)c[b].close();var d=new JSJaCPresence;a.send(d.setType("unavailable")),this.disconnectTimerId=setTimeout(function(){a.disconnect()},3e3)}else a.disconnect()}},a.XmppPresenceAPI.prototype.getContacts=function(){if(!this.running)throw new a.Exceptions.StateError("Presence not started");var b=new JSJaCIQ;b.setType("get"),b.setQuery(NS_ROSTER),this.crocObject.xmppCon.send(b,c,this)},a.XmppPresenceAPI.prototype.addContact=function(b,c){if(!this.running)throw new a.Exceptions.StateError("Presence not started");var d=new h(this,b),f=null;c=c||{};var g=c.watch!==!1,i=c.allowWatch!==!1;if(c.name){if(!a.Util.isType(c.name,"string"))throw new TypeError("Unexpected type for name");d.name=c.name}if(c.groups){if(!a.Util.isType(c.groups,"string[]"))throw new TypeError("Unexpected type for groups");d.groups=c.groups}(g||i)&&(f=function(){g&&d.watch(),i&&d.allowWatch()}),e(d,f)},a.XmppPresenceAPI.prototype.publishPresence=function(b){if(!this.running)throw new a.Exceptions.StateError("Presence not started");this.currentPresence=g(this.crocObject,b),this.crocObject.xmppCon.send(this.currentPresence)},a.XmppPresenceAPI.prototype.sendPresence=function(b,c){if(!this.running)throw new a.Exceptions.StateError("Presence not started");var d;d=c?g(this.crocObject,c):this.currentPresence.clone(),this.crocObject.xmppCon.send(d.setTo(b))}}(CrocSDK),function(a){a.croc=function(b){if(!b)throw new CrocSDK.Exceptions.ValueError("Configuration object missing");return b.jQuery=a,new CrocSDK.Croc(b)}}(jQuery);